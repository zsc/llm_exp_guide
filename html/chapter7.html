<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ä¸ƒç« ï¼šè®­ç»ƒå¾ªç¯ä¸è¿­ä»£ä¼˜åŒ–</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">LLM åè®­ç»ƒå®éªŒè®¾è®¡æŒ‡å—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸€ç« ï¼šåè®­ç»ƒåŸºç¡€ç†è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äºŒç« ï¼šå®éªŒä»£ç åŸºç¡€è®¾æ–½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸‰ç« ï¼šæ•°æ®å·¥ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å››ç« ï¼šçº¯è¯­è¨€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äº”ç« ï¼šå¤šæ¨¡æ€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…­ç« ï¼šå¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸ƒç« ï¼šè®­ç»ƒå¾ªç¯ä¸è¿­ä»£ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…«ç« ï¼šè¯„ä¼°ä¸åŸºå‡†æµ‹è¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¹ç« ï¼šç”Ÿäº§éƒ¨ç½²ä¸ç›‘æ§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬åç« ï¼šæ¡ˆä¾‹ç ”ç©¶ä¸æœ€ä½³å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="_1">ç¬¬ä¸ƒç« ï¼šè®­ç»ƒå¾ªç¯ä¸è¿­ä»£ä¼˜åŒ–</h1>
<p>æœ¬ç« æ·±å…¥æ¢è®¨ LLM åè®­ç»ƒçš„ç«¯åˆ°ç«¯è®­ç»ƒæµç¨‹è®¾è®¡ï¼Œé‡ç‚¹å…³æ³¨å¦‚ä½•æ„å»ºé«˜æ•ˆçš„è¿­ä»£ä¼˜åŒ–ç³»ç»Ÿã€‚æˆ‘ä»¬å°†ä»æ•°æ®-æ ‡æ³¨-è®­ç»ƒ-è¯„ä¼°çš„å®Œæ•´å¾ªç¯å¼€å§‹ï¼Œé€æ­¥æ·±å…¥åˆ°ä¸»åŠ¨å­¦ä¹ ã€æ¨¡å‹åˆå¹¶ã€è¶…å‚æ•°ä¼˜åŒ–ä»¥åŠåˆ†å¸ƒå¼è®­ç»ƒçš„å·¥ç¨‹å®è·µã€‚é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œæ‚¨å°†æŒæ¡æ„å»ºå¯æ‰©å±•ã€é«˜æ•ˆç‡è®­ç»ƒç³»ç»Ÿçš„æ ¸å¿ƒæ–¹æ³•è®ºã€‚</p>
<h2 id="71-">7.1 æ•°æ®-æ ‡æ³¨-è®­ç»ƒ-è¯„ä¼°å¾ªç¯è®¾è®¡</h2>
<p>åè®­ç»ƒçš„æˆåŠŸå¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºèƒ½å¦å»ºç«‹é«˜æ•ˆçš„è¿­ä»£å¾ªç¯ã€‚ä¸é¢„è®­ç»ƒçš„å•æ¬¡å¤§è§„æ¨¡è®­ç»ƒä¸åŒï¼Œåè®­ç»ƒéœ€è¦æŒç»­çš„æ•°æ®æ”¶é›†ã€æ ‡æ³¨ã€è®­ç»ƒå’Œè¯„ä¼°ï¼Œå½¢æˆä¸€ä¸ªä¸æ–­æ”¹è¿›çš„é—­ç¯ç³»ç»Ÿã€‚</p>
<h3 id="711">7.1.1 å¾ªç¯æ¶æ„çš„åŸºæœ¬åŸç†</h3>
<p>æ•°æ®-æ ‡æ³¨-è®­ç»ƒ-è¯„ä¼°ï¼ˆDLTEï¼‰å¾ªç¯æ˜¯åè®­ç»ƒçš„æ ¸å¿ƒæ¶æ„æ¨¡å¼ã€‚å…¶åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span></span><code>    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   æ•°æ®æ”¶é›†   â”‚ â† ç”¨æˆ·åé¦ˆ/åˆæˆç”Ÿæˆ
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚   æ•°æ®æ ‡æ³¨   â”‚ â† äººå·¥/æ¨¡å‹è¾…åŠ©
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚   æ¨¡å‹è®­ç»ƒ   â”‚ â† SFT/RLHF/DPO
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚   æ¨¡å‹è¯„ä¼°   â”‚ â†’ æŒ‡æ ‡ç›‘æ§
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚  éƒ¨ç½²/è¿­ä»£   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>å…³é”®è®¾è®¡åŸåˆ™</strong>ï¼š</p>
<ol>
<li><strong>å¢é‡å¼æ›´æ–°</strong>ï¼šæ¯æ¬¡å¾ªç¯ä¸å¿…å¤„ç†å…¨é‡æ•°æ®ï¼Œè€Œæ˜¯å…³æ³¨æ–°å¢å’Œé«˜ä»·å€¼æ•°æ®</li>
<li><strong>å¿«é€Ÿè¿­ä»£</strong>ï¼šç¼©çŸ­å¾ªç¯å‘¨æœŸï¼ŒåŠ å¿«åé¦ˆé€Ÿåº¦ï¼ˆç›®æ ‡ï¼šæ—¥çº§åˆ«è¿­ä»£ï¼‰</li>
<li><strong>è´¨é‡é—¨æ§</strong>ï¼šæ¯ä¸ªç¯èŠ‚è®¾ç½®è´¨é‡æ£€æŸ¥ç‚¹ï¼Œé˜²æ­¢ä½è´¨é‡æ•°æ®æ±¡æŸ“</li>
<li><strong>å¯è¿½æº¯æ€§</strong>ï¼šæ•°æ®æ¥æºã€æ ‡æ³¨å†å²ã€è®­ç»ƒé…ç½®å®Œå…¨å¯è¿½æº¯</li>
</ol>
<h3 id="712">7.1.2 æ•°æ®æµç®¡é“è®¾è®¡</h3>
<p>é«˜æ•ˆçš„æ•°æ®æµç®¡é“éœ€è¦è§£å†³æ•°æ®æ”¶é›†ã€é¢„å¤„ç†ã€å­˜å‚¨å’Œç‰ˆæœ¬ç®¡ç†ç­‰æŒ‘æˆ˜ï¼š</p>
<p><strong>æ•°æ®æ”¶é›†ç­–ç•¥</strong>ï¼š</p>
<ul>
<li><strong>ç”¨æˆ·äº¤äº’æ•°æ®</strong>ï¼šæ”¶é›†çœŸå®ç”¨æˆ·æŸ¥è¯¢å’Œåé¦ˆ</li>
<li><strong>åˆæˆæ•°æ®ç”Ÿæˆ</strong>ï¼šä½¿ç”¨æ›´å¼ºæ¨¡å‹ç”Ÿæˆè®­ç»ƒæ•°æ®</li>
<li><strong>å›°éš¾æ¡ˆä¾‹æŒ–æ˜</strong>ï¼šä¸»åŠ¨æ”¶é›†æ¨¡å‹è¡¨ç°ä¸ä½³çš„æ¡ˆä¾‹</li>
<li><strong>é¢†åŸŸæ•°æ®çˆ¬å–</strong>ï¼šé’ˆå¯¹ç‰¹å®šé¢†åŸŸçš„æ•°æ®æ”¶é›†</li>
</ul>
<p><strong>ç®¡é“æ¶æ„è®¾è®¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>è¾“å…¥æº â†’ æ•°æ®éªŒè¯ â†’ å»é‡æ¸…æ´— â†’ æ ¼å¼æ ‡å‡†åŒ– â†’ æ•°æ®æ± 
  â†“         â†“          â†“           â†“          â†“
ç›‘æ§      è´¨é‡æŠ¥å‘Š   æ¸…æ´—æ—¥å¿—    schemaæ£€æŸ¥  ç‰ˆæœ¬æ§åˆ¶
</code></pre></div>

<p><strong>æ•°æ®ç‰ˆæœ¬ç®¡ç†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ•°æ®ç‰ˆæœ¬é…ç½®ç¤ºä¾‹</span>
<span class="n">data_version</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;v2.3.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;base_dataset&quot;</span><span class="p">:</span> <span class="s2">&quot;v2.3.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;incremental&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;user_feedback&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
        <span class="s2">&quot;synthetic&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
        <span class="s2">&quot;hard_negatives&quot;</span><span class="p">:</span> <span class="mi">20000</span>
    <span class="p">},</span>
    <span class="s2">&quot;filters_applied&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;deduplication&quot;</span><span class="p">,</span>
        <span class="s2">&quot;quality_threshold_0.8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;safety_filter&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;split_ratio&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="mf">0.05</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="713">7.1.3 æ ‡æ³¨ç³»ç»Ÿé›†æˆ</h3>
<p>æ ‡æ³¨æ˜¯åè®­ç»ƒæ•°æ®è´¨é‡çš„å…³é”®ç¯èŠ‚ã€‚ç°ä»£æ ‡æ³¨ç³»ç»Ÿéœ€è¦å¹³è¡¡æ•ˆç‡ã€è´¨é‡å’Œæˆæœ¬ï¼š</p>
<p><strong>æ ‡æ³¨æ¨¡å¼é€‰æ‹©</strong>ï¼š</p>
<ol>
<li>
<p><strong>çº¯äººå·¥æ ‡æ³¨</strong>ï¼š
   - ä¼˜ç‚¹ï¼šè´¨é‡é«˜ï¼Œå¯å¤„ç†å¤æ‚ä»»åŠ¡
   - ç¼ºç‚¹ï¼šæˆæœ¬é«˜ï¼Œé€Ÿåº¦æ…¢ï¼Œä¸€è‡´æ€§éš¾ä¿è¯
   - é€‚ç”¨ï¼šå®‰å…¨ç›¸å…³ã€é«˜ä»·å€¼ä»»åŠ¡</p>
</li>
<li>
<p><strong>æ¨¡å‹è¾…åŠ©æ ‡æ³¨</strong>ï¼š
   - ä¼˜ç‚¹ï¼šæ•ˆç‡é«˜ï¼Œæˆæœ¬ä½
   - ç¼ºç‚¹ï¼šå¯èƒ½ä¼ æ’­æ¨¡å‹åè§
   - é€‚ç”¨ï¼šå¤§è§„æ¨¡åˆç­›ã€ç®€å•åˆ†ç±»ä»»åŠ¡</p>
</li>
<li>
<p><strong>æ··åˆæ ‡æ³¨ç­–ç•¥</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>åŸå§‹æ•°æ® â†’ æ¨¡å‹é¢„æ ‡æ³¨ â†’ äººå·¥å®¡æ ¸/ä¿®æ­£ â†’ è´¨é‡é‡‡æ ·æ£€æŸ¥ â†’ æœ€ç»ˆæ ‡æ³¨
             â†“              â†“                â†“
         ç½®ä¿¡åº¦è¯„åˆ†    æ ‡æ³¨è€…ä¸€è‡´æ€§    éšæœºè´¨æ£€(5-10%)
</code></pre></div>

<p><strong>æ ‡æ³¨è§„èŒƒè®¾è®¡è¦ç‚¹</strong>ï¼š</p>
<ul>
<li><strong>æ¸…æ™°çš„ä»»åŠ¡å®šä¹‰</strong>ï¼šé¿å…æ­§ä¹‰ï¼Œæä¾›å……åˆ†ç¤ºä¾‹</li>
<li><strong>å±‚æ¬¡åŒ–æ ‡æ³¨</strong>ï¼šå°†å¤æ‚ä»»åŠ¡åˆ†è§£ä¸ºç®€å•å­ä»»åŠ¡</li>
<li><strong>åŠ¨æ€è§„èŒƒæ›´æ–°</strong>ï¼šæ ¹æ®æ ‡æ³¨è¿‡ç¨‹ä¸­çš„é—®é¢˜æŒç»­ä¼˜åŒ–è§„èŒƒ</li>
<li><strong>æ ‡æ³¨è€…åŸ¹è®­</strong>ï¼šç³»ç»ŸåŒ–åŸ¹è®­å’Œè®¤è¯æœºåˆ¶</li>
</ul>
<h3 id="714">7.1.4 è®­ç»ƒè§¦å‘æœºåˆ¶</h3>
<p>ç¡®å®šä½•æ—¶è§¦å‘æ–°ä¸€è½®è®­ç»ƒæ˜¯å¾ªç¯è®¾è®¡çš„å…³é”®å†³ç­–ç‚¹ï¼š</p>
<p><strong>è§¦å‘ç­–ç•¥ç±»å‹</strong>ï¼š</p>
<ol>
<li>
<p><strong>å®šæ—¶è§¦å‘</strong>ï¼š
   - å›ºå®šå‘¨æœŸï¼ˆå¦‚æ¯æ—¥ã€æ¯å‘¨ï¼‰
   - ä¼˜ç‚¹ï¼šå¯é¢„æµ‹ï¼Œä¾¿äºèµ„æºè§„åˆ’
   - ç¼ºç‚¹ï¼šå¯èƒ½æµªè´¹è®¡ç®—èµ„æº</p>
</li>
<li>
<p><strong>æ•°æ®é‡è§¦å‘</strong>ï¼š
   - ç´¯ç§¯è¶³å¤Ÿæ–°æ•°æ®åè§¦å‘ï¼ˆå¦‚10ä¸‡æ¡ï¼‰
   - ä¼˜ç‚¹ï¼šç¡®ä¿æ¯æ¬¡è®­ç»ƒæœ‰è¶³å¤Ÿå¢é‡
   - ç¼ºç‚¹ï¼šæ—¶é—´ä¸å¯æ§</p>
</li>
<li>
<p><strong>æ€§èƒ½è§¦å‘</strong>ï¼š
   - ç›‘æ§æŒ‡æ ‡ä¸‹é™åˆ°é˜ˆå€¼æ—¶è§¦å‘
   - ä¼˜ç‚¹ï¼šæŒ‰éœ€è®­ç»ƒï¼Œé’ˆå¯¹æ€§å¼º
   - ç¼ºç‚¹ï¼šéœ€è¦å¯é çš„åœ¨çº¿ç›‘æ§</p>
</li>
<li>
<p><strong>æ··åˆè§¦å‘ç­–ç•¥</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">should_trigger_training</span><span class="p">():</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">data_accumulated</span> <span class="o">&gt;</span> <span class="n">min_data_threshold</span><span class="p">,</span>
        <span class="n">days_since_last_training</span> <span class="o">&gt;</span> <span class="n">max_wait_days</span><span class="p">,</span>
        <span class="n">performance_degradation</span> <span class="o">&gt;</span> <span class="n">alert_threshold</span><span class="p">,</span>
        <span class="n">critical_bug_fixes_pending</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">conditions</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
</code></pre></div>

<h3 id="715">7.1.5 è¯„ä¼°åé¦ˆè·¯å¾„</h3>
<p>è¯„ä¼°ç»“æœéœ€è¦æœ‰æ•ˆåé¦ˆåˆ°å¾ªç¯çš„å„ä¸ªç¯èŠ‚ï¼š</p>
<p><strong>åé¦ˆæœºåˆ¶è®¾è®¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>è¯„ä¼°ç»“æœ â”€â”€â”¬â”€â”€ æ•°æ®æ”¶é›†ï¼šæŒ‡å¯¼å›°éš¾æ ·æœ¬æ”¶é›†
          â”œâ”€â”€ æ ‡æ³¨ä¼˜åŒ–ï¼šè°ƒæ•´æ ‡æ³¨è§„èŒƒ
          â”œâ”€â”€ è®­ç»ƒç­–ç•¥ï¼šè°ƒæ•´æŸå¤±æƒé‡
          â””â”€â”€ æ¨¡å‹é€‰æ‹©ï¼šå†³å®šéƒ¨ç½²ç‰ˆæœ¬
</code></pre></div>

<p><strong>å…³é”®æŒ‡æ ‡ç›‘æ§</strong>ï¼š</p>
<ol>
<li><strong>ä»»åŠ¡æŒ‡æ ‡</strong>ï¼šå‡†ç¡®ç‡ã€BLEUã€ROUGEç­‰</li>
<li><strong>è´¨é‡æŒ‡æ ‡</strong>ï¼šå“åº”ç›¸å…³æ€§ã€äº‹å®å‡†ç¡®æ€§</li>
<li><strong>å®‰å…¨æŒ‡æ ‡</strong>ï¼šæœ‰å®³å†…å®¹ç‡ã€åè§ç¨‹åº¦</li>
<li><strong>æ•ˆç‡æŒ‡æ ‡</strong>ï¼šæ¨ç†å»¶è¿Ÿã€ååé‡</li>
</ol>
<p><strong>è‡ªåŠ¨åŒ–å†³ç­–è§„åˆ™</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_and_decide</span><span class="p">(</span><span class="n">model_metrics</span><span class="p">):</span>
    <span class="n">decisions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;deploy&quot;</span><span class="p">:</span> <span class="nb">all</span><span class="p">([</span>
            <span class="n">model_metrics</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">baseline</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.02</span><span class="p">,</span>
            <span class="n">model_metrics</span><span class="p">[</span><span class="s2">&quot;safety_score&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">,</span>
            <span class="n">model_metrics</span><span class="p">[</span><span class="s2">&quot;latency_p99&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">baseline</span><span class="p">[</span><span class="s2">&quot;latency_p99&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.1</span>
        <span class="p">]),</span>
        <span class="s2">&quot;collect_more_data&quot;</span><span class="p">:</span> <span class="n">model_metrics</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">target_accuracy</span><span class="p">,</span>
        <span class="s2">&quot;adjust_training&quot;</span><span class="p">:</span> <span class="n">model_metrics</span><span class="p">[</span><span class="s2">&quot;loss_variance&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span>
        <span class="s2">&quot;rollback&quot;</span><span class="p">:</span> <span class="n">model_metrics</span><span class="p">[</span><span class="s2">&quot;safety_score&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.9</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">decisions</span>
</code></pre></div>

<p><strong>æŒç»­æ”¹è¿›æœºåˆ¶</strong>ï¼š</p>
<ul>
<li><strong>A/Bæµ‹è¯•</strong>ï¼šæ–°æ¨¡å‹ä¸åŸºçº¿æ¨¡å‹å¯¹æ¯”</li>
<li><strong>æ¸è¿›å¼å‘å¸ƒ</strong>ï¼šé€æ­¥æ‰©å¤§æ–°æ¨¡å‹çš„æµé‡æ¯”ä¾‹</li>
<li><strong>å›æ»šæœºåˆ¶</strong>ï¼šæ€§èƒ½ä¸‹é™æ—¶å¿«é€Ÿæ¢å¤</li>
<li><strong>æ¡ˆä¾‹åˆ†æ</strong>ï¼šå®šæœŸåˆ†æå¤±è´¥æ¡ˆä¾‹ï¼Œä¼˜åŒ–æ•°æ®æ”¶é›†</li>
</ul>
<h2 id="72">7.2 ä¸»åŠ¨å­¦ä¹ ä¸æ•°æ®é€‰æ‹©ç­–ç•¥</h2>
<p>åœ¨åè®­ç»ƒä¸­ï¼Œå¹¶éæ‰€æœ‰æ•°æ®éƒ½å…·æœ‰åŒç­‰ä»·å€¼ã€‚ä¸»åŠ¨å­¦ä¹ ï¼ˆActive Learningï¼‰å¸®åŠ©æˆ‘ä»¬è¯†åˆ«å’Œä¼˜å…ˆå¤„ç†æœ€æœ‰ä»·å€¼çš„æ•°æ®ï¼Œä»è€Œä»¥æœ€å°çš„æ ‡æ³¨æˆæœ¬è·å¾—æœ€å¤§çš„æ¨¡å‹æ”¹è¿›ã€‚</p>
<h3 id="721">7.2.1 ä¸ç¡®å®šæ€§é‡‡æ ·</h3>
<p>ä¸ç¡®å®šæ€§é‡‡æ ·æ˜¯ä¸»åŠ¨å­¦ä¹ çš„æ ¸å¿ƒç­–ç•¥ï¼Œé€šè¿‡é€‰æ‹©æ¨¡å‹æœ€ä¸ç¡®å®šçš„æ ·æœ¬è¿›è¡Œæ ‡æ³¨ï¼š</p>
<p><strong>ä¸ç¡®å®šæ€§åº¦é‡æ–¹æ³•</strong>ï¼š</p>
<ol>
<li>
<p><strong>é¢„æµ‹ç†µï¼ˆEntropyï¼‰</strong>ï¼š
   $$H(x) = -\sum_{i=1}^{K} p(y_i|x) \log p(y_i|x)$$
å…¶ä¸­ $K$ æ˜¯ç±»åˆ«æ•°ï¼Œ$p(y_i|x)$ æ˜¯æ¨¡å‹å¯¹ç±»åˆ« $i$ çš„é¢„æµ‹æ¦‚ç‡</p>
</li>
<li>
<p><strong>æœ€å°ç½®ä¿¡åº¦ï¼ˆLeast Confidenceï¼‰</strong>ï¼š
$$LC(x) = 1 - \max_i p(y_i|x)$$</p>
</li>
<li>
<p><strong>è¾¹é™…é‡‡æ ·ï¼ˆMargin Samplingï¼‰</strong>ï¼š
$$MS(x) = p(y_1|x) - p(y_2|x)$$
å…¶ä¸­ $y_1, y_2$ æ˜¯æ¦‚ç‡æœ€é«˜çš„ä¸¤ä¸ªç±»åˆ«</p>
</li>
</ol>
<p><strong>LLM ç‰¹å®šçš„ä¸ç¡®å®šæ€§ä¼°è®¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_llm_uncertainty</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;é€šè¿‡å¤šæ¬¡é‡‡æ ·ä¼°è®¡ LLM çš„ä¸ç¡®å®šæ€§&quot;&quot;&quot;</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">log_probs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="n">response</span><span class="p">,</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
            <span class="n">prompt</span><span class="p">,</span> 
            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">return_log_probs</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">log_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span>

    <span class="c1"># è®¡ç®—å“åº”å¤šæ ·æ€§</span>
    <span class="n">unique_responses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">responses</span><span class="p">))</span>
    <span class="n">diversity_score</span> <span class="o">=</span> <span class="n">unique_responses</span> <span class="o">/</span> <span class="n">num_samples</span>

    <span class="c1"># è®¡ç®—å¹³å‡å¯¹æ•°æ¦‚ç‡æ–¹å·®</span>
    <span class="n">avg_log_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">log_probs</span><span class="p">])</span>
    <span class="n">log_prob_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">log_probs</span><span class="p">])</span>

    <span class="n">uncertainty</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;diversity&quot;</span><span class="p">:</span> <span class="n">diversity_score</span><span class="p">,</span>
        <span class="s2">&quot;avg_confidence&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">avg_log_prob</span><span class="p">),</span>
        <span class="s2">&quot;confidence_variance&quot;</span><span class="p">:</span> <span class="n">log_prob_variance</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">uncertainty</span>
</code></pre></div>

<p><strong>å®è·µæŠ€å·§</strong>ï¼š</p>
<ul>
<li><strong>æ¸©åº¦è°ƒèŠ‚</strong>ï¼šä½¿ç”¨ä¸åŒæ¸©åº¦å¤šæ¬¡é‡‡æ ·ï¼Œé«˜ä¸ç¡®å®šæ€§æ ·æœ¬çš„è¾“å‡ºå·®å¼‚æ›´å¤§</li>
<li><strong>æ³¨æ„åŠ›åˆ†æ</strong>ï¼šåˆ†ææ³¨æ„åŠ›æƒé‡çš„åˆ†æ•£ç¨‹åº¦ï¼Œè¯†åˆ«æ¨¡å‹"çŠ¹è±«"çš„ä½ç½®</li>
<li><strong>æ—©æœŸå±‚ç‰¹å¾</strong>ï¼šåˆ©ç”¨ä¸­é—´å±‚è¡¨ç¤ºçš„å˜åŒ–è¯„ä¼°ä¸ç¡®å®šæ€§</li>
</ul>
<h3 id="722">7.2.2 å¤šæ ·æ€§é€‰æ‹©</h3>
<p>ä»…é€‰æ‹©ä¸ç¡®å®šæ ·æœ¬å¯èƒ½å¯¼è‡´æ•°æ®å†—ä½™ã€‚å¤šæ ·æ€§é€‰æ‹©ç¡®ä¿è¦†ç›–ä¸åŒçš„æ•°æ®åˆ†å¸ƒï¼š</p>
<p><strong>å¤šæ ·æ€§ç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>èšç±»é‡‡æ ·</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">diversity_sampling</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># å…ˆèšç±»</span>
    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">)</span>
    <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>

    <span class="n">selected_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">samples_per_cluster</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="n">n_clusters</span>

    <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
        <span class="n">cluster_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># ä»æ¯ä¸ªç°‡ä¸­é€‰æ‹©æœ€æ¥è¿‘ä¸­å¿ƒçš„æ ·æœ¬</span>
        <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">]</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
            <span class="n">embeddings</span><span class="p">[</span><span class="n">cluster_indices</span><span class="p">]</span> <span class="o">-</span> <span class="n">cluster_center</span><span class="p">,</span> 
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">cluster_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">distances</span><span class="p">)[:</span><span class="n">samples_per_cluster</span><span class="p">]]</span>
        <span class="n">selected_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">selected_indices</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>æœ€å¤§è¾¹é™…ç›¸å…³æ€§ï¼ˆMMRï¼‰</strong>ï¼š
$$MMR = \arg\max_{d_i \in R \setminus S} [\lambda \cdot Sim_1(d_i, q) - (1-\lambda) \cdot \max_{d_j \in S} Sim_2(d_i, d_j)]$$
å¹³è¡¡ä¸æŸ¥è¯¢çš„ç›¸å…³æ€§å’Œä¸å·²é€‰æ ·æœ¬çš„å·®å¼‚æ€§</p>
</li>
<li>
<p><strong>å­æ¨¡å‡½æ•°ä¼˜åŒ–</strong>ï¼š
   åˆ©ç”¨å­æ¨¡å‡½æ•°çš„é€’å‡è¾¹é™…æ•ˆç”¨ç‰¹æ€§ï¼Œè´ªå¿ƒé€‰æ‹©æä¾›æœ€å¤§ä¿¡æ¯å¢ç›Šçš„æ ·æœ¬</p>
</li>
</ol>
<p><strong>å®ç°è€ƒè™‘</strong>ï¼š</p>
<ul>
<li><strong>åµŒå…¥ç©ºé—´é€‰æ‹©</strong>ï¼šä½¿ç”¨ä»»åŠ¡ç›¸å…³çš„åµŒå…¥ï¼ˆå¦‚æœ€åä¸€å±‚ vs ä¸­é—´å±‚ï¼‰</li>
<li><strong>å¢é‡æ›´æ–°</strong>ï¼šç»´æŠ¤å·²é€‰æ ·æœ¬çš„æ‘˜è¦ç»Ÿè®¡ï¼Œé¿å…é‡å¤è®¡ç®—</li>
<li><strong>æ‰¹é‡é€‰æ‹©</strong>ï¼šä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ ·æœ¬ï¼Œè€ƒè™‘æ ·æœ¬é—´çš„ç›¸äº’å½±å“</li>
</ul>
<h3 id="723">7.2.3 å›°éš¾æ ·æœ¬æŒ–æ˜</h3>
<p>å›°éš¾æ ·æœ¬ï¼ˆHard Examplesï¼‰æ˜¯æ¨¡å‹å®¹æ˜“å‡ºé”™çš„æ¡ˆä¾‹ï¼Œå¯¹æ”¹è¿›æ¨¡å‹æ€§èƒ½è‡³å…³é‡è¦ï¼š</p>
<p><strong>å›°éš¾æ ·æœ¬è¯†åˆ«æ–¹æ³•</strong>ï¼š</p>
<ol>
<li><strong>æŸå¤±æ’åº</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">find_hard_examples</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">95</span><span class="p">):</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_loss</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
    <span class="n">hard_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">losses</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">hard_indices</span>
</code></pre></div>

<ol start="2">
<li><strong>å¯¹æŠ—æ ·æœ¬ç”Ÿæˆ</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_adversarial_prompts</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">base_prompt</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç”Ÿæˆå¯¹æŠ—æ€§æç¤º&quot;&quot;&quot;</span>
    <span class="n">embedding</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">base_prompt</span><span class="p">)</span>
    <span class="n">embedding</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">compute_target_loss</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="c1"># å¯¹åµŒå…¥æ·»åŠ æ‰°åŠ¨</span>
    <span class="n">perturbation</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">embedding</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span>
    <span class="n">adversarial_embedding</span> <span class="o">=</span> <span class="n">embedding</span> <span class="o">+</span> <span class="n">perturbation</span>

    <span class="c1"># è§£ç å›æ–‡æœ¬ï¼ˆè¿‘ä¼¼ï¼‰</span>
    <span class="n">adversarial_prompt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">adversarial_embedding</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">adversarial_prompt</span>
</code></pre></div>

<ol start="3">
<li><strong>æ¨¡å‹åˆ†æ­§æŒ–æ˜</strong>ï¼š
   æ¯”è¾ƒä¸åŒæ¨¡å‹æˆ–åŒä¸€æ¨¡å‹ä¸åŒç‰ˆæœ¬çš„é¢„æµ‹å·®å¼‚</li>
</ol>
<p><strong>å›°éš¾æ ·æœ¬çš„ç±»å‹</strong>ï¼š</p>
<ul>
<li><strong>è¾¹ç•Œæ¡ˆä¾‹</strong>ï¼šæ¥è¿‘å†³ç­–è¾¹ç•Œçš„æ ·æœ¬</li>
<li><strong>é•¿å°¾æ ·æœ¬</strong>ï¼šç½•è§ä½†é‡è¦çš„æ¡ˆä¾‹</li>
<li><strong>ç»„åˆå¤æ‚æ€§</strong>ï¼šéœ€è¦å¤šæ­¥æ¨ç†çš„æ ·æœ¬</li>
<li><strong>é¢†åŸŸåç§»</strong>ï¼šä¸è®­ç»ƒåˆ†å¸ƒå·®å¼‚è¾ƒå¤§çš„æ ·æœ¬</li>
</ul>
<h3 id="724">7.2.4 è¯¾ç¨‹å­¦ä¹ è®¾è®¡</h3>
<p>è¯¾ç¨‹å­¦ä¹ ï¼ˆCurriculum Learningï¼‰é€šè¿‡æ§åˆ¶æ ·æœ¬çš„å­¦ä¹ é¡ºåºæ¥æé«˜è®­ç»ƒæ•ˆç‡ï¼š</p>
<p><strong>è¯¾ç¨‹è®¾è®¡ç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>éš¾åº¦é€’å¢è¯¾ç¨‹</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CurriculumScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">difficulty_scores</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">difficulty_scores</span> <span class="o">=</span> <span class="n">difficulty_scores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_difficulty</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">get_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">max_epoch</span><span class="p">):</span>
        <span class="c1"># çº¿æ€§å¢åŠ éš¾åº¦é˜ˆå€¼</span>
        <span class="n">difficulty_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">/</span> <span class="n">max_epoch</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span>

        <span class="c1"># é€‰æ‹©éš¾åº¦ä½äºé˜ˆå€¼çš„æ ·æœ¬</span>
        <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">difficulty_scores</span> <span class="o">&lt;=</span> <span class="n">difficulty_threshold</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># åŠ æƒé‡‡æ ·ï¼Œä¼˜å…ˆé€‰æ‹©æ¥è¿‘é˜ˆå€¼çš„æ ·æœ¬</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">difficulty_scores</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span> <span class="o">-</span> <span class="n">difficulty_threshold</span> <span class="o">*</span> <span class="mf">0.8</span>
        <span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">batch_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">valid_indices</span><span class="p">,</span> 
            <span class="n">size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
            <span class="n">p</span><span class="o">=</span><span class="n">weights</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">batch_indices</span><span class="p">]</span>
</code></pre></div>

<ol start="2">
<li><strong>è‡ªé€‚åº”è¯¾ç¨‹</strong>ï¼š
   æ ¹æ®æ¨¡å‹å½“å‰æ€§èƒ½åŠ¨æ€è°ƒæ•´è¯¾ç¨‹ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">adaptive_curriculum</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">performance_history</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">performance_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

        <span class="c1"># å¦‚æœæ€§èƒ½åœæ»ï¼Œå¢åŠ éš¾åº¦</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">performance_history</span><span class="p">)</span> <span class="o">==</span> <span class="n">window_size</span><span class="p">:</span>
            <span class="n">recent_improvement</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">performance_history</span><span class="p">)[:</span><span class="mi">500</span><span class="p">])</span> <span class="o">-</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">performance_history</span><span class="p">)[</span><span class="mi">500</span><span class="p">:])</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">recent_improvement</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="c1"># å¼•å…¥æ›´éš¾çš„æ ·æœ¬</span>
                <span class="n">increase_difficulty_level</span><span class="p">()</span>
</code></pre></div>

<ol start="3">
<li><strong>åè¯¾ç¨‹å­¦ä¹ </strong>ï¼š
   æŸäº›ä»»åŠ¡ä¸­ï¼Œå…ˆå­¦ä¹ å›°éš¾æ ·æœ¬å¯èƒ½æ›´æœ‰æ•ˆ</li>
</ol>
<p><strong>è¯¾ç¨‹å­¦ä¹ çš„å…³é”®è€ƒè™‘</strong>ï¼š</p>
<ul>
<li><strong>éš¾åº¦è¯„ä¼°</strong>ï¼šå‡†ç¡®è¯„ä¼°æ ·æœ¬éš¾åº¦æ˜¯å…³é”®</li>
<li><strong>è¿‡æ¸¡å¹³æ»‘</strong>ï¼šé¿å…éš¾åº¦è·³è·ƒè¿‡å¤§</li>
<li><strong>é—å¿˜é—®é¢˜</strong>ï¼šå®šæœŸå›é¡¾ç®€å•æ ·æœ¬ï¼Œé˜²æ­¢ç¾éš¾æ€§é—å¿˜</li>
</ul>
<h3 id="725">7.2.5 æ•°æ®ä»·å€¼è¯„ä¼°</h3>
<p>é‡åŒ–æ¯ä¸ªæ•°æ®ç‚¹å¯¹æ¨¡å‹æ”¹è¿›çš„è´¡çŒ®ï¼Œä¼˜åŒ–æ•°æ®æŠ•èµ„å›æŠ¥ï¼š</p>
<p><strong>æ•°æ®ä»·å€¼åº¦é‡æ–¹æ³•</strong>ï¼š</p>
<ol>
<li>
<p><strong>ç•™ä¸€æ³•å½±å“å‡½æ•°ï¼ˆLeave-One-Out Influenceï¼‰</strong>ï¼š
$$\mathcal{I}(z) = \nabla_\theta \mathcal{L}(z)^T H^{-1} \nabla_\theta \mathcal{L}(z_{test})$$
å…¶ä¸­ $H$ æ˜¯ Hessian çŸ©é˜µï¼Œ$z$ æ˜¯è®­ç»ƒæ ·æœ¬ï¼Œ$z_{test}$ æ˜¯æµ‹è¯•æ ·æœ¬</p>
</li>
<li>
<p><strong>æ•°æ® Shapley å€¼</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_data_shapley</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">test_set</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">shapley_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">):</span>
        <span class="c1"># éšæœºæ’åˆ—</span>
        <span class="n">perm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>

        <span class="n">prev_score</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_set</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">perm</span><span class="p">):</span>
            <span class="c1"># å¢é‡è®­ç»ƒ</span>
            <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">new_score</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_set</span><span class="p">)</span>

            <span class="c1"># è¾¹é™…è´¡çŒ®</span>
            <span class="n">shapley_values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">new_score</span> <span class="o">-</span> <span class="n">prev_score</span><span class="p">)</span>
            <span class="n">prev_score</span> <span class="o">=</span> <span class="n">new_score</span>

    <span class="k">return</span> <span class="n">shapley_values</span> <span class="o">/</span> <span class="n">n_iterations</span>
</code></pre></div>

<ol start="3">
<li><strong>æ¢¯åº¦ç›¸ä¼¼æ€§</strong>ï¼š
   è¡¡é‡è®­ç»ƒæ ·æœ¬æ¢¯åº¦ä¸éªŒè¯é›†æ¢¯åº¦çš„ä¸€è‡´æ€§</li>
</ol>
<p><strong>æ•°æ®ä»·å€¼çš„åº”ç”¨</strong>ï¼š</p>
<ul>
<li><strong>æ•°æ®è´­ä¹°å†³ç­–</strong>ï¼šç¡®å®šå“ªäº›æ•°æ®å€¼å¾—è´­ä¹°/æ ‡æ³¨</li>
<li><strong>æ•°æ®æ¸…ç†ä¼˜å…ˆçº§</strong>ï¼šä¼˜å…ˆæ¸…ç†é«˜ä»·å€¼æ•°æ®</li>
<li><strong>æ ·æœ¬æƒé‡è°ƒæ•´</strong>ï¼šæ ¹æ®ä»·å€¼è°ƒæ•´è®­ç»ƒæƒé‡</li>
<li><strong>æ•°æ®å½’å› </strong>ï¼šè¿½è¸ªæ¨¡å‹èƒ½åŠ›æ¥æº</li>
</ul>
<p><strong>å®è·µå»ºè®®</strong>ï¼š</p>
<ol>
<li><strong>ç»„åˆç­–ç•¥</strong>ï¼šç»“åˆä¸ç¡®å®šæ€§ã€å¤šæ ·æ€§å’Œå›°éš¾åº¦</li>
<li><strong>åŠ¨æ€è°ƒæ•´</strong>ï¼šéšè®­ç»ƒè¿›å±•è°ƒæ•´é€‰æ‹©ç­–ç•¥</li>
<li><strong>æˆæœ¬è€ƒè™‘</strong>ï¼šå¹³è¡¡æ•°æ®ä»·å€¼å’Œè·å–æˆæœ¬</li>
<li><strong>åœ¨çº¿æ›´æ–°</strong>ï¼šå®æ—¶æ›´æ–°æ•°æ®ä»·å€¼ä¼°è®¡</li>
</ol>
<h2 id="73">7.3 æ¨¡å‹åˆå¹¶ä¸é›†æˆå­¦ä¹ </h2>
<p>æ¨¡å‹åˆå¹¶å’Œé›†æˆå­¦ä¹ æŠ€æœ¯å…è®¸æˆ‘ä»¬ç»„åˆå¤šä¸ªæ¨¡å‹çš„ä¼˜åŠ¿ï¼Œåœ¨ä¸å¢åŠ æ¨ç†æˆæœ¬çš„æƒ…å†µä¸‹æå‡æ€§èƒ½ã€‚è¿™åœ¨åè®­ç»ƒä¸­ç‰¹åˆ«æœ‰ä»·å€¼ï¼Œå› ä¸ºæˆ‘ä»¬ç»å¸¸éœ€è¦æ•´åˆä¸åŒä»»åŠ¡æˆ–é¢†åŸŸçš„ä¸“é—¨åŒ–æ¨¡å‹ã€‚</p>
<h3 id="731">7.3.1 å‚æ•°ç©ºé—´åˆå¹¶æŠ€æœ¯</h3>
<p>ç›´æ¥åœ¨å‚æ•°ç©ºé—´åˆå¹¶æ¨¡å‹æ˜¯æœ€ç›´æ¥çš„æ–¹æ³•ï¼Œä½†éœ€è¦ä»”ç»†å¤„ç†ä»¥ä¿æŒæ¨¡å‹è´¨é‡ï¼š</p>
<p><strong>åŸºç¡€åˆå¹¶æ–¹æ³•</strong>ï¼š</p>
<ol>
<li>
<p><strong>çº¿æ€§æ’å€¼ï¼ˆLERPï¼‰</strong>ï¼š
$$\theta_{merged} = \alpha \cdot \theta_A + (1-\alpha) \cdot \theta_B$$
å…¶ä¸­ $\alpha \in [0,1]$ æ˜¯æ’å€¼ç³»æ•°</p>
</li>
<li>
<p><strong>çƒé¢çº¿æ€§æ’å€¼ï¼ˆSLERPï¼‰</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">slerp</span><span class="p">(</span><span class="n">theta_A</span><span class="p">,</span> <span class="n">theta_B</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;çƒé¢çº¿æ€§æ’å€¼ï¼Œä¿æŒå‚æ•°å‘é‡çš„èŒƒæ•°&quot;&quot;&quot;</span>
    <span class="c1"># å½’ä¸€åŒ–å‚æ•°å‘é‡</span>
    <span class="n">theta_A_norm</span> <span class="o">=</span> <span class="n">theta_A</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">theta_A</span><span class="p">)</span>
    <span class="n">theta_B_norm</span> <span class="o">=</span> <span class="n">theta_B</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">theta_B</span><span class="p">)</span>

    <span class="c1"># è®¡ç®—å¤¹è§’</span>
    <span class="n">dot_product</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">theta_A_norm</span><span class="p">,</span> <span class="n">theta_B_norm</span><span class="p">)</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">dot_product</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># çƒé¢æ’å€¼</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">theta_A</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">theta_B</span>

    <span class="n">sin_omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
    <span class="n">theta_merged</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">omega</span><span class="p">)</span> <span class="o">/</span> <span class="n">sin_omega</span><span class="p">)</span> <span class="o">*</span> <span class="n">theta_A</span> <span class="o">+</span> \
                  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">omega</span><span class="p">)</span> <span class="o">/</span> <span class="n">sin_omega</span><span class="p">)</span> <span class="o">*</span> <span class="n">theta_B</span>

    <span class="k">return</span> <span class="n">theta_merged</span>
</code></pre></div>

<ol start="3">
<li>
<p><strong>åŠ æƒå¹³å‡</strong>ï¼š
$$\theta_{merged} = \frac{\sum_{i=1}^{N} w_i \cdot \theta_i}{\sum_{i=1}^{N} w_i}$$
<strong>é«˜çº§åˆå¹¶æŠ€æœ¯</strong>ï¼š</p>
</li>
<li>
<p><strong>Fisher åŠ æƒåˆå¹¶</strong>ï¼š
   ä½¿ç”¨ Fisher ä¿¡æ¯çŸ©é˜µä½œä¸ºé‡è¦æ€§æƒé‡ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">fisher_weighted_merge</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åŸºäº Fisher ä¿¡æ¯çš„å‚æ•°åˆå¹¶&quot;&quot;&quot;</span>
    <span class="n">fisher_matrices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="c1"># è®¡ç®— Fisher ä¿¡æ¯çŸ©é˜µï¼ˆå¯¹è§’è¿‘ä¼¼ï¼‰</span>
        <span class="n">fisher</span> <span class="o">=</span> <span class="n">compute_fisher_diagonal</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
        <span class="n">fisher_matrices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fisher</span><span class="p">)</span>

    <span class="c1"># å½’ä¸€åŒ– Fisher æƒé‡</span>
    <span class="n">total_fisher</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fisher_matrices</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="o">/</span> <span class="n">total_fisher</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fisher_matrices</span><span class="p">]</span>

    <span class="c1"># åŠ æƒåˆå¹¶</span>
    <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">state_dict</span><span class="p">():</span>
        <span class="n">merged_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">w</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()[</span><span class="n">param_name</span><span class="p">]</span> 
            <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">models</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">merged_params</span>
</code></pre></div>

<ol start="2">
<li><strong>RegMeanï¼ˆæ­£åˆ™åŒ–å‡å€¼ï¼‰</strong>ï¼š
   é€šè¿‡æ·»åŠ æ­£åˆ™åŒ–é¡¹é˜²æ­¢åˆå¹¶åçš„å‚æ•°åç¦»è¿‡è¿œï¼š
$$\theta_{merged} = \arg\min_\theta \sum_{i=1}^{N} |\theta - \theta_i|^2 + \lambda R(\theta)$$</li>
</ol>
<h3 id="732">7.3.2 ä»»åŠ¡å‘é‡ä¸æ¨¡å‹ç®—æœ¯</h3>
<p>ä»»åŠ¡å‘é‡ï¼ˆTask Vectorsï¼‰å°†æ¨¡å‹èƒ½åŠ›è¡¨ç¤ºä¸ºå‚æ•°ç©ºé—´ä¸­çš„å‘é‡ï¼Œå®ç°æ¨¡å‹èƒ½åŠ›çš„ç®—æœ¯è¿ç®—ï¼š</p>
<p><strong>ä»»åŠ¡å‘é‡å®šä¹‰</strong>ï¼š
$$\tau = \theta_{finetuned} - \theta_{pretrained}$$</p>
<p><strong>æ¨¡å‹ç®—æœ¯è¿ç®—</strong>ï¼š</p>
<ol>
<li><strong>èƒ½åŠ›æ·»åŠ </strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">add_capabilities</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">task_vectors</span><span class="p">,</span> <span class="n">scaling_factors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å‘åŸºç¡€æ¨¡å‹æ·»åŠ å¤šä¸ªä»»åŠ¡èƒ½åŠ›&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">scaling_factors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scaling_factors</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">task_vectors</span><span class="p">)</span>

    <span class="n">merged_params</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">merged_params</span><span class="p">:</span>
        <span class="c1"># ç´¯åŠ ä»»åŠ¡å‘é‡</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">scale</span> <span class="o">*</span> <span class="n">tv</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> 
            <span class="k">for</span> <span class="n">scale</span><span class="p">,</span> <span class="n">tv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">scaling_factors</span><span class="p">,</span> <span class="n">task_vectors</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">merged_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span>

    <span class="k">return</span> <span class="n">merged_params</span>
</code></pre></div>

<ol start="2">
<li><strong>èƒ½åŠ›åˆ é™¤</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">remove_capability</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">task_vector</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä»æ¨¡å‹ä¸­ç§»é™¤ç‰¹å®šèƒ½åŠ›&quot;&quot;&quot;</span>
    <span class="n">updated_params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">updated_params</span><span class="p">:</span>
        <span class="n">updated_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">-=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">task_vector</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">updated_params</span>
</code></pre></div>

<ol start="3">
<li><strong>èƒ½åŠ›ç»„åˆçš„å†²çªæ£€æµ‹</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">detect_task_conflicts</span><span class="p">(</span><span class="n">task_vectors</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ£€æµ‹ä»»åŠ¡å‘é‡ä¹‹é—´çš„å†²çª&quot;&quot;&quot;</span>
    <span class="n">conflicts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tv1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_vectors</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">tv2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_vectors</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:],</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦</span>
            <span class="n">similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span>
                <span class="n">flatten</span><span class="p">(</span><span class="n">tv1</span><span class="p">),</span> <span class="n">flatten</span><span class="p">(</span><span class="n">tv2</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># è´Ÿç›¸å…³è¡¨ç¤ºæ½œåœ¨å†²çª</span>
            <span class="k">if</span> <span class="n">similarity</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">:</span>
                <span class="n">conflicts</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">similarity</span>

    <span class="k">return</span> <span class="n">conflicts</span>
</code></pre></div>

<p><strong>å®è·µè€ƒè™‘</strong>ï¼š</p>
<ul>
<li><strong>ç¼©æ”¾å› å­ä¼˜åŒ–</strong>ï¼šé€šè¿‡éªŒè¯é›†æœç´¢æœ€ä¼˜ç¼©æ”¾ç³»æ•°</li>
<li><strong>æ­£äº¤åŒ–</strong>ï¼šç¡®ä¿ä»»åŠ¡å‘é‡ç›¸äº’æ­£äº¤ï¼Œå‡å°‘å¹²æ‰°</li>
<li><strong>ç¨€ç–åŒ–</strong>ï¼šåªä¿ç•™é‡è¦çš„å‚æ•°å˜åŒ–</li>
</ul>
<h3 id="733">7.3.3 å±‚çº§åˆå¹¶ç­–ç•¥</h3>
<p>ä¸åŒå±‚å¯èƒ½éœ€è¦ä¸åŒçš„åˆå¹¶ç­–ç•¥ï¼ŒåŸºäºå±‚çš„åŠŸèƒ½å’Œé‡è¦æ€§ï¼š</p>
<p><strong>å±‚çº§é‡è¦æ€§åˆ†æ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_layer_importance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">layer_names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è®¡ç®—å„å±‚å¯¹ä»»åŠ¡çš„é‡è¦æ€§&quot;&quot;&quot;</span>
    <span class="n">importances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">layer_names</span><span class="p">:</span>
        <span class="c1"># ä¸´æ—¶ç§»é™¤å±‚</span>
        <span class="n">original_layer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">())</span>

        <span class="c1"># è¯„ä¼°æ€§èƒ½ä¸‹é™</span>
        <span class="n">degraded_performance</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># æ¢å¤å±‚</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">original_layer</span><span class="p">)</span>
        <span class="n">baseline_performance</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>

        <span class="n">importance</span> <span class="o">=</span> <span class="n">baseline_performance</span> <span class="o">-</span> <span class="n">degraded_performance</span>
        <span class="n">importances</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">importance</span>

    <span class="k">return</span> <span class="n">importances</span>
</code></pre></div>

<p><strong>åˆ†å±‚åˆå¹¶ç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>åº•å±‚å…±äº«ï¼Œé«˜å±‚ç‰¹åŒ–</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">hierarchical_merge</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">split_layer</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä½å±‚å‚æ•°å¹³å‡ï¼Œé«˜å±‚ä¿æŒç‰¹åŒ–&quot;&quot;&quot;</span>
    <span class="n">merged_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">layer_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_model</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">layer_idx</span> <span class="o">&lt;</span> <span class="n">split_layer</span><span class="p">:</span>
            <span class="c1"># ä½å±‚ï¼šå¹³å‡åˆå¹¶</span>
            <span class="n">merged_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">average_layers</span><span class="p">(</span>
                <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># é«˜å±‚ï¼šé€‰æ‹©æœ€ä½³æˆ–ä¿æŒç‹¬ç«‹</span>
            <span class="n">best_model_idx</span> <span class="o">=</span> <span class="n">select_best_for_layer</span><span class="p">(</span>
                <span class="n">models</span><span class="p">,</span> <span class="n">layer_idx</span>
            <span class="p">)</span>
            <span class="n">merged_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">models</span><span class="p">[</span><span class="n">best_model_idx</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">merged_model</span>
</code></pre></div>

<ol start="2">
<li><strong>æ³¨æ„åŠ›å¤´é€‰æ‹©æ€§åˆå¹¶</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">merge_attention_heads</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">importance_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ ¹æ®é‡è¦æ€§é€‰æ‹©æ€§åˆå¹¶æ³¨æ„åŠ›å¤´&quot;&quot;&quot;</span>
    <span class="n">merged_attention</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">n_heads</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n_heads</span>
    <span class="k">for</span> <span class="n">head_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_heads</span><span class="p">):</span>
        <span class="n">head_candidates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">m</span><span class="o">.</span><span class="n">attention</span><span class="o">.</span><span class="n">heads</span><span class="p">[</span><span class="n">head_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span>
        <span class="p">]</span>

        <span class="c1"># è¯„ä¼°æ¯ä¸ªå¤´çš„é‡è¦æ€§</span>
        <span class="n">importances</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">evaluate_head_importance</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">head_candidates</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">importances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">importance_threshold</span><span class="p">:</span>
            <span class="c1"># é€‰æ‹©æœ€é‡è¦çš„å¤´</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">importances</span><span class="p">)</span>
            <span class="n">merged_attention</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head_candidates</span><span class="p">[</span><span class="n">best_idx</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ä½é‡è¦æ€§å¤´å¯ä»¥å¹³å‡</span>
            <span class="n">merged_attention</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">average_heads</span><span class="p">(</span><span class="n">head_candidates</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">merged_attention</span>
</code></pre></div>

<h3 id="734">7.3.4 é›†æˆå­¦ä¹ æ–¹æ³•</h3>
<p>å½“æ— æ³•ç›´æ¥åˆå¹¶å‚æ•°æ—¶ï¼Œé›†æˆå¤šä¸ªæ¨¡å‹çš„é¢„æµ‹ï¼š</p>
<p><strong>é›†æˆç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>åŠ æƒæŠ•ç¥¨</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">WeightedEnsemble</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">):</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="n">pred</span><span class="p">)</span>

        <span class="c1"># åŠ æƒå¹³å‡</span>
        <span class="n">ensemble_pred</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

        <span class="c1"># å¯¹äºåˆ†ç±»ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦é‡æ–°å½’ä¸€åŒ–</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="n">ensemble_pred</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">ensemble_pred</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ensemble_pred</span>
</code></pre></div>

<ol start="2">
<li><strong>æ··åˆä¸“å®¶ï¼ˆMoEï¼‰é£æ ¼</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MixtureOfExperts</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experts</span><span class="p">,</span> <span class="n">gating_network</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experts</span> <span class="o">=</span> <span class="n">experts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gating</span> <span class="o">=</span> <span class="n">gating_network</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># è®¡ç®—é—¨æ§æƒé‡</span>
        <span class="n">gate_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gating</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># [batch_size, n_experts]</span>

        <span class="c1"># è·å–æ¯ä¸ªä¸“å®¶çš„è¾“å‡º</span>
        <span class="n">expert_outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
            <span class="n">expert</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">expert</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experts</span>
        <span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [batch_size, n_experts, output_dim]</span>

        <span class="c1"># åŠ æƒç»„åˆ</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">gate_weights</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">expert_outputs</span><span class="p">,</span> 
            <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<ol start="3">
<li><strong>çº§è”é›†æˆ</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">cascade_ensemble</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">confidence_threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æŒ‰ç½®ä¿¡åº¦çº§è”ä½¿ç”¨æ¨¡å‹&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
        <span class="n">prediction</span><span class="p">,</span> <span class="n">confidence</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_with_confidence</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="n">confidence_threshold</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prediction</span>

    <span class="c1"># å¦‚æœæ‰€æœ‰æ¨¡å‹ç½®ä¿¡åº¦éƒ½ä½ï¼Œå¯ä»¥ç»„åˆé¢„æµ‹</span>
    <span class="k">return</span> <span class="n">weighted_ensemble</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
</code></pre></div>

<h3 id="735">7.3.5 åˆå¹¶å†²çªè§£å†³</h3>
<p>å¤„ç†æ¨¡å‹åˆå¹¶ä¸­çš„å†²çªæ˜¯ç¡®ä¿è´¨é‡çš„å…³é”®ï¼š</p>
<p><strong>å†²çªç±»å‹ä¸è§£å†³ç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>å‚æ•°ç¬¦å·å†²çª</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">resolve_sign_conflicts</span><span class="p">(</span><span class="n">param_A</span><span class="p">,</span> <span class="n">param_B</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;magnitude&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è§£å†³å‚æ•°ç¬¦å·ç›¸åçš„å†²çª&quot;&quot;&quot;</span>
    <span class="n">sign_conflict</span> <span class="o">=</span> <span class="p">(</span><span class="n">param_A</span> <span class="o">*</span> <span class="n">param_B</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;magnitude&#39;</span><span class="p">:</span>
        <span class="c1"># é€‰æ‹©ç»å¯¹å€¼è¾ƒå¤§çš„</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">param_A</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">param_B</span><span class="p">),</span>
            <span class="n">param_A</span><span class="p">,</span> <span class="n">param_B</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;zero&#39;</span><span class="p">:</span>
        <span class="c1"># å†²çªä½ç½®ç½®é›¶</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sign_conflict</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">param_A</span> <span class="o">+</span> <span class="n">param_B</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;interpolate&#39;</span><span class="p">:</span>
        <span class="c1"># æ ¹æ®é‡è¦æ€§æ’å€¼</span>
        <span class="n">importance_A</span> <span class="o">=</span> <span class="n">compute_param_importance</span><span class="p">(</span><span class="n">param_A</span><span class="p">)</span>
        <span class="n">importance_B</span> <span class="o">=</span> <span class="n">compute_param_importance</span><span class="p">(</span><span class="n">param_B</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">importance_A</span> <span class="o">/</span> <span class="p">(</span><span class="n">importance_A</span> <span class="o">+</span> <span class="n">importance_B</span><span class="p">)</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">param_A</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">param_B</span>

    <span class="k">return</span> <span class="n">merged</span>
</code></pre></div>

<ol start="2">
<li><strong>æ¢¯åº¦å†²çªæ£€æµ‹ä¸ç¼“è§£</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">gradient_surgery</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ¢¯åº¦æ‰‹æœ¯ï¼šæŠ•å½±å†²çªæ¢¯åº¦åˆ°æ­£äº¤ç©ºé—´&quot;&quot;&quot;</span>
    <span class="n">modified_grads</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gradients</span><span class="p">):</span>
        <span class="n">g_modified</span> <span class="o">=</span> <span class="n">g_i</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">g_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gradients</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
                <span class="c1"># è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦</span>
                <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cosine_similarity</span><span class="p">(</span><span class="n">g_i</span><span class="p">,</span> <span class="n">g_j</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cos_sim</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>  <span class="c1"># è´Ÿç›¸å…³ï¼Œå­˜åœ¨å†²çª</span>
                    <span class="c1"># æŠ•å½±åˆ°æ­£äº¤ç©ºé—´</span>
                    <span class="n">projection</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_i</span> <span class="o">@</span> <span class="n">g_j</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">g_j</span> <span class="o">@</span> <span class="n">g_j</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span> <span class="o">*</span> <span class="n">g_j</span>
                    <span class="n">g_modified</span> <span class="o">=</span> <span class="n">g_modified</span> <span class="o">-</span> <span class="n">projection</span>

        <span class="n">modified_grads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g_modified</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">modified_grads</span>
</code></pre></div>

<p><strong>åˆå¹¶è´¨é‡éªŒè¯</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_merge_quality</span><span class="p">(</span><span class="n">original_models</span><span class="p">,</span> <span class="n">merged_model</span><span class="p">,</span> <span class="n">test_sets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;éªŒè¯åˆå¹¶åæ¨¡å‹çš„è´¨é‡&quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;performance_retention&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;capability_preservation&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;emergence_score&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">test_set</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">original_models</span><span class="p">,</span> <span class="n">test_sets</span><span class="p">):</span>
        <span class="c1"># æ€§èƒ½ä¿æŒç‡</span>
        <span class="n">original_score</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">test_set</span><span class="p">)</span>
        <span class="n">merged_score</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">merged_model</span><span class="p">,</span> <span class="n">test_set</span><span class="p">)</span>
        <span class="n">retention</span> <span class="o">=</span> <span class="n">merged_score</span> <span class="o">/</span> <span class="n">original_score</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;performance_retention&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">retention</span><span class="p">)</span>

        <span class="c1"># èƒ½åŠ›ä¿ç•™æ£€æŸ¥</span>
        <span class="n">capability_tests</span> <span class="o">=</span> <span class="n">generate_capability_tests</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="n">preservation</span> <span class="o">=</span> <span class="n">evaluate_capabilities</span><span class="p">(</span><span class="n">merged_model</span><span class="p">,</span> <span class="n">capability_tests</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;capability_preservation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preservation</span><span class="p">)</span>

    <span class="c1"># æ¶Œç°èƒ½åŠ›ï¼ˆåˆå¹¶åå‡ºç°çš„æ–°èƒ½åŠ›ï¼‰</span>
    <span class="n">combined_test</span> <span class="o">=</span> <span class="n">combine_test_sets</span><span class="p">(</span><span class="n">test_sets</span><span class="p">)</span>
    <span class="n">emergence</span> <span class="o">=</span> <span class="n">evaluate_emergence</span><span class="p">(</span><span class="n">merged_model</span><span class="p">,</span> <span class="n">combined_test</span><span class="p">,</span> <span class="n">original_models</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;emergence_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">emergence</span>

    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div>

<h2 id="74">7.4 è¶…å‚æ•°æœç´¢çš„å®ç”¨æŠ€å·§</h2>
<p>è¶…å‚æ•°ä¼˜åŒ–æ˜¯åè®­ç»ƒæˆåŠŸçš„å…³é”®å› ç´ ä¹‹ä¸€ã€‚ä¸é¢„è®­ç»ƒç›¸æ¯”ï¼Œåè®­ç»ƒçš„è¶…å‚æ•°ç©ºé—´æ›´å¤æ‚ï¼Œéœ€è¦æ›´ç²¾ç»†çš„æœç´¢ç­–ç•¥ã€‚</p>
<h3 id="741">7.4.1 æœç´¢ç©ºé—´è®¾è®¡</h3>
<p>åˆç†çš„æœç´¢ç©ºé—´è®¾è®¡å¯ä»¥å¤§å¹…æé«˜æœç´¢æ•ˆç‡ï¼š</p>
<p><strong>å…³é”®è¶…å‚æ•°åŠå…¶èŒƒå›´</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">hyperparameter_space</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># å­¦ä¹ ç‡ç›¸å…³</span>
    <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;log_uniform&quot;</span><span class="p">,</span>
        <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;å³°å€¼å­¦ä¹ ç‡&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;warmup_ratio&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
        <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;é¢„çƒ­æ­¥æ•°æ¯”ä¾‹&quot;</span>
    <span class="p">},</span>

    <span class="c1"># è®­ç»ƒé…ç½®</span>
    <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;choice&quot;</span><span class="p">,</span>
        <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;æœ‰æ•ˆæ‰¹æ¬¡å¤§å°&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;gradient_accumulation_steps&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;choice&quot;</span><span class="p">,</span>
        <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;æ¢¯åº¦ç´¯ç§¯æ­¥æ•°&quot;</span>
    <span class="p">},</span>

    <span class="c1"># æ­£åˆ™åŒ–</span>
    <span class="s2">&quot;weight_decay&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;log_uniform&quot;</span><span class="p">,</span>
        <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="mf">1e-4</span><span class="p">,</span>
        <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="mf">1e-1</span>
    <span class="p">},</span>
    <span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
        <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="mf">0.3</span>
    <span class="p">},</span>

    <span class="c1"># RLHF ç‰¹å®šå‚æ•°</span>
    <span class="s2">&quot;kl_coefficient&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;log_uniform&quot;</span><span class="p">,</span>
        <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
        <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;KL æ•£åº¦æƒ©ç½šç³»æ•°&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;clip_range&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
        <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;PPO è£å‰ªèŒƒå›´&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>æ¡ä»¶ä¾èµ–å…³ç³»</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">conditional_hyperparameters</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¤„ç†è¶…å‚æ•°é—´çš„æ¡ä»¶ä¾èµ–&quot;&quot;&quot;</span>
    <span class="c1"># å¦‚æœä½¿ç”¨ LoRAï¼Œæ·»åŠ ç›¸å…³å‚æ•°</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_lora&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lora_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_from</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lora_alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lora_rank&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;lora_dropout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_from</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># å­¦ä¹ ç‡ä¸æ‰¹æ¬¡å¤§å°çš„å…³ç³»</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span>

    <span class="c1"># æ¢¯åº¦ç´¯ç§¯ä¸å®é™…æ‰¹æ¬¡å¤§å°</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;effective_batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;gradient_accumulation_steps&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">config</span>
</code></pre></div>

<p><strong>æœç´¢ç©ºé—´çº¦ç®€æŠ€å·§</strong>ï¼š</p>
<ol>
<li><strong>åˆ†é˜¶æ®µæœç´¢</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">staged_search</span><span class="p">():</span>
    <span class="c1"># ç¬¬ä¸€é˜¶æ®µï¼šç²—ç²’åº¦æœç´¢</span>
    <span class="n">stage1_space</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">],</span>
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">best_config_stage1</span> <span class="o">=</span> <span class="n">grid_search</span><span class="p">(</span><span class="n">stage1_space</span><span class="p">)</span>

    <span class="c1"># ç¬¬äºŒé˜¶æ®µï¼šç»†ç²’åº¦æœç´¢</span>
    <span class="n">stage2_space</span> <span class="o">=</span> <span class="n">create_refined_space</span><span class="p">(</span><span class="n">best_config_stage1</span><span class="p">)</span>
    <span class="n">best_config</span> <span class="o">=</span> <span class="n">bayesian_optimization</span><span class="p">(</span><span class="n">stage2_space</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">best_config</span>
</code></pre></div>

<ol start="2">
<li><strong>é‡è¦æ€§é‡‡æ ·</strong>ï¼š
   åŸºäºå‚æ•°é‡è¦æ€§åˆ†é…æœç´¢é¢„ç®—</li>
</ol>
<h3 id="742">7.4.2 è´å¶æ–¯ä¼˜åŒ–</h3>
<p>è´å¶æ–¯ä¼˜åŒ–é€šè¿‡å»ºç«‹ä»£ç†æ¨¡å‹é«˜æ•ˆæ¢ç´¢è¶…å‚æ•°ç©ºé—´ï¼š</p>
<p><strong>é«˜æ–¯è¿‡ç¨‹å®ç°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">BayesianOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">acquisition_func</span><span class="o">=</span><span class="s2">&quot;ei&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_func</span> <span class="o">=</span> <span class="n">acquisition_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">suggest_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># åˆå§‹éšæœºæ¢ç´¢</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span>

        <span class="c1"># è®­ç»ƒé«˜æ–¯è¿‡ç¨‹</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># ä¼˜åŒ–è·å–å‡½æ•°</span>
        <span class="n">next_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_acquisition</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">next_point</span>

    <span class="k">def</span> <span class="nf">optimize_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¼˜åŒ–è·å–å‡½æ•°æ‰¾åˆ°ä¸‹ä¸€ä¸ªé‡‡æ ·ç‚¹&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_func</span> <span class="o">==</span> <span class="s2">&quot;ei&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_improvement</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_func</span> <span class="o">==</span> <span class="s2">&quot;ucb&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_confidence_bound</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_func</span> <span class="o">==</span> <span class="s2">&quot;pi&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">probability_improvement</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">expected_improvement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æœŸæœ›æ”¹è¿›è·å–å‡½æ•°&quot;&quot;&quot;</span>
        <span class="n">best_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">ei</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean</span> <span class="o">-</span> <span class="n">best_y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>
            <span class="n">ei_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean</span> <span class="o">-</span> <span class="n">best_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">std</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">ei_value</span>  <span class="c1"># è´Ÿå€¼ç”¨äºæœ€å°åŒ–</span>

        <span class="c1"># å¤šèµ·ç‚¹ä¼˜åŒ–</span>
        <span class="n">best_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_ei</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
            <span class="k">if</span> <span class="o">-</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span> <span class="o">&gt;</span> <span class="n">best_ei</span><span class="p">:</span>
                <span class="n">best_ei</span> <span class="o">=</span> <span class="o">-</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span>
                <span class="n">best_x</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>

        <span class="k">return</span> <span class="n">best_x</span>
</code></pre></div>

<p><strong>å¤šä¿çœŸåº¦ä¼˜åŒ–ï¼ˆMulti-fidelityï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">successive_halving</span><span class="p">(</span><span class="n">configs</span><span class="p">,</span> <span class="n">budget</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Successive Halving ç®—æ³•&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">budget</span> <span class="o">/</span> <span class="n">n</span>  <span class="c1"># åˆå§‹èµ„æºåˆ†é…</span>

    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># è®­ç»ƒæ‰€æœ‰é…ç½® r ä¸ª epoch</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">train_and_evaluate</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="c1"># ä¿ç•™å‰ 1/eta</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">//</span> <span class="n">eta</span><span class="p">)</span>
        <span class="n">top_k_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)[</span><span class="o">-</span><span class="n">k</span><span class="p">:]</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">configs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_k_indices</span><span class="p">]</span>

        <span class="c1"># å¢åŠ èµ„æº</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">eta</span>

    <span class="k">return</span> <span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<h3 id="743">7.4.3 ç¾¤ä½“è®­ç»ƒç­–ç•¥</h3>
<p>åŒæ—¶è®­ç»ƒå¤šä¸ªæ¨¡å‹å˜ä½“ï¼Œåˆ©ç”¨ç¾¤ä½“æ™ºæ…§ï¼š</p>
<p><strong>Population Based Training (PBT)</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PopulationBasedTraining</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population_size</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population_size</span> <span class="o">=</span> <span class="n">population_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_population</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">initialize_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆå§‹åŒ–ç§ç¾¤&quot;&quot;&quot;</span>
        <span class="n">population</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">):</span>
            <span class="n">member</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_hyperparameters</span><span class="p">(),</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
            <span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">population</span>

    <span class="k">def</span> <span class="nf">evolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¿›åŒ–è¿‡ç¨‹&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="c1"># å¹¶è¡Œè®­ç»ƒä¸€æ®µæ—¶é—´</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_population</span><span class="p">(</span><span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

            <span class="c1"># è¯„ä¼°æ€§èƒ½</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_population</span><span class="p">()</span>

            <span class="c1"># æ‰§è¡Œè¿›åŒ–æ“ä½œ</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exploit_and_explore</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">exploit_and_explore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ©ç”¨å’Œæ¢ç´¢&quot;&quot;&quot;</span>
        <span class="c1"># æ’åºç§ç¾¤</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># åº•éƒ¨ 25% è¢«é¡¶éƒ¨ 25% æ›¿æ¢</span>
        <span class="n">bottom_quartile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">population_size</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="n">top_quartile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">population_size</span> <span class="o">//</span> <span class="mi">4</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bottom_quartile</span><span class="p">):</span>
            <span class="c1"># å¤åˆ¶é«˜æ€§èƒ½æˆå‘˜</span>
            <span class="n">source_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">top_quartile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_member</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="n">source_idx</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># æ‰°åŠ¨è¶…å‚æ•°ï¼ˆæ¢ç´¢ï¼‰</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perturb_hyperparameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">perturb_hyperparameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">member</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ‰°åŠ¨è¶…å‚æ•°è¿›è¡Œæ¢ç´¢&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">member</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>  <span class="c1"># 20% æ¦‚ç‡æ‰°åŠ¨</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="c1"># ä¹˜æ€§æ‰°åŠ¨</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">])</span>
                    <span class="n">config</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">factor</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="c1"># åŠ æ€§æ‰°åŠ¨</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">config</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
</code></pre></div>

<h3 id="744">7.4.4 æ—©åœä¸é¢„ç®—åˆ†é…</h3>
<p>æ™ºèƒ½åˆ†é…è®¡ç®—èµ„æºï¼Œé¿å…åœ¨å·®é…ç½®ä¸Šæµªè´¹æ—¶é—´ï¼š</p>
<p><strong>è‡ªé€‚åº”æ—©åœç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AdaptiveEarlyStopping</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_delta</span> <span class="o">=</span> <span class="n">min_delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_score</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="c1"># ç›¸å¯¹æ”¹è¿›</span>
        <span class="n">relative_improvement</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">current_score</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">relative_improvement</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_delta</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">current_score</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># åŠ¨æ€è°ƒæ•´ patience</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">adjusted_patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># æ—©æœŸæ›´å®½å®¹</span>
        <span class="k">elif</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">adjusted_patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># åæœŸæ›´ä¸¥æ ¼</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adjusted_patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="n">adjusted_patience</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span>
</code></pre></div>

<p><strong>é¢„ç®—åˆ†é…ç®—æ³•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">hyperband</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">81</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hyperband ç®—æ³•&quot;&quot;&quot;</span>
    <span class="n">logeta</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span>
    <span class="n">s_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">logeta</span><span class="p">(</span><span class="n">max_iter</span><span class="p">))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_iter</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">s_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">B</span> <span class="o">/</span> <span class="n">max_iter</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">**</span> <span class="n">s</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># Successive halving</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_configuration</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">n_configs</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>
            <span class="n">n_iterations</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">**</span> <span class="n">i</span>

            <span class="c1"># è®­ç»ƒå’Œè¯„ä¼°</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">n_configs</span><span class="p">)]:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">train_and_evaluate</span><span class="p">(</span>
                    <span class="n">config</span><span class="p">,</span> 
                    <span class="n">iterations</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">score</span><span class="p">,</span> <span class="n">config</span><span class="p">))</span>

            <span class="c1"># é€‰æ‹©æœ€ä½³é…ç½®ç»§ç»­</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">n_configs</span> <span class="o">/</span> <span class="n">eta</span><span class="p">)]]</span>

        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scores</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># ä¿å­˜æœ€ä½³ç»“æœ</span>

    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>

<h3 id="745">7.4.5 è¶…å‚æ•°è¿ç§»å­¦ä¹ </h3>
<p>åˆ©ç”¨å†å²ä»»åŠ¡çš„è¶…å‚æ•°çŸ¥è¯†åŠ é€Ÿæ–°ä»»åŠ¡çš„æœç´¢ï¼š</p>
<p><strong>å…ƒå­¦ä¹ è¶…å‚æ•°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HyperparameterMetaLearner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_embeddings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameter_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_meta_model</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build_meta_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ„å»ºå…ƒå­¦ä¹ æ¨¡å‹&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">learn_from_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_features</span><span class="p">,</span> <span class="n">best_hyperparams</span><span class="p">,</span> <span class="n">performance</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä»ä»»åŠ¡ä¸­å­¦ä¹ &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameter_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;task_features&quot;</span><span class="p">:</span> <span class="n">task_features</span><span class="p">,</span>
            <span class="s2">&quot;hyperparams&quot;</span><span class="p">:</span> <span class="n">best_hyperparams</span><span class="p">,</span>
            <span class="s2">&quot;performance&quot;</span><span class="p">:</span> <span class="n">performance</span>
        <span class="p">})</span>

        <span class="c1"># æ›´æ–°å…ƒæ¨¡å‹</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameter_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;task_features&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;hyperparams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> 
                 <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameter_history</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;performance&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameter_history</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">suggest_initial_hyperparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_task_features</span><span class="p">,</span> <span class="n">n_suggestions</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¸ºæ–°ä»»åŠ¡å»ºè®®åˆå§‹è¶…å‚æ•°&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparameter_history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="c1"># å†å²æ•°æ®ä¸è¶³ï¼Œè¿”å›éšæœºé…ç½®</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">sample_random_config</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_suggestions</span><span class="p">)]</span>

        <span class="c1"># æ‰¾åˆ°ç›¸ä¼¼ä»»åŠ¡</span>
        <span class="n">similar_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_similar_tasks</span><span class="p">(</span><span class="n">new_task_features</span><span class="p">)</span>

        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">similar_tasks</span><span class="p">[:</span><span class="n">n_suggestions</span><span class="p">]:</span>
            <span class="c1"># åŸºäºç›¸ä¼¼ä»»åŠ¡çš„è¶…å‚æ•°ï¼Œæ·»åŠ å°æ‰°åŠ¨</span>
            <span class="n">base_config</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;hyperparams&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">perturbed_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perturb_config</span><span class="p">(</span><span class="n">base_config</span><span class="p">)</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perturbed_config</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">suggestions</span>

    <span class="k">def</span> <span class="nf">find_similar_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_features</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ‰¾åˆ°æœ€ç›¸ä¼¼çš„å†å²ä»»åŠ¡&quot;&quot;&quot;</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameter_history</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">task_features</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s2">&quot;task_features&quot;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dist</span><span class="p">,</span> <span class="n">hist</span><span class="p">))</span>

        <span class="n">distances</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">hist</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">[:</span><span class="n">k</span><span class="p">]]</span>
</code></pre></div>

<h2 id="75">7.5 åˆ†å¸ƒå¼è®­ç»ƒçš„å·¥ç¨‹ä¼˜åŒ–</h2>
<p>å¤§è§„æ¨¡ LLM åè®­ç»ƒå¿…é¡»ä¾èµ–åˆ†å¸ƒå¼ç³»ç»Ÿã€‚åˆç†çš„åˆ†å¸ƒå¼ç­–ç•¥å’Œå·¥ç¨‹ä¼˜åŒ–å¯ä»¥æ˜¾è‘—æå‡è®­ç»ƒæ•ˆç‡å’Œç¨³å®šæ€§ã€‚</p>
<h3 id="751">7.5.1 å¹¶è¡Œç­–ç•¥é€‰æ‹©</h3>
<p>æ ¹æ®æ¨¡å‹è§„æ¨¡å’Œç¡¬ä»¶èµ„æºé€‰æ‹©åˆé€‚çš„å¹¶è¡Œç­–ç•¥ï¼š</p>
<p><strong>å¹¶è¡Œç­–ç•¥å¯¹æ¯”</strong>ï¼š</p>
<p>| ç­–ç•¥ | é€šä¿¡å¼€é”€ | å†…å­˜æ•ˆç‡ | é€‚ç”¨åœºæ™¯ |</p>
<table>
<thead>
<tr>
<th>ç­–ç•¥</th>
<th>é€šä¿¡å¼€é”€</th>
<th>å†…å­˜æ•ˆç‡</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•°æ®å¹¶è¡Œ(DP)</td>
<td>O(æ¨¡å‹å¤§å°)</td>
<td>ä½</td>
<td>å°æ¨¡å‹ï¼Œå¤§æ‰¹æ¬¡</td>
</tr>
<tr>
<td>å¼ é‡å¹¶è¡Œ(TP)</td>
<td>O(æ¿€æ´»å¤§å°)</td>
<td>é«˜</td>
<td>å•å±‚å‚æ•°è¶…è¿‡GPUå†…å­˜</td>
</tr>
<tr>
<td>æµæ°´çº¿å¹¶è¡Œ(PP)</td>
<td>O(æ‰¹æ¬¡å¤§å°)</td>
<td>ä¸­</td>
<td>æ·±å±‚ç½‘ç»œ</td>
</tr>
<tr>
<td>3Då¹¶è¡Œ</td>
<td>æ··åˆ</td>
<td>æœ€é«˜</td>
<td>è¶…å¤§è§„æ¨¡æ¨¡å‹</td>
</tr>
</tbody>
</table>
<p><strong>æ··åˆå¹¶è¡Œç­–ç•¥å®ç°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HybridParallelConfig</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">model_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_size</span> <span class="o">=</span> <span class="n">world_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_strategy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">determine_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ ¹æ®æ¨¡å‹å’Œç¡¬ä»¶è‡ªåŠ¨ç¡®å®šå¹¶è¡Œç­–ç•¥&quot;&quot;&quot;</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">num_parameters</span>
        <span class="n">gpu_memory</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">total_memory</span>

        <span class="c1"># ä¼°ç®—å•GPUèƒ½å¦å®¹çº³æ¨¡å‹</span>
        <span class="n">bytes_per_param</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># FP32</span>
        <span class="n">model_memory</span> <span class="o">=</span> <span class="n">model_params</span> <span class="o">*</span> <span class="n">bytes_per_param</span>
        <span class="n">activation_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_activation_memory</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">model_memory</span> <span class="o">+</span> <span class="n">activation_memory</span> <span class="o">&lt;</span> <span class="n">gpu_memory</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># çº¯æ•°æ®å¹¶è¡Œ</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dp&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_size</span><span class="p">,</span> <span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;pp&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

        <span class="c1"># éœ€è¦æ¨¡å‹å¹¶è¡Œ</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
            <span class="c1"># æ·±å±‚ç½‘ç»œï¼Œä½¿ç”¨æµæ°´çº¿å¹¶è¡Œ</span>
            <span class="n">pp_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">//</span> <span class="mi">12</span><span class="p">)</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_size</span> <span class="o">//</span> <span class="n">pp_size</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">:</span>
                <span class="c1"># å®½æ¨¡å‹ï¼Œæ·»åŠ å¼ é‡å¹¶è¡Œ</span>
                <span class="n">tp_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">remaining</span><span class="p">)</span>
                <span class="n">dp_size</span> <span class="o">=</span> <span class="n">remaining</span> <span class="o">//</span> <span class="n">tp_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tp_size</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">dp_size</span> <span class="o">=</span> <span class="n">remaining</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># æµ…å±‚å®½æ¨¡å‹ï¼Œä¸»è¦ä½¿ç”¨å¼ é‡å¹¶è¡Œ</span>
            <span class="n">tp_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_size</span><span class="p">)</span>
            <span class="n">dp_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world_size</span> <span class="o">//</span> <span class="n">tp_size</span>
            <span class="n">pp_size</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dp&quot;</span><span class="p">:</span> <span class="n">dp_size</span><span class="p">,</span> <span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="n">tp_size</span><span class="p">,</span> <span class="s2">&quot;pp&quot;</span><span class="p">:</span> <span class="n">pp_size</span><span class="p">}</span>
</code></pre></div>

<p><strong>ZeRO ä¼˜åŒ–ç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">configure_zero_optimization</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;é…ç½® ZeRO ä¼˜åŒ–&quot;&quot;&quot;</span>
    <span class="n">zero_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="n">stage</span><span class="p">,</span>
        <span class="s2">&quot;allgather_partitions&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;allgather_bucket_size&quot;</span><span class="p">:</span> <span class="mf">2e8</span><span class="p">,</span>
        <span class="s2">&quot;overlap_comm&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;reduce_scatter&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;reduce_bucket_size&quot;</span><span class="p">:</span> <span class="mf">2e8</span><span class="p">,</span>
        <span class="s2">&quot;contiguous_gradients&quot;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">stage</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># ZeRO-2: ä¼˜åŒ–å™¨çŠ¶æ€åˆ†ç‰‡</span>
        <span class="n">zero_config</span><span class="p">[</span><span class="s2">&quot;offload_optimizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pin_memory&quot;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">stage</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># ZeRO-3: å‚æ•°åˆ†ç‰‡</span>
        <span class="n">zero_config</span><span class="p">[</span><span class="s2">&quot;offload_param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pin_memory&quot;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
        <span class="n">zero_config</span><span class="p">[</span><span class="s2">&quot;param_persistence_threshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e5</span>

    <span class="k">return</span> <span class="n">zero_config</span>
</code></pre></div>

<h3 id="752">7.5.2 é€šä¿¡ä¼˜åŒ–</h3>
<p>å‡å°‘é€šä¿¡å¼€é”€æ˜¯åˆ†å¸ƒå¼è®­ç»ƒçš„å…³é”®ä¼˜åŒ–ç‚¹ï¼š</p>
<p><strong>æ¢¯åº¦å‹ç¼©</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">GradientCompressor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compression_ratio</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression_ratio</span> <span class="o">=</span> <span class="n">compression_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Top-k ç¨€ç–åŒ–å‹ç¼©&quot;&quot;&quot;</span>
        <span class="c1"># æ·»åŠ æ®‹å·®</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">:</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">tensor</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># é€‰æ‹© top-k å…ƒç´ </span>
        <span class="n">numel</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">numel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression_ratio</span><span class="p">))</span>

        <span class="n">values</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">compressed</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>

        <span class="c1"># ä¿å­˜æ®‹å·®</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">compressed</span>

        <span class="c1"># è¿”å›ç¨€ç–è¡¨ç¤º</span>
        <span class="k">return</span> <span class="n">indices</span><span class="p">,</span> <span class="n">compressed</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è§£å‹ç¼©&quot;&quot;&quot;</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tensor</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="k">return</span> <span class="n">tensor</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>

<p><strong>é€šä¿¡è°ƒåº¦ä¼˜åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CommunicationScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_comm_groups</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">schedule_allreduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradients</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¼˜åŒ– AllReduce è°ƒåº¦&quot;&quot;&quot;</span>
        <span class="c1"># æŒ‰å¤§å°åˆ†ç»„</span>
        <span class="n">small_grads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">large_grads</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">grad</span> <span class="ow">in</span> <span class="n">gradients</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">grad</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e6</span><span class="p">:</span>
                <span class="n">small_grads</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">grad</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">large_grads</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">grad</span><span class="p">))</span>

        <span class="c1"># å°æ¢¯åº¦åˆå¹¶é€šä¿¡</span>
        <span class="k">if</span> <span class="n">small_grads</span><span class="p">:</span>
            <span class="n">merged</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">small_grads</span><span class="p">])</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># å¤§æ¢¯åº¦æµæ°´çº¿é€šä¿¡</span>
        <span class="n">handles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">grad</span> <span class="ow">in</span> <span class="n">large_grads</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">all_reduce</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">handles</span>
</code></pre></div>

<h3 id="753">7.5.3 å†…å­˜ç®¡ç†</h3>
<p>ç²¾ç»†çš„å†…å­˜ç®¡ç†å¯¹å¤§æ¨¡å‹è®­ç»ƒè‡³å…³é‡è¦ï¼š</p>
<p><strong>æ¿€æ´»æ£€æŸ¥ç‚¹ï¼ˆActivation Checkpointingï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SelectiveCheckpointing</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;é€‰æ‹©æ€§æ¿€æ´»æ£€æŸ¥ç‚¹&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">checkpoint_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_ratio</span> <span class="o">=</span> <span class="n">checkpoint_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_checkpointing</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setup_checkpointing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é…ç½®å“ªäº›å±‚ä½¿ç”¨æ£€æŸ¥ç‚¹&quot;&quot;&quot;</span>
        <span class="n">total_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
        <span class="n">checkpoint_layers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_layers</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_ratio</span><span class="p">)</span>

        <span class="c1"># é€‰æ‹©å†…å­˜å ç”¨å¤§çš„å±‚</span>
        <span class="n">layer_memories</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">):</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_layer_memory</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">layer_memories</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">memory</span><span class="p">))</span>

        <span class="c1"># ä¼˜å…ˆæ£€æŸ¥ç‚¹å†…å­˜å ç”¨å¤§çš„å±‚</span>
        <span class="n">layer_memories</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">layer_memories</span><span class="p">[:</span><span class="n">checkpoint_layers</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">use_checkpoint</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">estimate_layer_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¼°ç®—å±‚çš„æ¿€æ´»å†…å­˜&quot;&quot;&quot;</span>
        <span class="c1"># ç®€åŒ–ä¼°ç®—</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</code></pre></div>

<p><strong>å†…å­˜æ± ç®¡ç†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MemoryPool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;é¢„åˆ†é…å†…å­˜æ± å‡å°‘ç¢ç‰‡&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">):</span>  <span class="c1"># 1GB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">ByteTensor</span><span class="p">(</span><span class="n">pool_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä»æ± ä¸­åˆ†é…å†…å­˜&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Memory pool exhausted&quot;</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span> <span class="o">+=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é‡Šæ”¾å†…å­˜ï¼ˆé€»è¾‘é‡Šæ”¾ï¼‰&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="c1"># å®é™…å®ç°ä¸­éœ€è¦å†…å­˜æ•´ç†</span>
</code></pre></div>

<h3 id="754">7.5.4 æ•…éšœæ¢å¤æœºåˆ¶</h3>
<p>æ„å»ºå¥å£®çš„æ•…éšœæ¢å¤æœºåˆ¶ç¡®ä¿è®­ç»ƒç¨³å®šæ€§ï¼š</p>
<p><strong>æ£€æŸ¥ç‚¹ç®¡ç†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RobustCheckpointing</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">keep_last_n</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">checkpoint_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_n</span> <span class="o">=</span> <span class="n">keep_last_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¿å­˜æ£€æŸ¥ç‚¹withåŸå­æ“ä½œ&quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model_state_dict&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># ä¸´æ—¶æ–‡ä»¶</span>
        <span class="n">temp_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="si">}</span><span class="s2">/temp_ckpt_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pt&quot;</span>
        <span class="n">final_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="si">}</span><span class="s2">/checkpoint_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pt&quot;</span>

        <span class="c1"># åŸå­å†™å…¥</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">temp_path</span><span class="p">)</span>

        <span class="c1"># éªŒè¯æ£€æŸ¥ç‚¹</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_checkpoint</span><span class="p">(</span><span class="n">temp_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">final_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_path</span><span class="p">)</span>

            <span class="c1"># æ¸…ç†æ—§æ£€æŸ¥ç‚¹</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_last_n</span><span class="p">:</span>
                <span class="n">old_ckpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_history</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_ckpt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Checkpoint verification failed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verify_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;éªŒè¯æ£€æŸ¥ç‚¹å®Œæ•´æ€§&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
            <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;model_state_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;epoch&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">checkpoint</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<p><strong>å¼¹æ€§è®­ç»ƒ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ElasticTrainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ”¯æŒåŠ¨æ€èŠ‚ç‚¹å¢å‡çš„å¼¹æ€§è®­ç»ƒ&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_nodes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_nodes</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_nodes</span> <span class="o">=</span> <span class="n">min_nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_nodes</span> <span class="o">=</span> <span class="n">max_nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_available_nodes</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_node_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failed_node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¤„ç†èŠ‚ç‚¹æ•…éšœ&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">failed_node</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_nodes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_nodes</span><span class="p">:</span>
            <span class="c1"># ç­‰å¾…æ–°èŠ‚ç‚¹æˆ–ç»ˆæ­¢</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_nodes</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># é‡æ–°é…ç½®å¹¶ç»§ç»­</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reconfigure_training</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reconfigure_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é‡æ–°é…ç½®è®­ç»ƒ&quot;&quot;&quot;</span>
        <span class="c1"># é‡æ–°åˆå§‹åŒ–è¿›ç¨‹ç»„</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">destroy_process_group</span><span class="p">()</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span>
            <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;nccl&quot;</span><span class="p">,</span>
            <span class="n">world_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_nodes</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># è°ƒæ•´æ‰¹æ¬¡å¤§å°ä¿æŒå…¨å±€æ‰¹æ¬¡ä¸å˜</span>
        <span class="n">global_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">global_batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">local_batch_size</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">global_batch_size</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_nodes</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># é‡æ–°åˆ†é…æ•°æ®</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redistribute_data</span><span class="p">()</span>
</code></pre></div>

<h3 id="755">7.5.5 æ€§èƒ½è°ƒä¼˜å®è·µ</h3>
<p>ç³»ç»Ÿçº§ä¼˜åŒ–æå‡è®­ç»ƒæ•ˆç‡ï¼š</p>
<p><strong>æ€§èƒ½åˆ†æå·¥å…·é›†æˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PerformanceMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">profile_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ†æå•æ¬¡è¿­ä»£&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span>
            <span class="n">activities</span><span class="o">=</span><span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">ProfilerActivity</span><span class="o">.</span><span class="n">CPU</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">ProfilerActivity</span><span class="o">.</span><span class="n">CUDA</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">record_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">profile_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">with_stack</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">prof</span><span class="p">:</span>
            <span class="c1"># æ‰§è¡Œè®­ç»ƒæ­¥éª¤</span>
            <span class="k">yield</span>

        <span class="c1"># åˆ†æç»“æœ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_profile</span><span class="p">(</span><span class="n">prof</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">analyze_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prof</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ†ææ€§èƒ½ç“¶é¢ˆ&quot;&quot;&quot;</span>
        <span class="c1"># GPUåˆ©ç”¨ç‡</span>
        <span class="n">cuda_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
            <span class="n">item</span><span class="o">.</span><span class="n">cuda_time_total</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prof</span><span class="o">.</span><span class="n">key_averages</span><span class="p">()</span>
        <span class="p">])</span>

        <span class="c1"># é€šä¿¡æ—¶é—´</span>
        <span class="n">comm_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
            <span class="n">item</span><span class="o">.</span><span class="n">cuda_time_total</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prof</span><span class="o">.</span><span class="n">key_averages</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;nccl&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">key</span> <span class="ow">or</span> <span class="s2">&quot;allreduce&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">key</span>
        <span class="p">])</span>

        <span class="c1"># å†…å­˜å³°å€¼</span>
        <span class="n">memory_peak</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">max_memory_allocated</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;gpu_utilization&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;comm_overhead&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comm_time</span> <span class="o">/</span> <span class="n">cuda_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;memory_peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">memory_peak</span><span class="p">)</span>

        <span class="c1"># è¯†åˆ«ç“¶é¢ˆ</span>
        <span class="k">if</span> <span class="n">comm_time</span> <span class="o">/</span> <span class="n">cuda_time</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: High communication overhead (</span><span class="si">{</span><span class="n">comm_time</span><span class="o">/</span><span class="n">cuda_time</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>è‡ªåŠ¨æ€§èƒ½è°ƒä¼˜</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AutoTuner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è‡ªåŠ¨è°ƒä¼˜è®­ç»ƒé…ç½®&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">initial_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">initial_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">auto_tune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_trials</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è‡ªåŠ¨è°ƒä¼˜&quot;&quot;&quot;</span>
        <span class="n">best_throughput</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trials</span><span class="p">):</span>
            <span class="c1"># ç”Ÿæˆæ–°é…ç½®</span>
            <span class="n">trial_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_config_variant</span><span class="p">()</span>

            <span class="c1"># æµ‹è¯•æ€§èƒ½</span>
            <span class="n">throughput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_config</span><span class="p">(</span><span class="n">trial_config</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">throughput</span> <span class="o">&gt;</span> <span class="n">best_throughput</span><span class="p">:</span>
                <span class="n">best_throughput</span> <span class="o">=</span> <span class="n">throughput</span>
                <span class="n">best_config</span> <span class="o">=</span> <span class="n">trial_config</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">trial_config</span><span class="p">,</span>
                <span class="s2">&quot;throughput&quot;</span><span class="p">:</span> <span class="n">throughput</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">best_config</span>

    <span class="k">def</span> <span class="nf">generate_config_variant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç”Ÿæˆé…ç½®å˜ä½“&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># è°ƒæ•´å…³é”®å‚æ•°</span>
        <span class="n">params_to_tune</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;micro_batch_size&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">&quot;gradient_accumulation_steps&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">&quot;num_workers&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">&quot;pin_memory&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">&quot;prefetch_factor&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">params_to_tune</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>  <span class="c1"># 30% æ¦‚ç‡ä¿®æ”¹</span>
                <span class="n">config</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">config</span>
</code></pre></div>

<h2 id="_2">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« ç³»ç»Ÿä»‹ç»äº† LLM åè®­ç»ƒä¸­çš„è®­ç»ƒå¾ªç¯ä¸è¿­ä»£ä¼˜åŒ–æ–¹æ³•ï¼š</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹</strong>ï¼š</p>
<ol>
<li>
<p><strong>æ•°æ®-æ ‡æ³¨-è®­ç»ƒ-è¯„ä¼°å¾ªç¯</strong>ï¼š
   - å»ºç«‹é«˜æ•ˆçš„é—­ç¯ç³»ç»Ÿæ˜¯åè®­ç»ƒæˆåŠŸçš„åŸºç¡€
   - æ¯ä¸ªç¯èŠ‚çš„è´¨é‡æ§åˆ¶å’Œåé¦ˆæœºåˆ¶è‡³å…³é‡è¦
   - è‡ªåŠ¨åŒ–å’Œæ™ºèƒ½åŒ–å†³ç­–æå‡è¿­ä»£æ•ˆç‡</p>
</li>
<li>
<p><strong>ä¸»åŠ¨å­¦ä¹ ä¸æ•°æ®é€‰æ‹©</strong>ï¼š
   - ä¸ç¡®å®šæ€§é‡‡æ ·ã€å¤šæ ·æ€§é€‰æ‹©ã€å›°éš¾æ ·æœ¬æŒ–æ˜ç›¸ç»“åˆ
   - è¯¾ç¨‹å­¦ä¹ ä¼˜åŒ–è®­ç»ƒé¡ºåºï¼Œæé«˜æ”¶æ•›é€Ÿåº¦
   - æ•°æ®ä»·å€¼è¯„ä¼°æŒ‡å¯¼èµ„æºåˆ†é…</p>
</li>
<li>
<p><strong>æ¨¡å‹åˆå¹¶ä¸é›†æˆ</strong>ï¼š
   - å‚æ•°ç©ºé—´åˆå¹¶æŠ€æœ¯å®ç°é›¶æˆæœ¬é›†æˆ
   - ä»»åŠ¡å‘é‡æ”¯æŒæ¨¡å‹èƒ½åŠ›çš„ç®—æœ¯è¿ç®—
   - å±‚çº§ç­–ç•¥å’Œå†²çªè§£å†³ç¡®ä¿åˆå¹¶è´¨é‡</p>
</li>
<li>
<p><strong>è¶…å‚æ•°ä¼˜åŒ–</strong>ï¼š
   - è´å¶æ–¯ä¼˜åŒ–å’Œç¾¤ä½“è®­ç»ƒæé«˜æœç´¢æ•ˆç‡
   - å¤šä¿çœŸåº¦æ–¹æ³•ä¼˜åŒ–è®¡ç®—èµ„æºä½¿ç”¨
   - è¶…å‚æ•°è¿ç§»å­¦ä¹ åŠ é€Ÿæ–°ä»»åŠ¡é€‚é…</p>
</li>
<li>
<p><strong>åˆ†å¸ƒå¼è®­ç»ƒä¼˜åŒ–</strong>ï¼š
   - æ··åˆå¹¶è¡Œç­–ç•¥é€‚åº”ä¸åŒè§„æ¨¡æ¨¡å‹
   - é€šä¿¡å’Œå†…å­˜ä¼˜åŒ–é™ä½è®­ç»ƒæˆæœ¬
   - æ•…éšœæ¢å¤æœºåˆ¶ä¿è¯è®­ç»ƒç¨³å®šæ€§</p>
</li>
</ol>
<p><strong>å…³é”®å…¬å¼å›é¡¾</strong>ï¼š</p>
<ul>
<li>ä¸ç¡®å®šæ€§åº¦é‡ï¼š$H(x) = -\sum_{i=1}^{K} p(y_i|x) \log p(y_i|x)$</li>
<li>ä»»åŠ¡å‘é‡ï¼š$\tau = \theta_{finetuned} - \theta_{pretrained}$</li>
<li>æœŸæœ›æ”¹è¿›ï¼š$EI(x) = (\mu(x) - f^*) \Phi(Z) + \sigma(x) \phi(Z)$</li>
</ul>
<h2 id="_3">ç»ƒä¹ é¢˜</h2>
<h3 id="_4">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>å¾ªç¯è®¾è®¡ç†è§£</strong>
   è®¾è®¡ä¸€ä¸ªæ•°æ®-æ ‡æ³¨-è®­ç»ƒ-è¯„ä¼°å¾ªç¯ï¼Œè¦æ±‚æ—¥äº§å‡º 1000 ä¸ªé«˜è´¨é‡æ ‡æ³¨æ ·æœ¬ï¼Œæè¿°å„ç¯èŠ‚çš„å…³é”®æŒ‡æ ‡å’Œè´¨é‡æ§åˆ¶ç‚¹ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">æç¤º</summary>
   è€ƒè™‘æ ‡æ³¨æ•ˆç‡ã€è´¨é‡æ£€æŸ¥ã€è‡ªåŠ¨åŒ–ç¨‹åº¦ã€åé¦ˆå»¶è¿Ÿç­‰å› ç´ ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   å¾ªç¯è®¾è®¡æ–¹æ¡ˆï¼š

   - æ•°æ®æ”¶é›†ï¼šä»ç”¨æˆ·äº¤äº’æ—¥å¿—ç­›é€‰ï¼ˆ2000æ ·æœ¬/æ—¥ï¼‰ï¼Œé¢„è¿‡æ»¤è§„åˆ™å»é™¤æ˜æ˜¾ä½è´¨é‡
   - æ ‡æ³¨ï¼šæ··åˆæ¨¡å¼ï¼Œæ¨¡å‹é¢„æ ‡æ³¨(5000/æ—¥) â†’ äººå·¥å®¡æ ¸(1500/æ—¥) â†’ è´¨æ£€(100%è¦†ç›–)
   - è®­ç»ƒï¼šç´¯ç§¯5000æ ·æœ¬è§¦å‘ï¼Œå¢é‡è®­ç»ƒ2å°æ—¶
   - è¯„ä¼°ï¼šè‡ªåŠ¨è¯„ä¼°(å‡†ç¡®ç‡&gt;95%) + äººå·¥æŠ½æ£€(5%)
   - å…³é”®æŒ‡æ ‡ï¼šæ ‡æ³¨ä¸€è‡´æ€§&gt;0.85ï¼Œæ¨¡å‹æ”¹è¿›&gt;2%ï¼Œç«¯åˆ°ç«¯å»¶è¿Ÿ&lt;24å°æ—¶
   </details>
<ol start="2">
<li><strong>ä¸ç¡®å®šæ€§è®¡ç®—</strong>
   ç»™å®šæ¨¡å‹å¯¹ä¸‰ä¸ªç±»åˆ«çš„é¢„æµ‹æ¦‚ç‡ä¸º [0.4, 0.35, 0.25]ï¼Œè®¡ç®—é¢„æµ‹ç†µã€æœ€å°ç½®ä¿¡åº¦å’Œè¾¹é™…é‡‡æ ·åˆ†æ•°ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">æç¤º</summary>
   ç›´æ¥åº”ç”¨æœ¬ç« ä»‹ç»çš„ä¸‰ä¸ªå…¬å¼ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   - é¢„æµ‹ç†µï¼šH = -0.4Ã—log(0.4) - 0.35Ã—log(0.35) - 0.25Ã—log(0.25) â‰ˆ 1.08
   - æœ€å°ç½®ä¿¡åº¦ï¼šLC = 1 - 0.4 = 0.6
   - è¾¹é™…é‡‡æ ·ï¼šMS = 0.4 - 0.35 = 0.05
   - ç»“è®ºï¼šé«˜ä¸ç¡®å®šæ€§æ ·æœ¬ï¼Œé€‚åˆä¸»åŠ¨å­¦ä¹ 
   </details>
<ol start="3">
<li><strong>æ¨¡å‹åˆå¹¶æƒé‡</strong>
   ä¸¤ä¸ªæ¨¡å‹åœ¨éªŒè¯é›†ä¸Šçš„æ€§èƒ½åˆ†åˆ«ä¸º 0.85 å’Œ 0.90ï¼ŒFisher ä¿¡æ¯çŸ©é˜µèŒƒæ•°æ¯”ä¸º 2:3ï¼Œè®¡ç®—æœ€ä¼˜åˆå¹¶æƒé‡ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">æç¤º</summary>
   ç»“åˆæ€§èƒ½å’Œ Fisher ä¿¡æ¯ç¡®å®šæƒé‡ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   ç»¼åˆæƒé‡è®¡ç®—ï¼š

   - æ€§èƒ½æƒé‡ï¼š0.85:0.90 = 0.486:0.514
   - Fisher æƒé‡ï¼š2:3 = 0.4:0.6
   - ç»¼åˆæƒé‡ï¼ˆå¹³å‡ï¼‰ï¼š(0.486+0.4)/2 : (0.514+0.6)/2 = 0.443:0.557
   - å½’ä¸€åŒ–ï¼š0.443:0.557
   </details>
<ol start="4">
<li><strong>å¹¶è¡Œç­–ç•¥é€‰æ‹©</strong>
   æ¨¡å‹å‚æ•° 70Bï¼Œ32 ä¸ª A100 GPUï¼ˆ80GBï¼‰ï¼Œæ‰¹æ¬¡å¤§å° 512ï¼Œå¦‚ä½•è®¾è®¡ 3D å¹¶è¡Œç­–ç•¥ï¼Ÿ</li>
</ol>
<details markdown="block">
   <summary markdown="off">æç¤º</summary>
   è®¡ç®—æ¨¡å‹å†…å­˜éœ€æ±‚ï¼Œè€ƒè™‘æ¿€æ´»å†…å­˜ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   ç­–ç•¥è®¾è®¡ï¼š

   - æ¨¡å‹å†…å­˜ï¼š70B Ã— 4 bytes = 280GBï¼ˆFP32ï¼‰
   - å•GPUæ— æ³•å®¹çº³ï¼Œéœ€è¦æ¨¡å‹å¹¶è¡Œ
   - å»ºè®®é…ç½®ï¼šTP=4, PP=2, DP=4
   - æ¯ä¸ªGPUè´Ÿè´£ï¼š70B/(4Ã—2) = 8.75B å‚æ•°
   - å†…å­˜å ç”¨ï¼š35GBæ¨¡å‹ + 20GBæ¿€æ´» &lt; 80GB
   </details>
<h3 id="_5">æŒ‘æˆ˜é¢˜</h3>
<ol start="5">
<li><strong>ä¸»åŠ¨å­¦ä¹ ç­–ç•¥è®¾è®¡</strong>
   è®¾è®¡ä¸€ä¸ªç»“åˆä¸ç¡®å®šæ€§ã€å¤šæ ·æ€§å’Œå›°éš¾åº¦çš„ç»¼åˆä¸»åŠ¨å­¦ä¹ ç­–ç•¥ï¼Œç»™å‡ºå…·ä½“çš„è¯„åˆ†å‡½æ•°å’Œé€‰æ‹©ç®—æ³•ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">æç¤º</summary>
   è€ƒè™‘ä¸‰ä¸ªç»´åº¦çš„æƒé‡å¹³è¡¡å’Œå½’ä¸€åŒ–ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   ç»¼åˆè¯„åˆ†å‡½æ•°ï¼š
   Score(x) = Î±Â·Uncertainty(x) + Î²Â·Diversity(x) + Î³Â·Difficulty(x)

   å…¶ä¸­ï¼š

   - Uncertainty(x) = H(x) / log(K)  # å½’ä¸€åŒ–ç†µ
   - Diversity(x) = min_distance(x, selected_set) / max_distance
   - Difficulty(x) = loss(x) / percentile_95_loss
   - Î±=0.4, Î²=0.3, Î³=0.3ï¼ˆå¯è°ƒï¼‰

   é€‰æ‹©ç®—æ³•ï¼š

   1. è®¡ç®—æ‰€æœ‰å€™é€‰æ ·æœ¬çš„ç»¼åˆåˆ†æ•°
   2. è´ªå¿ƒé€‰æ‹©ï¼šæ¯æ¬¡é€‰æœ€é«˜åˆ†ï¼Œæ›´æ–°å·²é€‰é›†åˆ
   3. åŠ¨æ€è°ƒæ•´æƒé‡ï¼šæ—©æœŸé‡è§†å¤šæ ·æ€§ï¼ŒåæœŸé‡è§†å›°éš¾åº¦
   </details>
<ol start="6">
<li><strong>è¶…å‚æ•°è¿ç§»æ–¹æ¡ˆ</strong>
   è®¾è®¡ä¸€ä¸ªè·¨ä»»åŠ¡çš„è¶…å‚æ•°è¿ç§»å­¦ä¹ ç³»ç»Ÿï¼ŒåŒ…æ‹¬ä»»åŠ¡ç›¸ä¼¼åº¦è®¡ç®—ã€å†å²çŸ¥è¯†å­˜å‚¨å’Œåˆå§‹åŒ–ç­–ç•¥ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">æç¤º</summary>
   è€ƒè™‘ä»»åŠ¡ç‰¹å¾æå–ã€ç›¸ä¼¼åº¦åº¦é‡ã€çŸ¥è¯†è’¸é¦ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   ç³»ç»Ÿè®¾è®¡ï¼š

   1. ä»»åŠ¡ç‰¹å¾æå–ï¼š
      - æ•°æ®ç»Ÿè®¡ï¼šæ ·æœ¬æ•°ã€ç±»åˆ«æ•°ã€æ–‡æœ¬é•¿åº¦åˆ†å¸ƒ
      - æ¨¡å‹ç‰¹å¾ï¼šæ¶æ„ã€å‚æ•°é‡ã€é¢„è®­ç»ƒæ¥æº
      - é¢†åŸŸç‰¹å¾ï¼šä»»åŠ¡ç±»å‹ã€è¯„ä¼°æŒ‡æ ‡

   2. ç›¸ä¼¼åº¦è®¡ç®—ï¼š
      - ç‰¹å¾å‘é‡ä½™å¼¦ç›¸ä¼¼åº¦
      - ä»»åŠ¡åµŒå…¥ï¼ˆé€šè¿‡å…ƒå­¦ä¹ è·å¾—ï¼‰
      - å†å²æ€§èƒ½ç›¸å…³æ€§

   3. çŸ¥è¯†è¿ç§»ï¼š
      - Top-3ç›¸ä¼¼ä»»åŠ¡çš„è¶…å‚æ•°åŠ æƒå¹³å‡
      - æ·»åŠ æ¢ç´¢å™ªå£°ï¼ˆÂ±20%ï¼‰
      - ä¿ç•™ä»»åŠ¡ç‰¹å®šè°ƒæ•´ç©ºé—´
   </details>
<ol start="7">
<li><strong>åˆ†å¸ƒå¼è®­ç»ƒæ•…éšœæ¢å¤</strong>
   è®¾è®¡ä¸€ä¸ªèƒ½å¤„ç†èŠ‚ç‚¹æ•…éšœã€ç½‘ç»œåˆ†åŒºå’Œæ•°æ®æŸåçš„å®Œæ•´æ•…éšœæ¢å¤ç³»ç»Ÿã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">æç¤º</summary>
   è€ƒè™‘æ£€æµ‹ã€éš”ç¦»ã€æ¢å¤ã€éªŒè¯å››ä¸ªé˜¶æ®µã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   æ•…éšœæ¢å¤ç³»ç»Ÿï¼š

   1. æ•…éšœæ£€æµ‹ï¼š
      - å¿ƒè·³ç›‘æ§ï¼ˆ5ç§’è¶…æ—¶ï¼‰
      - æ¢¯åº¦èŒƒæ•°å¼‚å¸¸æ£€æµ‹
      - é€šä¿¡é”™è¯¯ç‡ç›‘æ§

   2. æ•…éšœéš”ç¦»ï¼š
      - æ ‡è®°æ•…éšœèŠ‚ç‚¹
      - é‡ç»„é€šä¿¡æ‹“æ‰‘
      - æ•°æ®é‡åˆ†é…

   3. çŠ¶æ€æ¢å¤ï¼š
      - ä»æœ€è¿‘æ£€æŸ¥ç‚¹æ¢å¤
      - é‡æ”¾æ—¥å¿—æ¢å¤ä¸­é—´çŠ¶æ€
      - éªŒè¯æ¨¡å‹å‚æ•°ä¸€è‡´æ€§

   4. å¼¹æ€§è°ƒæ•´ï¼š
      - åŠ¨æ€è°ƒæ•´å¹¶è¡Œåº¦
      - é‡æ–°è®¡ç®—æ‰¹æ¬¡å¤§å°
      - æ›´æ–°å­¦ä¹ ç‡ï¼ˆæ ¹æ®æœ‰æ•ˆæ‰¹æ¬¡ï¼‰
   </details>
<ol start="8">
<li><strong>æ¨¡å‹åˆå¹¶å†²çªè§£å†³</strong>
   ä¸¤ä¸ªæ¨¡å‹åœ¨ç›¸åŒä»»åŠ¡ä¸Šè®­ç»ƒä½†ä½¿ç”¨ä¸åŒæ•°æ®é›†ï¼Œåˆå¹¶æ—¶å‘ç°30%çš„å‚æ•°ç¬¦å·ç›¸åï¼Œè®¾è®¡è§£å†³æ–¹æ¡ˆã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">æç¤º</summary>
   åˆ†æå†²çªåŸå› ï¼Œè®¾è®¡å¤šçº§è§£å†³ç­–ç•¥ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   å†²çªè§£å†³æ–¹æ¡ˆï¼š

   1. å†²çªåˆ†æï¼š
      - æŒ‰å±‚ç»Ÿè®¡å†²çªæ¯”ä¾‹
      - è¯†åˆ«ç³»ç»Ÿæ€§ vs éšæœºæ€§å†²çª
      - è¯„ä¼°å‚æ•°é‡è¦æ€§ï¼ˆæ¢¯åº¦ã€Fisherä¿¡æ¯ï¼‰

   2. åˆ†çº§å¤„ç†ï¼š
      - å…³é”®å±‚ï¼ˆæ³¨æ„åŠ›ï¼‰ï¼šåŸºäºéªŒè¯é›†æ€§èƒ½é€‰æ‹©
      - ä¸­é—´å±‚ï¼šé‡è¦æ€§åŠ æƒæ’å€¼
      - é¡¶å±‚ï¼šä»»åŠ¡ç›¸å…³æ€§å†³å®š

   3. åå¤„ç†ï¼š
      - å¾®è°ƒåˆå¹¶æ¨¡å‹ï¼ˆå°å­¦ä¹ ç‡ï¼‰
      - çŸ¥è¯†è’¸é¦å¯¹é½
      - éªŒè¯å…³é”®èƒ½åŠ›ä¿æŒ

   4. é¢„é˜²æªæ–½ï¼š
      - è®­ç»ƒæ—¶æ·»åŠ ä¸€è‡´æ€§æ­£åˆ™åŒ–
      - ä½¿ç”¨ç›¸åŒåˆå§‹åŒ–
      - å®šæœŸäº¤æ¢æ¢¯åº¦ä¿¡æ¯
   </details>
<h2 id="_6">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="_7">æ•°æ®å¾ªç¯ç›¸å…³</h3>
<p>âš ï¸ <strong>é™·é˜±1ï¼šæ•°æ®æ³„éœ²</strong></p>
<ul>
<li>é”™è¯¯ï¼šéªŒè¯é›†æ•°æ®è¿›å…¥è®­ç»ƒå¾ªç¯</li>
<li>åæœï¼šè¿‡é«˜ä¼°è®¡æ¨¡å‹æ€§èƒ½</li>
<li>è§£å†³ï¼šä¸¥æ ¼çš„æ•°æ®éš”ç¦»ï¼Œç‰ˆæœ¬æ§åˆ¶</li>
</ul>
<p>âš ï¸ <strong>é™·é˜±2ï¼šæ ‡æ³¨æ¼‚ç§»</strong></p>
<ul>
<li>é”™è¯¯ï¼šæ ‡æ³¨è§„èŒƒéšæ—¶é—´å˜åŒ–ä½†æœªæ›´æ–°å†å²æ•°æ®</li>
<li>åæœï¼šæ•°æ®ä¸ä¸€è‡´ï¼Œæ¨¡å‹å­¦ä¹ å†²çªä¿¡å·</li>
<li>è§£å†³ï¼šå®šæœŸå®¡æŸ¥è§„èŒƒï¼Œå¿…è¦æ—¶é‡æ–°æ ‡æ³¨</li>
</ul>
<h3 id="_8">ä¸»åŠ¨å­¦ä¹ ç›¸å…³</h3>
<p>âš ï¸ <strong>é™·é˜±3ï¼šé‡‡æ ·åå·®</strong></p>
<ul>
<li>é”™è¯¯ï¼šè¿‡åº¦å…³æ³¨ä¸ç¡®å®šæ ·æœ¬ï¼Œå¿½ç•¥ä»£è¡¨æ€§</li>
<li>åæœï¼šæ¨¡å‹åœ¨å¸¸è§æ¡ˆä¾‹ä¸Šæ€§èƒ½ä¸‹é™</li>
<li>è§£å†³ï¼šå¹³è¡¡ä¸ç¡®å®šæ€§å’Œå¤šæ ·æ€§</li>
</ul>
<p>âš ï¸ <strong>é™·é˜±4ï¼šå†·å¯åŠ¨é—®é¢˜</strong></p>
<ul>
<li>é”™è¯¯ï¼šåˆå§‹æ¨¡å‹å¤ªå·®ï¼Œä¸ç¡®å®šæ€§ä¼°è®¡ä¸å¯é </li>
<li>åæœï¼šé€‰æ‹©ä½ä»·å€¼æ ·æœ¬</li>
<li>è§£å†³ï¼šåˆå§‹éšæœºé‡‡æ ·å»ºç«‹åŸºçº¿</li>
</ul>
<h3 id="_9">æ¨¡å‹åˆå¹¶ç›¸å…³</h3>
<p>âš ï¸ <strong>é™·é˜±5ï¼šç›²ç›®å¹³å‡</strong></p>
<ul>
<li>é”™è¯¯ï¼šç›´æ¥å¹³å‡æ‰€æœ‰å‚æ•°</li>
<li>åæœï¼šç ´åå­¦ä¹ çš„ç‰¹å¾è¡¨ç¤º</li>
<li>è§£å†³ï¼šè€ƒè™‘å‚æ•°é‡è¦æ€§å’Œä»»åŠ¡ç›¸å…³æ€§</li>
</ul>
<p>âš ï¸ <strong>é™·é˜±6ï¼šå¿½è§†åˆå§‹åŒ–</strong></p>
<ul>
<li>é”™è¯¯ï¼šåˆå¹¶ä¸åŒåˆå§‹åŒ–çš„æ¨¡å‹</li>
<li>åæœï¼šå‚æ•°ç©ºé—´ä¸å¯¹é½</li>
<li>è§£å†³ï¼šä½¿ç”¨ç›¸åŒé¢„è®­ç»ƒæ¨¡å‹ä½œä¸ºåŸºç¡€</li>
</ul>
<h3 id="_10">åˆ†å¸ƒå¼è®­ç»ƒç›¸å…³</h3>
<p>âš ï¸ <strong>é™·é˜±7ï¼šé€šä¿¡ç“¶é¢ˆ</strong></p>
<ul>
<li>é”™è¯¯ï¼šå¿½è§†ç½‘ç»œå¸¦å®½é™åˆ¶</li>
<li>åæœï¼šGPUåˆ©ç”¨ç‡ä½</li>
<li>è§£å†³ï¼šæ¢¯åº¦å‹ç¼©ï¼Œé€šä¿¡ä¼˜åŒ–</li>
</ul>
<p>âš ï¸ <strong>é™·é˜±8ï¼šæ£€æŸ¥ç‚¹æŸå</strong></p>
<ul>
<li>é”™è¯¯ï¼šæ£€æŸ¥ç‚¹ä¿å­˜ä¸å®Œæ•´æˆ–æŸå</li>
<li>åæœï¼šæ— æ³•æ¢å¤è®­ç»ƒ</li>
<li>è§£å†³ï¼šåŸå­æ“ä½œï¼Œå¤šå‰¯æœ¬ï¼ŒéªŒè¯æœºåˆ¶</li>
</ul>
<h3 id="_11">è¶…å‚æ•°ä¼˜åŒ–ç›¸å…³</h3>
<p>âš ï¸ <strong>é™·é˜±9ï¼šè¿‡æ—©åœæ­¢</strong></p>
<ul>
<li>é”™è¯¯ï¼šåœ¨å­¦ä¹ ç‡é¢„çƒ­é˜¶æ®µå°±åœæ­¢</li>
<li>åæœï¼šé”™è¿‡æ½œåœ¨å¥½é…ç½®</li>
<li>è§£å†³ï¼šè®¾ç½®æœ€å°è®­ç»ƒæ­¥æ•°</li>
</ul>
<p>âš ï¸ <strong>é™·é˜±10ï¼šæœç´¢ç©ºé—´è¿‡å¤§</strong></p>
<ul>
<li>é”™è¯¯ï¼šåŒæ—¶æœç´¢æ‰€æœ‰è¶…å‚æ•°</li>
<li>åæœï¼šæœç´¢æ•ˆç‡ä½</li>
<li>è§£å†³ï¼šåˆ†é˜¶æ®µæœç´¢ï¼Œå›ºå®šæ¬¡è¦å‚æ•°</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter6.html" class="nav-link prev">â† ç¬¬å…­ç« ï¼šå¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆ</a><a href="chapter8.html" class="nav-link next">ç¬¬å…«ç« ï¼šè¯„ä¼°ä¸åŸºå‡†æµ‹è¯• â†’</a></nav>
        </main>
    </div>
</body>
</html>