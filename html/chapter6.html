<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬å…­ç« ï¼šå¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">LLM åè®­ç»ƒå®éªŒè®¾è®¡æŒ‡å—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸€ç« ï¼šåè®­ç»ƒåŸºç¡€ç†è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äºŒç« ï¼šå®éªŒä»£ç åŸºç¡€è®¾æ–½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸‰ç« ï¼šæ•°æ®å·¥ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å››ç« ï¼šçº¯è¯­è¨€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äº”ç« ï¼šå¤šæ¨¡æ€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…­ç« ï¼šå¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸ƒç« ï¼šè®­ç»ƒå¾ªç¯ä¸è¿­ä»£ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…«ç« ï¼šè¯„ä¼°ä¸åŸºå‡†æµ‹è¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¹ç« ï¼šç”Ÿäº§éƒ¨ç½²ä¸ç›‘æ§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬åç« ï¼šæ¡ˆä¾‹ç ”ç©¶ä¸æœ€ä½³å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="_1">ç¬¬å…­ç« ï¼šå¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆ</h1>
<p>æœ¬ç« æ·±å…¥æ¢è®¨åŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ ï¼ˆRLHFï¼‰åŠå…¶å˜ä½“åœ¨å¤§è¯­è¨€æ¨¡å‹åè®­ç»ƒä¸­çš„åº”ç”¨ã€‚æˆ‘ä»¬å°†ä»å¥–åŠ±æ¨¡å‹çš„æ„å»ºå¼€å§‹ï¼Œè¯¦ç»†åˆ†æPPOã€DPOç­‰ä¸»æµç®—æ³•çš„å®ç°ç»†èŠ‚ï¼Œæ¢è®¨Constitutional AIç­‰è‡ªæˆ‘æ”¹è¿›æ–¹æ³•ï¼Œå¹¶è®¨è®ºåœ¨çº¿ä¸ç¦»çº¿å¼ºåŒ–å­¦ä¹ çš„æƒè¡¡ã€‚é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œæ‚¨å°†æŒæ¡è®¾è®¡å’Œå®æ–½RLHFç³»ç»Ÿçš„å®Œæ•´æ–¹æ³•è®ºï¼Œç†è§£ä¸åŒç®—æ³•çš„é€‚ç”¨åœºæ™¯ï¼Œä»¥åŠé¿å…å¸¸è§çš„å®éªŒé™·é˜±ã€‚</p>
<h2 id="61-rlhf">6.1 RLHFçš„åŠ¨æœºä¸æ ¸å¿ƒæŒ‘æˆ˜</h2>
<h3 id="611-rlhf">6.1.1 ä¸ºä»€ä¹ˆéœ€è¦RLHF</h3>
<p>ç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰è™½ç„¶èƒ½è®©æ¨¡å‹å­¦ä¼šéµå¾ªæŒ‡ä»¤çš„åŸºæœ¬æ ¼å¼ï¼Œä½†å­˜åœ¨å‡ ä¸ªæ ¹æœ¬æ€§é™åˆ¶ï¼š</p>
<ol>
<li>
<p><strong>è¡Œä¸ºæ¨¡ä»¿çš„å±€é™æ€§</strong>ï¼šSFTæœ¬è´¨ä¸Šæ˜¯è®©æ¨¡å‹æ¨¡ä»¿è®­ç»ƒæ•°æ®ä¸­çš„è¡Œä¸ºæ¨¡å¼ã€‚å³ä½¿æœ‰é«˜è´¨é‡çš„ç¤ºèŒƒæ•°æ®ï¼Œæ¨¡å‹ä¹Ÿåªèƒ½å­¦åˆ°"å¦‚ä½•è¯´"ï¼Œè€ŒéçœŸæ­£ç†è§£"ä¸ºä»€ä¹ˆè¿™æ ·è¯´æ›´å¥½"ã€‚</p>
</li>
<li>
<p><strong>åå¥½çš„éšå¼æ€§</strong>ï¼šäººç±»åå¥½å¾€å¾€æ˜¯éšå¼çš„ã€å¤šç»´çš„ï¼Œå¾ˆéš¾é€šè¿‡ç¤ºä¾‹å®Œå…¨è¡¨è¾¾ã€‚æ¯”å¦‚"æœ‰å¸®åŠ©"è¿™ä¸ªæ¦‚å¿µï¼ŒåŒ…å«å‡†ç¡®æ€§ã€å®Œæ•´æ€§ã€æ¸…æ™°åº¦ç­‰å¤šä¸ªç»´åº¦ï¼Œä¸”åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­æƒé‡ä¸åŒã€‚</p>
</li>
<li>
<p><strong>åˆ†å¸ƒåç§»é—®é¢˜</strong>ï¼šSFTæ¨¡å‹åœ¨ç”Ÿæˆæ—¶ä¼šç´¯ç§¯è¯¯å·®ï¼Œé€æ¸åç¦»è®­ç»ƒåˆ†å¸ƒã€‚è€ŒRLHFé€šè¿‡åœ¨æ¨¡å‹è‡ªå·±çš„ç”Ÿæˆåˆ†å¸ƒä¸Šè®­ç»ƒï¼Œèƒ½æ›´å¥½åœ°å¤„ç†è¿™ç§åç§»ã€‚</p>
</li>
</ol>
<h3 id="612-rlhf">6.1.2 RLHFçš„æ ¸å¿ƒç»„ä»¶</h3>
<div class="codehilite"><pre><span></span><code>    Human Preferences
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Reward Model â”‚ â† åå¥½æ•°æ®è®­ç»ƒ
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
       å¥–åŠ±ä¿¡å·
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  RL Training â”‚ â† PPO/DPOç­‰ç®—æ³•
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
     Aligned Model
</code></pre></div>

<p>RLHFç³»ç»ŸåŒ…å«ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p>
<ol>
<li><strong>åå¥½æ•°æ®æ”¶é›†</strong>ï¼šè·å–äººç±»å¯¹ä¸åŒå›å¤çš„ç›¸å¯¹åå¥½åˆ¤æ–­</li>
<li><strong>å¥–åŠ±æ¨¡å‹è®­ç»ƒ</strong>ï¼šå­¦ä¹ å°†æ–‡æœ¬æ˜ å°„åˆ°æ ‡é‡å¥–åŠ±å€¼</li>
<li><strong>ç­–ç•¥ä¼˜åŒ–</strong>ï¼šä½¿ç”¨RLç®—æ³•ä¼˜åŒ–è¯­è¨€æ¨¡å‹ä»¥æœ€å¤§åŒ–æœŸæœ›å¥–åŠ±</li>
</ol>
<h3 id="613">6.1.3 ä¸»è¦æŒ‘æˆ˜</h3>
<p><strong>æŒ‘æˆ˜1ï¼šå¥–åŠ±è¿‡æ‹Ÿåˆï¼ˆReward Hackingï¼‰</strong></p>
<p>æ¨¡å‹å¯èƒ½æ‰¾åˆ°è·å¾—é«˜å¥–åŠ±ä½†å®é™…è´¨é‡å·®çš„æ·å¾„ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>è¿‡åº¦ä½¿ç”¨å¥–åŠ±æ¨¡å‹åå¥½çš„ç‰¹å®šçŸ­è¯­</li>
<li>ç”Ÿæˆçœ‹ä¼¼å®Œæ•´ä½†å®é™…ç©ºæ´çš„é•¿å›å¤</li>
<li>åˆ©ç”¨å¥–åŠ±æ¨¡å‹çš„ç›²ç‚¹ç”Ÿæˆæœ‰é—®é¢˜çš„å†…å®¹</li>
</ul>
<p><strong>æŒ‘æˆ˜2ï¼šè®­ç»ƒä¸ç¨³å®šæ€§</strong></p>
<p>RLHFè®­ç»ƒè¿‡ç¨‹å®¹æ˜“å‡ºç°ï¼š</p>
<ul>
<li>ç­–ç•¥å´©æºƒï¼šæ¨¡å‹é€€åŒ–åˆ°é‡å¤ç®€å•æ¨¡å¼</li>
<li>å¥–åŠ±çˆ†ç‚¸ï¼šä¼˜åŒ–è¿‡ç¨‹å¤±æ§å¯¼è‡´å¥–åŠ±å€¼å¼‚å¸¸</li>
<li>KLæ•£åº¦å¤±æ§ï¼šç”Ÿæˆåˆ†å¸ƒè¿‡åº¦åç¦»åˆå§‹æ¨¡å‹</li>
</ul>
<p><strong>æŒ‘æˆ˜3ï¼šè¯„ä¼°å›°éš¾</strong></p>
<ul>
<li>å¥–åŠ±å€¼ä¸èƒ½å®Œå…¨ä»£è¡¨çœŸå®è´¨é‡</li>
<li>éœ€è¦å¤§é‡äººå·¥è¯„ä¼°éªŒè¯æ”¹è¿›æ•ˆæœ</li>
<li>ä¸åŒè¯„ä¼°æŒ‡æ ‡å¯èƒ½ç›¸äº’å†²çª</li>
</ul>
<h2 id="62">6.2 å¥–åŠ±æ¨¡å‹çš„è®­ç»ƒä¸æ ¡å‡†</h2>
<h3 id="621-bradley-terry">6.2.1 Bradley-Terryåå¥½æ¨¡å‹</h3>
<p>å¥–åŠ±æ¨¡å‹çš„ç†è®ºåŸºç¡€æ˜¯Bradley-Terryæ¨¡å‹ï¼Œå®ƒå‡è®¾äººç±»é€‰æ‹©å›å¤Aä¼˜äºå›å¤Bçš„æ¦‚ç‡ä¸ºï¼š</p>
<p>$$P(A \succ B) = \frac{\exp(r(A))}{\exp(r(A)) + \exp(r(B))} = \sigma(r(A) - r(B))$$
å…¶ä¸­$r(\cdot)$æ˜¯å¥–åŠ±å‡½æ•°ï¼Œ$\sigma$æ˜¯sigmoidå‡½æ•°ã€‚</p>
<p>è®­ç»ƒç›®æ ‡æ˜¯æœ€å¤§åŒ–å¯¹æ•°ä¼¼ç„¶ï¼š
$$\mathcal{L}_{RM} = -\mathbb{E}_{(x,y_w,y_l)\sim D}\left[\log\sigma(r_\theta(x,y_w) - r_\theta(x,y_l))\right]$$
å…¶ä¸­$y_w$æ˜¯è¢«åå¥½çš„å›å¤ï¼Œ$y_l$æ˜¯è¾ƒå·®çš„å›å¤ã€‚</p>
<h3 id="622">6.2.2 å¥–åŠ±æ¨¡å‹æ¶æ„è®¾è®¡</h3>
<p>å…¸å‹çš„å¥–åŠ±æ¨¡å‹æ¶æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nl">è¾“å…¥</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">prompt</span><span class="o">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">[</span><span class="n">response</span><span class="o">]</span>
<span class="w">  </span><span class="err">â†“</span>
<span class="n">Transformer</span><span class="w"> </span><span class="n">Encoder</span><span class="w"> </span><span class="p">(</span><span class="n">é¢„è®­ç»ƒLM</span><span class="p">)</span>
<span class="w">  </span><span class="err">â†“</span>
<span class="n">æœ€åä¸€ä¸ªtokençš„éšçŠ¶æ€</span>
<span class="w">  </span><span class="err">â†“</span>
<span class="n">Linear</span><span class="w"> </span><span class="n">Head</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">æ ‡é‡å¥–åŠ±å€¼</span>
</code></pre></div>

<p><strong>å…³é”®è®¾è®¡é€‰æ‹©ï¼š</strong></p>
<ol>
<li>
<p><strong>åŸºåº§æ¨¡å‹é€‰æ‹©</strong>ï¼š
   - ä½¿ç”¨ä¸ç­–ç•¥æ¨¡å‹ç›¸åŒè§„æ¨¡çš„åŸºåº§ï¼ˆå¦‚7Bå¯¹7Bï¼‰
   - æˆ–ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹ï¼ˆå¦‚13Bå¥–åŠ±æ¨¡å‹æŒ‡å¯¼7Bç­–ç•¥ï¼‰</p>
</li>
<li>
<p><strong>æ± åŒ–ç­–ç•¥</strong>ï¼š
   - æœ€åtokenæ± åŒ–ï¼ˆæœ€å¸¸ç”¨ï¼‰
   - å¹³å‡æ± åŒ–ï¼ˆå¯¹é•¿æ–‡æœ¬æ›´ç¨³å®šï¼‰
   - åŠ æƒæ± åŒ–ï¼ˆè€ƒè™‘tokené‡è¦æ€§ï¼‰</p>
</li>
<li>
<p><strong>å½’ä¸€åŒ–æ–¹æ¡ˆ</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ¯æ‰¹æ¬¡æ ‡å‡†åŒ–</span>
<span class="n">rewards</span> <span class="o">=</span> <span class="p">(</span><span class="n">rewards</span> <span class="o">-</span> <span class="n">rewards</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">rewards</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

<span class="c1"># æˆ–ä½¿ç”¨è¿è¡Œå‡å€¼/æ–¹å·®</span>
<span class="bp">self</span><span class="o">.</span><span class="n">running_mean</span> <span class="o">=</span> <span class="mf">0.99</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_mean</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">batch_mean</span>
</code></pre></div>

<h3 id="623">6.2.3 è®­ç»ƒæŠ€å·§ä¸è¿‡æ‹Ÿåˆé¢„é˜²</h3>
<p><strong>æŠ€å·§1ï¼šæ•°æ®å¢å¼º</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">augment_preference_data</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">rejected</span><span class="p">):</span>
    <span class="c1"># 1. é¡ºåºéšæœºåŒ–</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">rejected</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># æ ‡ç­¾ç¿»è½¬</span>

    <span class="c1"># 2. è¾¹é™…æ¡ˆä¾‹ç”Ÿæˆ</span>
    <span class="k">if</span> <span class="n">similarity</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="n">rejected</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
        <span class="c1"># ä¸ºé«˜åº¦ç›¸ä¼¼çš„å¯¹æ·»åŠ å™ªå£°</span>
        <span class="n">rejected</span> <span class="o">=</span> <span class="n">add_noise</span><span class="p">(</span><span class="n">rejected</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">rejected</span><span class="p">,</span> <span class="mi">1</span>
</code></pre></div>

<p><strong>æŠ€å·§2ï¼šé›†æˆä¸ä¸ç¡®å®šæ€§ä¼°è®¡</strong></p>
<p>è®­ç»ƒå¤šä¸ªå¥–åŠ±æ¨¡å‹å¹¶ä½¿ç”¨é›†æˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">EnsembleRewardModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">]</span>
        <span class="n">mean_reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>

        <span class="c1"># é«˜ä¸ç¡®å®šæ€§æ—¶é™ä½å¥–åŠ±ç½®ä¿¡åº¦</span>
        <span class="k">if</span> <span class="n">uncertainty</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">mean_reward</span> <span class="o">*=</span> <span class="mf">0.8</span>

        <span class="k">return</span> <span class="n">mean_reward</span><span class="p">,</span> <span class="n">uncertainty</span>
</code></pre></div>

<p><strong>æŠ€å·§3ï¼šå¯¹æŠ—éªŒè¯</strong></p>
<p>å®šæœŸç”¨å¯¹æŠ—æ ·æœ¬æµ‹è¯•å¥–åŠ±æ¨¡å‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_adversarial_samples</span><span class="p">(</span><span class="n">reward_model</span><span class="p">,</span> <span class="n">base_model</span><span class="p">):</span>
    <span class="c1"># ç”Ÿæˆé«˜å¥–åŠ±ä½†è´¨é‡å·®çš„æ ·æœ¬</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;è§£é‡Šé‡å­åŠ›å­¦&quot;</span>

    <span class="c1"># ç­–ç•¥1ï¼šé‡å¤å…³é”®è¯</span>
    <span class="n">bad_response_1</span> <span class="o">=</span> <span class="s2">&quot;é‡å­åŠ›å­¦é‡å­åŠ›å­¦...&quot;</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="c1"># ç­–ç•¥2ï¼šç©ºæ´çš„é•¿å›å¤</span>
    <span class="n">bad_response_2</span> <span class="o">=</span> <span class="n">generate_verbose_but_empty</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

    <span class="c1"># æ£€æŸ¥å¥–åŠ±æ¨¡å‹æ˜¯å¦è¢«æ¬ºéª—</span>
    <span class="k">if</span> <span class="n">reward_model</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">bad_response_1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;å¥–åŠ±æ¨¡å‹å¯¹é‡å¤å†…å®¹ç»™å‡ºé«˜åˆ†&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="624">6.2.4 æ ¡å‡†æŠ€æœ¯</h3>
<p><strong>æ¸©åº¦ç¼©æ”¾ï¼ˆTemperature Scalingï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CalibratedRewardModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">base_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span>

    <span class="k">def</span> <span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val_data</span><span class="p">):</span>
        <span class="c1"># åœ¨éªŒè¯é›†ä¸Šä¼˜åŒ–æ¸©åº¦å‚æ•°</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">LBFGS</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">closure</span><span class="p">():</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">rejected</span> <span class="ow">in</span> <span class="n">val_data</span><span class="p">:</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">chosen</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">rejected</span><span class="p">))</span> 
                <span class="p">)</span>
                <span class="n">loss</span> <span class="o">-=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">loss</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">closure</span><span class="p">)</span>
</code></pre></div>

<p><strong>æœŸæœ›æ ¡å‡†è¯¯å·®ï¼ˆECEï¼‰ç›‘æ§</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_ece</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">bin_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ece</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bins</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">&gt;=</span> <span class="n">bin_boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> \
               <span class="p">(</span><span class="n">predictions</span> <span class="o">&lt;</span> <span class="n">bin_boundaries</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bin_acc</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">bin_conf</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">bin_weight</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

            <span class="n">ece</span> <span class="o">+=</span> <span class="n">bin_weight</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bin_acc</span> <span class="o">-</span> <span class="n">bin_conf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ece</span>
</code></pre></div>

<h2 id="63-ppollm">6.3 PPOåœ¨LLMä¸­çš„å®ç°ç»†èŠ‚</h2>
<h3 id="631-ppo">6.3.1 PPOç®—æ³•æ ¸å¿ƒ</h3>
<p>PPOï¼ˆProximal Policy Optimizationï¼‰é€šè¿‡é™åˆ¶æ¯æ¬¡æ›´æ–°çš„å¹…åº¦æ¥ä¿è¯è®­ç»ƒç¨³å®šæ€§ï¼š
$$\mathcal{L}_{PPO} = \mathbb{E}_t\left[\min\left(r_t(\theta)\hat{A}_t, \text{clip}(r_t(\theta), 1-\epsilon, 1+\epsilon)\hat{A}_t\right)\right]$$
å…¶ä¸­ï¼š</p>
<ul>
<li>$r_t(\theta) = \frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{old}}(a_t|s_t)}$ æ˜¯é‡è¦æ€§é‡‡æ ·æ¯”ç‡</li>
<li>$\hat{A}_t$ æ˜¯ä¼˜åŠ¿å‡½æ•°ä¼°è®¡</li>
<li>$\epsilon$ æ˜¯è£å‰ªå‚æ•°ï¼ˆé€šå¸¸0.1-0.2ï¼‰</li>
</ul>
<h3 id="632-llm">6.3.2 LLMç‰¹å®šçš„å®ç°ç»†èŠ‚</h3>
<p><strong>æŒ‘æˆ˜1ï¼šåºåˆ—ç”Ÿæˆçš„ä¿¡ç”¨åˆ†é…</strong></p>
<p>åœ¨LLMä¸­ï¼Œä¸€ä¸ª"åŠ¨ä½œ"æ˜¯ç”Ÿæˆä¸€ä¸ªtokenï¼Œ"è½¨è¿¹"æ˜¯å®Œæ•´çš„å›å¤ã€‚å¥–åŠ±é€šå¸¸åªåœ¨åºåˆ—æœ«å°¾ç»™å‡ºï¼Œéœ€è¦åˆç†çš„ä¿¡ç”¨åˆ†é…ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_advantages</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    è®¡ç®—å¹¿ä¹‰ä¼˜åŠ¿ä¼°è®¡(GAE)</span>
<span class="sd">    rewards: [batch_size, seq_len] é€šå¸¸åªæœ‰æœ€åä¸€ä¸ªéé›¶</span>
<span class="sd">    values: [batch_size, seq_len] ä»·å€¼å‡½æ•°é¢„æµ‹</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">advantages</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>
    <span class="n">lastgaelam</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">[</span><span class="mi">0</span><span class="p">]))):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">next_values</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># ç»ˆæ­¢çŠ¶æ€</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="n">rewards</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">next_values</span> <span class="o">-</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span>
        <span class="n">advantages</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastgaelam</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">lam</span> <span class="o">*</span> <span class="n">lastgaelam</span>

    <span class="k">return</span> <span class="n">advantages</span>
</code></pre></div>

<p><strong>æŒ‘æˆ˜2ï¼šKLæ•£åº¦çº¦æŸ</strong></p>
<p>é˜²æ­¢ç­–ç•¥åç¦»å¤ªè¿œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_kl_penalty</span><span class="p">(</span><span class="n">logprobs_new</span><span class="p">,</span> <span class="n">logprobs_ref</span><span class="p">,</span> <span class="n">kl_coef</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    è®¡ç®—KLæ•£åº¦æƒ©ç½š</span>
<span class="sd">    logprobs_new: å½“å‰ç­–ç•¥çš„å¯¹æ•°æ¦‚ç‡</span>
<span class="sd">    logprobs_ref: å‚è€ƒç­–ç•¥ï¼ˆé€šå¸¸æ˜¯SFTæ¨¡å‹ï¼‰çš„å¯¹æ•°æ¦‚ç‡</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kl</span> <span class="o">=</span> <span class="p">(</span><span class="n">logprobs_ref</span> <span class="o">-</span> <span class="n">logprobs_new</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># è‡ªé€‚åº”KLç³»æ•°</span>
    <span class="k">if</span> <span class="n">kl</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">target_kl</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">:</span>
        <span class="n">kl_coef</span> <span class="o">*=</span> <span class="mf">1.5</span>  <span class="c1"># å¢åŠ æƒ©ç½š</span>
    <span class="k">elif</span> <span class="n">kl</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">target_kl</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">kl_coef</span> <span class="o">*=</span> <span class="mf">0.5</span>  <span class="c1"># å‡å°‘æƒ©ç½š</span>

    <span class="k">return</span> <span class="n">kl</span> <span class="o">*</span> <span class="n">kl_coef</span>
</code></pre></div>

<h3 id="633">6.3.3 è®­ç»ƒå¾ªç¯å®ç°</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PPOTrainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_model</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">reward_model</span><span class="p">,</span> 
                 <span class="n">lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">kl_coef</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward</span> <span class="o">=</span> <span class="n">reward_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">AdamW</span><span class="p">(</span><span class="n">policy_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kl_coef</span> <span class="o">=</span> <span class="n">kl_coef</span>

    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
        <span class="c1"># 1. ç”Ÿæˆå›å¤</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">responses</span><span class="p">,</span> <span class="n">old_logprobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_responses</span><span class="p">(</span>
                <span class="n">prompts</span><span class="p">,</span> <span class="n">max_length</span>
            <span class="p">)</span>

            <span class="c1"># 2. è®¡ç®—å¥–åŠ±</span>
            <span class="n">rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>

            <span class="c1"># 3. è®¡ç®—å‚è€ƒæ¨¡å‹çš„å¯¹æ•°æ¦‚ç‡</span>
            <span class="n">ref_logprobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>

        <span class="c1"># 4. å¤šè½®PPOæ›´æ–°</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>  <span class="c1"># PPO epochs</span>
            <span class="c1"># è®¡ç®—å½“å‰ç­–ç•¥çš„å¯¹æ•°æ¦‚ç‡</span>
            <span class="n">new_logprobs</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">forward_with_value</span><span class="p">(</span>
                <span class="n">prompts</span><span class="p">,</span> <span class="n">responses</span>
            <span class="p">)</span>

            <span class="c1"># è®¡ç®—ä¼˜åŠ¿</span>
            <span class="n">advantages</span> <span class="o">=</span> <span class="n">compute_advantages</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

            <span class="c1"># PPOæŸå¤±</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">new_logprobs</span> <span class="o">-</span> <span class="n">old_logprobs</span><span class="p">)</span>
            <span class="n">clipped_ratio</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>

            <span class="n">policy_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
                <span class="n">ratio</span> <span class="o">*</span> <span class="n">advantages</span><span class="p">,</span>
                <span class="n">clipped_ratio</span> <span class="o">*</span> <span class="n">advantages</span>
            <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="c1"># KLæƒ©ç½š</span>
            <span class="n">kl_loss</span> <span class="o">=</span> <span class="n">compute_kl_penalty</span><span class="p">(</span>
                <span class="n">new_logprobs</span><span class="p">,</span> <span class="n">ref_logprobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_coef</span>
            <span class="p">)</span>

            <span class="c1"># ä»·å€¼å‡½æ•°æŸå¤±</span>
            <span class="n">value_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">rewards</span> <span class="o">+</span> <span class="n">values</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

            <span class="c1"># æ€»æŸå¤±</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">policy_loss</span> <span class="o">+</span> <span class="n">kl_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">value_loss</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</code></pre></div>

<h3 id="634-ppo">6.3.4 PPOè°ƒè¯•æŠ€å·§</h3>
<p><strong>æŠ€å·§1ï¼šç›‘æ§å…³é”®æŒ‡æ ‡</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">log_ppo_metrics</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
    <span class="c1"># å¿…é¡»ç›‘æ§çš„æŒ‡æ ‡</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;kl_divergence&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;kl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;clip_fraction&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;approx_kl&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;reward_mean&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;rewards&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;reward_std&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;rewards&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
        <span class="s1">&#39;value_loss&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;value_loss&#39;</span><span class="p">],</span>
        <span class="s1">&#39;policy_loss&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;policy_loss&#39;</span><span class="p">],</span>
        <span class="s1">&#39;entropy&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;entropy&#39;</span><span class="p">],</span>  <span class="c1"># ç›‘æ§æ¢ç´¢ç¨‹åº¦</span>
    <span class="p">}</span>

    <span class="c1"># å¼‚å¸¸æ£€æµ‹</span>
    <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;kl_divergence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;KLæ•£åº¦è¿‡å¤§ï¼Œå¯èƒ½å¯¼è‡´è®­ç»ƒä¸ç¨³å®š&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;clip_fraction&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;è£å‰ªæ¯”ä¾‹è¿‡é«˜ï¼Œè€ƒè™‘å‡å°å­¦ä¹ ç‡&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div>

<p><strong>æŠ€å·§2ï¼šæ¸è¿›å¼è®­ç»ƒ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">progressive_ppo_training</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="n">stages</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    åˆ†é˜¶æ®µé€æ­¥å¢åŠ è®­ç»ƒéš¾åº¦</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">stages</span><span class="p">:</span>
        <span class="c1"># é˜¶æ®µ1ï¼šç®€å•ä»»åŠ¡ï¼Œå¤§KLå®¹å¿åº¦</span>
        <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">kl_coef</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="n">prompts</span> <span class="o">=</span> <span class="n">get_simple_prompts</span><span class="p">()</span>

        <span class="c1"># é˜¶æ®µ2ï¼šä¸­ç­‰éš¾åº¦ï¼Œæ ‡å‡†KL</span>
        <span class="k">elif</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">kl_coef</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">prompts</span> <span class="o">=</span> <span class="n">get_medium_prompts</span><span class="p">()</span>

        <span class="c1"># é˜¶æ®µ3ï¼šå›°éš¾ä»»åŠ¡ï¼Œä¸¥æ ¼KL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">kl_coef</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="n">prompts</span> <span class="o">=</span> <span class="n">get_hard_prompts</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stage_steps</span><span class="p">):</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
</code></pre></div>

<h2 id="64-dpoipo">6.4 DPOä¸IPOçš„æ¯”è¾ƒåˆ†æ</h2>
<h3 id="641-dpo">6.4.1 DPOçš„ç†è®ºåŸºç¡€</h3>
<p>DPOï¼ˆDirect Preference Optimizationï¼‰é€šè¿‡é‡æ–°å‚æ•°åŒ–ï¼Œå°†RLHFé—®é¢˜è½¬æ¢ä¸ºç›‘ç£å­¦ä¹ é—®é¢˜ï¼Œé¿å…äº†æ˜¾å¼è®­ç»ƒå¥–åŠ±æ¨¡å‹ï¼š</p>
<p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼šæœ€ä¼˜ç­–ç•¥å¯ä»¥ç”¨å°é—­å½¢å¼è¡¨è¾¾ï¼š
$$\pi^*(y|x) = \frac{1}{Z(x)}\pi_{ref}(y|x)\exp\left(\frac{r(x,y)}{\beta}\right)$$
åæ¨å¥–åŠ±å‡½æ•°ï¼š
$$r(x,y) = \beta\log\frac{\pi^*(y|x)}{\pi_{ref}(y|x)} + \beta\log Z(x)$$
ä»£å…¥Bradley-Terryæ¨¡å‹ï¼Œå¾—åˆ°DPOæŸå¤±ï¼š
$$\mathcal{L}_{DPO} = -\mathbb{E}\left[\log\sigma\left(\beta\log\frac{\pi_\theta(y_w|x)}{\pi_{ref}(y_w|x)} - \beta\log\frac{\pi_\theta(y_l|x)}{\pi_{ref}(y_l|x)}\right)\right]$$</p>
<h3 id="642-dpo">6.4.2 DPOå®ç°ç»†èŠ‚</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DPOTrainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="n">ref_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">AdamW</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">5e-7</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">rejected</span><span class="p">):</span>
        <span class="c1"># è®¡ç®—ç­–ç•¥æ¨¡å‹çš„å¯¹æ•°æ¦‚ç‡</span>
        <span class="n">chosen_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">chosen</span><span class="p">)</span>
        <span class="n">rejected_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">rejected</span><span class="p">)</span>

        <span class="c1"># è®¡ç®—å‚è€ƒæ¨¡å‹çš„å¯¹æ•°æ¦‚ç‡</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">ref_chosen_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span>
                <span class="n">prompts</span><span class="p">,</span> <span class="n">chosen</span>
            <span class="p">)</span>
            <span class="n">ref_rejected_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span>
                <span class="n">prompts</span><span class="p">,</span> <span class="n">rejected</span>
            <span class="p">)</span>

        <span class="c1"># è®¡ç®—å¯¹æ•°æ¦‚ç‡æ¯”</span>
        <span class="n">chosen_rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">chosen_logps</span> <span class="o">-</span> <span class="n">ref_chosen_logps</span><span class="p">)</span>
        <span class="n">rejected_rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">rejected_logps</span> <span class="o">-</span> <span class="n">ref_rejected_logps</span><span class="p">)</span>

        <span class="c1"># DPOæŸå¤±</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">logsigmoid</span><span class="p">(</span><span class="n">chosen_rewards</span> <span class="o">-</span> <span class="n">rejected_rewards</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># æ·»åŠ éšå¼å¥–åŠ±çš„ç›‘æ§</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">reward_accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">chosen_rewards</span> <span class="o">&gt;</span> <span class="n">rejected_rewards</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">reward_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">chosen_rewards</span> <span class="o">-</span> <span class="n">rejected_rewards</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;reward_accuracy&#39;</span><span class="p">:</span> <span class="n">reward_accuracy</span><span class="p">,</span>
            <span class="s1">&#39;reward_margin&#39;</span><span class="p">:</span> <span class="n">reward_margin</span><span class="p">,</span>
            <span class="s1">&#39;chosen_rewards&#39;</span><span class="p">:</span> <span class="n">chosen_rewards</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;rejected_rewards&#39;</span><span class="p">:</span> <span class="n">rejected_rewards</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="643-ipo">6.4.3 IPOçš„æ”¹è¿›</h3>
<p>IPOï¼ˆIdentity Preference Optimizationï¼‰è§£å†³äº†DPOçš„ä¸€äº›é—®é¢˜ï¼š</p>
<ol>
<li><strong>è¿‡æ‹Ÿåˆé—®é¢˜</strong>ï¼šDPOå€¾å‘äºè®©rejectedæ ·æœ¬çš„ä¼¼ç„¶åº¦è¶‹è¿‘äº0</li>
<li><strong>ç¡®å®šæ€§åå¥½</strong>ï¼šDPOå‡è®¾åå¥½æ˜¯ç¡®å®šæ€§çš„ï¼Œå¿½ç•¥äº†æ ‡æ³¨å™ªå£°</li>
</ol>
<p>IPOçš„æŸå¤±å‡½æ•°ï¼š
$$\mathcal{L}_{IPO} = \mathbb{E}\left[\left(\log\frac{\pi_\theta(y_w|x)}{\pi_{ref}(y_w|x)} - \log\frac{\pi_\theta(y_l|x)}{\pi_{ref}(y_l|x)} - \frac{1}{2\beta}\right)^2\right]$$</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">IPOTrainer</span><span class="p">(</span><span class="n">DPOTrainer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">rejected</span><span class="p">):</span>
        <span class="c1"># ä¸DPOç›¸åŒçš„å¯¹æ•°æ¦‚ç‡è®¡ç®—</span>
        <span class="n">chosen_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">chosen</span><span class="p">)</span>
        <span class="n">rejected_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">rejected</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">ref_chosen_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span>
                <span class="n">prompts</span><span class="p">,</span> <span class="n">chosen</span>
            <span class="p">)</span>
            <span class="n">ref_rejected_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span>
                <span class="n">prompts</span><span class="p">,</span> <span class="n">rejected</span>
            <span class="p">)</span>

        <span class="c1"># IPOä½¿ç”¨å¹³æ–¹æŸå¤±è€ŒélogisticæŸå¤±</span>
        <span class="n">log_ratio_chosen</span> <span class="o">=</span> <span class="n">chosen_logps</span> <span class="o">-</span> <span class="n">ref_chosen_logps</span>
        <span class="n">log_ratio_rejected</span> <span class="o">=</span> <span class="n">rejected_logps</span> <span class="o">-</span> <span class="n">ref_rejected_logps</span>

        <span class="c1"># IPOæŸå¤±ï¼šé¼“åŠ±å·®å€¼ä¸º1/(2Î²)</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_ratio_chosen</span> <span class="o">-</span> <span class="n">log_ratio_rejected</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">losses</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="p">{</span>
            <span class="s1">&#39;log_ratio_diff&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">log_ratio_chosen</span> <span class="o">-</span> <span class="n">log_ratio_rejected</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="644-dpo-vs-ipo">6.4.4 DPO vs IPOå®éªŒå¯¹æ¯”</h3>
<p><strong>å®éªŒè®¾ç½®å¯¹æ¯”è¡¨</strong>ï¼š</p>
<p>| ç»´åº¦ | DPO | IPO |</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>DPO</th>
<th>IPO</th>
</tr>
</thead>
<tbody>
<tr>
<td>æŸå¤±å‡½æ•°</td>
<td>Logistic</td>
<td>MSE</td>
</tr>
<tr>
<td>Î²å‚æ•°æ•æ„Ÿåº¦</td>
<td>é«˜</td>
<td>ä¸­</td>
</tr>
<tr>
<td>è®­ç»ƒç¨³å®šæ€§</td>
<td>ä¸­</td>
<td>é«˜</td>
</tr>
<tr>
<td>æ”¶æ•›é€Ÿåº¦</td>
<td>å¿«</td>
<td>æ…¢</td>
</tr>
<tr>
<td>è¿‡æ‹Ÿåˆé£é™©</td>
<td>é«˜</td>
<td>ä½</td>
</tr>
<tr>
<td>å™ªå£°é²æ£’æ€§</td>
<td>ä½</td>
<td>é«˜</td>
</tr>
</tbody>
</table>
<p><strong>é€‰æ‹©æŒ‡å—</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">choose_optimization_method</span><span class="p">(</span><span class="n">dataset_properties</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    æ ¹æ®æ•°æ®é›†ç‰¹æ€§é€‰æ‹©DPOæˆ–IPO</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataset_properties</span><span class="p">[</span><span class="s1">&#39;annotation_agreement&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>
        <span class="c1"># æ ‡æ³¨ä¸€è‡´æ€§ä½ï¼Œä½¿ç”¨IPO</span>
        <span class="k">return</span> <span class="s1">&#39;IPO&#39;</span><span class="p">,</span> <span class="s1">&#39;æ ‡æ³¨å™ªå£°å¤§ï¼ŒIPOæ›´é²æ£’&#39;</span>

    <span class="k">elif</span> <span class="n">dataset_properties</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="c1"># æ•°æ®é‡å°ï¼Œä½¿ç”¨IPOé¿å…è¿‡æ‹Ÿåˆ</span>
        <span class="k">return</span> <span class="s1">&#39;IPO&#39;</span><span class="p">,</span> <span class="s1">&#39;æ•°æ®é‡å°ï¼ŒIPOæ³›åŒ–æ›´å¥½&#39;</span>

    <span class="k">elif</span> <span class="n">dataset_properties</span><span class="p">[</span><span class="s1">&#39;preference_strength&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
        <span class="c1"># åå¥½éå¸¸æ˜ç¡®ï¼Œä½¿ç”¨DPO</span>
        <span class="k">return</span> <span class="s1">&#39;DPO&#39;</span><span class="p">,</span> <span class="s1">&#39;åå¥½æ˜ç¡®ï¼ŒDPOæ”¶æ•›å¿«&#39;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># é»˜è®¤ä½¿ç”¨DPO</span>
        <span class="k">return</span> <span class="s1">&#39;DPO&#39;</span><span class="p">,</span> <span class="s1">&#39;æ ‡å‡†åœºæ™¯ï¼ŒDPOæ•ˆç‡é«˜&#39;</span>
</code></pre></div>

<h3 id="645">6.4.5 æ··åˆç­–ç•¥</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HybridDPO_IPO</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ç»“åˆDPOå’ŒIPOä¼˜ç‚¹çš„æ··åˆæ–¹æ³•</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="n">ref_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="c1"># DPOå’ŒIPOçš„æ··åˆæƒé‡</span>

    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">chosen</span><span class="p">,</span> <span class="n">rejected</span><span class="p">):</span>
        <span class="c1"># è®¡ç®—å¯¹æ•°æ¦‚ç‡</span>
        <span class="n">chosen_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">chosen</span><span class="p">)</span>
        <span class="n">rejected_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">rejected</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">ref_chosen_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">chosen</span><span class="p">)</span>
            <span class="n">ref_rejected_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="o">.</span><span class="n">compute_logprobs</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">rejected</span><span class="p">)</span>

        <span class="c1"># å¯¹æ•°æ¯”</span>
        <span class="n">log_ratio_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">chosen_logps</span> <span class="o">-</span> <span class="n">ref_chosen_logps</span><span class="p">)</span> <span class="o">-</span> \
                        <span class="p">(</span><span class="n">rejected_logps</span> <span class="o">-</span> <span class="n">ref_rejected_logps</span><span class="p">)</span>

        <span class="c1"># DPOæŸå¤±</span>
        <span class="n">dpo_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">logsigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">log_ratio_diff</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># IPOæŸå¤±</span>
        <span class="n">ipo_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_ratio_diff</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">))</span><span class="o">**</span><span class="mf">2.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># æ··åˆæŸå¤±</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">dpo_loss</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">ipo_loss</span>

        <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>

<h2 id="65-constitutional-ai">6.5 Constitutional AIä¸è‡ªæˆ‘æ”¹è¿›</h2>
<h3 id="651-constitutional-ai">6.5.1 Constitutional AIåŸç†</h3>
<p>Constitutional AIï¼ˆCAIï¼‰ä½¿ç”¨ä¸€ç»„åŸåˆ™æ¥æŒ‡å¯¼æ¨¡å‹çš„è‡ªæˆ‘æ”¹è¿›ï¼Œå‡å°‘å¯¹äººç±»æ ‡æ³¨çš„ä¾èµ–ï¼š</p>
<div class="codehilite"><pre><span></span><code>åŸå§‹å›å¤ â†’ AIè‡ªæˆ‘æ‰¹åˆ¤ â†’ ä¿®è®¢å›å¤ â†’ AIåå¥½åˆ¤æ–­ â†’ è®­ç»ƒ
</code></pre></div>

<p>æ ¸å¿ƒç»„ä»¶ï¼š</p>
<ol>
<li><strong>å®ªæ³•åŸåˆ™</strong>ï¼šå®šä¹‰æ¨¡å‹åº”éµå¾ªçš„è§„åˆ™</li>
<li><strong>è‡ªæˆ‘æ‰¹åˆ¤</strong>ï¼šæ¨¡å‹è¯„ä¼°è‡ªå·±çš„è¾“å‡º</li>
<li><strong>è‡ªæˆ‘ä¿®è®¢</strong>ï¼šåŸºäºæ‰¹åˆ¤æ”¹è¿›å›å¤</li>
<li><strong>è‡ªæˆ‘åå¥½</strong>ï¼šç”Ÿæˆåå¥½æ•°æ®ç”¨äºè®­ç»ƒ</li>
</ol>
<h3 id="652-constitutional-ai">6.5.2 å®ç°Constitutional AI</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ConstitutionalAI</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">principles</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">principles</span> <span class="o">=</span> <span class="n">principles</span>

    <span class="k">def</span> <span class="nf">critique_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ä½¿ç”¨å®ªæ³•åŸåˆ™æ‰¹åˆ¤å›å¤</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">critiques</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">principle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">principles</span><span class="p">:</span>
            <span class="n">critique_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            åŸåˆ™ï¼š</span><span class="si">{</span><span class="n">principle</span><span class="si">}</span>
<span class="s2">            ç”¨æˆ·é—®é¢˜ï¼š</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span>
<span class="s2">            åŠ©æ‰‹å›å¤ï¼š</span><span class="si">{</span><span class="n">response</span><span class="si">}</span>

<span class="s2">            è¿™ä¸ªå›å¤æ˜¯å¦è¿åäº†ä¸Šè¿°åŸåˆ™ï¼Ÿå¦‚æœæ˜¯ï¼Œè¯·è¯´æ˜å¦‚ä½•æ”¹è¿›ã€‚</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="n">critique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">critique_prompt</span><span class="p">)</span>
            <span class="n">critiques</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">critique</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">critiques</span>

    <span class="k">def</span> <span class="nf">revise_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">critiques</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        åŸºäºæ‰¹åˆ¤ä¿®è®¢å›å¤</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">revision_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        åŸå§‹é—®é¢˜ï¼š</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span>
<span class="s2">        åŸå§‹å›å¤ï¼š</span><span class="si">{</span><span class="n">response</span><span class="si">}</span>

<span class="s2">        æ‰¹åˆ¤æ„è§ï¼š</span>
<span class="s2">        </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">critiques</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        è¯·æ ¹æ®æ‰¹åˆ¤æ„è§ä¿®è®¢å›å¤ï¼Œä½¿å…¶æ›´å¥½åœ°éµå¾ªåŸåˆ™ã€‚</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">revised</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">revision_prompt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">revised</span>

    <span class="k">def</span> <span class="nf">generate_preference_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ç”Ÿæˆè‡ªæˆ‘æ ‡æ³¨çš„åå¥½æ•°æ®</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">preference_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">:</span>
            <span class="c1"># ç”Ÿæˆåˆå§‹å›å¤</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

            <span class="c1"># è‡ªæˆ‘æ‰¹åˆ¤</span>
            <span class="n">critiques</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critique_response</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

            <span class="c1"># å¦‚æœæœ‰æ‰¹åˆ¤ï¼Œç”Ÿæˆä¿®è®¢ç‰ˆæœ¬</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">critiques</span><span class="p">):</span>
                <span class="n">revised</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">revise_response</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">critiques</span><span class="p">)</span>

                <span class="c1"># åˆ›å»ºåå¥½å¯¹ï¼ˆä¿®è®¢ç‰ˆæœ¬ &gt; åŸå§‹ç‰ˆæœ¬ï¼‰</span>
                <span class="n">preference_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;prompt&#39;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                    <span class="s1">&#39;chosen&#39;</span><span class="p">:</span> <span class="n">revised</span><span class="p">,</span>
                    <span class="s1">&#39;rejected&#39;</span><span class="p">:</span> <span class="n">response</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">preference_data</span>
</code></pre></div>

<h3 id="653-rlaif">6.5.3 RLAIFå®è·µ</h3>
<p>RLAIFï¼ˆRL from AI Feedbackï¼‰å®Œæ•´æµç¨‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RLAIFTrainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">critic_model</span><span class="p">,</span> <span class="n">principles</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critic</span> <span class="o">=</span> <span class="n">critic_model</span>  <span class="c1"># å¯ä»¥æ˜¯åŒä¸€ä¸ªæ¨¡å‹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">principles</span> <span class="o">=</span> <span class="n">principles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dpo_trainer</span> <span class="o">=</span> <span class="n">DPOTrainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">train_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">n_iterations</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RLAIFè¿­ä»£ </span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># 1. ç”Ÿæˆå›å¤</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

            <span class="c1"># 2. AIè¯„åˆ†å’Œæ’åº</span>
            <span class="n">scored_responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_responses</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>

            <span class="c1"># 3. æ„å»ºåå¥½æ•°æ®</span>
            <span class="n">preference_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_preferences</span><span class="p">(</span><span class="n">scored_responses</span><span class="p">)</span>

            <span class="c1"># 4. DPOè®­ç»ƒ</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">preference_data</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpo_trainer</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="c1"># 5. è¯„ä¼°æ”¹è¿›</span>
            <span class="n">improvement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_improvement</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æ”¹è¿›å¹…åº¦: </span><span class="si">{</span><span class="n">improvement</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">improvement</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># æ”¶æ•›</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">score_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">responses</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ä½¿ç”¨AIè¯„åˆ†å™¨ç»™å›å¤æ‰“åˆ†</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">responses</span><span class="p">):</span>
            <span class="n">score_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            æ ¹æ®ä»¥ä¸‹åŸåˆ™è¯„åˆ†ï¼ˆ1-10åˆ†ï¼‰ï¼š</span>
<span class="s2">            </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">principles</span><span class="si">}</span>

<span class="s2">            é—®é¢˜ï¼š</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span>
<span class="s2">            å›å¤ï¼š</span><span class="si">{</span><span class="n">response</span><span class="si">}</span>

<span class="s2">            è¯„åˆ†ï¼ˆåªè¿”å›æ•°å­—ï¼‰ï¼š</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">critic</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">score_prompt</span><span class="p">))</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">scores</span><span class="p">))</span>
</code></pre></div>

<h3 id="654">6.5.4 åŸåˆ™è®¾è®¡æœ€ä½³å®è·µ</h3>
<p><strong>åŸåˆ™å±‚æ¬¡ç»“æ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">CONSTITUTIONAL_PRINCIPLES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># ç¬¬ä¸€å±‚ï¼šå®‰å…¨æ€§åŸåˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰</span>
    <span class="s1">&#39;safety&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;ä¸æä¾›å¯èƒ½é€ æˆä¼¤å®³çš„ä¿¡æ¯&quot;</span><span class="p">,</span>
        <span class="s2">&quot;é¿å…ç”Ÿæˆæ­§è§†æ€§å†…å®¹&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ä¿æŠ¤ç”¨æˆ·éšç§&quot;</span>
    <span class="p">],</span>

    <span class="c1"># ç¬¬äºŒå±‚ï¼šæœ‰ç”¨æ€§åŸåˆ™</span>
    <span class="s1">&#39;helpfulness&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;æä¾›å‡†ç¡®çš„ä¿¡æ¯&quot;</span><span class="p">,</span>
        <span class="s2">&quot;å›ç­”è¦åˆ‡ä¸­è¦ç‚¹&quot;</span><span class="p">,</span>
        <span class="s2">&quot;æ‰¿è®¤ä¸ç¡®å®šæ€§&quot;</span>
    <span class="p">],</span>

    <span class="c1"># ç¬¬ä¸‰å±‚ï¼šé£æ ¼åŸåˆ™</span>
    <span class="s1">&#39;style&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;ä¿æŒä¸“ä¸šè¯­æ°”&quot;</span><span class="p">,</span>
        <span class="s2">&quot;é¿å…è¿‡åº¦è‡ªä¿¡&quot;</span><span class="p">,</span>
        <span class="s2">&quot;é€‚å½“ä½¿ç”¨ä¾‹å­&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">apply_principles_hierarchically</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">principles</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    åˆ†å±‚åº”ç”¨åŸåˆ™ï¼Œé«˜ä¼˜å…ˆçº§åŸåˆ™å¯è¦†ç›–ä½ä¼˜å…ˆçº§</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;safety&#39;</span><span class="p">,</span> <span class="s1">&#39;helpfulness&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">principle</span> <span class="ow">in</span> <span class="n">principles</span><span class="p">[</span><span class="n">level</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">violates_principle</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">principle</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;safety&#39;</span><span class="p">:</span>
                    <span class="c1"># å®‰å…¨é—®é¢˜å¿…é¡»ä¿®æ­£</span>
                    <span class="k">return</span> <span class="n">revise_for_safety</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">principle</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># å…¶ä»–é—®é¢˜å°è¯•ä¿®æ­£ä½†ä¸å¼ºåˆ¶</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">soft_revise</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">principle</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<h2 id="66">6.6 åœ¨çº¿ä¸ç¦»çº¿å¼ºåŒ–å­¦ä¹ çš„æƒè¡¡</h2>
<h3 id="661-vsrl">6.6.1 åœ¨çº¿vsç¦»çº¿RLçš„æœ¬è´¨åŒºåˆ«</h3>
<p><strong>åœ¨çº¿RL</strong>ï¼šæ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸æ–­ä¸ç¯å¢ƒäº¤äº’ï¼Œç”Ÿæˆæ–°æ•°æ®å¹¶ç«‹å³ä»ä¸­å­¦ä¹ ã€‚</p>
<p><strong>ç¦»çº¿RL</strong>ï¼šä»…ä½¿ç”¨é¢„å…ˆæ”¶é›†çš„å›ºå®šæ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œä¸ä¸ç¯å¢ƒå®æ—¶äº¤äº’ã€‚</p>
<div class="codehilite"><pre><span></span><code>åœ¨çº¿RLæµç¨‹ï¼š
ç­–ç•¥ â†’ ç”Ÿæˆ â†’ å¥–åŠ± â†’ æ›´æ–° â†’ ç­–ç•¥ï¼ˆå¾ªç¯ï¼‰

ç¦»çº¿RLæµç¨‹ï¼š
å›ºå®šæ•°æ®é›† â†’ è®­ç»ƒ â†’ ç­–ç•¥ï¼ˆä¸€æ¬¡æ€§ï¼‰
</code></pre></div>

<h3 id="662-rl">6.6.2 åœ¨çº¿RLçš„ä¼˜åŠ¿ä¸æŒ‘æˆ˜</h3>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ol>
<li><strong>æ¢ç´¢èƒ½åŠ›å¼º</strong>ï¼šèƒ½ä¸»åŠ¨æ¢ç´¢é«˜å¥–åŠ±åŒºåŸŸ</li>
<li><strong>é€‚åº”æ€§å¥½</strong>ï¼šå¿«é€Ÿé€‚åº”å¥–åŠ±å‡½æ•°å˜åŒ–</li>
<li><strong>æ— åˆ†å¸ƒåç§»</strong>ï¼šåœ¨è‡ªå·±çš„ç”Ÿæˆåˆ†å¸ƒä¸Šè®­ç»ƒ</li>
</ol>
<p><strong>æŒ‘æˆ˜</strong>ï¼š</p>
<ol>
<li><strong>è®¡ç®—æˆæœ¬é«˜</strong>ï¼šéœ€è¦å®æ—¶ç”Ÿæˆå’Œè¯„ä¼°</li>
<li><strong>ä¸ç¨³å®šæ€§</strong>ï¼šå®¹æ˜“å‡ºç°ç­–ç•¥å´©æºƒ</li>
<li><strong>å®‰å…¨é£é™©</strong>ï¼šå¯èƒ½ç”Ÿæˆæœ‰å®³å†…å®¹</li>
</ol>
<p><strong>åœ¨çº¿PPOå®ç°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">OnlinePPO</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">reward_model</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_model</span> <span class="o">=</span> <span class="n">reward_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>

    <span class="k">def</span> <span class="nf">collect_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        å®æ—¶æ”¶é›†è½¨è¿¹æ•°æ®</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trajectories</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
                <span class="c1"># åœ¨çº¿ç”Ÿæˆ</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

                <span class="c1"># å®æ—¶è®¡ç®—å¥–åŠ±</span>
                <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_model</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

                <span class="c1"># è®¡ç®—ä¼˜åŠ¿ï¼ˆéœ€è¦ä»·å€¼å‡½æ•°ï¼‰</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">value_head</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

                <span class="n">trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;prompt&#39;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                    <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
                    <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="n">reward</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                    <span class="s1">&#39;logprobs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">get_logprobs</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">trajectories</span>

    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">):</span>
        <span class="c1"># æ”¶é›†æ–°æ•°æ®</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_trajectories</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>

        <span class="c1"># æ›´æ–°ç¼“å†²åŒºï¼ˆFIFOï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">:]</span>

        <span class="c1"># åœ¨ç¼“å†²åŒºæ•°æ®ä¸Šè®­ç»ƒ</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">):</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppo_loss</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</code></pre></div>

<h3 id="663-rl">6.6.3 ç¦»çº¿RLçš„ä¼˜åŠ¿ä¸æŒ‘æˆ˜</h3>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ol>
<li><strong>å®‰å…¨å¯æ§</strong>ï¼šä¸ä¼šç”Ÿæˆæœªè§è¿‡çš„æœ‰å®³å†…å®¹</li>
<li><strong>è®¡ç®—é«˜æ•ˆ</strong>ï¼šæ•°æ®å¯é¢„å¤„ç†å’Œç¼“å­˜</li>
<li><strong>å¯é‡å¤æ€§</strong>ï¼šç›¸åŒæ•°æ®å¾—åˆ°ç›¸åŒç»“æœ</li>
</ol>
<p><strong>æŒ‘æˆ˜</strong>ï¼š</p>
<ol>
<li><strong>åˆ†å¸ƒåç§»</strong>ï¼šè®­ç»ƒå’Œéƒ¨ç½²åˆ†å¸ƒä¸åŒ¹é…</li>
<li><strong>æ•°æ®è´¨é‡ä¾èµ–</strong>ï¼šå®Œå…¨ä¾èµ–å†å²æ•°æ®è´¨é‡</li>
<li><strong>ä¿å®ˆæ€§</strong>ï¼šéš¾ä»¥è¶…è¶Šæ•°æ®é›†ä¸­çš„æœ€ä½³è¡¨ç°</li>
</ol>
<p><strong>ç¦»çº¿DPOå®ç°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">OfflineDPO</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="n">ref_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>  <span class="c1"># é¢„æ”¶é›†çš„åå¥½æ•°æ®</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        çº¯ç¦»çº¿è®­ç»ƒï¼Œä¸ç”Ÿæˆæ–°æ•°æ®</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                <span class="c1"># ä½¿ç”¨å›ºå®šæ•°æ®é›†</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dpo_loss</span><span class="p">(</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;prompts&#39;</span><span class="p">],</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;chosen&#39;</span><span class="p">],</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;rejected&#39;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

            <span class="c1"># ç¦»çº¿è¯„ä¼°</span>
            <span class="n">val_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_offline</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">: Val Loss = </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_importance_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        è®¡ç®—é‡è¦æ€§æƒé‡ä»¥ç¼“è§£åˆ†å¸ƒåç§»</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="c1"># å½“å‰ç­–ç•¥çš„æ¦‚ç‡</span>
            <span class="n">current_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_probs</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;prompts&#39;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;responses&#39;</span><span class="p">])</span>

            <span class="c1"># æ•°æ®æ”¶é›†æ—¶çš„æ¦‚ç‡ï¼ˆå¦‚æœæœ‰ï¼‰</span>
            <span class="n">old_probs</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_probs&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">current_probs</span><span class="p">))</span>

            <span class="c1"># é‡è¦æ€§æƒé‡</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">current_probs</span> <span class="o">/</span> <span class="p">(</span><span class="n">old_probs</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

            <span class="c1"># è£å‰ªé˜²æ­¢æƒé‡çˆ†ç‚¸</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">weights</span>
</code></pre></div>

<h3 id="664">6.6.4 æ··åˆç­–ç•¥ï¼šåŠåœ¨çº¿å­¦ä¹ </h3>
<p>ç»“åˆä¸¤è€…ä¼˜åŠ¿çš„å®ç”¨æ–¹æ¡ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SemiOnlineRL</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">offline_data</span><span class="p">,</span> <span class="n">online_ratio</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offline_data</span> <span class="o">=</span> <span class="n">offline_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span> <span class="o">=</span> <span class="n">online_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">online_buffer</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>

        <span class="c1"># 1. ç¦»çº¿æ•°æ®é‡‡æ ·</span>
        <span class="n">offline_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span><span class="p">))</span>
        <span class="n">offline_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_offline</span><span class="p">(</span><span class="n">offline_size</span><span class="p">)</span>

        <span class="c1"># 2. åœ¨çº¿æ•°æ®ç”Ÿæˆï¼ˆå°‘é‡ï¼‰</span>
        <span class="n">online_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">offline_size</span>
        <span class="n">online_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_online</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">[:</span><span class="n">online_size</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># 3. æ··åˆè®­ç»ƒ</span>
        <span class="n">combined_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_batches</span><span class="p">(</span>
            <span class="n">offline_batch</span><span class="p">,</span> 
            <span class="n">online_batch</span>
        <span class="p">)</span>

        <span class="c1"># 4. åŠ æƒæ›´æ–°</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_loss</span><span class="p">(</span><span class="n">combined_batch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">weighted_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        å¯¹åœ¨çº¿å’Œç¦»çº¿æ•°æ®ä½¿ç”¨ä¸åŒæƒé‡</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;online&#39;</span><span class="p">:</span>
                <span class="c1"># åœ¨çº¿æ•°æ®æƒé‡æ›´é«˜ï¼ˆæ›´å¯ä¿¡ï¼‰</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ç¦»çº¿æ•°æ®æƒé‡è¾ƒä½</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_loss</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>

<h3 id="665">6.6.5 å®ç”¨å†³ç­–æ¡†æ¶</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">choose_rl_strategy</span><span class="p">(</span><span class="n">constraints</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    æ ¹æ®å®é™…çº¦æŸé€‰æ‹©RLç­–ç•¥</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;safety_critical&#39;</span><span class="p">]:</span>
        <span class="c1"># å®‰å…¨è¦æ±‚é«˜ï¼Œä½¿ç”¨çº¯ç¦»çº¿</span>
        <span class="k">return</span> <span class="s1">&#39;offline&#39;</span><span class="p">,</span> <span class="s2">&quot;å®‰å…¨ç¬¬ä¸€ï¼Œé¿å…æœªçŸ¥é£é™©&quot;</span>

    <span class="k">elif</span> <span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;compute_budget&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># GPUå°æ—¶</span>
        <span class="c1"># è®¡ç®—é¢„ç®—æœ‰é™ï¼Œä½¿ç”¨ç¦»çº¿</span>
        <span class="k">return</span> <span class="s1">&#39;offline&#39;</span><span class="p">,</span> <span class="s2">&quot;è®¡ç®—èµ„æºå—é™&quot;</span>

    <span class="k">elif</span> <span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;data_quality&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>
        <span class="c1"># æ•°æ®è´¨é‡å·®ï¼Œéœ€è¦åœ¨çº¿æ¢ç´¢</span>
        <span class="k">return</span> <span class="s1">&#39;online&#39;</span><span class="p">,</span> <span class="s2">&quot;æ•°æ®è´¨é‡ä¸è¶³ï¼Œéœ€è¦ä¸»åŠ¨æ”¹è¿›&quot;</span>

    <span class="k">elif</span> <span class="n">constraints</span><span class="p">[</span><span class="s1">&#39;deployment_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span><span class="p">:</span>
        <span class="c1"># ç”Ÿäº§ç¯å¢ƒï¼Œä½¿ç”¨åŠåœ¨çº¿</span>
        <span class="k">return</span> <span class="s1">&#39;semi_online&#39;</span><span class="p">,</span> <span class="s2">&quot;å¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ç ”ç©¶ç¯å¢ƒï¼Œä½¿ç”¨åœ¨çº¿</span>
        <span class="k">return</span> <span class="s1">&#39;online&#39;</span><span class="p">,</span> <span class="s2">&quot;è¿½æ±‚æœ€ä½³æ€§èƒ½&quot;</span>
</code></pre></div>

<h3 id="666">6.6.6 åˆ†å¸ƒåç§»çš„ç¼“è§£æŠ€æœ¯</h3>
<p><strong>æŠ€æœ¯1ï¼šä¿å®ˆæ­£åˆ™åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">conservative_regularization</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">ref_policy</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CQL-styleä¿å®ˆæ­£åˆ™åŒ–ï¼Œé˜²æ­¢ç¦»çº¿RLè¿‡åº¦ä¹è§‚</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># è®¡ç®—OODï¼ˆout-of-distributionï¼‰åŠ¨ä½œçš„Qå€¼</span>
    <span class="n">ood_responses</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>  <span class="c1"># é«˜æ¸©é‡‡æ ·OOD</span>
    <span class="n">ood_q_values</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">q_function</span><span class="p">(</span><span class="n">ood_responses</span><span class="p">)</span>

    <span class="c1"># æƒ©ç½šOODåŠ¨ä½œçš„é«˜Qå€¼</span>
    <span class="n">conservative_loss</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">ood_q_values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">conservative_loss</span>
</code></pre></div>

<p><strong>æŠ€æœ¯2ï¼šåˆ†å¸ƒæ„ŸçŸ¥é‡‡æ ·</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DistributionAwareSampler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offline_data</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offline_data</span> <span class="o">=</span> <span class="n">offline_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="c1"># é¢„è®¡ç®—æ•°æ®åˆ†å¸ƒç‰¹å¾</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_embeddings</span><span class="p">(</span><span class="n">offline_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribution_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_embeddings</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sample_in_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ä¼˜å…ˆé‡‡æ ·åˆ†å¸ƒå†…çš„æ•°æ®</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="mi">5</span><span class="p">):</span>  <span class="c1"># è¿‡é‡‡æ ·</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
            <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_embedding</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

            <span class="c1"># è®¡ç®—ä¸è®­ç»ƒåˆ†å¸ƒçš„è·ç¦»</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_distance</span><span class="p">(</span>
                <span class="n">embedding</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">distribution_stats</span>
            <span class="p">)</span>

            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">response</span><span class="p">,</span> <span class="n">distance</span><span class="p">))</span>

        <span class="c1"># é€‰æ‹©æœ€æ¥è¿‘è®­ç»ƒåˆ†å¸ƒçš„æ ·æœ¬</span>
        <span class="n">candidates</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">[:</span><span class="n">n_samples</span><span class="p">]]</span>
</code></pre></div>

<h2 id="_2">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†åŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ ï¼ˆRLHFï¼‰åŠå…¶å˜ä½“åœ¨å¤§è¯­è¨€æ¨¡å‹åè®­ç»ƒä¸­çš„åº”ç”¨ã€‚æˆ‘ä»¬å­¦ä¹ äº†ï¼š</p>
<h3 id="_3">æ ¸å¿ƒæ¦‚å¿µå›é¡¾</h3>
<ol>
<li>
<p><strong>RLHFçš„ä¸‰å¤§æ”¯æŸ±</strong>ï¼š
   - å¥–åŠ±æ¨¡å‹ï¼šå°†äººç±»åå¥½è½¬åŒ–ä¸ºå¯ä¼˜åŒ–çš„æ ‡é‡ä¿¡å·
   - ç­–ç•¥ä¼˜åŒ–ï¼šé€šè¿‡PPOç­‰ç®—æ³•æœ€å¤§åŒ–æœŸæœ›å¥–åŠ±
   - KLçº¦æŸï¼šé˜²æ­¢æ¨¡å‹åç¦»åˆå§‹åˆ†å¸ƒè¿‡è¿œ</p>
</li>
<li>
<p><strong>å…³é”®ç®—æ³•å¯¹æ¯”</strong>ï¼š
   - <strong>PPO</strong>ï¼šç¨³å®šä½†è®¡ç®—å¯†é›†ï¼Œéœ€è¦æ˜¾å¼å¥–åŠ±æ¨¡å‹
   - <strong>DPO</strong>ï¼šç›´æ¥ä¼˜åŒ–ï¼Œè®­ç»ƒé«˜æ•ˆä½†å¯èƒ½è¿‡æ‹Ÿåˆ
   - <strong>IPO</strong>ï¼šæ›´é²æ£’ä½†æ”¶æ•›è¾ƒæ…¢
   - <strong>Constitutional AI</strong>ï¼šè‡ªæˆ‘æ”¹è¿›ï¼Œå‡å°‘äººå·¥æ ‡æ³¨</p>
</li>
<li>
<p><strong>å®ç”¨æƒè¡¡</strong>ï¼š
   - åœ¨çº¿RLï¼šæ¢ç´¢èƒ½åŠ›å¼ºä½†æˆæœ¬é«˜
   - ç¦»çº¿RLï¼šå®‰å…¨é«˜æ•ˆä½†å—é™äºæ•°æ®è´¨é‡
   - æ··åˆç­–ç•¥ï¼šå¹³è¡¡æ¢ç´¢ä¸å®‰å…¨æ€§</p>
</li>
</ol>
<h3 id="_4">å…³é”®å…¬å¼æ±‡æ€»</h3>
<p><strong>Bradley-Terryåå¥½æ¨¡å‹</strong>ï¼š
$$P(A \succ B) = \sigma(r(A) - r(B))$$
<strong>PPOç›®æ ‡å‡½æ•°</strong>ï¼š
$$\mathcal{L}_{PPO} = \min(r_t(\theta)\hat{A}_t, \text{clip}(r_t(\theta), 1-\epsilon, 1+\epsilon)\hat{A}_t)$$
<strong>DPOæŸå¤±å‡½æ•°</strong>ï¼š
$$\mathcal{L}_{DPO} = -\log\sigma\left(\beta\log\frac{\pi_\theta(y_w|x)}{\pi_{ref}(y_w|x)} - \beta\log\frac{\pi_\theta(y_l|x)}{\pi_{ref}(y_l|x)}\right)$$</p>
<h3 id="_5">å®è·µè¦ç‚¹</h3>
<ol>
<li><strong>å¥–åŠ±æ¨¡å‹è®­ç»ƒ</strong>ï¼šä½¿ç”¨é›†æˆå’Œæ ¡å‡†æŠ€æœ¯æé«˜é²æ£’æ€§</li>
<li><strong>PPOè°ƒä¼˜</strong>ï¼šç›‘æ§KLæ•£åº¦å’Œè£å‰ªæ¯”ä¾‹ï¼Œé‡‡ç”¨æ¸è¿›å¼è®­ç»ƒ</li>
<li><strong>DPO/IPOé€‰æ‹©</strong>ï¼šæ ¹æ®æ•°æ®è´¨é‡å’Œæ ‡æ³¨ä¸€è‡´æ€§é€‰æ‹©</li>
<li><strong>åœ¨çº¿/ç¦»çº¿å†³ç­–</strong>ï¼šåŸºäºå®‰å…¨éœ€æ±‚å’Œè®¡ç®—é¢„ç®—æƒè¡¡</li>
</ol>
<h2 id="_6">ç»ƒä¹ é¢˜</h2>
<h3 id="_7">åŸºç¡€é¢˜ï¼ˆç†è§£æ¦‚å¿µï¼‰</h3>
<p><strong>ç»ƒä¹ 6.1ï¼šå¥–åŠ±æ¨¡å‹è®¾è®¡</strong>
è®¾è®¡ä¸€ä¸ªå¥–åŠ±æ¨¡å‹æ¶æ„ï¼Œç”¨äºè¯„ä¼°ä»£ç ç”Ÿæˆä»»åŠ¡çš„è´¨é‡ã€‚è€ƒè™‘å¦‚ä½•å¤„ç†è¯­æ³•æ­£ç¡®æ€§ã€åŠŸèƒ½å®Œæ•´æ€§å’Œä»£ç é£æ ¼ç­‰å¤šä¸ªç»´åº¦ã€‚</p>
<details>
<summary>æç¤ºï¼ˆHintï¼‰</summary>
<p>è€ƒè™‘å¤šå¤´æ¶æ„ï¼Œæ¯ä¸ªå¤´è´Ÿè´£ä¸€ä¸ªè´¨é‡ç»´åº¦ï¼Œæœ€ç»ˆåŠ æƒç»„åˆã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å¥–åŠ±æ¨¡å‹åº”åŒ…å«ï¼š</p>
<ol>
<li>è¯­æ³•æ£€æŸ¥å¤´ï¼šä½¿ç”¨ASTè§£æéªŒè¯è¯­æ³•æ­£ç¡®æ€§ï¼ˆäºŒå€¼è¾“å‡ºï¼‰</li>
<li>åŠŸèƒ½è¯„ä¼°å¤´ï¼šé€šè¿‡æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œè¯„ä¼°åŠŸèƒ½å®Œæ•´æ€§ï¼ˆ0-1è¿ç»­å€¼ï¼‰</li>
<li>é£æ ¼è¯„åˆ†å¤´ï¼šåŸºäºä»£ç è§„èŒƒæ£€æŸ¥å·¥å…·çš„è¾“å‡ºï¼ˆ0-1è¿ç»­å€¼ï¼‰</li>
<li>æ•ˆç‡è¯„ä¼°å¤´ï¼šåˆ†ææ—¶é—´/ç©ºé—´å¤æ‚åº¦ï¼ˆå¯é€‰ï¼‰</li>
</ol>
<p>æœ€ç»ˆå¥–åŠ± = w1Ã—è¯­æ³• + w2Ã—åŠŸèƒ½ + w3Ã—é£æ ¼ + w4Ã—æ•ˆç‡</p>
<p>å…¶ä¸­æƒé‡å¯ä»¥æ ¹æ®ä»»åŠ¡éœ€æ±‚è°ƒæ•´ï¼Œå¦‚ç”Ÿäº§ä»£ç æ›´é‡è§†åŠŸèƒ½å’Œè¯­æ³•ï¼Œæ•™å­¦ä»£ç æ›´é‡è§†é£æ ¼ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 6.2ï¼šKLæ•£åº¦è®¡ç®—</strong>
ç»™å®šå‚è€ƒåˆ†å¸ƒ $p_{ref} = [0.1, 0.2, 0.3, 0.4]$ å’Œå½“å‰åˆ†å¸ƒ $p_{\theta} = [0.15, 0.25, 0.35, 0.25]$ï¼Œè®¡ç®—KLæ•£åº¦ $D_{KL}(p_{\theta} || p_{ref})$ã€‚</p>
<details>
<summary>æç¤ºï¼ˆHintï¼‰</summary>
<p>ä½¿ç”¨å…¬å¼ï¼š$D_{KL}(p||q) = \sum_i p_i \log(p_i/q_i)$</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>$D_{KL}(p_{\theta} || p_{ref}) = \sum_i p_{\theta,i} \log(p_{\theta,i}/p_{ref,i})$</p>
<p>= 0.15Ã—log(0.15/0.1) + 0.25Ã—log(0.25/0.2) + 0.35Ã—log(0.35/0.3) + 0.25Ã—log(0.25/0.4)
= 0.15Ã—0.405 + 0.25Ã—0.223 + 0.35Ã—0.155 + 0.25Ã—(-0.470)
= 0.061 + 0.056 + 0.054 - 0.118
= 0.053</p>
<p>KLæ•£åº¦çº¦ä¸º0.053ï¼Œè¡¨ç¤ºä¸¤ä¸ªåˆ†å¸ƒç›¸å¯¹æ¥è¿‘ã€‚</p>
</details>
<p><strong>ç»ƒä¹ 6.3ï¼šDPO vs PPOåœºæ™¯é€‰æ‹©</strong>
åˆ—ä¸¾ä¸‰ä¸ªé€‚åˆä½¿ç”¨DPOè€ŒéPPOçš„å…·ä½“åœºæ™¯ï¼Œå¹¶è¯´æ˜åŸå› ã€‚</p>
<details>
<summary>æç¤ºï¼ˆHintï¼‰</summary>
<p>è€ƒè™‘è®¡ç®—èµ„æºã€æ•°æ®å¯ç”¨æ€§å’Œè®­ç»ƒç¨³å®šæ€§ç­‰å› ç´ ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<ol>
<li>
<p><strong>å­¦æœ¯ç ”ç©¶ç¯å¢ƒ</strong>ï¼šè®¡ç®—èµ„æºæœ‰é™ï¼ŒDPOä¸éœ€è¦è®­ç»ƒç‹¬ç«‹çš„å¥–åŠ±æ¨¡å‹ï¼ŒèŠ‚çœGPUå†…å­˜å’Œè®­ç»ƒæ—¶é—´ã€‚</p>
</li>
<li>
<p><strong>é«˜è´¨é‡åå¥½æ•°æ®å……è¶³</strong>ï¼šå·²æœ‰å¤§é‡äººå·¥æ ‡æ³¨çš„åå¥½å¯¹ï¼Œä¸”æ ‡æ³¨ä¸€è‡´æ€§é«˜ï¼ˆ&gt;85%ï¼‰ï¼ŒDPOå¯ä»¥ç›´æ¥åˆ©ç”¨è¿™äº›æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>å¿«é€ŸåŸå‹éªŒè¯</strong>ï¼šéœ€è¦å¿«é€ŸéªŒè¯å¯¹é½æ–¹æ³•çš„æ•ˆæœï¼ŒDPOå®ç°ç®€å•ï¼Œæ”¶æ•›å¿«ï¼Œé€‚åˆå¿«é€Ÿè¿­ä»£ã€‚</p>
</li>
</ol>
<p>ä¸é€‚åˆDPOçš„åœºæ™¯ï¼šæ ‡æ³¨å™ªå£°å¤§ã€éœ€è¦åœ¨çº¿æ¢ç´¢ã€å®‰å…¨æ€§è¦æ±‚æé«˜çš„åœºæ™¯ã€‚</p>
</details>
<h3 id="_8">æŒ‘æˆ˜é¢˜ï¼ˆæ·±å…¥æ€è€ƒï¼‰</h3>
<p><strong>ç»ƒä¹ 6.4ï¼šå¥–åŠ±è¿‡æ‹Ÿåˆæ£€æµ‹</strong>
è®¾è®¡ä¸€ä¸ªæ–¹æ³•æ¥è‡ªåŠ¨æ£€æµ‹RLHFè®­ç»ƒè¿‡ç¨‹ä¸­çš„å¥–åŠ±è¿‡æ‹Ÿåˆï¼ˆreward hackingï¼‰ç°è±¡ã€‚</p>
<details>
<summary>æç¤ºï¼ˆHintï¼‰</summary>
<p>è€ƒè™‘ç›‘æ§å¤šä¸ªæŒ‡æ ‡çš„ç›¸å…³æ€§å˜åŒ–ï¼Œå¦‚å¥–åŠ±å€¼ä¸äººç±»è¯„ä¼°çš„ç›¸å…³æ€§ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å¥–åŠ±è¿‡æ‹Ÿåˆæ£€æµ‹ç³»ç»Ÿï¼š</p>
<ol>
<li>
<p><strong>æŒ‡æ ‡ç›‘æ§</strong>ï¼š
   - å¥–åŠ±å€¼è¶‹åŠ¿ï¼šå¦‚æœå¥–åŠ±æŒç»­ä¸Šå‡ä½†éªŒè¯é›†æ€§èƒ½ä¸‹é™
   - å“åº”é•¿åº¦åˆ†å¸ƒï¼šçªç„¶å˜é•¿å¯èƒ½è¡¨ç¤ºåœ¨åˆ©ç”¨é•¿åº¦åå¥½
   - è¯æ±‡å¤šæ ·æ€§ï¼šä¸‹é™è¡¨ç¤ºæ¨¡å‹åœ¨é‡å¤ç‰¹å®šæ¨¡å¼</p>
</li>
<li>
<p><strong>å¯¹æŠ—æµ‹è¯•</strong>ï¼š
   - å®šæœŸç”Ÿæˆå¯¹æŠ—æ ·æœ¬ï¼Œæ£€æŸ¥å¥–åŠ±æ¨¡å‹æ˜¯å¦ç»™äºˆä¸åˆç†é«˜åˆ†
   - ä½¿ç”¨ç®€å•çš„é‡å¤æ¨¡å¼æµ‹è¯•ï¼Œå¦‚"éå¸¸å¥½éå¸¸å¥½..."</p>
</li>
<li>
<p><strong>äººç±»è¯„ä¼°å¯¹æ¯”</strong>ï¼š
   - å®šæœŸæŠ½æ ·è¿›è¡Œäººç±»è¯„ä¼°
   - è®¡ç®—å¥–åŠ±å€¼ä¸äººç±»è¯„åˆ†çš„Spearmanç›¸å…³ç³»æ•°
   - ç›¸å…³æ€§ä¸‹é™æ˜¯è¿‡æ‹Ÿåˆçš„å¼ºä¿¡å·</p>
</li>
<li>
<p><strong>è‡ªåŠ¨åŒ–æ£€æµ‹è§„åˆ™</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="n">reward_increase</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="o">%</span> <span class="ow">and</span> 
    <span class="n">human_eval_correlation</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="ow">and</span>
    <span class="n">response_length_std</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">initial_std</span><span class="p">):</span>
    <span class="n">trigger_alert</span><span class="p">(</span><span class="s2">&quot;å¯èƒ½çš„å¥–åŠ±è¿‡æ‹Ÿåˆ&quot;</span><span class="p">)</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹ 6.5ï¼šConstitutional AIåŸåˆ™è®¾è®¡</strong>
ä¸ºä¸€ä¸ªåŒ»ç–—å’¨è¯¢AIåŠ©æ‰‹è®¾è®¡ä¸€å¥—å®ªæ³•åŸåˆ™å±‚æ¬¡ç»“æ„ï¼Œç¡®ä¿å®‰å…¨æ€§ã€å‡†ç¡®æ€§å’Œæœ‰ç”¨æ€§çš„å¹³è¡¡ã€‚</p>
<details>
<summary>æç¤ºï¼ˆHintï¼‰</summary>
<p>è€ƒè™‘åŒ»ç–—é¢†åŸŸçš„ç‰¹æ®Šæ€§ï¼šé”™è¯¯ä¿¡æ¯çš„ä¸¥é‡åæœã€æ³•å¾‹è´£ä»»ã€æ‚£è€…éšç§ç­‰ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>åŒ»ç–—AIå®ªæ³•åŸåˆ™å±‚æ¬¡ï¼š</p>
<p><strong>ç¬¬ä¸€å±‚ï¼šå®‰å…¨æ€§ï¼ˆä¸å¯è¿åï¼‰</strong></p>
<ol>
<li>ç»ä¸æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­</li>
<li>å±æ€¥æƒ…å†µå¿…é¡»å»ºè®®ç«‹å³å°±åŒ»</li>
<li>ä¸æ¨èæœªç»éªŒè¯çš„æ²»ç–—æ–¹æ³•</li>
<li>ä¸¥æ ¼ä¿æŠ¤æ‚£è€…éšç§ä¿¡æ¯</li>
</ol>
<p><strong>ç¬¬äºŒå±‚ï¼šå‡†ç¡®æ€§ï¼ˆå¼ºçº¦æŸï¼‰</strong></p>
<ol>
<li>å¼•ç”¨ä¿¡æ¯å¿…é¡»æ¥è‡ªå¯é åŒ»å­¦æ¥æº</li>
<li>æ˜ç¡®åŒºåˆ†å¸¸è§æƒ…å†µå’Œéœ€è¦ä¸“ä¸šè¯„ä¼°çš„æƒ…å†µ</li>
<li>æ‰¿è®¤åŒ»å­¦ä¸ç¡®å®šæ€§ï¼Œé¿å…ç»å¯¹åŒ–è¡¨è¿°</li>
<li>çº æ­£æ˜æ˜¾çš„åŒ»å­¦è¯¯è§£</li>
</ol>
<p><strong>ç¬¬ä¸‰å±‚ï¼šæœ‰ç”¨æ€§ï¼ˆè½¯çº¦æŸï¼‰</strong></p>
<ol>
<li>æä¾›æ˜“æ‡‚çš„åŒ»å­¦çŸ¥è¯†è§£é‡Š</li>
<li>ç»™å‡ºåˆç†çš„å¥åº·ç”Ÿæ´»å»ºè®®</li>
<li>å¸®åŠ©å‡†å¤‡å°±åŒ»é—®é¢˜æ¸…å•</li>
<li>æä¾›æƒ…ç»ªæ”¯æŒå’Œå®‰æ…°</li>
</ol>
<p><strong>å®æ–½ç­–ç•¥</strong>ï¼š</p>
<ul>
<li>ç¬¬ä¸€å±‚è¿å â†’ ç«‹å³æ‹’ç»è¾“å‡º</li>
<li>ç¬¬äºŒå±‚è¿å â†’ å¼ºåˆ¶ä¿®æ”¹ç›´åˆ°æ»¡è¶³</li>
<li>ç¬¬ä¸‰å±‚è¿å â†’ å°è¯•æ”¹è¿›ä½†å¯æ¥å—</li>
</ul>
</details>
<p><strong>ç»ƒä¹ 6.6ï¼šåœ¨çº¿ç¦»çº¿RLæ··åˆç­–ç•¥</strong>
è®¾è®¡ä¸€ä¸ªè‡ªé€‚åº”çš„åœ¨çº¿/ç¦»çº¿RLæ··åˆè®­ç»ƒç­–ç•¥ï¼Œèƒ½å¤Ÿæ ¹æ®è®­ç»ƒè¿‡ç¨‹ä¸­çš„è¡¨ç°åŠ¨æ€è°ƒæ•´åœ¨çº¿æ•°æ®çš„æ¯”ä¾‹ã€‚</p>
<details>
<summary>æç¤ºï¼ˆHintï¼‰</summary>
<p>è€ƒè™‘ä½¿ç”¨éªŒè¯é›†æ€§èƒ½ã€KLæ•£åº¦ã€è®¡ç®—æˆæœ¬ç­‰ä¿¡å·æ¥è°ƒæ•´æ··åˆæ¯”ä¾‹ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>è‡ªé€‚åº”æ··åˆç­–ç•¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AdaptiveMixedRL</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># åˆå§‹10%åœ¨çº¿</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">adjust_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
        <span class="c1"># 1. æ€§èƒ½æ”¹è¿›ç‡</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">recent_improvement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]))</span>

            <span class="k">if</span> <span class="n">recent_improvement</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>  <span class="c1"># æ€§èƒ½åœæ»</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="c1"># 2. KLæ•£åº¦ç›‘æ§</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;kl_divergence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># KLè¿‡å¤§</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>

        <span class="c1"># 3. è®¡ç®—é¢„ç®—çº¦æŸ</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;compute_usage&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>  <span class="c1"># æ¥è¿‘é¢„ç®—ä¸Šé™</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># 4. æ•°æ®åˆ†å¸ƒåŒ¹é…åº¦</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;distribution_shift&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>  <span class="c1"># åˆ†å¸ƒåç§»ä¸¥é‡</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">online_ratio</span>
</code></pre></div>

<p><strong>åŠ¨æ€è°ƒæ•´è§„åˆ™</strong>ï¼š</p>
<ol>
<li>åˆå§‹é˜¶æ®µï¼ˆå‰1000æ­¥ï¼‰ï¼šçº¯ç¦»çº¿ï¼Œå»ºç«‹åŸºçº¿</li>
<li>æ¢ç´¢é˜¶æ®µï¼ˆ1000-5000æ­¥ï¼‰ï¼šé€æ­¥å¢åŠ åœ¨çº¿æ¯”ä¾‹</li>
<li>ç¨³å®šé˜¶æ®µï¼ˆ5000+æ­¥ï¼‰ï¼šæ ¹æ®æ€§èƒ½è‡ªé€‚åº”è°ƒæ•´</li>
<li>å¼‚å¸¸å¤„ç†ï¼šæ£€æµ‹åˆ°è®­ç»ƒä¸ç¨³å®šæ—¶å¿«é€Ÿé™ä½åœ¨çº¿æ¯”ä¾‹</li>
</ol>
</details>
<p><strong>ç»ƒä¹ 6.7ï¼šå¤šç›®æ ‡RLHFä¼˜åŒ–</strong>
è®¾è®¡ä¸€ä¸ªæ–¹æ³•æ¥åŒæ—¶ä¼˜åŒ–å¤šä¸ªå¯èƒ½å†²çªçš„ç›®æ ‡ï¼ˆå¦‚æœ‰ç”¨æ€§ã€å®‰å…¨æ€§ã€åˆ›é€ æ€§ï¼‰ï¼Œå¹¶å¤„ç†å®ƒä»¬ä¹‹é—´çš„æƒè¡¡ã€‚</p>
<details>
<summary>æç¤ºï¼ˆHintï¼‰</summary>
<p>è€ƒè™‘Paretoä¼˜åŒ–ã€å¤šå¥–åŠ±æ¨¡å‹ã€æ¡ä»¶è®­ç»ƒç­‰æ–¹æ³•ã€‚</p>
</details>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å¤šç›®æ ‡RLHFæ¡†æ¶ï¼š</p>
<ol>
<li><strong>å¤šå¥–åŠ±æ¨¡å‹æ¶æ„</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiObjectiveRLHF</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_models</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;helpfulness&#39;</span><span class="p">:</span> <span class="n">RewardModel</span><span class="p">(),</span>
            <span class="s1">&#39;safety&#39;</span><span class="p">:</span> <span class="n">RewardModel</span><span class="p">(),</span>
            <span class="s1">&#39;creativity&#39;</span><span class="p">:</span> <span class="n">RewardModel</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;helpfulness&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;safety&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;creativity&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">compute_pareto_rewards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">responses</span><span class="p">):</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rewards</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>

        <span class="c1"># è®¡ç®—Paretoå‰æ²¿</span>
        <span class="n">pareto_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pareto_optimal</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">pareto_mask</span>
</code></pre></div>

<ol start="2">
<li><strong>åŠ¨æ€æƒé‡è°ƒæ•´</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">adjust_weights_by_context</span><span class="p">(</span><span class="n">prompt_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s1">&#39;medical&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;safety&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;helpfulness&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;creativity&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">prompt_type</span> <span class="o">==</span> <span class="s1">&#39;creative_writing&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;creativity&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span> <span class="s1">&#39;helpfulness&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;safety&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;helpfulness&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;safety&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;creativity&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>æ¡ä»¶å¥–åŠ±å‡½æ•°</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">conditional_reward</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">base_rewards</span> <span class="o">=</span> <span class="n">compute_base_rewards</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">objectives</span><span class="p">)</span>

    <span class="c1"># ç¡¬çº¦æŸï¼šå®‰å…¨æ€§ä½äºé˜ˆå€¼æ—¶ä¸¥é‡æƒ©ç½š</span>
    <span class="k">if</span> <span class="n">base_rewards</span><span class="p">[</span><span class="s1">&#39;safety&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">10.0</span>

    <span class="c1"># è½¯çº¦æŸï¼šæ ¹æ®ä¸Šä¸‹æ–‡åŠ æƒ</span>
    <span class="n">weighted_reward</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">base_rewards</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span> 
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">context_weights</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">weighted_reward</span>
</code></pre></div>

<ol start="4">
<li><strong>å¤šç­–ç•¥é›†æˆ</strong>ï¼š
è®­ç»ƒå¤šä¸ªä¸“é—¨åŒ–çš„ç­–ç•¥ï¼Œæ¨ç†æ—¶æ ¹æ®éœ€æ±‚é€‰æ‹©æˆ–æ’å€¼ã€‚</li>
</ol>
</details>
<h2 id="_9">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1">1. å¥–åŠ±æ¨¡å‹è¿‡æ‹Ÿåˆ</h3>
<p><strong>é”™è¯¯è¡¨ç°</strong>ï¼š</p>
<ul>
<li>å¥–åŠ±å€¼æŒç»­ä¸Šå‡ä½†å®é™…è´¨é‡ä¸‹é™</li>
<li>æ¨¡å‹è¾“å‡ºå˜å¾—å•ä¸€åŒ–ï¼ˆå¦‚æ€»æ˜¯ç”Ÿæˆæé•¿å›å¤ï¼‰</li>
</ul>
<p><strong>è°ƒè¯•æ–¹æ³•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ£€æµ‹å¥–åŠ±è¿‡æ‹Ÿåˆ</span>
<span class="k">def</span> <span class="nf">detect_reward_overfitting</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">reward_model</span><span class="p">,</span> <span class="n">test_prompts</span><span class="p">):</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">test_prompts</span><span class="p">)</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="n">reward_model</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>

    <span class="c1"># æ£€æŸ¥1ï¼šå¥–åŠ±åˆ†å¸ƒæ˜¯å¦å¼‚å¸¸é›†ä¸­</span>
    <span class="k">if</span> <span class="n">rewards</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;è­¦å‘Šï¼šå¥–åŠ±åˆ†å¸ƒè¿‡äºé›†ä¸­&quot;</span><span class="p">)</span>

    <span class="c1"># æ£€æŸ¥2ï¼šå“åº”é•¿åº¦æ˜¯å¦å¼‚å¸¸</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">expected_length</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;è­¦å‘Šï¼šå“åº”é•¿åº¦å¼‚å¸¸&quot;</span><span class="p">)</span>

    <span class="c1"># æ£€æŸ¥3ï¼šè¯æ±‡å¤šæ ·æ€§</span>
    <span class="n">vocab_diversity</span> <span class="o">=</span> <span class="n">compute_vocab_diversity</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vocab_diversity</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;è­¦å‘Šï¼šè¯æ±‡å¤šæ ·æ€§è¿‡ä½&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2-kl">2. KLæ•£åº¦çˆ†ç‚¸</h3>
<p><strong>é”™è¯¯è¡¨ç°</strong>ï¼š</p>
<ul>
<li>è®­ç»ƒåæ¨¡å‹è¡Œä¸ºå®Œå…¨æ”¹å˜</li>
<li>å¤±å»åŸºç¡€èƒ½åŠ›ï¼ˆå¦‚è¯­æ³•æ­£ç¡®æ€§ï¼‰</li>
</ul>
<p><strong>é¢„é˜²æªæ–½</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨è‡ªé€‚åº”KLç³»æ•°</li>
<li>è®¾ç½®KLæ•£åº¦ç¡¬ä¸Šé™</li>
<li>å®šæœŸé‡ç½®åˆ°checkpoint</li>
</ul>
<h3 id="3-dpo">3. DPOè®­ç»ƒä¸ç¨³å®š</h3>
<p><strong>é”™è¯¯è¡¨ç°</strong>ï¼š</p>
<ul>
<li>æŸå¤±éœ‡è¡ä¸æ”¶æ•›</li>
<li>chosenå’Œrejectedçš„æ¦‚ç‡éƒ½è¶‹å‘äº0</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>é™ä½å­¦ä¹ ç‡ï¼ˆé€šå¸¸5e-7ä»¥ä¸‹ï¼‰</li>
<li>å¢åŠ Î²å‚æ•°ï¼ˆæé«˜æ­£åˆ™åŒ–ï¼‰</li>
<li>è¿‡æ»¤ä½è´¨é‡åå¥½å¯¹</li>
</ul>
<h3 id="4-constitutional-ai">4. Constitutional AIçš„åŸåˆ™å†²çª</h3>
<p><strong>é”™è¯¯è¡¨ç°</strong>ï¼š</p>
<ul>
<li>æ¨¡å‹åœ¨æ»¡è¶³ä¸€ä¸ªåŸåˆ™æ—¶è¿åå¦ä¸€ä¸ª</li>
<li>è¾“å‡ºå˜å¾—è¿‡äºä¿å®ˆæˆ–æ¨¡ç³Š</li>
</ul>
<p><strong>å¤„ç†æ–¹æ³•</strong>ï¼š</p>
<ul>
<li>å»ºç«‹æ¸…æ™°çš„åŸåˆ™ä¼˜å…ˆçº§</li>
<li>ä½¿ç”¨åˆ†å±‚åŸåˆ™ç»“æ„</li>
<li>å®šæœŸå®¡æŸ¥å’Œè°ƒæ•´åŸåˆ™</li>
</ul>
<h3 id="5-rl">5. åœ¨çº¿RLçš„è®¡ç®—çˆ†ç‚¸</h3>
<p><strong>é”™è¯¯è¡¨ç°</strong>ï¼š</p>
<ul>
<li>è®­ç»ƒæ—¶é—´æŒ‡æ•°å¢é•¿</li>
<li>GPUå†…å­˜æº¢å‡º</li>
</ul>
<p><strong>ä¼˜åŒ–æŠ€å·§</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ç»éªŒå›æ”¾ç¼“å†²åŒº</li>
<li>æ‰¹é‡ç”Ÿæˆå’Œè¯„ä¼°</li>
<li>å®æ–½æ—©åœæœºåˆ¶</li>
</ul>
<p>ğŸ’¡ <strong>æœ€ä½³å®è·µå»ºè®®</strong>ï¼š</p>
<ol>
<li>å§‹ç»ˆä¿ç•™SFTæ£€æŸ¥ç‚¹ä½œä¸ºå›é€€æ–¹æ¡ˆ</li>
<li>ä½¿ç”¨å¤šä¸ªç‹¬ç«‹çš„è¯„ä¼°æŒ‡æ ‡</li>
<li>å®šæœŸè¿›è¡Œäººå·¥è¯„ä¼°éªŒè¯</li>
<li>è®°å½•è¯¦ç»†çš„å®éªŒæ—¥å¿—ä¾¿äºè°ƒè¯•</li>
<li>ä»å°è§„æ¨¡å®éªŒå¼€å§‹é€æ­¥æ‰©å¤§</li>
</ol>
            </article>
            
            <nav class="page-nav"><a href="chapter5.html" class="nav-link prev">â† ç¬¬äº”ç« ï¼šå¤šæ¨¡æ€ä»»åŠ¡å®éªŒè®¾è®¡</a><a href="chapter7.html" class="nav-link next">ç¬¬ä¸ƒç« ï¼šè®­ç»ƒå¾ªç¯ä¸è¿­ä»£ä¼˜åŒ– â†’</a></nav>
        </main>
    </div>
</body>
</html>