<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬äºŒç« ï¼šå®éªŒä»£ç åŸºç¡€è®¾æ–½</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">LLM åè®­ç»ƒå®éªŒè®¾è®¡æŒ‡å—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸€ç« ï¼šåè®­ç»ƒåŸºç¡€ç†è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äºŒç« ï¼šå®éªŒä»£ç åŸºç¡€è®¾æ–½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸‰ç« ï¼šæ•°æ®å·¥ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å››ç« ï¼šçº¯è¯­è¨€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äº”ç« ï¼šå¤šæ¨¡æ€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…­ç« ï¼šå¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸ƒç« ï¼šè®­ç»ƒå¾ªç¯ä¸è¿­ä»£ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…«ç« ï¼šè¯„ä¼°ä¸åŸºå‡†æµ‹è¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¹ç« ï¼šç”Ÿäº§éƒ¨ç½²ä¸ç›‘æ§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬åç« ï¼šæ¡ˆä¾‹ç ”ç©¶ä¸æœ€ä½³å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="_1">ç¬¬äºŒç« ï¼šå®éªŒä»£ç åŸºç¡€è®¾æ–½</h1>
<p>æ„å»ºå¯ç»´æŠ¤ã€å¯æ‰©å±•çš„å®éªŒä»£ç æ¶æ„æ˜¯æˆåŠŸè¿›è¡Œ LLM åè®­ç»ƒçš„åŸºçŸ³ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨å¦‚ä½•è®¾è®¡å’Œå®ç°ä¸€ä¸ªå¥å£®çš„å®éªŒåŸºç¡€è®¾æ–½ï¼Œæ¶µç›–é…ç½®ç®¡ç†ã€ç‰ˆæœ¬æ§åˆ¶ã€å®éªŒè¿½è¸ªç­‰å…³é”®ç»„ä»¶ã€‚æˆ‘ä»¬å°†é‡ç‚¹è§£å†³å®é™…å·¥ç¨‹ä¸­çš„æŒ‘æˆ˜ï¼šå¦‚ä½•åœ¨å¿«é€Ÿè¿­ä»£çš„åŒæ—¶ä¿æŒä»£ç è´¨é‡ï¼Œå¦‚ä½•ç®¡ç†æ•°ç™¾ä¸ªå®éªŒçš„é…ç½®å’Œç»“æœï¼Œä»¥åŠå¦‚ä½•é˜²æ­¢æŠ€æœ¯å€ºåŠ¡çš„ç´¯ç§¯ã€‚</p>
<h2 id="21">2.1 å®éªŒé…ç½®ç®¡ç†</h2>
<h3 id="_2">é…ç½®æ–‡ä»¶æ ¼å¼é€‰æ‹©</h3>
<p>åœ¨ LLM åè®­ç»ƒé¡¹ç›®ä¸­ï¼Œé…ç½®ç®¡ç†çš„å¤æ‚åº¦è¿œè¶…ä¼ ç»Ÿæ·±åº¦å­¦ä¹ é¡¹ç›®ã€‚ä¸€ä¸ªå…¸å‹çš„å®éªŒå¯èƒ½åŒ…å«ä¸Šç™¾ä¸ªè¶…å‚æ•°ï¼Œæ¶‰åŠæ¨¡å‹æ¶æ„ã€è®­ç»ƒç­–ç•¥ã€æ•°æ®å¤„ç†ã€è¯„ä¼°æŒ‡æ ‡ç­‰å¤šä¸ªç»´åº¦ã€‚é€‰æ‹©åˆé€‚çš„é…ç½®æ ¼å¼è‡³å…³é‡è¦ã€‚</p>
<p><strong>YAML é…ç½®çš„ä¼˜åŠ¿ä¸åŠ£åŠ¿</strong></p>
<p>YAML å› å…¶å¯è¯»æ€§å¼ºè€Œå¹¿å—æ¬¢è¿ï¼Œç‰¹åˆ«é€‚åˆåµŒå¥—ç»“æ„çš„è¡¨è¾¾ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">architecture</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llama2</span>
<span class="w">  </span><span class="nt">hidden_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4096</span>
<span class="w">  </span><span class="nt">num_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="w">  </span><span class="nt">attention</span><span class="p">:</span>
<span class="w">    </span><span class="nt">num_heads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="w">    </span><span class="nt">head_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<span class="w">    </span><span class="nt">rotary_embedding</span><span class="p">:</span>
<span class="w">      </span><span class="nt">base</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">      </span><span class="nt">scaling_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</code></pre></div>

<p>ä¼˜åŠ¿ï¼š</p>
<ul>
<li>äººç±»å¯è¯»æ€§æœ€ä½³ï¼Œé€‚åˆé…ç½®å®¡æŸ¥</li>
<li>æ”¯æŒæ³¨é‡Šï¼Œä¾¿äºæ–‡æ¡£åŒ–</li>
<li>å±‚æ¬¡ç»“æ„æ¸…æ™°ï¼Œé€‚åˆå¤æ‚é…ç½®</li>
<li>ç”Ÿæ€ç³»ç»Ÿæˆç†Ÿï¼Œå·¥å…·é“¾å®Œå–„</li>
</ul>
<p>åŠ£åŠ¿ï¼š</p>
<ul>
<li>ç¼©è¿›æ•æ„Ÿï¼Œå®¹æ˜“å‡ºé”™</li>
<li>ç±»å‹æ¨æ–­å¯èƒ½äº§ç”Ÿæ„å¤–ï¼ˆå¦‚ "no" è¢«è§£æä¸ºå¸ƒå°”å€¼ï¼‰</li>
<li>ä¸æ”¯æŒå˜é‡å¼•ç”¨å’Œè®¡ç®—è¡¨è¾¾å¼</li>
<li>å¤§æ–‡ä»¶è§£æé€Ÿåº¦è¾ƒæ…¢</li>
</ul>
<p><strong>TOML é…ç½®çš„æƒè¡¡</strong></p>
<p>TOML åœ¨ Rust å’Œ Python ç¤¾åŒºé€æ¸æµè¡Œï¼Œæä¾›äº†æ›´ä¸¥æ ¼çš„è¯­æ³•ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">[model]</span>
<span class="n">architecture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;llama2&quot;</span>
<span class="n">hidden_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span>
<span class="n">num_layers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>

<span class="k">[model.attention]</span>
<span class="n">num_heads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>
<span class="n">head_dim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span>

<span class="k">[model.attention.rotary_embedding]</span>
<span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span>
<span class="n">scaling_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
</code></pre></div>

<p>ä¼˜åŠ¿ï¼š</p>
<ul>
<li>è¯­æ³•æ˜ç¡®ï¼Œæ­§ä¹‰å°‘</li>
<li>åŸç”Ÿæ”¯æŒæ—¥æœŸæ—¶é—´ç±»å‹</li>
<li>è¡¨æ ¼æ•°ç»„è¯­æ³•é€‚åˆæ‰¹é‡å®éªŒé…ç½®</li>
</ul>
<p>åŠ£åŠ¿ï¼š</p>
<ul>
<li>æ·±å±‚åµŒå¥—å¯è¯»æ€§ä¸‹é™</li>
<li>æ•°ç»„å’Œå†…è”è¡¨çš„è¯­æ³•è¾ƒå¤æ‚</li>
<li>ç”Ÿæ€ç³»ç»Ÿç›¸å¯¹è¾ƒæ–°</li>
</ul>
<p><strong>Python é…ç½®çš„çµæ´»æ€§</strong></p>
<p>ç›´æ¥ä½¿ç”¨ Python æ–‡ä»¶ä½œä¸ºé…ç½®æä¾›äº†æœ€å¤§çš„çµæ´»æ€§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">architecture</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;llama2&quot;</span>
    <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span>
    <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># åŠ¨æ€è®¡ç®—å‚æ•°é‡</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_params</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">scale_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŠ¨æ€è°ƒæ•´æ¨¡å‹è§„æ¨¡&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</code></pre></div>

<p>ä¼˜åŠ¿ï¼š</p>
<ul>
<li>æ”¯æŒåŠ¨æ€è®¡ç®—å’Œæ¡ä»¶é€»è¾‘</li>
<li>ç±»å‹æ£€æŸ¥å’Œ IDE æ”¯æŒå®Œå–„</li>
<li>å¯ä»¥å¤ç”¨ä»£ç å’Œå¯¼å…¥æ¨¡å—</li>
<li>æ”¯æŒé…ç½®éªŒè¯å’Œé»˜è®¤å€¼</li>
</ul>
<p>åŠ£åŠ¿ï¼š</p>
<ul>
<li>å®‰å…¨æ€§é£é™©ï¼ˆæ‰§è¡Œä»»æ„ä»£ç ï¼‰</li>
<li>éæŠ€æœ¯äººå‘˜éš¾ä»¥ä¿®æ”¹</li>
<li>ç‰ˆæœ¬æ§åˆ¶ä¸­ diff å¯è¯»æ€§è¾ƒå·®</li>
</ul>
<h3 id="_3">é…ç½®ç»§æ‰¿ä¸è¦†ç›–æœºåˆ¶</h3>
<p>å®è·µä¸­ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦ä¸€ä¸ªåŸºç¡€é…ç½®å’Œå¤šä¸ªå®éªŒå˜ä½“ã€‚è®¾è®¡è‰¯å¥½çš„ç»§æ‰¿æœºåˆ¶å¯ä»¥å¤§å¹…å‡å°‘é…ç½®å†—ä½™ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ConfigManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">base_config_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_config_path</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">inherit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ”¯æŒå¤šçº§ç»§æ‰¿&quot;&quot;&quot;</span>
        <span class="n">parent_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">parent_config_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_merge</span><span class="p">(</span><span class="n">parent_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_chain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_config_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">override</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overrides</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ”¯æŒå‘½ä»¤è¡Œè¦†ç›–&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">overrides</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_nested_value</span><span class="p">(</span><span class="n">key_path</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deep_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é€’å½’åˆå¹¶é…ç½®å­—å…¸&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">override</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_merge</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<p><strong>é…ç½®è¦†ç›–çš„ä¼˜å…ˆçº§è®¾è®¡</strong></p>
<p>ä¸€ä¸ªæ¸…æ™°çš„ä¼˜å…ˆçº§ä½“ç³»é¿å…äº†é…ç½®å†²çªï¼š</p>
<ol>
<li>å‘½ä»¤è¡Œå‚æ•°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰</li>
<li>ç¯å¢ƒå˜é‡</li>
<li>å®éªŒç‰¹å®šé…ç½®æ–‡ä»¶</li>
<li>ç”¨æˆ·é…ç½®æ–‡ä»¶</li>
<li>é¡¹ç›®é»˜è®¤é…ç½®ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰</li>
</ol>
<div class="codehilite"><pre><span></span><code>ä¼˜å…ˆçº§é“¾ï¼š
CLI Args &gt; ENV &gt; experiment.yaml &gt; user.yaml &gt; default.yaml
</code></pre></div>

<h3 id="_4">é…ç½®éªŒè¯ä¸ç±»å‹æ£€æŸ¥</h3>
<p>ä½¿ç”¨ Pydantic æˆ– attrs è¿›è¡Œè¿è¡Œæ—¶éªŒè¯å¯ä»¥åŠæ—©å‘ç°é…ç½®é”™è¯¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="k">class</span> <span class="nc">TrainingConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">multiple_of</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">optimizer</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="s2">&quot;sgd&quot;</span><span class="p">,</span> <span class="s2">&quot;adamw&quot;</span><span class="p">]</span>
    <span class="n">gradient_accumulation_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_batch_size</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;gradient_accumulation_steps&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">effective_batch</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;gradient_accumulation_steps&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">effective_batch</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effective batch size </span><span class="si">{</span><span class="n">effective_batch</span><span class="si">}</span><span class="s2"> too large&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_lr_schedule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;sgd&quot;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SGD learning rate typically should be &lt; 0.1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</code></pre></div>

<h2 id="22-flag-git">2.2 Flagã€ç¯å¢ƒå˜é‡ä¸ Git åˆ†æ”¯ç­–ç•¥</h2>
<h3 id="command-line-flags">Command-line Flags çš„è®¾è®¡åŸåˆ™</h3>
<p>å‘½ä»¤è¡Œå‚æ•°æ˜¯å®éªŒé…ç½®çš„ç¬¬ä¸€æ¥è§¦ç‚¹ï¼Œè‰¯å¥½çš„è®¾è®¡èƒ½æ˜¾è‘—æå‡å®éªŒæ•ˆç‡ã€‚ä»¥ä¸‹æ˜¯ç»è¿‡å¤§è§„æ¨¡å®éªŒéªŒè¯çš„è®¾è®¡åŸåˆ™ï¼š</p>
<p><strong>å±‚æ¬¡åŒ–çš„å‚æ•°ç»„ç»‡</strong></p>
<p>é¿å…å¹³é“ºæ‰€æœ‰å‚æ•°ï¼Œè€Œæ˜¯æŒ‰åŠŸèƒ½åŸŸç»„ç»‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">argparse</span>

<span class="k">def</span> <span class="nf">create_parser</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="c1"># ä½¿ç”¨å‚æ•°ç»„æé«˜å¯è¯»æ€§</span>
    <span class="n">model_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="n">model_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model.name&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;llama2-7b&quot;</span><span class="p">)</span>
    <span class="n">model_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model.checkpoint&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">model_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model.dtype&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fp32&quot;</span><span class="p">,</span> <span class="s2">&quot;fp16&quot;</span><span class="p">,</span> <span class="s2">&quot;bf16&quot;</span><span class="p">])</span>

    <span class="n">training_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;training&quot;</span><span class="p">)</span>
    <span class="n">training_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--training.batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">training_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--training.learning_rate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
    <span class="n">training_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--training.warmup_steps&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="n">data_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
    <span class="n">data_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data.train_path&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data.val_path&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data.num_workers&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span>
</code></pre></div>

<p><strong>æ™ºèƒ½é»˜è®¤å€¼ä¸å¿…éœ€å‚æ•°</strong></p>
<p>åŒºåˆ†å¿…éœ€å‚æ•°å’Œå¯é€‰å‚æ•°ï¼Œä¸ºå¸¸è§åœºæ™¯æä¾›åˆç†é»˜è®¤å€¼ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">FlagValidator</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_flags</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># è‡ªåŠ¨æ¨æ–­ç›¸å…³å‚æ•°</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">distributed</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># æ ¹æ®ç¡¬ä»¶è‡ªåŠ¨è®¾ç½®</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>

        <span class="c1"># æ‰¹é‡å¤§å°è‡ªåŠ¨è°ƒæ•´</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_checkpointing</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reducing batch size from </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> to 16 due to gradient checkpointing&quot;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">16</span>

        <span class="k">return</span> <span class="n">args</span>
</code></pre></div>

<p><strong>å‚æ•°åˆ«åä¸ç®€å†™</strong></p>
<p>ä¸ºå¸¸ç”¨å‚æ•°æä¾›ç®€å†™ï¼Œæé«˜å‘½ä»¤è¡Œæ•ˆç‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;--batch-size&quot;</span><span class="p">,</span> <span class="s2">&quot;--training.batch_size&quot;</span><span class="p">,</span> 
                   <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Training batch size per device&quot;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-lr&quot;</span><span class="p">,</span> <span class="s2">&quot;--learning-rate&quot;</span><span class="p">,</span> <span class="s2">&quot;--training.lr&quot;</span><span class="p">,</span>
                   <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Peak learning rate&quot;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="s2">&quot;--epochs&quot;</span><span class="p">,</span> <span class="s2">&quot;--num-epochs&quot;</span><span class="p">,</span>
                   <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;num_epochs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of training epochs&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_5">ç¯å¢ƒå˜é‡çš„ä½¿ç”¨åœºæ™¯</h3>
<p>ç¯å¢ƒå˜é‡é€‚åˆç®¡ç†è·¨å®éªŒçš„å…¨å±€è®¾ç½®å’Œæ•æ„Ÿä¿¡æ¯ï¼š</p>
<p><strong>åˆ†å±‚çš„ç¯å¢ƒå˜é‡ä½“ç³»</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç³»ç»Ÿçº§åˆ«ï¼ˆé›†ç¾¤é…ç½®ï¼‰</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1,2,3
<span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">8</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">NCCL_DEBUG</span><span class="o">=</span>INFO

<span class="c1"># é¡¹ç›®çº§åˆ«ï¼ˆè·¯å¾„å’Œå‡­è¯ï¼‰</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LLM_DATA_ROOT</span><span class="o">=</span>/mnt/data/llm_datasets
<span class="nb">export</span><span class="w"> </span><span class="nv">LLM_CHECKPOINT_DIR</span><span class="o">=</span>/mnt/checkpoints
<span class="nb">export</span><span class="w"> </span><span class="nv">WANDB_API_KEY</span><span class="o">=</span>your_api_key_here
<span class="nb">export</span><span class="w"> </span><span class="nv">HF_TOKEN</span><span class="o">=</span>your_huggingface_token

<span class="c1"># å®éªŒçº§åˆ«ï¼ˆè¿è¡Œæ—¶é…ç½®ï¼‰</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LLM_EXPERIMENT_NAME</span><span class="o">=</span>dpo_ablation_v3
<span class="nb">export</span><span class="w"> </span><span class="nv">LLM_RUN_ID</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d_%H%M%S<span class="k">)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LLM_DEBUG_MODE</span><span class="o">=</span><span class="m">1</span>
</code></pre></div>

<p><strong>ç¯å¢ƒå˜é‡çš„æœ€ä½³å®è·µ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">EnvConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç»Ÿä¸€ç®¡ç†ç¯å¢ƒå˜é‡&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_data_root</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è·å–æ•°æ®æ ¹ç›®å½•ï¼Œæ”¯æŒå¤šçº§fallback&quot;&quot;&quot;</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_DATA_ROOT&quot;</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DATA_ROOT&quot;</span><span class="p">),</span>
            <span class="s2">&quot;/data/llm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;./data&quot;</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid data root found&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_wandb_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å®‰å…¨åœ°è·å– W&amp;B é…ç½®&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WANDB_API_KEY&quot;</span><span class="p">):</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;api_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="k">if</span> <span class="n">project</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WANDB_PROJECT&quot;</span><span class="p">):</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WANDB_ENTITY&quot;</span><span class="p">):</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_debug_mode</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æŸ¥è°ƒè¯•æ¨¡å¼&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_DEBUG_MODE&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="git">Git åˆ†æ”¯ç®¡ç†å®è·µ</h3>
<p>åœ¨å¿«é€Ÿè¿­ä»£çš„å®éªŒç¯å¢ƒä¸­ï¼ŒGit åˆ†æ”¯ç­–ç•¥éœ€è¦å¹³è¡¡å®éªŒè‡ªç”±åº¦å’Œä»£ç è´¨é‡ï¼š</p>
<p><strong>å®éªŒåˆ†æ”¯å‘½åè§„èŒƒ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åŠŸèƒ½å¼€å‘åˆ†æ”¯</span>
feature/distributed-dpo
feature/multimodal-alignment

<span class="c1"># å®éªŒåˆ†æ”¯ï¼ˆçŸ­æœŸï¼‰</span>
exp/20250105-lr-sweep
exp/20250106-batch-size-ablation

<span class="c1"># ä¸ªäººå®éªŒåˆ†æ”¯ï¼ˆæ›´è‡ªç”±ï¼‰</span>
dev/alice/rope-scaling
dev/bob/attention-variants

<span class="c1"># é•¿æœŸç ”ç©¶åˆ†æ”¯</span>
research/constitutional-ai
research/online-rlhf
</code></pre></div>

<p><strong>åˆ†æ”¯ä¿æŠ¤ä¸åˆå¹¶ç­–ç•¥</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/branch_protection.yml</span>
<span class="n">protection_rules</span><span class="p">:</span>
  <span class="n">main</span><span class="p">:</span>
    <span class="n">required_reviews</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">dismiss_stale_reviews</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">require_code_owner_reviews</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">required_status_checks</span><span class="p">:</span>

      <span class="o">-</span> <span class="n">lint</span>
      <span class="o">-</span> <span class="nb">type</span><span class="o">-</span><span class="n">check</span>
      <span class="o">-</span> <span class="n">unit</span><span class="o">-</span><span class="n">tests</span>
    <span class="n">enforce_admins</span><span class="p">:</span> <span class="n">false</span>

  <span class="n">release</span><span class="o">/*</span><span class="p">:</span>
    <span class="n">required_reviews</span><span class="p">:</span> <span class="mi">3</span>
    <span class="n">require_code_owner_reviews</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">required_status_checks</span><span class="p">:</span>

      <span class="o">-</span> <span class="nb">all</span><span class="o">-</span><span class="n">tests</span>
      <span class="o">-</span> <span class="n">integration</span><span class="o">-</span><span class="n">tests</span>
      <span class="o">-</span> <span class="n">benchmark</span><span class="o">-</span><span class="n">regression</span>
</code></pre></div>

<p><strong>å®éªŒåˆ†æ”¯çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong></p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># scripts/manage_exp_branches.sh</span>

<span class="c1"># è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„å®éªŒåˆ†æ”¯</span>
cleanup_old_exp_branches<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">days_old</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">30</span><span class="si">}</span>

<span class="w">    </span>git<span class="w"> </span><span class="k">for</span>-each-ref<span class="w"> </span>--format<span class="o">=</span><span class="s1">&#39;%(refname:short) %(committerdate:unix)&#39;</span><span class="w"> </span>refs/heads/exp/<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>branch<span class="w"> </span>timestamp<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nv">age_days</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="o">(</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">timestamp</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">86400</span><span class="w"> </span><span class="k">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$age</span><span class="se">\_</span>days<span class="w"> </span>-gt<span class="w"> </span><span class="nv">$days_old</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Deleting old experimental branch: </span><span class="nv">$branch</span><span class="s2"> (</span><span class="si">${</span><span class="nv">age_days</span><span class="si">}</span><span class="s2"> days old)&quot;</span>
<span class="w">            </span>git<span class="w"> </span>branch<span class="w"> </span>-D<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$branch</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>
<span class="o">}</span>

<span class="c1"># å½’æ¡£é‡è¦å®éªŒåˆ†æ”¯</span>
archive_exp_branch<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">branch</span><span class="o">=</span><span class="nv">$1</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">archive_tag</span><span class="o">=</span><span class="s2">&quot;archive/</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="s2">/</span><span class="si">${</span><span class="nv">branch</span><span class="p">##*/</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span>git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$archive</span><span class="s2">\_tag&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$branch</span><span class="s2">&quot;</span><span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Archived experimental branch </span><span class="nv">$branch</span><span class="s2">&quot;</span>
<span class="w">    </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$archive_tag</span><span class="s2">&quot;</span>
<span class="w">    </span>git<span class="w"> </span>branch<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$branch</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Archived </span><span class="nv">$branch</span><span class="s2"> as </span><span class="nv">$archive_tag</span><span class="s2">&quot;</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="23">2.3 å®éªŒè¿½è¸ªä¸ç‰ˆæœ¬æ§åˆ¶</h2>
<h3 id="_6">å®éªŒè¿½è¸ªå·¥å…·é€‰æ‹©</h3>
<p>é€‰æ‹©åˆé€‚çš„å®éªŒè¿½è¸ªå·¥å…·æ˜¯å»ºç«‹å¯é‡ç°ç ”ç©¶æµç¨‹çš„å…³é”®ã€‚ä¸»æµå·¥å…·å„æœ‰ç‰¹è‰²ï¼Œéœ€è¦æ ¹æ®å›¢é˜Ÿè§„æ¨¡å’Œéœ€æ±‚é€‰æ‹©ã€‚</p>
<p><strong>MLflowï¼šå¼€æºæ ‡å‡†çš„é€‰æ‹©</strong></p>
<p>MLflow æä¾›äº†å®Œæ•´çš„å®éªŒç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">mlflow.tracking</span> <span class="kn">import</span> <span class="n">MlflowClient</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">class</span> <span class="nc">MLflowExperimentTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tracking_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;file:./mlruns&quot;</span><span class="p">):</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">tracking_uri</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="n">experiment_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">MlflowClient</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¼€å§‹ä¸€ä¸ªæ–°çš„å®éªŒè¿è¡Œ&quot;&quot;&quot;</span>
        <span class="c1"># ç”Ÿæˆé…ç½®å“ˆå¸Œä½œä¸ºè¿è¡Œæ ‡è¯†</span>
        <span class="n">config_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>

        <span class="n">run_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">config_hash</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
            <span class="c1"># è®°å½•é…ç½®å‚æ•°</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten_dict</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

            <span class="c1"># è®°å½•æ ‡ç­¾</span>
            <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

            <span class="c1"># è®°å½•ä»£ç ç‰ˆæœ¬</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s2">&quot;git_commit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_commit</span><span class="p">())</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s2">&quot;git_branch&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_branch</span><span class="p">())</span>

            <span class="k">return</span> <span class="n">run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span>

    <span class="k">def</span> <span class="nf">log_metrics_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ‰¹é‡è®°å½•æŒ‡æ ‡&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_artifact_with_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®°å½•æ–‡ä»¶åŠå…¶å…ƒæ•°æ®&quot;&quot;&quot;</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="c1"># åŒæ—¶è®°å½•å…ƒæ•°æ®</span>
        <span class="n">metadata_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">.metadata.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">)</span>
</code></pre></div>

<p><strong>Weights &amp; Biasesï¼šäº‘åŸç”Ÿçš„å¼ºå¤§åŠŸèƒ½</strong></p>
<p>W&amp;B æä¾›äº†æ›´ä¸°å¯Œçš„å¯è§†åŒ–å’Œåä½œåŠŸèƒ½ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">wandb</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">WandBTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>

    <span class="k">def</span> <span class="nf">init_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">resume</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆå§‹åŒ– W&amp;B è¿è¡Œ&quot;&quot;&quot;</span>
        <span class="n">run</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
            <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
            <span class="n">entity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">,</span>  <span class="c1"># æ”¯æŒæ–­ç‚¹ç»­è®­</span>
            <span class="n">save_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># è‡ªåŠ¨ä¿å­˜ä»£ç </span>
            <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_tags</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># å®šä¹‰è‡ªå®šä¹‰æŒ‡æ ‡</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;train/step&quot;</span><span class="p">)</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;train/*&quot;</span><span class="p">,</span> <span class="n">step_metric</span><span class="o">=</span><span class="s2">&quot;train/step&quot;</span><span class="p">)</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;eval/step&quot;</span><span class="p">)</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;eval/*&quot;</span><span class="p">,</span> <span class="n">step_metric</span><span class="o">=</span><span class="s2">&quot;eval/step&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">run</span>

    <span class="k">def</span> <span class="nf">log_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®°å½•æ•°æ®åˆ†å¸ƒ&quot;&quot;&quot;</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/min&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/max&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/histogram&quot;</span><span class="p">:</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Histogram</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">},</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_gradient_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®°å½•æ¢¯åº¦æµä¿¡æ¯&quot;&quot;&quot;</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;grad_norm&quot;</span><span class="p">:</span> <span class="n">grad_norm</span>
                <span class="p">})</span>

        <span class="c1"># åˆ›å»ºæ¢¯åº¦è¡¨æ ¼</span>
        <span class="n">grad_table</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="s2">&quot;gradient_norm&quot;</span><span class="p">],</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;grad_norm&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gradients</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="s2">&quot;gradients&quot;</span><span class="p">:</span> <span class="n">grad_table</span><span class="p">},</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
</code></pre></div>

<p><strong>TensorBoardï¼šè½»é‡çº§æœ¬åœ°æ–¹æ¡ˆ</strong></p>
<p>å¯¹äºä¸éœ€è¦äº‘æœåŠ¡çš„åœºæ™¯ï¼ŒTensorBoard ä»æ˜¯å¯é é€‰æ‹©ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">torch.utils.tensorboard</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span> <span class="nc">TensorBoardTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span>
            <span class="n">log_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">),</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
            <span class="n">flush_secs</span><span class="o">=</span><span class="mi">30</span>  <span class="c1"># å®šæœŸåˆ·æ–°åˆ°ç£ç›˜</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_model_architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®°å½•æ¨¡å‹æ¶æ„&quot;&quot;&quot;</span>
        <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dummy_input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_attention_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attention_weights</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
                            <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">head_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¯è§†åŒ–æ³¨æ„åŠ›æƒé‡&quot;&quot;&quot;</span>
        <span class="c1"># é€‰æ‹©ç‰¹å®šçš„æ³¨æ„åŠ›å¤´</span>
        <span class="n">attn</span> <span class="o">=</span> <span class="n">attention_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">head_idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># åˆ›å»ºçƒ­åŠ›å›¾</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">attn</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attention Weights - Head </span><span class="si">{</span><span class="n">head_idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;attention/head_</span><span class="si">{</span><span class="n">head_idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">log_learning_rate_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®°å½•å­¦ä¹ ç‡å˜åŒ–&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">):</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="n">param_group</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;learning_rate/group_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</code></pre></div>

<h3 id="_7">å®éªŒå…ƒæ•°æ®ç®¡ç†</h3>
<p>å®Œæ•´çš„å…ƒæ•°æ®è®°å½•æ˜¯å®éªŒå¯é‡ç°æ€§çš„åŸºç¡€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">GPUtil</span>

<span class="k">class</span> <span class="nc">ExperimentMetadata</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">collect_system_info</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ”¶é›†ç³»ç»Ÿä¿¡æ¯&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">(),</span>
            <span class="s2">&quot;python_version&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">python_version</span><span class="p">(),</span>
            <span class="s2">&quot;cpu_count&quot;</span><span class="p">:</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span>
            <span class="s2">&quot;memory_gb&quot;</span><span class="p">:</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">total</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">),</span>
            <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">(),</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">collect_gpu_info</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ”¶é›† GPU ä¿¡æ¯&quot;&quot;&quot;</span>
        <span class="n">gpus</span> <span class="o">=</span> <span class="n">GPUtil</span><span class="o">.</span><span class="n">getGPUs</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">gpu</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">gpu</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;memory_total&quot;</span><span class="p">:</span> <span class="n">gpu</span><span class="o">.</span><span class="n">memoryTotal</span><span class="p">,</span>
            <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">gpu</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span>
            <span class="s2">&quot;compute_capability&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gpu</span><span class="o">.</span><span class="n">major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">gpu</span><span class="o">.</span><span class="n">minor</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">collect_dependencies</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ”¶é›†ä¾èµ–ç‰ˆæœ¬&quot;&quot;&quot;</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">torch</span>
            <span class="n">deps</span><span class="p">[</span><span class="s2">&quot;torch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span>
            <span class="n">deps</span><span class="p">[</span><span class="s2">&quot;cuda&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">transformers</span>
            <span class="n">deps</span><span class="p">[</span><span class="s2">&quot;transformers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">__version__</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ä» requirements.txt æˆ– pyproject.toml è¯»å–</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;requirements.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;requirements.txt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;==&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">pkg</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;==&quot;</span><span class="p">)</span>
                        <span class="n">deps</span><span class="p">[</span><span class="n">pkg</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>

        <span class="k">return</span> <span class="n">deps</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_experiment_card</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºå®éªŒå¡ç‰‡&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">ExperimentMetadata</span><span class="o">.</span><span class="n">collect_system_info</span><span class="p">(),</span>
            <span class="s2">&quot;gpus&quot;</span><span class="p">:</span> <span class="n">ExperimentMetadata</span><span class="o">.</span><span class="n">collect_gpu_info</span><span class="p">(),</span>
            <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="n">ExperimentMetadata</span><span class="o">.</span><span class="n">collect_dependencies</span><span class="p">(),</span>
            <span class="s2">&quot;git&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;commit&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                <span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;branch&quot;</span><span class="p">,</span> <span class="s2">&quot;--show-current&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                <span class="s2">&quot;diff&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="_8">æ¨¡å‹æ£€æŸ¥ç‚¹ç­–ç•¥</h3>
<p>é«˜æ•ˆçš„æ£€æŸ¥ç‚¹ç®¡ç†å¯¹äºé•¿æ—¶é—´è®­ç»ƒè‡³å…³é‡è¦ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CheckpointManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">max_checkpoints</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_checkpoints</span> <span class="o">=</span> <span class="n">max_checkpoints</span>

    <span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                       <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">is_best</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¿å­˜æ£€æŸ¥ç‚¹&quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
            <span class="s2">&quot;model_state_dict&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># å¸¸è§„æ£€æŸ¥ç‚¹</span>
        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;checkpoint_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pt&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">)</span>

        <span class="c1"># æœ€ä½³æ¨¡å‹</span>
        <span class="k">if</span> <span class="n">is_best</span><span class="p">:</span>
            <span class="n">best_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">/</span> <span class="s2">&quot;best_model.pt&quot;</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">best_path</span><span class="p">)</span>

        <span class="c1"># æ¸…ç†æ—§æ£€æŸ¥ç‚¹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_old_checkpoints</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cleanup_old_checkpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¿ç•™æœ€æ–°çš„Nä¸ªæ£€æŸ¥ç‚¹&quot;&quot;&quot;</span>
        <span class="n">checkpoints</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;checkpoint_epoch_*.pt&quot;</span><span class="p">),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_checkpoints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ckpt</span> <span class="ow">in</span> <span class="n">checkpoints</span><span class="p">[:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_checkpoints</span><span class="p">]:</span>
                <span class="n">ckpt</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">resume_from_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> 
                              <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä»æ£€æŸ¥ç‚¹æ¢å¤&quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_state_dict&quot;</span><span class="p">])</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">],</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">]</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="24">2.4 é˜²æ­¢ä»£ç è…åŒ–çš„æœ€ä½³å®è·µ</h2>
<h3 id="_9">æŠ€æœ¯å€ºåŠ¡ç®¡ç†</h3>
<p>LLM åè®­ç»ƒé¡¹ç›®çš„å¿«é€Ÿè¿­ä»£å®¹æ˜“ç´¯ç§¯æŠ€æœ¯å€ºåŠ¡ã€‚ä¸»åŠ¨ç®¡ç†æŠ€æœ¯å€ºåŠ¡æ˜¯ä¿æŒé¡¹ç›®é•¿æœŸå¥åº·çš„å…³é”®ã€‚</p>
<p><strong>æŠ€æœ¯å€ºåŠ¡çš„é‡åŒ–ä¸è¿½è¸ª</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">TechnicalDebtAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codebase_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">codebase_path</span> <span class="o">=</span> <span class="n">codebase_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debt_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TODO&quot;</span><span class="p">,</span> <span class="s2">&quot;FIXME&quot;</span><span class="p">,</span> <span class="s2">&quot;HACK&quot;</span><span class="p">,</span> <span class="s2">&quot;XXX&quot;</span><span class="p">,</span> <span class="s2">&quot;DEPRECATED&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">scan_codebase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ‰«æä»£ç åº“ä¸­çš„æŠ€æœ¯å€ºåŠ¡æ ‡è®°&quot;&quot;&quot;</span>
        <span class="n">debt_items</span> <span class="o">=</span> <span class="p">{</span><span class="n">marker</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">debt_markers</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">py_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">codebase_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.py&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">py_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">debt_markers</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">debt_items</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">py_file</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">codebase_path</span><span class="p">)),</span>
                                <span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="n">line_num</span><span class="p">,</span>
                                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                                <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_priority</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="p">})</span>

        <span class="k">return</span> <span class="n">debt_items</span>

    <span class="k">def</span> <span class="nf">calculate_complexity_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¡ç®—ä»£ç å¤æ‚åº¦æŒ‡æ ‡&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cyclomatic_complexity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_cyclomatic_complexity</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span>
            <span class="s2">&quot;lines_of_code&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span>
            <span class="s2">&quot;num_functions&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)]),</span>
            <span class="s2">&quot;num_classes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">)]),</span>
            <span class="s2">&quot;max_nesting_depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_max_nesting</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">generate_debt_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç”ŸæˆæŠ€æœ¯å€ºåŠ¡æŠ¥å‘Š&quot;&quot;&quot;</span>
        <span class="n">debt_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_codebase</span><span class="p">()</span>
        <span class="n">total_debt</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">debt_items</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># æŠ€æœ¯å€ºåŠ¡æŠ¥å‘Š</span>
<span class="s2">ç”Ÿæˆæ—¶é—´: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span>
<span class="s2">æ€»å€ºåŠ¡é¡¹: </span><span class="si">{</span><span class="n">total_debt</span><span class="si">}</span>

<span class="s2">## æŒ‰ç±»å‹åˆ†å¸ƒ</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">marker</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">debt_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">marker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2"> é¡¹</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># é«˜ä¼˜å…ˆçº§é¡¹ç›®</span>
        <span class="n">high_priority</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">marker</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">debt_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">high_priority</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span> 
                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span>
            <span class="p">])</span>

        <span class="k">if</span> <span class="n">high_priority</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## é«˜ä¼˜å…ˆçº§å€ºåŠ¡</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">high_priority</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># æ˜¾ç¤ºå‰10ä¸ª</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>

<p><strong>ä»£ç è´¨é‡é—¨ç¦</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CodeQualityGate</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">thresholds</span>

    <span class="k">def</span> <span class="nf">check_diff_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diff_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æŸ¥ä»£ç å˜æ›´çš„è´¨é‡&quot;&quot;&quot;</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;no_print_statements&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_no_prints</span><span class="p">(</span><span class="n">diff_file</span><span class="p">),</span>
            <span class="s2">&quot;has_tests&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_has_tests</span><span class="p">(</span><span class="n">diff_file</span><span class="p">),</span>
            <span class="s2">&quot;docstring_coverage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_docstrings</span><span class="p">(</span><span class="n">diff_file</span><span class="p">),</span>
            <span class="s2">&quot;type_hints&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_type_hints</span><span class="p">(</span><span class="n">diff_file</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">failures</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">passed</span> <span class="ow">in</span> <span class="n">checks</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">passed</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">failures</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quality gate failed: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">failures</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">check_no_prints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diff</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æŸ¥æ˜¯å¦åŒ…å«è°ƒè¯•ç”¨çš„printè¯­å¥&quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\+.*print\(&#39;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_has_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diff</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æŸ¥æ˜¯å¦åŒ…å«å¯¹åº”çš„æµ‹è¯•&quot;&quot;&quot;</span>
        <span class="c1"># å¦‚æœä¿®æ”¹äº†src/ä¸‹çš„æ–‡ä»¶ï¼Œåº”è¯¥æœ‰å¯¹åº”çš„test/ä¸‹çš„ä¿®æ”¹</span>
        <span class="n">src_modified</span> <span class="o">=</span> <span class="s2">&quot;src/&quot;</span> <span class="ow">in</span> <span class="n">diff</span>
        <span class="n">test_modified</span> <span class="o">=</span> <span class="s2">&quot;test/&quot;</span> <span class="ow">in</span> <span class="n">diff</span> <span class="ow">or</span> <span class="s2">&quot;tests/&quot;</span> <span class="ow">in</span> <span class="n">diff</span>

        <span class="k">if</span> <span class="n">src_modified</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">test_modified</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<h3 id="_10">ä»£ç å¤ç”¨ä¸æ¨¡å—åŒ–</h3>
<p>è‰¯å¥½çš„æ¨¡å—åŒ–è®¾è®¡æ˜¯é˜²æ­¢ä»£ç è…åŒ–çš„åŸºç¡€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BaseExperiment</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å®éªŒåŸºç±»ï¼Œå¼ºåˆ¶è§„èŒƒåŒ–å®éªŒæµç¨‹&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆå§‹åŒ–å®éªŒç¯å¢ƒ&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ•°æ®å‡†å¤‡&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ„å»ºæ¨¡å‹&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å•æ­¥è®­ç»ƒ&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¯„ä¼°&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ ‡å‡†åŒ–çš„å®éªŒæµç¨‹&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_model</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_epochs&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

            <span class="n">eval_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_eval_metrics</span><span class="p">(</span><span class="n">eval_metrics</span><span class="p">)</span>
</code></pre></div>

<p><strong>ç»„ä»¶æ³¨å†Œæœºåˆ¶</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ComponentRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç»Ÿä¸€çš„ç»„ä»¶æ³¨å†Œæœºåˆ¶ï¼Œé¿å…ä»£ç åˆ†æ•£&quot;&quot;&quot;</span>

    <span class="n">_registry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;datasets&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;trainers&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;evaluators&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è£…é¥°å™¨ï¼šæ³¨å†Œç»„ä»¶&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">component_cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown category: </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_cls</span>
            <span class="k">return</span> <span class="n">component_cls</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è·å–æ³¨å†Œçš„ç»„ä»¶&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown category: </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">category</span><span class="p">]:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">. Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>

<span class="c1"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="nd">@ComponentRegistry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="s2">&quot;llama2&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LLaMA2Model</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="nd">@ComponentRegistry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="s2">&quot;alpaca&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AlpacaDataset</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div>

<h3 id="_11">æŒç»­é›†æˆä¸æµ‹è¯•</h3>
<p><strong>åˆ†å±‚æµ‹è¯•ç­–ç•¥</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

<span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åˆ†å±‚æµ‹è¯•ç­–ç•¥&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">unit_test_example</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å•å…ƒæµ‹è¯•ï¼šæµ‹è¯•ç‹¬ç«‹å‡½æ•°&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">test_config_merge</span><span class="p">():</span>
            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}}</span>
            <span class="n">override</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">deep_merge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">override</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">integration_test_example</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é›†æˆæµ‹è¯•ï¼šæµ‹è¯•ç»„ä»¶äº¤äº’&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">test_model_with_dataloader</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="n">dataloader</span> <span class="o">=</span> <span class="n">create_dataloader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">expected_shape</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">smoke_test_example</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å†’çƒŸæµ‹è¯•ï¼šå¿«é€ŸéªŒè¯åŸºæœ¬åŠŸèƒ½&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">test_training_loop_runs</span><span class="p">():</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">get_minimal_config</span><span class="p">()</span>
            <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

            <span class="c1"># åªè¿è¡Œå‡ æ­¥</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">trainer</span><span class="o">.</span><span class="n">global_step</span> <span class="o">==</span> <span class="mi">10</span>
</code></pre></div>

<p><strong>CI/CD é…ç½®</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/ci.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CI Pipeline</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">develop</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">quality-checks</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v2</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.9&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install -r requirements-dev.txt</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run linting</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">flake8 src/ --max-line-length=100</span>
<span class="w">          </span><span class="no">black --check src/</span>
<span class="w">          </span><span class="no">isort --check-only src/</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Type checking</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">mypy src/ --ignore-missing-imports</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest tests/ -v --cov=src --cov-report=xml</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Check code complexity</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">radon cc src/ -s -nb</span>
</code></pre></div>

<h3 id="_12">æ–‡æ¡£ä¸çŸ¥è¯†ä¼ æ‰¿</h3>
<p><strong>è‡ªåŠ¨åŒ–æ–‡æ¡£ç”Ÿæˆ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DocumentationGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è‡ªåŠ¨ç”Ÿæˆå®éªŒæ–‡æ¡£&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">generate_experiment_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_class</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä»å®éªŒç±»ç”Ÿæˆæ–‡æ¡£&quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">experiment_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="c1"># æå–ç±»æ–‡æ¡£å­—ç¬¦ä¸²</span>
        <span class="k">if</span> <span class="n">experiment_class</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">experiment_class</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="c1"># æå–é…ç½®å‚æ•°</span>
        <span class="n">doc</span> <span class="o">+=</span> <span class="s2">&quot;## Configuration Parameters</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">config_schema</span> <span class="o">=</span> <span class="n">experiment_class</span><span class="o">.</span><span class="n">get_config_schema</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">config_schema</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">**: </span><span class="si">{</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(default: </span><span class="si">{</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># æå–æ–¹æ³•æ–‡æ¡£</span>
        <span class="n">doc</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Methods</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">experiment_class</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">method_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">experiment_class</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">and</span> <span class="n">method</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;### </span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">doc</span>
</code></pre></div>

<h2 id="_13">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº† LLM åè®­ç»ƒå®éªŒä»£ç åŸºç¡€è®¾æ–½çš„æ„å»ºã€‚æˆ‘ä»¬å­¦ä¹ äº†ï¼š</p>
<p>ğŸ“Œ <strong>é…ç½®ç®¡ç†çš„å±‚æ¬¡åŒ–è®¾è®¡</strong>ï¼šé€šè¿‡ YAML/TOML/Python é…ç½®æ–‡ä»¶çš„åˆç†é€‰æ‹©ï¼Œé…ç½®ç»§æ‰¿æœºåˆ¶ï¼Œä»¥åŠè¿è¡Œæ—¶éªŒè¯ï¼Œå»ºç«‹äº†çµæ´»ä¸”å¥å£®çš„é…ç½®ä½“ç³»ã€‚è®°ä½ï¼šé…ç½®çš„å¤æ‚åº¦åº”è¯¥ä¸å®éªŒçš„å¤æ‚åº¦ç›¸åŒ¹é…ï¼Œè¿‡åº¦è®¾è®¡å’Œè®¾è®¡ä¸è¶³éƒ½ä¼šé™ä½æ•ˆç‡ã€‚</p>
<p>ğŸ“Œ <strong>å®éªŒç¯å¢ƒçš„å¤šç»´ç®¡ç†</strong>ï¼šé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ã€ç¯å¢ƒå˜é‡å’Œ Git åˆ†æ”¯çš„ååŒä½¿ç”¨ï¼Œå®ç°äº†å®éªŒçš„éš”ç¦»æ€§å’Œå¯é‡ç°æ€§ã€‚å…³é”®åŸåˆ™æ˜¯ï¼šFlag ç”¨äºå®éªŒç‰¹å®šé…ç½®ï¼Œç¯å¢ƒå˜é‡ç”¨äºç³»ç»Ÿçº§è®¾ç½®ï¼ŒGit åˆ†æ”¯ç”¨äºä»£ç ç‰ˆæœ¬ç®¡ç†ã€‚</p>
<p>ğŸ“Œ <strong>å®éªŒè¿½è¸ªçš„å…¨ç”Ÿå‘½å‘¨æœŸè¦†ç›–</strong>ï¼šä» MLflowã€W&amp;B åˆ° TensorBoardï¼Œä¸åŒå·¥å…·é€‚åˆä¸åŒåœºæ™¯ã€‚æ ¸å¿ƒæ˜¯è¦è®°å½•è¶³å¤Ÿçš„å…ƒæ•°æ®ä»¥æ”¯æŒå®éªŒé‡ç°ï¼ŒåŒ…æ‹¬ä»£ç ç‰ˆæœ¬ã€ä¾èµ–ç¯å¢ƒã€ç¡¬ä»¶é…ç½®ç­‰ã€‚</p>
<p>ğŸ“Œ <strong>æŠ€æœ¯å€ºåŠ¡çš„ä¸»åŠ¨ç®¡ç†</strong>ï¼šé€šè¿‡ä»£ç è´¨é‡é—¨ç¦ã€æ¨¡å—åŒ–è®¾è®¡ã€è‡ªåŠ¨åŒ–æµ‹è¯•å’Œæ–‡æ¡£ç”Ÿæˆï¼Œå»ºç«‹äº†é˜²æ­¢ä»£ç è…åŒ–çš„å¤šé‡é˜²çº¿ã€‚è®°ä½ï¼šæŠ€æœ¯å€ºåŠ¡æ˜¯ä¸å¯é¿å…çš„ï¼Œå…³é”®æ˜¯è¦å¯è§ã€å¯æ§ã€å¯å¿è¿˜ã€‚</p>
<h3 id="_14">å…³é”®å…¬å¼ä¸åº¦é‡</h3>
<ol>
<li>
<p><strong>æŠ€æœ¯å€ºåŠ¡åˆ©æ¯</strong> = $\sum_{i=1}^{n} \text{complexity}_i \times \text{change_frequency}_i$</p>
</li>
<li>
<p><strong>å®éªŒå¯é‡ç°æ€§å¾—åˆ†</strong> = $\frac{\text{æˆåŠŸé‡ç°çš„å®éªŒæ•°}}{\text{æ€»å®éªŒæ•°}} \times \text{å…ƒæ•°æ®å®Œæ•´åº¦}$</p>
</li>
<li>
<p><strong>é…ç½®å¤æ‚åº¦</strong> = $\log_2(\text{é…ç½®å‚æ•°æ•°}) \times \text{åµŒå¥—æ·±åº¦}$</p>
</li>
</ol>
<h2 id="gotchas">å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<p>âš ï¸ <strong>é…ç½®åœ°ç‹±ï¼ˆConfiguration Hellï¼‰</strong></p>
<ul>
<li>é”™è¯¯ï¼šä¸ºæ¯ä¸ªå°å®éªŒåˆ›å»ºå®Œå…¨ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶</li>
<li>åæœï¼šé…ç½®æ–‡ä»¶çˆ†ç‚¸å¼å¢é•¿ï¼Œéš¾ä»¥ç»´æŠ¤</li>
<li>è§£å†³ï¼šä½¿ç”¨é…ç½®ç»§æ‰¿ï¼Œåªè®°å½•ä¸åŸºçº¿çš„å·®å¼‚</li>
</ul>
<p>âš ï¸ <strong>å®éªŒè¿½è¸ªè¿‡åº¦æˆ–ä¸è¶³</strong></p>
<ul>
<li>é”™è¯¯ï¼šè®°å½•æ‰€æœ‰å¯èƒ½çš„æŒ‡æ ‡ vs åªè®°å½•æœ€ç»ˆç»“æœ</li>
<li>åæœï¼šå­˜å‚¨çˆ†ç‚¸æˆ–ä¿¡æ¯ä¸è¶³æ— æ³•è°ƒè¯•</li>
<li>è§£å†³ï¼šåˆ†å±‚è®°å½•ç­–ç•¥ï¼Œå…³é”®æŒ‡æ ‡è¯¦ç»†è®°å½•ï¼Œè¾…åŠ©æŒ‡æ ‡é‡‡æ ·è®°å½•</li>
</ul>
<p>âš ï¸ <strong>Git åˆ†æ”¯ç®¡ç†æ··ä¹±</strong></p>
<ul>
<li>é”™è¯¯ï¼šæ‰€æœ‰å®éªŒéƒ½åœ¨ main åˆ†æ”¯è¿›è¡Œ</li>
<li>åæœï¼šä»£ç å†å²æ··ä¹±ï¼Œéš¾ä»¥å›æº¯</li>
<li>è§£å†³ï¼šä¸¥æ ¼çš„åˆ†æ”¯å‘½åè§„èŒƒå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†</li>
</ul>
<p>âš ï¸ <strong>ç¡¬ç¼–ç è·¯å¾„å’Œé…ç½®</strong></p>
<ul>
<li>é”™è¯¯ï¼šåœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•°æ®è·¯å¾„ã€æ¨¡å‹è·¯å¾„</li>
<li>åæœï¼šä»£ç æ— æ³•è·¨ç¯å¢ƒè¿è¡Œ</li>
<li>è§£å†³ï¼šæ‰€æœ‰è·¯å¾„é€šè¿‡é…ç½®æˆ–ç¯å¢ƒå˜é‡ç®¡ç†</li>
</ul>
<p>âš ï¸ <strong>å¿½è§†ä»£ç å¤æ‚åº¦å¢é•¿</strong></p>
<ul>
<li>é”™è¯¯ï¼šä¸ºäº†å¿«é€Ÿå®éªŒä¸æ–­æ·»åŠ  if-else åˆ†æ”¯</li>
<li>åæœï¼šä»£ç å˜æˆæ„å¤§åˆ©é¢æ¡ï¼Œæ— æ³•ç»´æŠ¤</li>
<li>è§£å†³ï¼šå®šæœŸé‡æ„ï¼Œä½¿ç”¨ç­–ç•¥æ¨¡å¼æˆ–æ³¨å†Œæœºåˆ¶</li>
</ul>
<p>âš ï¸ <strong>æ£€æŸ¥ç‚¹ç®¡ç†ä¸å½“</strong></p>
<ul>
<li>é”™è¯¯ï¼šä¿å­˜æ‰€æœ‰æ£€æŸ¥ç‚¹æˆ–åªä¿å­˜æœ€åä¸€ä¸ª</li>
<li>åæœï¼šç£ç›˜ç©ºé—´è€—å°½æˆ–æ— æ³•æ¢å¤æœ€ä½³æ¨¡å‹</li>
<li>è§£å†³ï¼šæ»šåŠ¨çª—å£ç­–ç•¥ + æœ€ä½³æ¨¡å‹ä¿å­˜</li>
</ul>
<p>ğŸ’¡ <strong>å®ç”¨æŠ€å·§</strong></p>
<ol>
<li><strong>é…ç½®éªŒè¯å‰ç½®</strong>ï¼šåœ¨å®éªŒå¼€å§‹å‰éªŒè¯æ‰€æœ‰é…ç½®ï¼Œfail fast</li>
<li><strong>å®éªŒå‘½åè§„èŒƒ</strong>ï¼š<code>{date}_{model}_{dataset}_{key_hyperparam}</code></li>
<li><strong>è‡ªåŠ¨åŒ–æ¸…ç†</strong>ï¼šå®šæœŸæ¸…ç†è¿‡æœŸçš„å®éªŒåˆ†æ”¯å’Œæ£€æŸ¥ç‚¹</li>
<li><strong>å¢é‡å¼æ—¥å¿—</strong>ï¼šä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ï¼Œä¾¿äºåç»­åˆ†æ</li>
<li><strong>é…ç½®å¿«ç…§</strong>ï¼šæ¯æ¬¡å®éªŒå¼€å§‹æ—¶ä¿å­˜å®Œæ•´é…ç½®å¿«ç…§</li>
</ol>
<h2 id="_15">ç»ƒä¹ é¢˜</h2>
<h3 id="_16">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  2.1ï¼šé…ç½®æ–‡ä»¶æ ¼å¼é€‰æ‹©</strong>
ä½ çš„å›¢é˜Ÿæ­£åœ¨å¯åŠ¨ä¸€ä¸ªæ–°çš„ LLM åè®­ç»ƒé¡¹ç›®ã€‚é¡¹ç›®éœ€è¦æ”¯æŒï¼š(1) éæŠ€æœ¯äººå‘˜è°ƒæ•´è¶…å‚æ•°ï¼›(2) å¤æ‚çš„åµŒå¥—é…ç½®ï¼›(3) åŠ¨æ€è®¡ç®—æŸäº›å‚æ•°ã€‚è¯·ä¸ºè¿™ä¸ªé¡¹ç›®é€‰æ‹©é…ç½®æ–‡ä»¶æ ¼å¼ï¼Œå¹¶è¯´æ˜ç†ç”±ã€‚</p>
<p><em>Hint: è€ƒè™‘æ··åˆæ–¹æ¡ˆï¼Œä¸åŒå±‚æ¬¡ä½¿ç”¨ä¸åŒæ ¼å¼ã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å»ºè®®é‡‡ç”¨æ··åˆé…ç½®æ–¹æ¡ˆï¼š</p>
<ul>
<li><strong>åŸºç¡€é…ç½®å±‚ï¼ˆYAMLï¼‰</strong>ï¼šç”¨äºéæŠ€æœ¯äººå‘˜å¯è°ƒæ•´çš„å‚æ•°ï¼Œå¦‚å­¦ä¹ ç‡ã€æ‰¹æ¬¡å¤§å°ç­‰</li>
<li><strong>é«˜çº§é…ç½®å±‚ï¼ˆPythonï¼‰</strong>ï¼šç”¨äºéœ€è¦åŠ¨æ€è®¡ç®—çš„å‚æ•°ï¼Œå¦‚æ ¹æ® GPU å†…å­˜è‡ªåŠ¨è°ƒæ•´æ‰¹æ¬¡å¤§å°</li>
<li><strong>ç”¨æˆ·è¦†ç›–å±‚ï¼ˆTOMLï¼‰</strong>ï¼šç”¨äºç”¨æˆ·ç‰¹å®šçš„ç¯å¢ƒé…ç½®</li>
</ul>
<p>å®ç°æ–¹å¼ï¼š</p>
<ol>
<li>å…ˆåŠ è½½ YAML åŸºç¡€é…ç½®</li>
<li>é€šè¿‡ Python é…ç½®ç±»è¿›è¡ŒåŠ¨æ€è®¡ç®—å’ŒéªŒè¯</li>
<li>æœ€ååº”ç”¨ TOML ç”¨æˆ·è¦†ç›–</li>
</ol>
<p>è¿™æ ·æ—¢ä¿è¯äº†æ˜“ç”¨æ€§ï¼Œåˆæä¾›äº†è¶³å¤Ÿçš„çµæ´»æ€§ã€‚</p>
</details>
<p><strong>ç»ƒä¹  2.2ï¼šå®éªŒè¿½è¸ªå·¥å…·é›†æˆ</strong>
è®¾è®¡ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œèƒ½å¤ŸåŒæ—¶å‘ MLflow å’Œ W&amp;B è®°å½•å®éªŒæŒ‡æ ‡ã€‚è¦æ±‚æ”¯æŒæ‰¹é‡è®°å½•å’Œå¼‚æ­¥å†™å…¥ã€‚</p>
<p><em>Hint: ä½¿ç”¨é€‚é…å™¨æ¨¡å¼å’Œé˜Ÿåˆ—æœºåˆ¶ã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="k">class</span> <span class="nc">ExperimentTracker</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">UnifiedTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_queue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracker</span><span class="p">:</span> <span class="n">ExperimentTracker</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># å¼‚æ­¥è®°å½•</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_process_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">event_type</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tracker</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tracker failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>å…³é”®ç‚¹ï¼š</p>
<ol>
<li>ç»Ÿä¸€æ¥å£æŠ½è±¡</li>
<li>å¼‚æ­¥é˜Ÿåˆ—é¿å…é˜»å¡è®­ç»ƒ</li>
<li>é”™è¯¯éš”ç¦»ï¼Œå•ä¸ª tracker å¤±è´¥ä¸å½±å“å…¶ä»–</li>
</ol>
</details>
<p><strong>ç»ƒä¹  2.3ï¼šGit åˆ†æ”¯æ¸…ç†ç­–ç•¥</strong>
ç¼–å†™ä¸€ä¸ªè„šæœ¬ï¼Œè‡ªåŠ¨æ¸…ç†å®éªŒåˆ†æ”¯ã€‚è¦æ±‚ï¼š(1) ä¿ç•™æœ€è¿‘ 30 å¤©çš„åˆ†æ”¯ï¼›(2) ä¿ç•™æœ‰æœªåˆå¹¶æäº¤çš„åˆ†æ”¯ï¼›(3) å½’æ¡£é‡è¦å®éªŒç»“æœã€‚</p>
<p><em>Hint: ä½¿ç”¨ git for-each-ref å’Œ git cherry å‘½ä»¤ã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>

cleanup_experimental_branches<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">cutoff_date</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;30 days ago&quot;</span><span class="w"> </span>+%s<span class="k">)</span>

<span class="w">    </span>git<span class="w"> </span><span class="k">for</span>-each-ref<span class="w"> </span>--format<span class="o">=</span><span class="s1">&#39;%(refname:short) %(committerdate:unix)&#39;</span><span class="w"> </span>refs/heads/exp/<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>branch<span class="w"> </span>timestamp<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="c1"># æ£€æŸ¥å¹´é¾„</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$timestamp</span><span class="w"> </span>-lt<span class="w"> </span><span class="nv">$cutoff_date</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c1"># æ£€æŸ¥æ˜¯å¦æœ‰æœªåˆå¹¶çš„æäº¤</span>
<span class="w">            </span><span class="nv">unmerged</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>cherry<span class="w"> </span>main<span class="w"> </span><span class="nv">$branch</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;^+&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="k">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$unmerged</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c1"># æ£€æŸ¥æ˜¯å¦æ ‡è®°ä¸ºé‡è¦</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span>git<span class="w"> </span>tag<span class="w"> </span>--list<span class="w"> </span><span class="s2">&quot;important/</span><span class="nv">$branch</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>.<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c1"># å½’æ¡£è€Œéåˆ é™¤</span>
<span class="w">                    </span>git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;archive/</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m<span class="k">)</span><span class="s2">/</span><span class="nv">$branch</span><span class="s2">&quot;</span><span class="w"> </span><span class="nv">$branch</span><span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Auto-archived&quot;</span>
<span class="w">                </span><span class="k">fi</span>
<span class="w">                </span>git<span class="w"> </span>branch<span class="w"> </span>-D<span class="w"> </span><span class="nv">$branch</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Deleted: </span><span class="nv">$branch</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Kept (unmerged): </span><span class="nv">$branch</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>
<span class="o">}</span>
</code></pre></div>

<p>å…³é”®æ£€æŸ¥ï¼š</p>
<ol>
<li>æ—¶é—´æˆ³æ¯”è¾ƒ</li>
<li>æœªåˆå¹¶æäº¤æ£€æµ‹</li>
<li>é‡è¦æ€§æ ‡è®°è¯†åˆ«</li>
</ol>
</details>
<h3 id="_17">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  2.4ï¼šé…ç½®å·®å¼‚åˆ†æ</strong>
å®ç°ä¸€ä¸ªå·¥å…·ï¼Œèƒ½å¤Ÿï¼š(1) æ¯”è¾ƒä¸¤ä¸ªå®éªŒçš„é…ç½®å·®å¼‚ï¼›(2) è¯†åˆ«å“ªäº›é…ç½®å˜åŒ–å¯¼è‡´äº†æ€§èƒ½æå‡ï¼›(3) ç”Ÿæˆé…ç½®ä¼˜åŒ–å»ºè®®ã€‚</p>
<p><em>Hint: è€ƒè™‘ä½¿ç”¨å†³ç­–æ ‘æˆ– SHAP å€¼åˆ†æé…ç½®é‡è¦æ€§ã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">import</span> <span class="nn">shap</span>

<span class="k">class</span> <span class="nc">ConfigAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_features</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># æå–æ‰€æœ‰é…ç½®é”®</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
            <span class="n">all_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_flatten_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">parent_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_key</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">parent_key</span> <span class="k">else</span> <span class="n">k</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_key</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">analyze_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">):</span>
        <span class="c1"># å‡†å¤‡æ•°æ®</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
            <span class="n">flat_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span>
            <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">flat_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">]</span>
            <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="n">metric</span><span class="p">])</span>

        <span class="c1"># è®­ç»ƒæ¨¡å‹</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># SHAP åˆ†æ</span>
        <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># ç”Ÿæˆé‡è¦æ€§æ’å</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">):</span>
            <span class="n">importance</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shap_values</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">importance</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">suggest_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_importance</span><span class="p">()</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># æ‰¾å‡ºè¡¨ç°æœ€å¥½çš„é…ç½®</span>
        <span class="n">best_exp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        <span class="n">best_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">best_exp</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span>
        <span class="n">current_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">current_config</span><span class="p">)</span>

        <span class="c1"># åŸºäºé‡è¦æ€§ç”Ÿæˆå»ºè®®</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">imp_score</span> <span class="ow">in</span> <span class="n">importance</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Top 5 é‡è¦å‚æ•°</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">best_config</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">current_flat</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">best_config</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">!=</span> <span class="n">current_flat</span><span class="p">[</span><span class="n">param</span><span class="p">]:</span>
                    <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param</span><span class="p">,</span>
                        <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">current_flat</span><span class="p">[</span><span class="n">param</span><span class="p">],</span>
                        <span class="s1">&#39;suggested&#39;</span><span class="p">:</span> <span class="n">best_config</span><span class="p">[</span><span class="n">param</span><span class="p">],</span>
                        <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">imp_score</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">suggestions</span>
</code></pre></div>

<p>æ ¸å¿ƒæ€è·¯ï¼š</p>
<ol>
<li>ä½¿ç”¨éšæœºæ£®æ—å­¦ä¹ é…ç½®åˆ°æ€§èƒ½çš„æ˜ å°„</li>
<li>SHAP å€¼é‡åŒ–æ¯ä¸ªé…ç½®çš„è´¡çŒ®</li>
<li>åŸºäºå†å²æœ€ä½³å®è·µç”Ÿæˆä¼˜åŒ–å»ºè®®</li>
</ol>
</details>
<p><strong>ç»ƒä¹  2.5ï¼šå®éªŒä»£ç ç‰ˆæœ¬éš”ç¦»</strong>
è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œèƒ½å¤Ÿä¸ºæ¯ä¸ªå®éªŒåˆ›å»ºéš”ç¦»çš„ä»£ç ç¯å¢ƒï¼Œæ”¯æŒï¼š(1) ä»£ç å¿«ç…§ï¼›(2) ä¾èµ–ç‰ˆæœ¬é”å®šï¼›(3) å¿«é€Ÿåˆ‡æ¢å’Œæ¢å¤ã€‚</p>
<p><em>Hint: ç»“åˆ Git worktreeã€Docker æˆ– Python è™šæ‹Ÿç¯å¢ƒã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">venv</span>

<span class="k">class</span> <span class="nc">ExperimentEnvironment</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;environments&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">env_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span> <span class="o">/</span> <span class="n">exp_id</span>

        <span class="c1"># 1. åˆ›å»º Git worktree</span>
        <span class="n">worktree_path</span> <span class="o">=</span> <span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;code&quot;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
            <span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;worktree&quot;</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span> 
            <span class="nb">str</span><span class="p">(</span><span class="n">worktree_path</span><span class="p">),</span> 
            <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;git_commit&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># 2. åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒ</span>
        <span class="n">venv_path</span> <span class="o">=</span> <span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;venv&quot;</span>
        <span class="n">venv</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">venv_path</span><span class="p">,</span> <span class="n">with_pip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 3. é”å®šä¾èµ–ç‰ˆæœ¬</span>
        <span class="n">pip_path</span> <span class="o">=</span> <span class="n">venv_path</span> <span class="o">/</span> <span class="s2">&quot;bin&quot;</span> <span class="o">/</span> <span class="s2">&quot;pip&quot;</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirements&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># ç”Ÿæˆ requirements.txt</span>
        <span class="n">req_file</span> <span class="o">=</span> <span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;requirements.txt&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">req_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># å®‰è£…ä¾èµ–</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">pip_path</span><span class="p">),</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">req_file</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># 4. ä¿å­˜ç¯å¢ƒå…ƒæ•°æ®</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;exp_id&quot;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;git_commit&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">],</span> 
                <span class="n">cwd</span><span class="o">=</span><span class="n">worktree_path</span>
            <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;metadata.json&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">env_path</span>

    <span class="k">def</span> <span class="nf">activate_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">env_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span> <span class="o">/</span> <span class="n">exp_id</span>

        <span class="c1"># ç”Ÿæˆæ¿€æ´»è„šæœ¬</span>
        <span class="n">activate_script</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#!/bin/bash</span>
<span class="s2">export EXPERIMENT_ID=</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span>
<span class="s2">export PYTHONPATH=</span><span class="si">{</span><span class="n">env_path</span><span class="si">}</span><span class="s2">/code:$PYTHONPATH</span>
<span class="s2">source </span><span class="si">{</span><span class="n">env_path</span><span class="si">}</span><span class="s2">/venv/bin/activate</span>
<span class="s2">cd </span><span class="si">{</span><span class="n">env_path</span><span class="si">}</span><span class="s2">/code</span>
<span class="s2">echo &quot;Environment </span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2"> activated&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="n">script_path</span> <span class="o">=</span> <span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;activate.sh&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">activate_script</span><span class="p">)</span>

        <span class="n">script_path</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="mo">0o755</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">script_path</span>

    <span class="k">def</span> <span class="nf">cleanup_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">archive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">env_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span> <span class="o">/</span> <span class="n">exp_id</span>

        <span class="k">if</span> <span class="n">archive</span><span class="p">:</span>
            <span class="c1"># å½’æ¡£é‡è¦æ–‡ä»¶</span>
            <span class="n">archive_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;archives&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span>
            <span class="n">archive_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
                <span class="s2">&quot;tar&quot;</span><span class="p">,</span> <span class="s2">&quot;czf&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">archive_path</span><span class="p">),</span>
                <span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span><span class="p">),</span>
                <span class="n">exp_id</span><span class="p">,</span>
                <span class="s2">&quot;--exclude&quot;</span><span class="p">,</span> <span class="s2">&quot;venv&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--exclude&quot;</span><span class="p">,</span> <span class="s2">&quot;.git&quot;</span>
            <span class="p">])</span>

        <span class="c1"># æ¸…ç† worktree</span>
        <span class="n">worktree_path</span> <span class="o">=</span> <span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;code&quot;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;worktree&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">worktree_path</span><span class="p">)])</span>

        <span class="c1"># åˆ é™¤ç¯å¢ƒç›®å½•</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span>
</code></pre></div>

<p>å…³é”®ç‰¹æ€§ï¼š</p>
<ol>
<li>Git worktree æä¾›ä»£ç éš”ç¦»</li>
<li>Python venv æä¾›ä¾èµ–éš”ç¦»  </li>
<li>å…ƒæ•°æ®è®°å½•ä¿è¯å¯è¿½æº¯æ€§</li>
<li>å½’æ¡£æœºåˆ¶ä¿ç•™é‡è¦å®éªŒ</li>
</ol>
</details>
<p><strong>ç»ƒä¹  2.6ï¼šåˆ†å¸ƒå¼å®éªŒåè°ƒ</strong>
è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼å®éªŒç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒï¼š(1) å¤šæœºå™¨ä¸Šçš„å®éªŒè°ƒåº¦ï¼›(2) èµ„æºï¼ˆGPUï¼‰åˆ†é…ï¼›(3) å®éªŒå¤±è´¥è‡ªåŠ¨é‡è¯•ã€‚</p>
<p><em>Hint: è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å’ŒçŠ¶æ€æœºã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">ExperimentState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
    <span class="n">RETRYING</span> <span class="o">=</span> <span class="s2">&quot;retrying&quot;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ExperimentJob</span><span class="p">:</span>
    <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">ExperimentState</span>
    <span class="n">assigned_worker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">class</span> <span class="nc">DistributedExperimentScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_host</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">redis_host</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span> <span class="o">=</span> <span class="s2">&quot;experiment_queue&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_status</span> <span class="o">=</span> <span class="s2">&quot;worker_status&quot;</span>

    <span class="k">def</span> <span class="nf">submit_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">ExperimentJob</span><span class="p">(</span>
            <span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">ExperimentState</span><span class="o">.</span><span class="n">PENDING</span>
        <span class="p">)</span>

        <span class="c1"># åŠ å…¥é˜Ÿåˆ—</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">exp_id</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;retry_count&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">retry_count</span>
        <span class="p">}))</span>

        <span class="c1"># è®°å½•ä½œä¸šçŠ¶æ€</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job:</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;submitted_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">worker_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å·¥ä½œèŠ‚ç‚¹ä¸»å¾ªç¯&quot;&quot;&quot;</span>

        <span class="c1"># æ³¨å†Œå·¥ä½œèŠ‚ç‚¹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_status</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;idle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resources&#39;</span><span class="p">:</span> <span class="n">resources</span><span class="p">,</span>
            <span class="s1">&#39;last_heartbeat&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}))</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># è·å–ä»»åŠ¡</span>
            <span class="n">job_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">brpop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">job_data</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">job_str</span> <span class="o">=</span> <span class="n">job_data</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">job_str</span><span class="p">)</span>

                <span class="c1"># æ£€æŸ¥èµ„æºéœ€æ±‚</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_run</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">],</span> <span class="n">resources</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_run_experiment</span><span class="p">(</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># æ”¾å›é˜Ÿåˆ—æœ«å°¾</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="p">,</span> <span class="n">job_str</span><span class="p">)</span>

            <span class="c1"># å‘é€å¿ƒè·³</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat</span><span class="p">(</span><span class="n">worker_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_can_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æŸ¥èµ„æºæ˜¯å¦æ»¡è¶³éœ€æ±‚&quot;&quot;&quot;</span>
        <span class="n">required_gpus</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_gpus&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">available_gpus</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gpus&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">required_memory</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_gb&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">available_memory</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_gb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">available_gpus</span> <span class="o">&gt;=</span> <span class="n">required_gpus</span> <span class="ow">and</span> 
                <span class="n">available_memory</span> <span class="o">&gt;=</span> <span class="n">required_memory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;exp_id&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># æ›´æ–°çŠ¶æ€</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job:</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">ExperimentState</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s1">&#39;worker&#39;</span><span class="p">:</span> <span class="n">worker_id</span><span class="p">,</span>
                <span class="s1">&#39;started_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">})</span>

            <span class="c1"># æ›´æ–°å·¥ä½œèŠ‚ç‚¹çŠ¶æ€</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_status</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;busy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;current_job&#39;</span><span class="p">:</span> <span class="n">exp_id</span>
            <span class="p">}))</span>

            <span class="c1"># æ‰§è¡Œå®éªŒ</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_experiment</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span>

            <span class="c1"># æ ‡è®°å®Œæˆ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job:</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">ExperimentState</span><span class="o">.</span><span class="n">COMPLETED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s1">&#39;completed_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="p">})</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># å¤„ç†å¤±è´¥</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_failure</span><span class="p">(</span><span class="n">exp_id</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_handle_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">retry_count</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retry_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">max_retries</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_retries&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
            <span class="c1"># é‡è¯•</span>
            <span class="n">job</span><span class="p">[</span><span class="s1">&#39;retry_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retry_count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">job</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExperimentState</span><span class="o">.</span><span class="n">RETRYING</span><span class="o">.</span><span class="n">value</span>

            <span class="c1"># å»¶è¿Ÿé‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">retry_count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="si">}</span><span class="s2">:delayed:</span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                           <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">job</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job:</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">ExperimentState</span><span class="o">.</span><span class="n">RETRYING</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s1">&#39;retry_count&#39;</span><span class="p">:</span> <span class="n">retry_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;last_error&#39;</span><span class="p">:</span> <span class="n">error</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># æœ€ç»ˆå¤±è´¥</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job:</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">ExperimentState</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s1">&#39;failed_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">error</span>
            <span class="p">})</span>
</code></pre></div>

<p>ç³»ç»Ÿè®¾è®¡è¦ç‚¹ï¼š</p>
<ol>
<li>Redis ä½œä¸ºä¸­å¤®åè°ƒå™¨</li>
<li>åŸºäºèµ„æºçš„ä»»åŠ¡åˆ†é…</li>
<li>çŠ¶æ€æœºç®¡ç†å®éªŒç”Ÿå‘½å‘¨æœŸ</li>
<li>æŒ‡æ•°é€€é¿çš„é‡è¯•æœºåˆ¶</li>
<li>å¿ƒè·³æœºåˆ¶æ£€æµ‹å·¥ä½œèŠ‚ç‚¹å¥åº·</li>
</ol>
</details>
<p><strong>ç»ƒä¹  2.7ï¼šä»£ç è…åŒ–åº¦é‡ä¸é¢„è­¦</strong>
å¼€å‘ä¸€ä¸ªç³»ç»Ÿï¼Œèƒ½å¤Ÿï¼š(1) é‡åŒ–ä»£ç è…åŒ–ç¨‹åº¦ï¼›(2) é¢„æµ‹æŠ€æœ¯å€ºåŠ¡å¢é•¿è¶‹åŠ¿ï¼›(3) è‡ªåŠ¨ç”Ÿæˆé‡æ„å»ºè®®ã€‚</p>
<p><em>Hint: ç»“åˆé™æ€åˆ†æã€Git å†å²å’Œå¤æ‚åº¦åº¦é‡ã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">git</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="k">class</span> <span class="nc">CodeHealthMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">Repo</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">calculate_health_score</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¡ç®—ä»£ç å¥åº·åº¦å¾—åˆ† (0-100)&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_complexity</span><span class="p">(),</span>
            <span class="s1">&#39;duplication&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_duplication</span><span class="p">(),</span>
            <span class="s1">&#39;test_coverage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_test_coverage</span><span class="p">(),</span>
            <span class="s1">&#39;debt_density&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_technical_debt</span><span class="p">(),</span>
            <span class="s1">&#39;change_frequency&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_change_frequency</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># åŠ æƒè®¡ç®—æ€»åˆ†</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span>      <span class="c1"># å¤æ‚åº¦è¶Šé«˜åˆ†æ•°è¶Šä½</span>
            <span class="s1">&#39;duplication&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span>     <span class="c1"># é‡å¤ä»£ç è¶Šå¤šåˆ†æ•°è¶Šä½</span>
            <span class="s1">&#39;test_coverage&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>   <span class="c1"># æµ‹è¯•è¦†ç›–ç‡è¶Šé«˜åˆ†æ•°è¶Šé«˜</span>
            <span class="s1">&#39;debt_density&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span>   <span class="c1"># æŠ€æœ¯å€ºåŠ¡è¶Šå¤šåˆ†æ•°è¶Šä½</span>
            <span class="s1">&#39;change_frequency&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.1</span> <span class="c1"># é¢‘ç¹ä¿®æ”¹çš„ä»£ç åˆ†æ•°è¶Šä½</span>
        <span class="p">}</span>

        <span class="n">score</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># åŸºå‡†åˆ†</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">*</span> <span class="n">value</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_measure_complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æµ‹é‡åœˆå¤æ‚åº¦&quot;&quot;&quot;</span>
        <span class="n">total_complexity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">file_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">py_file</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.py&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">py_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">complexity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cyclomatic_complexity</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
                <span class="n">total_complexity</span> <span class="o">+=</span> <span class="n">complexity</span>
                <span class="n">file_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">total_complexity</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">file_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_measure_duplication</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æµ‹é‡ä»£ç é‡å¤ç‡&quot;&quot;&quot;</span>
        <span class="c1"># ä½¿ç”¨ç®€åŒ–çš„æ–¹æ³•ï¼šç›¸ä¼¼ä»£ç å—æ£€æµ‹</span>
        <span class="n">code_blocks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">py_file</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.py&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">py_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># æå–å‡½æ•°ä½“ä½œä¸ºä»£ç å—</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
                        <span class="n">code_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>

        <span class="c1"># è®¡ç®—ç›¸ä¼¼åº¦</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">block1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">code_blocks</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">block2</span> <span class="ow">in</span> <span class="n">code_blocks</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="n">block2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
                    <span class="n">duplicates</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">duplicates</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code_blocks</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">predict_debt_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_ahead</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é¢„æµ‹æŠ€æœ¯å€ºåŠ¡å¢é•¿è¶‹åŠ¿&quot;&quot;&quot;</span>

        <span class="c1"># æ”¶é›†å†å²æ•°æ®</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">days_ago</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">):</span>  <span class="c1"># è¿‡å»90å¤©ï¼Œæ¯å‘¨é‡‡æ ·</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_ago</span><span class="p">)</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_commit_at_date</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">hexsha</span><span class="p">)</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
                    <span class="s1">&#39;debt_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_debt_markers</span><span class="p">(),</span>
                    <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_complexity</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="c1"># å›åˆ°å½“å‰åˆ†æ”¯</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>

        <span class="c1"># çº¿æ€§å›å½’é¢„æµ‹</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">))])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;debt_count&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span><span class="p">])</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># é¢„æµ‹æœªæ¥</span>
        <span class="n">future_x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">+</span> <span class="n">days_ahead</span> <span class="o">//</span> <span class="mi">7</span>
        <span class="n">predicted_debt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">future_x</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;current_debt&#39;</span><span class="p">:</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;debt_count&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">history</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;predicted_debt&#39;</span><span class="p">:</span> <span class="n">predicted_debt</span><span class="p">,</span>
            <span class="s1">&#39;growth_rate&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_refactoring_suggestions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç”Ÿæˆé‡æ„å»ºè®®&quot;&quot;&quot;</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># åˆ†æçƒ­ç‚¹æ–‡ä»¶ï¼ˆé¢‘ç¹ä¿®æ”¹ä¸”å¤æ‚åº¦é«˜ï¼‰</span>
        <span class="n">hotspots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identify_hotspots</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">hotspots</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Top 5 çƒ­ç‚¹</span>
            <span class="n">suggestion</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;complexity&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;é«˜å¤æ‚åº¦: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;complexity&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;æ‹†åˆ†å¤§å‡½æ•°ä¸ºæ›´å°çš„åŠŸèƒ½å•å…ƒ&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;change_frequency&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;é¢‘ç¹ä¿®æ”¹: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;change_frequency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">æ¬¡/æœˆ&quot;</span><span class="p">)</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;è€ƒè™‘æŠ½è±¡å‡ºç¨³å®šæ¥å£&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;duplication&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ä»£ç é‡å¤: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;duplication&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;æå–å…¬å…±ä»£ç åˆ°å·¥å…·æ¨¡å—&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;test_coverage&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æµ‹è¯•è¦†ç›–ç‡ä½: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;test_coverage&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;å¢åŠ å•å…ƒæµ‹è¯•è¦†ç›–&quot;</span><span class="p">)</span>

            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">suggestion</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">suggestions</span>

    <span class="k">def</span> <span class="nf">_identify_hotspots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¯†åˆ«ä»£ç çƒ­ç‚¹&quot;&quot;&quot;</span>
        <span class="n">file_metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># åˆ†æ Git å†å²</span>
        <span class="k">for</span> <span class="n">commit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">iter_commits</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="n">max_count</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">commit</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_metrics</span><span class="p">:</span>
                        <span class="n">file_metrics</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;change_frequency&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s1">&#39;duplication&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s1">&#39;test_coverage&#39;</span><span class="p">:</span> <span class="mi">0</span>
                        <span class="p">}</span>
                    <span class="n">file_metrics</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s1">&#39;change_frequency&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># è®¡ç®—å½“å‰æŒ‡æ ‡</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_metrics</span><span class="p">:</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">file_path</span>
            <span class="k">if</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="n">file_metrics</span><span class="p">[</span><span class="n">file_path</span><span class="p">][</span><span class="s1">&#39;complexity&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cyclomatic_complexity</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="c1"># æŒ‰ç»¼åˆå¾—åˆ†æ’åº</span>
        <span class="n">scored</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">file_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;change_frequency&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span> 
                    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;complexity&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;duplication&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>
            <span class="n">scored</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scored</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>ç›‘æ§ç³»ç»Ÿç‰¹ç‚¹ï¼š</p>
<ol>
<li>å¤šç»´åº¦å¥åº·è¯„åˆ†</li>
<li>åŸºäºå†å²æ•°æ®çš„è¶‹åŠ¿é¢„æµ‹</li>
<li>çƒ­ç‚¹åˆ†æè¯†åˆ«é—®é¢˜åŒºåŸŸ</li>
<li>å¯æ“ä½œçš„é‡æ„å»ºè®®</li>
<li>æŒç»­ç›‘æ§å’Œé¢„è­¦æœºåˆ¶</li>
</ol>
</details>
<p><strong>ç»ƒä¹  2.8ï¼šå®éªŒç»“æœè‡ªåŠ¨åˆ†æ</strong>
å®ç°ä¸€ä¸ªç³»ç»Ÿï¼Œèƒ½å¤Ÿè‡ªåŠ¨åˆ†æå®éªŒç»“æœï¼Œè¯†åˆ«ï¼š(1) å¼‚å¸¸å®éªŒï¼›(2) æ€§èƒ½ç“¶é¢ˆï¼›(3) æœ€ä¼˜é…ç½®ç»„åˆã€‚</p>
<p><em>Hint: ä½¿ç”¨å¼‚å¸¸æ£€æµ‹ã€æ€§èƒ½å‰–æå’Œè´å¶æ–¯ä¼˜åŒ–ã€‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process.kernels</span> <span class="kn">import</span> <span class="n">Matern</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">ExperimentAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_history</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">experiment_history</span>

    <span class="k">def</span> <span class="nf">detect_anomalies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æµ‹å¼‚å¸¸å®éªŒ&quot;&quot;&quot;</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># æå–å…³é”®æŒ‡æ ‡</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;training_time&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># ä½¿ç”¨ IQR æ–¹æ³•æ£€æµ‹å¼‚å¸¸</span>
            <span class="n">q1</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
            <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">iqr</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">iqr</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">lower_bound</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">:</span>
                    <span class="n">anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                        <span class="s1">&#39;expected_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">),</span>
                        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span>
                    <span class="p">})</span>

        <span class="c1"># æ£€æµ‹è®­ç»ƒæ›²çº¿å¼‚å¸¸</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;training_curve&#39;</span> <span class="ow">in</span> <span class="n">exp</span><span class="p">:</span>
                <span class="n">curve_anomalies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_curve_anomalies</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;training_curve&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">curve_anomalies</span><span class="p">:</span>
                    <span class="n">anomalies</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">curve_anomalies</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">anomalies</span>

    <span class="k">def</span> <span class="nf">_detect_curve_anomalies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curve</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æµ‹è®­ç»ƒæ›²çº¿å¼‚å¸¸&quot;&quot;&quot;</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># æ£€æµ‹ loss çˆ†ç‚¸</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">curve</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">losses</span><span class="p">)):</span>
            <span class="n">anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;loss_explosion&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;critical&#39;</span>
            <span class="p">})</span>

        <span class="c1"># æ£€æµ‹è¿‡æ‹Ÿåˆ</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">train_acc</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train_acc&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]]</span>
            <span class="n">val_acc</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_acc&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]]</span>

            <span class="k">if</span> <span class="n">train_acc</span> <span class="ow">and</span> <span class="n">val_acc</span><span class="p">:</span>
                <span class="n">gap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_acc</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val_acc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gap</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># 10% å·®è·</span>
                    <span class="n">anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;overfitting&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;train_val_gap&#39;</span><span class="p">:</span> <span class="n">gap</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">anomalies</span>

    <span class="k">def</span> <span class="nf">identify_bottlenecks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ&quot;&quot;&quot;</span>
        <span class="n">bottlenecks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data_loading&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;forward_pass&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;backward_pass&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;optimizer_step&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;profiling&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exp</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">prof</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;profiling&#39;</span><span class="p">]</span>

            <span class="c1"># åˆ†æå„é˜¶æ®µè€—æ—¶</span>
            <span class="n">total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">stage</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">prof</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">/</span> <span class="n">total_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="c1"># å¦‚æœæŸé˜¶æ®µå æ¯”å¼‚å¸¸é«˜</span>
                <span class="n">expected_percentages</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;data_loading&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="s1">&#39;forward_pass&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                    <span class="s1">&#39;backward_pass&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
                    <span class="s1">&#39;optimizer_step&#39;</span><span class="p">:</span> <span class="mi">20</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">expected_percentages</span><span class="p">:</span>
                    <span class="n">expected</span> <span class="o">=</span> <span class="n">expected_percentages</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">percentage</span> <span class="o">&gt;</span> <span class="n">expected</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">:</span>  <span class="c1"># è¶…è¿‡é¢„æœŸ 50%</span>
                        <span class="n">bottlenecks</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;percentage&#39;</span><span class="p">:</span> <span class="n">percentage</span><span class="p">,</span>
                            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
                            <span class="s1">&#39;suggestions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_optimization_suggestions</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
                        <span class="p">})</span>

        <span class="k">return</span> <span class="n">bottlenecks</span>

    <span class="k">def</span> <span class="nf">_get_optimization_suggestions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è·å–ä¼˜åŒ–å»ºè®®&quot;&quot;&quot;</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data_loading&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;å¢åŠ æ•°æ®åŠ è½½çš„ num_workers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®æ ¼å¼ (å¦‚ HDF5)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;å®ç°æ•°æ®é¢„å–å’Œç¼“å­˜&quot;</span><span class="p">,</span>
                <span class="s2">&quot;è€ƒè™‘ä½¿ç”¨ DALI æˆ–å…¶ä»–åŠ é€Ÿåº“&quot;</span>
            <span class="p">],</span>
            <span class="s1">&#39;forward_pass&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ (AMP)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;å¯ç”¨ cudnn.benchmark&quot;</span><span class="p">,</span>
                <span class="s2">&quot;è€ƒè™‘æ¨¡å‹å‰ªææˆ–é‡åŒ–&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ä½¿ç”¨æ›´é«˜æ•ˆçš„ç®—å­å®ç°&quot;</span>
            <span class="p">],</span>
            <span class="s1">&#39;backward_pass&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯å‡å°‘æ˜¾å­˜å ç”¨&quot;</span><span class="p">,</span>
                <span class="s2">&quot;å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹&quot;</span><span class="p">,</span>
                <span class="s2">&quot;è€ƒè™‘ä½¿ç”¨ ZeRO ä¼˜åŒ–å™¨&quot;</span><span class="p">,</span>
                <span class="s2">&quot;æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¿…è¦çš„æ¢¯åº¦è®¡ç®—&quot;</span>
            <span class="p">],</span>
            <span class="s1">&#39;optimizer_step&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;ä½¿ç”¨èåˆä¼˜åŒ–å™¨ (å¦‚ FusedAdam)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;å‡å°‘å‚æ•°æ›´æ–°é¢‘ç‡&quot;</span><span class="p">,</span>
                <span class="s2">&quot;è€ƒè™‘ä½¿ç”¨ LARS æˆ– LAMB&quot;</span><span class="p">,</span>
                <span class="s2">&quot;æ£€æŸ¥æƒé‡è¡°å‡è®¾ç½®&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">suggestions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">find_optimal_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä½¿ç”¨è´å¶æ–¯ä¼˜åŒ–æ‰¾åˆ°æœ€ä¼˜é…ç½®&quot;&quot;&quot;</span>

        <span class="c1"># å‡†å¤‡æ•°æ®</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="n">flat_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_config</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span>
            <span class="n">param_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flat_config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flat_config</span><span class="p">)</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span>

        <span class="c1"># è½¬æ¢ä¸ºæ•°å€¼çŸ©é˜µ</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># ç®€å•çš„æ•°å€¼åŒ–</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># ç®€åŒ–å¤„ç†</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

        <span class="c1"># é«˜æ–¯è¿‡ç¨‹å›å½’</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">Matern</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="n">gpr</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">gpr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># è´å¶æ–¯ä¼˜åŒ–ï¼šæ‰¾ä¸‹ä¸€ä¸ªæœ€ä½³ç‚¹</span>
        <span class="k">def</span> <span class="nf">acquisition_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Expected Improvement&quot;&quot;&quot;</span>
            <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">best_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">best_y</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
            <span class="n">ei</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">best_y</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ei</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># éšæœºæœç´¢æ‰¾æœ€å¤§ EI</span>
        <span class="n">best_ei</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">best_config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="c1"># åœ¨å·²æœ‰é…ç½®é™„è¿‘é‡‡æ ·</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.1</span>

            <span class="n">ei</span> <span class="o">=</span> <span class="n">acquisition_function</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ei</span> <span class="o">&gt;</span> <span class="n">best_ei</span><span class="p">:</span>
                <span class="n">best_ei</span> <span class="o">=</span> <span class="n">ei</span>
                <span class="n">best_config</span> <span class="o">=</span> <span class="n">candidate</span>

        <span class="c1"># è½¬æ¢å›é…ç½®å­—å…¸</span>
        <span class="n">optimal_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">):</span>
            <span class="n">optimal_config</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_config</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># é¢„æµ‹æ€§èƒ½</span>
        <span class="n">predicted_score</span><span class="p">,</span> <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">best_config</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
            <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">optimal_config</span><span class="p">,</span>
            <span class="s1">&#39;predicted_score&#39;</span><span class="p">:</span> <span class="n">predicted_score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;uncertainty&#39;</span><span class="p">:</span> <span class="n">uncertainty</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;expected_improvement&#39;</span><span class="p">:</span> <span class="n">best_ei</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_flatten_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å±•å¹³åµŒå¥—é…ç½®&quot;&quot;&quot;</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="n">key</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">flat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flatten_config</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">full_key</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flat</span><span class="p">[</span><span class="n">full_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">flat</span>
</code></pre></div>

<p>åˆ†æç³»ç»ŸåŠŸèƒ½ï¼š</p>
<ol>
<li>å¼‚å¸¸æ£€æµ‹ï¼šIQR æ–¹æ³• + æ›²çº¿åˆ†æ</li>
<li>ç“¶é¢ˆè¯†åˆ«ï¼šæ€§èƒ½å‰–æ + é˜¶æ®µåˆ†æ</li>
<li>é…ç½®ä¼˜åŒ–ï¼šè´å¶æ–¯ä¼˜åŒ– + é«˜æ–¯è¿‡ç¨‹</li>
<li>å¯æ“ä½œå»ºè®®ï¼šé’ˆå¯¹æ€§ä¼˜åŒ–æ–¹æ¡ˆ</li>
<li>ä¸ç¡®å®šæ€§é‡åŒ–ï¼šé¢„æµ‹ç½®ä¿¡åº¦</li>
</ol>
</details>
<hr />
<p>é€šè¿‡å®Œæˆè¿™äº›ç»ƒä¹ ï¼Œä½ å°†æŒæ¡æ„å»ºå¥å£®çš„ LLM åè®­ç»ƒå®éªŒåŸºç¡€è®¾æ–½çš„æ ¸å¿ƒæŠ€èƒ½ã€‚è®°ä½ï¼Œå¥½çš„åŸºç¡€è®¾æ–½æ˜¯é«˜æ•ˆå®éªŒçš„åŸºçŸ³ï¼Œå€¼å¾—åœ¨é¡¹ç›®åˆæœŸæŠ•å…¥æ—¶é—´å»ºè®¾ã€‚</p>
            </article>
            
            <nav class="page-nav"><a href="chapter1.html" class="nav-link prev">â† ç¬¬ä¸€ç« ï¼šåè®­ç»ƒåŸºç¡€ç†è®º</a><a href="chapter3.html" class="nav-link next">ç¬¬ä¸‰ç« ï¼šæ•°æ®å·¥ç¨‹ â†’</a></nav>
        </main>
    </div>
</body>
</html>