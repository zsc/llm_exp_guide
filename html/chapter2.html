<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>第二章：实验代码基础设施</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">LLM 后训练实验设计指南</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第一章：后训练基础理论</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第二章：实验代码基础设施</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第三章：数据工程</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第四章：纯语言任务实验设计</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第五章：多模态任务实验设计</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第六章：强化学习与人类反馈</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第七章：训练循环与迭代优化</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第八章：评估与基准测试</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第九章：生产部署与监控</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第十章：案例研究与最佳实践</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="_1">第二章：实验代码基础设施</h1>
<p>构建可维护、可扩展的实验代码架构是成功进行 LLM 后训练的基石。本章将深入探讨如何设计和实现一个健壮的实验基础设施，涵盖配置管理、版本控制、实验追踪等关键组件。我们将重点解决实际工程中的挑战：如何在快速迭代的同时保持代码质量，如何管理数百个实验的配置和结果，以及如何防止技术债务的累积。</p>
<h2 id="21">2.1 实验配置管理</h2>
<h3 id="_2">配置文件格式选择</h3>
<p>在 LLM 后训练项目中，配置管理的复杂度远超传统深度学习项目。一个典型的实验可能包含上百个超参数，涉及模型架构、训练策略、数据处理、评估指标等多个维度。选择合适的配置格式至关重要。</p>
<p><strong>YAML 配置的优势与劣势</strong></p>
<p>YAML 因其可读性强而广受欢迎，特别适合嵌套结构的表达：</p>
<div class="codehilite"><pre><span></span><code><span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">architecture</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llama2</span>
<span class="w">  </span><span class="nt">hidden_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4096</span>
<span class="w">  </span><span class="nt">num_layers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="w">  </span><span class="nt">attention</span><span class="p">:</span>
<span class="w">    </span><span class="nt">num_heads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<span class="w">    </span><span class="nt">head_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<span class="w">    </span><span class="nt">rotary_embedding</span><span class="p">:</span>
<span class="w">      </span><span class="nt">base</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<span class="w">      </span><span class="nt">scaling_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</code></pre></div>

<p>优势：</p>
<ul>
<li>人类可读性最佳，适合配置审查</li>
<li>支持注释，便于文档化</li>
<li>层次结构清晰，适合复杂配置</li>
<li>生态系统成熟，工具链完善</li>
</ul>
<p>劣势：</p>
<ul>
<li>缩进敏感，容易出错</li>
<li>类型推断可能产生意外（如 "no" 被解析为布尔值）</li>
<li>不支持变量引用和计算表达式</li>
<li>大文件解析速度较慢</li>
</ul>
<p><strong>TOML 配置的权衡</strong></p>
<p>TOML 在 Rust 和 Python 社区逐渐流行，提供了更严格的语法：</p>
<div class="codehilite"><pre><span></span><code><span class="k">[model]</span>
<span class="n">architecture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;llama2&quot;</span>
<span class="n">hidden_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4096</span>
<span class="n">num_layers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>

<span class="k">[model.attention]</span>
<span class="n">num_heads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span>
<span class="n">head_dim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span>

<span class="k">[model.attention.rotary_embedding]</span>
<span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span>
<span class="n">scaling_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
</code></pre></div>

<p>优势：</p>
<ul>
<li>语法明确，歧义少</li>
<li>原生支持日期时间类型</li>
<li>表格数组语法适合批量实验配置</li>
</ul>
<p>劣势：</p>
<ul>
<li>深层嵌套可读性下降</li>
<li>数组和内联表的语法较复杂</li>
<li>生态系统相对较新</li>
</ul>
<p><strong>Python 配置的灵活性</strong></p>
<p>直接使用 Python 文件作为配置提供了最大的灵活性：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="n">architecture</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;llama2&quot;</span>
    <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span>
    <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># 动态计算参数量</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_params</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">scale_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;动态调整模型规模&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</code></pre></div>

<p>优势：</p>
<ul>
<li>支持动态计算和条件逻辑</li>
<li>类型检查和 IDE 支持完善</li>
<li>可以复用代码和导入模块</li>
<li>支持配置验证和默认值</li>
</ul>
<p>劣势：</p>
<ul>
<li>安全性风险（执行任意代码）</li>
<li>非技术人员难以修改</li>
<li>版本控制中 diff 可读性较差</li>
</ul>
<h3 id="_3">配置继承与覆盖机制</h3>
<p>实践中，我们通常需要一个基础配置和多个实验变体。设计良好的继承机制可以大幅减少配置冗余：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ConfigManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">base_config_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_config_path</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">inherit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;支持多级继承&quot;&quot;&quot;</span>
        <span class="n">parent_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">parent_config_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_merge</span><span class="p">(</span><span class="n">parent_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_chain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_config_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">override</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overrides</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;支持命令行覆盖&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">overrides</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_nested_value</span><span class="p">(</span><span class="n">key_path</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deep_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;递归合并配置字典&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">override</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_merge</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<p><strong>配置覆盖的优先级设计</strong></p>
<p>一个清晰的优先级体系避免了配置冲突：</p>
<ol>
<li>命令行参数（最高优先级）</li>
<li>环境变量</li>
<li>实验特定配置文件</li>
<li>用户配置文件</li>
<li>项目默认配置（最低优先级）</li>
</ol>
<div class="codehilite"><pre><span></span><code>优先级链：
CLI Args &gt; ENV &gt; experiment.yaml &gt; user.yaml &gt; default.yaml
</code></pre></div>

<h3 id="_4">配置验证与类型检查</h3>
<p>使用 Pydantic 或 attrs 进行运行时验证可以及早发现配置错误：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="k">class</span> <span class="nc">TrainingConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">multiple_of</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">optimizer</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="s2">&quot;sgd&quot;</span><span class="p">,</span> <span class="s2">&quot;adamw&quot;</span><span class="p">]</span>
    <span class="n">gradient_accumulation_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_batch_size</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;gradient_accumulation_steps&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">effective_batch</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;gradient_accumulation_steps&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">effective_batch</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effective batch size </span><span class="si">{</span><span class="n">effective_batch</span><span class="si">}</span><span class="s2"> too large&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_lr_schedule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;sgd&quot;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SGD learning rate typically should be &lt; 0.1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</code></pre></div>

<h2 id="22-flag-git">2.2 Flag、环境变量与 Git 分支策略</h2>
<h3 id="command-line-flags">Command-line Flags 的设计原则</h3>
<p>命令行参数是实验配置的第一接触点，良好的设计能显著提升实验效率。以下是经过大规模实验验证的设计原则：</p>
<p><strong>层次化的参数组织</strong></p>
<p>避免平铺所有参数，而是按功能域组织：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">argparse</span>

<span class="k">def</span> <span class="nf">create_parser</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="c1"># 使用参数组提高可读性</span>
    <span class="n">model_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="n">model_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model.name&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;llama2-7b&quot;</span><span class="p">)</span>
    <span class="n">model_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model.checkpoint&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">model_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model.dtype&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fp32&quot;</span><span class="p">,</span> <span class="s2">&quot;fp16&quot;</span><span class="p">,</span> <span class="s2">&quot;bf16&quot;</span><span class="p">])</span>

    <span class="n">training_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;training&quot;</span><span class="p">)</span>
    <span class="n">training_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--training.batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">training_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--training.learning_rate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
    <span class="n">training_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--training.warmup_steps&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="n">data_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
    <span class="n">data_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data.train_path&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data.val_path&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data.num_workers&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span>
</code></pre></div>

<p><strong>智能默认值与必需参数</strong></p>
<p>区分必需参数和可选参数，为常见场景提供合理默认值：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">FlagValidator</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_flags</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># 自动推断相关参数</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">distributed</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># 根据硬件自动设置</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>

        <span class="c1"># 批量大小自动调整</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_checkpointing</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reducing batch size from </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> to 16 due to gradient checkpointing&quot;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">16</span>

        <span class="k">return</span> <span class="n">args</span>
</code></pre></div>

<p><strong>参数别名与简写</strong></p>
<p>为常用参数提供简写，提高命令行效率：</p>
<div class="codehilite"><pre><span></span><code><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;--batch-size&quot;</span><span class="p">,</span> <span class="s2">&quot;--training.batch_size&quot;</span><span class="p">,</span> 
                   <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Training batch size per device&quot;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-lr&quot;</span><span class="p">,</span> <span class="s2">&quot;--learning-rate&quot;</span><span class="p">,</span> <span class="s2">&quot;--training.lr&quot;</span><span class="p">,</span>
                   <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Peak learning rate&quot;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="s2">&quot;--epochs&quot;</span><span class="p">,</span> <span class="s2">&quot;--num-epochs&quot;</span><span class="p">,</span>
                   <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;num_epochs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of training epochs&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_5">环境变量的使用场景</h3>
<p>环境变量适合管理跨实验的全局设置和敏感信息：</p>
<p><strong>分层的环境变量体系</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 系统级别（集群配置）</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1,2,3
<span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">8</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">NCCL_DEBUG</span><span class="o">=</span>INFO

<span class="c1"># 项目级别（路径和凭证）</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LLM_DATA_ROOT</span><span class="o">=</span>/mnt/data/llm_datasets
<span class="nb">export</span><span class="w"> </span><span class="nv">LLM_CHECKPOINT_DIR</span><span class="o">=</span>/mnt/checkpoints
<span class="nb">export</span><span class="w"> </span><span class="nv">WANDB_API_KEY</span><span class="o">=</span>your_api_key_here
<span class="nb">export</span><span class="w"> </span><span class="nv">HF_TOKEN</span><span class="o">=</span>your_huggingface_token

<span class="c1"># 实验级别（运行时配置）</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LLM_EXPERIMENT_NAME</span><span class="o">=</span>dpo_ablation_v3
<span class="nb">export</span><span class="w"> </span><span class="nv">LLM_RUN_ID</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d_%H%M%S<span class="k">)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LLM_DEBUG_MODE</span><span class="o">=</span><span class="m">1</span>
</code></pre></div>

<p><strong>环境变量的最佳实践</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">EnvConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;统一管理环境变量&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_data_root</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取数据根目录，支持多级fallback&quot;&quot;&quot;</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_DATA_ROOT&quot;</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DATA_ROOT&quot;</span><span class="p">),</span>
            <span class="s2">&quot;/data/llm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;./data&quot;</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid data root found&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_wandb_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;安全地获取 W&amp;B 配置&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">api_key</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WANDB_API_KEY&quot;</span><span class="p">):</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;api_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="k">if</span> <span class="n">project</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WANDB_PROJECT&quot;</span><span class="p">):</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WANDB_ENTITY&quot;</span><span class="p">):</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_debug_mode</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检查调试模式&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_DEBUG_MODE&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="git">Git 分支管理实践</h3>
<p>在快速迭代的实验环境中，Git 分支策略需要平衡实验自由度和代码质量：</p>
<p><strong>实验分支命名规范</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 功能开发分支</span>
feature/distributed-dpo
feature/multimodal-alignment

<span class="c1"># 实验分支（短期）</span>
exp/20250105-lr-sweep
exp/20250106-batch-size-ablation

<span class="c1"># 个人实验分支（更自由）</span>
dev/alice/rope-scaling
dev/bob/attention-variants

<span class="c1"># 长期研究分支</span>
research/constitutional-ai
research/online-rlhf
</code></pre></div>

<p><strong>分支保护与合并策略</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/branch_protection.yml</span>
<span class="n">protection_rules</span><span class="p">:</span>
  <span class="n">main</span><span class="p">:</span>
    <span class="n">required_reviews</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">dismiss_stale_reviews</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">require_code_owner_reviews</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">required_status_checks</span><span class="p">:</span>

      <span class="o">-</span> <span class="n">lint</span>
      <span class="o">-</span> <span class="nb">type</span><span class="o">-</span><span class="n">check</span>
      <span class="o">-</span> <span class="n">unit</span><span class="o">-</span><span class="n">tests</span>
    <span class="n">enforce_admins</span><span class="p">:</span> <span class="n">false</span>

  <span class="n">release</span><span class="o">/*</span><span class="p">:</span>
    <span class="n">required_reviews</span><span class="p">:</span> <span class="mi">3</span>
    <span class="n">require_code_owner_reviews</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">required_status_checks</span><span class="p">:</span>

      <span class="o">-</span> <span class="nb">all</span><span class="o">-</span><span class="n">tests</span>
      <span class="o">-</span> <span class="n">integration</span><span class="o">-</span><span class="n">tests</span>
      <span class="o">-</span> <span class="n">benchmark</span><span class="o">-</span><span class="n">regression</span>
</code></pre></div>

<p><strong>实验分支的生命周期管理</strong></p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># scripts/manage_exp_branches.sh</span>

<span class="c1"># 自动清理过期的实验分支</span>
cleanup_old_exp_branches<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">days_old</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">30</span><span class="si">}</span>

<span class="w">    </span>git<span class="w"> </span><span class="k">for</span>-each-ref<span class="w"> </span>--format<span class="o">=</span><span class="s1">&#39;%(refname:short) %(committerdate:unix)&#39;</span><span class="w"> </span>refs/heads/exp/<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>branch<span class="w"> </span>timestamp<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nv">age_days</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="o">(</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">timestamp</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">86400</span><span class="w"> </span><span class="k">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$age</span><span class="se">\_</span>days<span class="w"> </span>-gt<span class="w"> </span><span class="nv">$days_old</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Deleting old experimental branch: </span><span class="nv">$branch</span><span class="s2"> (</span><span class="si">${</span><span class="nv">age_days</span><span class="si">}</span><span class="s2"> days old)&quot;</span>
<span class="w">            </span>git<span class="w"> </span>branch<span class="w"> </span>-D<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$branch</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>
<span class="o">}</span>

<span class="c1"># 归档重要实验分支</span>
archive_exp_branch<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">branch</span><span class="o">=</span><span class="nv">$1</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">archive_tag</span><span class="o">=</span><span class="s2">&quot;archive/</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="s2">/</span><span class="si">${</span><span class="nv">branch</span><span class="p">##*/</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span>git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$archive</span><span class="s2">\_tag&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$branch</span><span class="s2">&quot;</span><span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Archived experimental branch </span><span class="nv">$branch</span><span class="s2">&quot;</span>
<span class="w">    </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$archive_tag</span><span class="s2">&quot;</span>
<span class="w">    </span>git<span class="w"> </span>branch<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$branch</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Archived </span><span class="nv">$branch</span><span class="s2"> as </span><span class="nv">$archive_tag</span><span class="s2">&quot;</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="23">2.3 实验追踪与版本控制</h2>
<h3 id="_6">实验追踪工具选择</h3>
<p>选择合适的实验追踪工具是建立可重现研究流程的关键。主流工具各有特色，需要根据团队规模和需求选择。</p>
<p><strong>MLflow：开源标准的选择</strong></p>
<p>MLflow 提供了完整的实验生命周期管理：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">mlflow.tracking</span> <span class="kn">import</span> <span class="n">MlflowClient</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">class</span> <span class="nc">MLflowExperimentTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tracking_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;file:./mlruns&quot;</span><span class="p">):</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">tracking_uri</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="n">experiment_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">MlflowClient</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;开始一个新的实验运行&quot;&quot;&quot;</span>
        <span class="c1"># 生成配置哈希作为运行标识</span>
        <span class="n">config_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>

        <span class="n">run_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">config_hash</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
            <span class="c1"># 记录配置参数</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten_dict</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>

            <span class="c1"># 记录标签</span>
            <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

            <span class="c1"># 记录代码版本</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s2">&quot;git_commit&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_commit</span><span class="p">())</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s2">&quot;git_branch&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_branch</span><span class="p">())</span>

            <span class="k">return</span> <span class="n">run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span>

    <span class="k">def</span> <span class="nf">log_metrics_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;批量记录指标&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_artifact_with_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;记录文件及其元数据&quot;&quot;&quot;</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="c1"># 同时记录元数据</span>
        <span class="n">metadata_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">.metadata.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">)</span>
</code></pre></div>

<p><strong>Weights &amp; Biases：云原生的强大功能</strong></p>
<p>W&amp;B 提供了更丰富的可视化和协作功能：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">wandb</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">WandBTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>

    <span class="k">def</span> <span class="nf">init_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">resume</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初始化 W&amp;B 运行&quot;&quot;&quot;</span>
        <span class="n">run</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
            <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
            <span class="n">entity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">,</span>  <span class="c1"># 支持断点续训</span>
            <span class="n">save_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 自动保存代码</span>
            <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_tags</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 定义自定义指标</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;train/step&quot;</span><span class="p">)</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;train/*&quot;</span><span class="p">,</span> <span class="n">step_metric</span><span class="o">=</span><span class="s2">&quot;train/step&quot;</span><span class="p">)</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;eval/step&quot;</span><span class="p">)</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;eval/*&quot;</span><span class="p">,</span> <span class="n">step_metric</span><span class="o">=</span><span class="s2">&quot;eval/step&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">run</span>

    <span class="k">def</span> <span class="nf">log_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;记录数据分布&quot;&quot;&quot;</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/min&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/max&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/histogram&quot;</span><span class="p">:</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Histogram</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">},</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_gradient_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;记录梯度流信息&quot;&quot;&quot;</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;grad_norm&quot;</span><span class="p">:</span> <span class="n">grad_norm</span>
                <span class="p">})</span>

        <span class="c1"># 创建梯度表格</span>
        <span class="n">grad_table</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="s2">&quot;gradient_norm&quot;</span><span class="p">],</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;grad_norm&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gradients</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="s2">&quot;gradients&quot;</span><span class="p">:</span> <span class="n">grad_table</span><span class="p">},</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
</code></pre></div>

<p><strong>TensorBoard：轻量级本地方案</strong></p>
<p>对于不需要云服务的场景，TensorBoard 仍是可靠选择：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">torch.utils.tensorboard</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span> <span class="nc">TensorBoardTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span>
            <span class="n">log_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">),</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
            <span class="n">flush_secs</span><span class="o">=</span><span class="mi">30</span>  <span class="c1"># 定期刷新到磁盘</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_model_architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;记录模型架构&quot;&quot;&quot;</span>
        <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_graph</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dummy_input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_attention_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attention_weights</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
                            <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">head_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;可视化注意力权重&quot;&quot;&quot;</span>
        <span class="c1"># 选择特定的注意力头</span>
        <span class="n">attn</span> <span class="o">=</span> <span class="n">attention_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">head_idx</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># 创建热力图</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">attn</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attention Weights - Head </span><span class="si">{</span><span class="n">head_idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;attention/head_</span><span class="si">{</span><span class="n">head_idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">log_learning_rate_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;记录学习率变化&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">):</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="n">param_group</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;learning_rate/group_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</code></pre></div>

<h3 id="_7">实验元数据管理</h3>
<p>完整的元数据记录是实验可重现性的基础：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">GPUtil</span>

<span class="k">class</span> <span class="nc">ExperimentMetadata</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">collect_system_info</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;收集系统信息&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">(),</span>
            <span class="s2">&quot;python_version&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">python_version</span><span class="p">(),</span>
            <span class="s2">&quot;cpu_count&quot;</span><span class="p">:</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span>
            <span class="s2">&quot;memory_gb&quot;</span><span class="p">:</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">total</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">),</span>
            <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">(),</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">collect_gpu_info</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;收集 GPU 信息&quot;&quot;&quot;</span>
        <span class="n">gpus</span> <span class="o">=</span> <span class="n">GPUtil</span><span class="o">.</span><span class="n">getGPUs</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">gpu</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">gpu</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;memory_total&quot;</span><span class="p">:</span> <span class="n">gpu</span><span class="o">.</span><span class="n">memoryTotal</span><span class="p">,</span>
            <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">gpu</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span>
            <span class="s2">&quot;compute_capability&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gpu</span><span class="o">.</span><span class="n">major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">gpu</span><span class="o">.</span><span class="n">minor</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">collect_dependencies</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;收集依赖版本&quot;&quot;&quot;</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">torch</span>
            <span class="n">deps</span><span class="p">[</span><span class="s2">&quot;torch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span>
            <span class="n">deps</span><span class="p">[</span><span class="s2">&quot;cuda&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">transformers</span>
            <span class="n">deps</span><span class="p">[</span><span class="s2">&quot;transformers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">__version__</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># 从 requirements.txt 或 pyproject.toml 读取</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;requirements.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;requirements.txt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;==&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">pkg</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;==&quot;</span><span class="p">)</span>
                        <span class="n">deps</span><span class="p">[</span><span class="n">pkg</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>

        <span class="k">return</span> <span class="n">deps</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_experiment_card</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;创建实验卡片&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">ExperimentMetadata</span><span class="o">.</span><span class="n">collect_system_info</span><span class="p">(),</span>
            <span class="s2">&quot;gpus&quot;</span><span class="p">:</span> <span class="n">ExperimentMetadata</span><span class="o">.</span><span class="n">collect_gpu_info</span><span class="p">(),</span>
            <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="n">ExperimentMetadata</span><span class="o">.</span><span class="n">collect_dependencies</span><span class="p">(),</span>
            <span class="s2">&quot;git&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;commit&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                <span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;branch&quot;</span><span class="p">,</span> <span class="s2">&quot;--show-current&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                <span class="s2">&quot;diff&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>

<h3 id="_8">模型检查点策略</h3>
<p>高效的检查点管理对于长时间训练至关重要：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CheckpointManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">max_checkpoints</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_checkpoints</span> <span class="o">=</span> <span class="n">max_checkpoints</span>

    <span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                       <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">is_best</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;保存检查点&quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
            <span class="s2">&quot;model_state_dict&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># 常规检查点</span>
        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;checkpoint_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pt&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">)</span>

        <span class="c1"># 最佳模型</span>
        <span class="k">if</span> <span class="n">is_best</span><span class="p">:</span>
            <span class="n">best_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">/</span> <span class="s2">&quot;best_model.pt&quot;</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">best_path</span><span class="p">)</span>

        <span class="c1"># 清理旧检查点</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_old_checkpoints</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cleanup_old_checkpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;保留最新的N个检查点&quot;&quot;&quot;</span>
        <span class="n">checkpoints</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;checkpoint_epoch_*.pt&quot;</span><span class="p">),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkpoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_checkpoints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ckpt</span> <span class="ow">in</span> <span class="n">checkpoints</span><span class="p">[:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_checkpoints</span><span class="p">]:</span>
                <span class="n">ckpt</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">resume_from_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> 
                              <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;从检查点恢复&quot;&quot;&quot;</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_state_dict&quot;</span><span class="p">])</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">],</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">]</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="24">2.4 防止代码腐化的最佳实践</h2>
<h3 id="_9">技术债务管理</h3>
<p>LLM 后训练项目的快速迭代容易累积技术债务。主动管理技术债务是保持项目长期健康的关键。</p>
<p><strong>技术债务的量化与追踪</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">class</span> <span class="nc">TechnicalDebtAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codebase_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">codebase_path</span> <span class="o">=</span> <span class="n">codebase_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debt_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TODO&quot;</span><span class="p">,</span> <span class="s2">&quot;FIXME&quot;</span><span class="p">,</span> <span class="s2">&quot;HACK&quot;</span><span class="p">,</span> <span class="s2">&quot;XXX&quot;</span><span class="p">,</span> <span class="s2">&quot;DEPRECATED&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">scan_codebase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;扫描代码库中的技术债务标记&quot;&quot;&quot;</span>
        <span class="n">debt_items</span> <span class="o">=</span> <span class="p">{</span><span class="n">marker</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">debt_markers</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">py_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">codebase_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.py&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">py_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">debt_markers</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">debt_items</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">py_file</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">codebase_path</span><span class="p">)),</span>
                                <span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="n">line_num</span><span class="p">,</span>
                                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                                <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_priority</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="p">})</span>

        <span class="k">return</span> <span class="n">debt_items</span>

    <span class="k">def</span> <span class="nf">calculate_complexity_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算代码复杂度指标&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cyclomatic_complexity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_cyclomatic_complexity</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span>
            <span class="s2">&quot;lines_of_code&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span>
            <span class="s2">&quot;num_functions&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)]),</span>
            <span class="s2">&quot;num_classes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">)]),</span>
            <span class="s2">&quot;max_nesting_depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_max_nesting</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">generate_debt_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成技术债务报告&quot;&quot;&quot;</span>
        <span class="n">debt_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_codebase</span><span class="p">()</span>
        <span class="n">total_debt</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">debt_items</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># 技术债务报告</span>
<span class="s2">生成时间: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span>
<span class="s2">总债务项: </span><span class="si">{</span><span class="n">total_debt</span><span class="si">}</span>

<span class="s2">## 按类型分布</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">marker</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">debt_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">marker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2"> 项</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># 高优先级项目</span>
        <span class="n">high_priority</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">marker</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">debt_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">high_priority</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span> 
                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span>
            <span class="p">])</span>

        <span class="k">if</span> <span class="n">high_priority</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## 高优先级债务</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">high_priority</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># 显示前10个</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>

<p><strong>代码质量门禁</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CodeQualityGate</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">thresholds</span>

    <span class="k">def</span> <span class="nf">check_diff_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diff_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检查代码变更的质量&quot;&quot;&quot;</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;no_print_statements&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_no_prints</span><span class="p">(</span><span class="n">diff_file</span><span class="p">),</span>
            <span class="s2">&quot;has_tests&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_has_tests</span><span class="p">(</span><span class="n">diff_file</span><span class="p">),</span>
            <span class="s2">&quot;docstring_coverage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_docstrings</span><span class="p">(</span><span class="n">diff_file</span><span class="p">),</span>
            <span class="s2">&quot;type_hints&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_type_hints</span><span class="p">(</span><span class="n">diff_file</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">failures</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">passed</span> <span class="ow">in</span> <span class="n">checks</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">passed</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">failures</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quality gate failed: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">failures</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">check_no_prints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diff</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检查是否包含调试用的print语句&quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\+.*print\(&#39;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_has_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diff</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检查是否包含对应的测试&quot;&quot;&quot;</span>
        <span class="c1"># 如果修改了src/下的文件，应该有对应的test/下的修改</span>
        <span class="n">src_modified</span> <span class="o">=</span> <span class="s2">&quot;src/&quot;</span> <span class="ow">in</span> <span class="n">diff</span>
        <span class="n">test_modified</span> <span class="o">=</span> <span class="s2">&quot;test/&quot;</span> <span class="ow">in</span> <span class="n">diff</span> <span class="ow">or</span> <span class="s2">&quot;tests/&quot;</span> <span class="ow">in</span> <span class="n">diff</span>

        <span class="k">if</span> <span class="n">src_modified</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">test_modified</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<h3 id="_10">代码复用与模块化</h3>
<p>良好的模块化设计是防止代码腐化的基础：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BaseExperiment</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;实验基类，强制规范化实验流程&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初始化实验环境&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;数据准备&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;构建模型&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;单步训练&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评估&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;标准化的实验流程&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_model</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_epochs&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

            <span class="n">eval_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_eval_metrics</span><span class="p">(</span><span class="n">eval_metrics</span><span class="p">)</span>
</code></pre></div>

<p><strong>组件注册机制</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ComponentRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;统一的组件注册机制，避免代码分散&quot;&quot;&quot;</span>

    <span class="n">_registry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;datasets&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;trainers&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;evaluators&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;装饰器：注册组件&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">component_cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown category: </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_cls</span>
            <span class="k">return</span> <span class="n">component_cls</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取注册的组件&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown category: </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">category</span><span class="p">]:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">. Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>

<span class="c1"># 使用示例</span>
<span class="nd">@ComponentRegistry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="s2">&quot;llama2&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LLaMA2Model</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="nd">@ComponentRegistry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="s2">&quot;alpaca&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AlpacaDataset</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div>

<h3 id="_11">持续集成与测试</h3>
<p><strong>分层测试策略</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>

<span class="k">class</span> <span class="nc">TestStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;分层测试策略&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">unit_test_example</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;单元测试：测试独立函数&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">test_config_merge</span><span class="p">():</span>
            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}}</span>
            <span class="n">override</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">deep_merge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">override</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">integration_test_example</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;集成测试：测试组件交互&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">test_model_with_dataloader</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="n">dataloader</span> <span class="o">=</span> <span class="n">create_dataloader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">expected_shape</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">smoke_test_example</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;冒烟测试：快速验证基本功能&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">test_training_loop_runs</span><span class="p">():</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">get_minimal_config</span><span class="p">()</span>
            <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

            <span class="c1"># 只运行几步</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">trainer</span><span class="o">.</span><span class="n">global_step</span> <span class="o">==</span> <span class="mi">10</span>
</code></pre></div>

<p><strong>CI/CD 配置</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .github/workflows/ci.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CI Pipeline</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">develop</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">quality-checks</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v2</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.9&#39;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pip install -r requirements-dev.txt</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run linting</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">flake8 src/ --max-line-length=100</span>
<span class="w">          </span><span class="no">black --check src/</span>
<span class="w">          </span><span class="no">isort --check-only src/</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Type checking</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">mypy src/ --ignore-missing-imports</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">pytest tests/ -v --cov=src --cov-report=xml</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Check code complexity</span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">radon cc src/ -s -nb</span>
</code></pre></div>

<h3 id="_12">文档与知识传承</h3>
<p><strong>自动化文档生成</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DocumentationGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;自动生成实验文档&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">generate_experiment_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_class</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;从实验类生成文档&quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">experiment_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="c1"># 提取类文档字符串</span>
        <span class="k">if</span> <span class="n">experiment_class</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">experiment_class</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="c1"># 提取配置参数</span>
        <span class="n">doc</span> <span class="o">+=</span> <span class="s2">&quot;## Configuration Parameters</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">config_schema</span> <span class="o">=</span> <span class="n">experiment_class</span><span class="o">.</span><span class="n">get_config_schema</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">config_schema</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">**: </span><span class="si">{</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(default: </span><span class="si">{</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># 提取方法文档</span>
        <span class="n">doc</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Methods</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">experiment_class</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">method_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">experiment_class</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">and</span> <span class="n">method</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;### </span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">doc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">doc</span>
</code></pre></div>

<h2 id="_13">本章小结</h2>
<p>本章深入探讨了 LLM 后训练实验代码基础设施的构建。我们学习了：</p>
<p>📌 <strong>配置管理的层次化设计</strong>：通过 YAML/TOML/Python 配置文件的合理选择，配置继承机制，以及运行时验证，建立了灵活且健壮的配置体系。记住：配置的复杂度应该与实验的复杂度相匹配，过度设计和设计不足都会降低效率。</p>
<p>📌 <strong>实验环境的多维管理</strong>：通过命令行参数、环境变量和 Git 分支的协同使用，实现了实验的隔离性和可重现性。关键原则是：Flag 用于实验特定配置，环境变量用于系统级设置，Git 分支用于代码版本管理。</p>
<p>📌 <strong>实验追踪的全生命周期覆盖</strong>：从 MLflow、W&amp;B 到 TensorBoard，不同工具适合不同场景。核心是要记录足够的元数据以支持实验重现，包括代码版本、依赖环境、硬件配置等。</p>
<p>📌 <strong>技术债务的主动管理</strong>：通过代码质量门禁、模块化设计、自动化测试和文档生成，建立了防止代码腐化的多重防线。记住：技术债务是不可避免的，关键是要可见、可控、可偿还。</p>
<h3 id="_14">关键公式与度量</h3>
<ol>
<li>
<p><strong>技术债务利息</strong> = $\sum_{i=1}^{n} \text{complexity}_i \times \text{change_frequency}_i$</p>
</li>
<li>
<p><strong>实验可重现性得分</strong> = $\frac{\text{成功重现的实验数}}{\text{总实验数}} \times \text{元数据完整度}$</p>
</li>
<li>
<p><strong>配置复杂度</strong> = $\log_2(\text{配置参数数}) \times \text{嵌套深度}$</p>
</li>
</ol>
<h2 id="gotchas">常见陷阱与错误 (Gotchas)</h2>
<p>⚠️ <strong>配置地狱（Configuration Hell）</strong></p>
<ul>
<li>错误：为每个小实验创建完全独立的配置文件</li>
<li>后果：配置文件爆炸式增长，难以维护</li>
<li>解决：使用配置继承，只记录与基线的差异</li>
</ul>
<p>⚠️ <strong>实验追踪过度或不足</strong></p>
<ul>
<li>错误：记录所有可能的指标 vs 只记录最终结果</li>
<li>后果：存储爆炸或信息不足无法调试</li>
<li>解决：分层记录策略，关键指标详细记录，辅助指标采样记录</li>
</ul>
<p>⚠️ <strong>Git 分支管理混乱</strong></p>
<ul>
<li>错误：所有实验都在 main 分支进行</li>
<li>后果：代码历史混乱，难以回溯</li>
<li>解决：严格的分支命名规范和生命周期管理</li>
</ul>
<p>⚠️ <strong>硬编码路径和配置</strong></p>
<ul>
<li>错误：在代码中硬编码数据路径、模型路径</li>
<li>后果：代码无法跨环境运行</li>
<li>解决：所有路径通过配置或环境变量管理</li>
</ul>
<p>⚠️ <strong>忽视代码复杂度增长</strong></p>
<ul>
<li>错误：为了快速实验不断添加 if-else 分支</li>
<li>后果：代码变成意大利面条，无法维护</li>
<li>解决：定期重构，使用策略模式或注册机制</li>
</ul>
<p>⚠️ <strong>检查点管理不当</strong></p>
<ul>
<li>错误：保存所有检查点或只保存最后一个</li>
<li>后果：磁盘空间耗尽或无法恢复最佳模型</li>
<li>解决：滚动窗口策略 + 最佳模型保存</li>
</ul>
<p>💡 <strong>实用技巧</strong></p>
<ol>
<li><strong>配置验证前置</strong>：在实验开始前验证所有配置，fail fast</li>
<li><strong>实验命名规范</strong>：<code>{date}_{model}_{dataset}_{key_hyperparam}</code></li>
<li><strong>自动化清理</strong>：定期清理过期的实验分支和检查点</li>
<li><strong>增量式日志</strong>：使用结构化日志，便于后续分析</li>
<li><strong>配置快照</strong>：每次实验开始时保存完整配置快照</li>
</ol>
<h2 id="_15">练习题</h2>
<h3 id="_16">基础题</h3>
<p><strong>练习 2.1：配置文件格式选择</strong>
你的团队正在启动一个新的 LLM 后训练项目。项目需要支持：(1) 非技术人员调整超参数；(2) 复杂的嵌套配置；(3) 动态计算某些参数。请为这个项目选择配置文件格式，并说明理由。</p>
<p><em>Hint: 考虑混合方案，不同层次使用不同格式。</em></p>
<details>
<summary>参考答案</summary>
<p>建议采用混合配置方案：</p>
<ul>
<li><strong>基础配置层（YAML）</strong>：用于非技术人员可调整的参数，如学习率、批次大小等</li>
<li><strong>高级配置层（Python）</strong>：用于需要动态计算的参数，如根据 GPU 内存自动调整批次大小</li>
<li><strong>用户覆盖层（TOML）</strong>：用于用户特定的环境配置</li>
</ul>
<p>实现方式：</p>
<ol>
<li>先加载 YAML 基础配置</li>
<li>通过 Python 配置类进行动态计算和验证</li>
<li>最后应用 TOML 用户覆盖</li>
</ol>
<p>这样既保证了易用性，又提供了足够的灵活性。</p>
</details>
<p><strong>练习 2.2：实验追踪工具集成</strong>
设计一个统一的接口，能够同时向 MLflow 和 W&amp;B 记录实验指标。要求支持批量记录和异步写入。</p>
<p><em>Hint: 使用适配器模式和队列机制。</em></p>
<details>
<summary>参考答案</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="k">class</span> <span class="nc">ExperimentTracker</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">UnifiedTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_queue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracker</span><span class="p">:</span> <span class="n">ExperimentTracker</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># 异步记录</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_process_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">event_type</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tracker</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tracker failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>关键点：</p>
<ol>
<li>统一接口抽象</li>
<li>异步队列避免阻塞训练</li>
<li>错误隔离，单个 tracker 失败不影响其他</li>
</ol>
</details>
<p><strong>练习 2.3：Git 分支清理策略</strong>
编写一个脚本，自动清理实验分支。要求：(1) 保留最近 30 天的分支；(2) 保留有未合并提交的分支；(3) 归档重要实验结果。</p>
<p><em>Hint: 使用 git for-each-ref 和 git cherry 命令。</em></p>
<details>
<summary>参考答案</summary>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>

cleanup_experimental_branches<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">cutoff_date</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;30 days ago&quot;</span><span class="w"> </span>+%s<span class="k">)</span>

<span class="w">    </span>git<span class="w"> </span><span class="k">for</span>-each-ref<span class="w"> </span>--format<span class="o">=</span><span class="s1">&#39;%(refname:short) %(committerdate:unix)&#39;</span><span class="w"> </span>refs/heads/exp/<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>branch<span class="w"> </span>timestamp<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="c1"># 检查年龄</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$timestamp</span><span class="w"> </span>-lt<span class="w"> </span><span class="nv">$cutoff_date</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c1"># 检查是否有未合并的提交</span>
<span class="w">            </span><span class="nv">unmerged</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>cherry<span class="w"> </span>main<span class="w"> </span><span class="nv">$branch</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;^+&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="k">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$unmerged</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c1"># 检查是否标记为重要</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span>git<span class="w"> </span>tag<span class="w"> </span>--list<span class="w"> </span><span class="s2">&quot;important/</span><span class="nv">$branch</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span>.<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c1"># 归档而非删除</span>
<span class="w">                    </span>git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;archive/</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m<span class="k">)</span><span class="s2">/</span><span class="nv">$branch</span><span class="s2">&quot;</span><span class="w"> </span><span class="nv">$branch</span><span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Auto-archived&quot;</span>
<span class="w">                </span><span class="k">fi</span>
<span class="w">                </span>git<span class="w"> </span>branch<span class="w"> </span>-D<span class="w"> </span><span class="nv">$branch</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Deleted: </span><span class="nv">$branch</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Kept (unmerged): </span><span class="nv">$branch</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>
<span class="o">}</span>
</code></pre></div>

<p>关键检查：</p>
<ol>
<li>时间戳比较</li>
<li>未合并提交检测</li>
<li>重要性标记识别</li>
</ol>
</details>
<h3 id="_17">挑战题</h3>
<p><strong>练习 2.4：配置差异分析</strong>
实现一个工具，能够：(1) 比较两个实验的配置差异；(2) 识别哪些配置变化导致了性能提升；(3) 生成配置优化建议。</p>
<p><em>Hint: 考虑使用决策树或 SHAP 值分析配置重要性。</em></p>
<details>
<summary>参考答案</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">import</span> <span class="nn">shap</span>

<span class="k">class</span> <span class="nc">ConfigAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_features</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 提取所有配置键</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
            <span class="n">all_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_flatten_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">parent_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_key</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">parent_key</span> <span class="k">else</span> <span class="n">k</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_key</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">analyze_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">):</span>
        <span class="c1"># 准备数据</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">:</span>
            <span class="n">flat_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span>
            <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">flat_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">]</span>
            <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="n">metric</span><span class="p">])</span>

        <span class="c1"># 训练模型</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># SHAP 分析</span>
        <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># 生成重要性排名</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">):</span>
            <span class="n">importance</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shap_values</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">importance</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">suggest_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_importance</span><span class="p">()</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 找出表现最好的配置</span>
        <span class="n">best_exp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        <span class="n">best_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">best_exp</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span>
        <span class="n">current_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">current_config</span><span class="p">)</span>

        <span class="c1"># 基于重要性生成建议</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">imp_score</span> <span class="ow">in</span> <span class="n">importance</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Top 5 重要参数</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">best_config</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">current_flat</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">best_config</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">!=</span> <span class="n">current_flat</span><span class="p">[</span><span class="n">param</span><span class="p">]:</span>
                    <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param</span><span class="p">,</span>
                        <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">current_flat</span><span class="p">[</span><span class="n">param</span><span class="p">],</span>
                        <span class="s1">&#39;suggested&#39;</span><span class="p">:</span> <span class="n">best_config</span><span class="p">[</span><span class="n">param</span><span class="p">],</span>
                        <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">imp_score</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">suggestions</span>
</code></pre></div>

<p>核心思路：</p>
<ol>
<li>使用随机森林学习配置到性能的映射</li>
<li>SHAP 值量化每个配置的贡献</li>
<li>基于历史最佳实践生成优化建议</li>
</ol>
</details>
<p><strong>练习 2.5：实验代码版本隔离</strong>
设计一个系统，能够为每个实验创建隔离的代码环境，支持：(1) 代码快照；(2) 依赖版本锁定；(3) 快速切换和恢复。</p>
<p><em>Hint: 结合 Git worktree、Docker 或 Python 虚拟环境。</em></p>
<details>
<summary>参考答案</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">venv</span>

<span class="k">class</span> <span class="nc">ExperimentEnvironment</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;environments&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">env_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span> <span class="o">/</span> <span class="n">exp_id</span>

        <span class="c1"># 1. 创建 Git worktree</span>
        <span class="n">worktree_path</span> <span class="o">=</span> <span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;code&quot;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
            <span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;worktree&quot;</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span> 
            <span class="nb">str</span><span class="p">(</span><span class="n">worktree_path</span><span class="p">),</span> 
            <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;git_commit&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># 2. 创建 Python 虚拟环境</span>
        <span class="n">venv_path</span> <span class="o">=</span> <span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;venv&quot;</span>
        <span class="n">venv</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">venv_path</span><span class="p">,</span> <span class="n">with_pip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 3. 锁定依赖版本</span>
        <span class="n">pip_path</span> <span class="o">=</span> <span class="n">venv_path</span> <span class="o">/</span> <span class="s2">&quot;bin&quot;</span> <span class="o">/</span> <span class="s2">&quot;pip&quot;</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirements&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># 生成 requirements.txt</span>
        <span class="n">req_file</span> <span class="o">=</span> <span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;requirements.txt&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">req_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 安装依赖</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">pip_path</span><span class="p">),</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">req_file</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># 4. 保存环境元数据</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;exp_id&quot;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;git_commit&quot;</span><span class="p">:</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">],</span> 
                <span class="n">cwd</span><span class="o">=</span><span class="n">worktree_path</span>
            <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;metadata.json&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">env_path</span>

    <span class="k">def</span> <span class="nf">activate_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">env_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span> <span class="o">/</span> <span class="n">exp_id</span>

        <span class="c1"># 生成激活脚本</span>
        <span class="n">activate_script</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#!/bin/bash</span>
<span class="s2">export EXPERIMENT_ID=</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span>
<span class="s2">export PYTHONPATH=</span><span class="si">{</span><span class="n">env_path</span><span class="si">}</span><span class="s2">/code:$PYTHONPATH</span>
<span class="s2">source </span><span class="si">{</span><span class="n">env_path</span><span class="si">}</span><span class="s2">/venv/bin/activate</span>
<span class="s2">cd </span><span class="si">{</span><span class="n">env_path</span><span class="si">}</span><span class="s2">/code</span>
<span class="s2">echo &quot;Environment </span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2"> activated&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="n">script_path</span> <span class="o">=</span> <span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;activate.sh&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">activate_script</span><span class="p">)</span>

        <span class="n">script_path</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="mo">0o755</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">script_path</span>

    <span class="k">def</span> <span class="nf">cleanup_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">archive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">env_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span> <span class="o">/</span> <span class="n">exp_id</span>

        <span class="k">if</span> <span class="n">archive</span><span class="p">:</span>
            <span class="c1"># 归档重要文件</span>
            <span class="n">archive_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;archives&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span>
            <span class="n">archive_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
                <span class="s2">&quot;tar&quot;</span><span class="p">,</span> <span class="s2">&quot;czf&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">archive_path</span><span class="p">),</span>
                <span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">envs_dir</span><span class="p">),</span>
                <span class="n">exp_id</span><span class="p">,</span>
                <span class="s2">&quot;--exclude&quot;</span><span class="p">,</span> <span class="s2">&quot;venv&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--exclude&quot;</span><span class="p">,</span> <span class="s2">&quot;.git&quot;</span>
            <span class="p">])</span>

        <span class="c1"># 清理 worktree</span>
        <span class="n">worktree_path</span> <span class="o">=</span> <span class="n">env_path</span> <span class="o">/</span> <span class="s2">&quot;code&quot;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;worktree&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">worktree_path</span><span class="p">)])</span>

        <span class="c1"># 删除环境目录</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span>
</code></pre></div>

<p>关键特性：</p>
<ol>
<li>Git worktree 提供代码隔离</li>
<li>Python venv 提供依赖隔离  </li>
<li>元数据记录保证可追溯性</li>
<li>归档机制保留重要实验</li>
</ol>
</details>
<p><strong>练习 2.6：分布式实验协调</strong>
设计一个分布式实验管理系统，支持：(1) 多机器上的实验调度；(2) 资源（GPU）分配；(3) 实验失败自动重试。</p>
<p><em>Hint: 考虑使用消息队列和状态机。</em></p>
<details>
<summary>参考答案</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">ExperimentState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
    <span class="n">RETRYING</span> <span class="o">=</span> <span class="s2">&quot;retrying&quot;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ExperimentJob</span><span class="p">:</span>
    <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">ExperimentState</span>
    <span class="n">assigned_worker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">class</span> <span class="nc">DistributedExperimentScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_host</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">redis_host</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span> <span class="o">=</span> <span class="s2">&quot;experiment_queue&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_status</span> <span class="o">=</span> <span class="s2">&quot;worker_status&quot;</span>

    <span class="k">def</span> <span class="nf">submit_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">ExperimentJob</span><span class="p">(</span>
            <span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">ExperimentState</span><span class="o">.</span><span class="n">PENDING</span>
        <span class="p">)</span>

        <span class="c1"># 加入队列</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">exp_id</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;retry_count&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">retry_count</span>
        <span class="p">}))</span>

        <span class="c1"># 记录作业状态</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job:</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;submitted_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">worker_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;工作节点主循环&quot;&quot;&quot;</span>

        <span class="c1"># 注册工作节点</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_status</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;idle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resources&#39;</span><span class="p">:</span> <span class="n">resources</span><span class="p">,</span>
            <span class="s1">&#39;last_heartbeat&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}))</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># 获取任务</span>
            <span class="n">job_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">brpop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">job_data</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">job_str</span> <span class="o">=</span> <span class="n">job_data</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">job_str</span><span class="p">)</span>

                <span class="c1"># 检查资源需求</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_run</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">],</span> <span class="n">resources</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_run_experiment</span><span class="p">(</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 放回队列末尾</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="p">,</span> <span class="n">job_str</span><span class="p">)</span>

            <span class="c1"># 发送心跳</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat</span><span class="p">(</span><span class="n">worker_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_can_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检查资源是否满足需求&quot;&quot;&quot;</span>
        <span class="n">required_gpus</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_gpus&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">available_gpus</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gpus&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">required_memory</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_gb&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">available_memory</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory_gb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">available_gpus</span> <span class="o">&gt;=</span> <span class="n">required_gpus</span> <span class="ow">and</span> 
                <span class="n">available_memory</span> <span class="o">&gt;=</span> <span class="n">required_memory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;exp_id&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 更新状态</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job:</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">ExperimentState</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s1">&#39;worker&#39;</span><span class="p">:</span> <span class="n">worker_id</span><span class="p">,</span>
                <span class="s1">&#39;started_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">})</span>

            <span class="c1"># 更新工作节点状态</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_status</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;busy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;current_job&#39;</span><span class="p">:</span> <span class="n">exp_id</span>
            <span class="p">}))</span>

            <span class="c1"># 执行实验</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_experiment</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span>

            <span class="c1"># 标记完成</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job:</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">ExperimentState</span><span class="o">.</span><span class="n">COMPLETED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s1">&#39;completed_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="p">})</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># 处理失败</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_failure</span><span class="p">(</span><span class="n">exp_id</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_handle_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">retry_count</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retry_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">max_retries</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_retries&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
            <span class="c1"># 重试</span>
            <span class="n">job</span><span class="p">[</span><span class="s1">&#39;retry_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retry_count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">job</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExperimentState</span><span class="o">.</span><span class="n">RETRYING</span><span class="o">.</span><span class="n">value</span>

            <span class="c1"># 延迟重试（指数退避）</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">retry_count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="si">}</span><span class="s2">:delayed:</span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                           <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">job</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job:</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">ExperimentState</span><span class="o">.</span><span class="n">RETRYING</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s1">&#39;retry_count&#39;</span><span class="p">:</span> <span class="n">retry_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;last_error&#39;</span><span class="p">:</span> <span class="n">error</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 最终失败</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;job:</span><span class="si">{</span><span class="n">exp_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">ExperimentState</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s1">&#39;failed_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">error</span>
            <span class="p">})</span>
</code></pre></div>

<p>系统设计要点：</p>
<ol>
<li>Redis 作为中央协调器</li>
<li>基于资源的任务分配</li>
<li>状态机管理实验生命周期</li>
<li>指数退避的重试机制</li>
<li>心跳机制检测工作节点健康</li>
</ol>
</details>
<p><strong>练习 2.7：代码腐化度量与预警</strong>
开发一个系统，能够：(1) 量化代码腐化程度；(2) 预测技术债务增长趋势；(3) 自动生成重构建议。</p>
<p><em>Hint: 结合静态分析、Git 历史和复杂度度量。</em></p>
<details>
<summary>参考答案</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">git</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="k">class</span> <span class="nc">CodeHealthMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">Repo</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">calculate_health_score</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算代码健康度得分 (0-100)&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_complexity</span><span class="p">(),</span>
            <span class="s1">&#39;duplication&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_duplication</span><span class="p">(),</span>
            <span class="s1">&#39;test_coverage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_test_coverage</span><span class="p">(),</span>
            <span class="s1">&#39;debt_density&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_technical_debt</span><span class="p">(),</span>
            <span class="s1">&#39;change_frequency&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_change_frequency</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># 加权计算总分</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span>      <span class="c1"># 复杂度越高分数越低</span>
            <span class="s1">&#39;duplication&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span>     <span class="c1"># 重复代码越多分数越低</span>
            <span class="s1">&#39;test_coverage&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>   <span class="c1"># 测试覆盖率越高分数越高</span>
            <span class="s1">&#39;debt_density&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span>   <span class="c1"># 技术债务越多分数越低</span>
            <span class="s1">&#39;change_frequency&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.1</span> <span class="c1"># 频繁修改的代码分数越低</span>
        <span class="p">}</span>

        <span class="n">score</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># 基准分</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">*</span> <span class="n">value</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_measure_complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;测量圈复杂度&quot;&quot;&quot;</span>
        <span class="n">total_complexity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">file_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">py_file</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.py&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">py_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">complexity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cyclomatic_complexity</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
                <span class="n">total_complexity</span> <span class="o">+=</span> <span class="n">complexity</span>
                <span class="n">file_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">total_complexity</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">file_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_measure_duplication</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;测量代码重复率&quot;&quot;&quot;</span>
        <span class="c1"># 使用简化的方法：相似代码块检测</span>
        <span class="n">code_blocks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">py_file</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.py&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">py_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># 提取函数体作为代码块</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
                        <span class="n">code_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>

        <span class="c1"># 计算相似度</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">block1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">code_blocks</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">block2</span> <span class="ow">in</span> <span class="n">code_blocks</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="n">block2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
                    <span class="n">duplicates</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">duplicates</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code_blocks</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">predict_debt_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_ahead</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;预测技术债务增长趋势&quot;&quot;&quot;</span>

        <span class="c1"># 收集历史数据</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">days_ago</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">):</span>  <span class="c1"># 过去90天，每周采样</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_ago</span><span class="p">)</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_commit_at_date</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">hexsha</span><span class="p">)</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
                    <span class="s1">&#39;debt_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_debt_markers</span><span class="p">(),</span>
                    <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measure_complexity</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

        <span class="c1"># 回到当前分支</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>

        <span class="c1"># 线性回归预测</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">))])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;debt_count&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span><span class="p">])</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># 预测未来</span>
        <span class="n">future_x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">+</span> <span class="n">days_ahead</span> <span class="o">//</span> <span class="mi">7</span>
        <span class="n">predicted_debt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([[</span><span class="n">future_x</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;current_debt&#39;</span><span class="p">:</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;debt_count&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">history</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;predicted_debt&#39;</span><span class="p">:</span> <span class="n">predicted_debt</span><span class="p">,</span>
            <span class="s1">&#39;growth_rate&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_refactoring_suggestions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成重构建议&quot;&quot;&quot;</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 分析热点文件（频繁修改且复杂度高）</span>
        <span class="n">hotspots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identify_hotspots</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">hotspots</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Top 5 热点</span>
            <span class="n">suggestion</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;complexity&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;高复杂度: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;complexity&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;拆分大函数为更小的功能单元&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;change_frequency&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;频繁修改: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;change_frequency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">次/月&quot;</span><span class="p">)</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;考虑抽象出稳定接口&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;duplication&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;代码重复: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;duplication&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;提取公共代码到工具模块&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;test_coverage&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;测试覆盖率低: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;test_coverage&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                <span class="n">suggestion</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;增加单元测试覆盖&quot;</span><span class="p">)</span>

            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">suggestion</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">suggestions</span>

    <span class="k">def</span> <span class="nf">_identify_hotspots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;识别代码热点&quot;&quot;&quot;</span>
        <span class="n">file_metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 分析 Git 历史</span>
        <span class="k">for</span> <span class="n">commit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">iter_commits</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="n">max_count</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">commit</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_metrics</span><span class="p">:</span>
                        <span class="n">file_metrics</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;change_frequency&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s1">&#39;duplication&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s1">&#39;test_coverage&#39;</span><span class="p">:</span> <span class="mi">0</span>
                        <span class="p">}</span>
                    <span class="n">file_metrics</span><span class="p">[</span><span class="n">file</span><span class="p">][</span><span class="s1">&#39;change_frequency&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># 计算当前指标</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_metrics</span><span class="p">:</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">file_path</span>
            <span class="k">if</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="n">file_metrics</span><span class="p">[</span><span class="n">file_path</span><span class="p">][</span><span class="s1">&#39;complexity&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cyclomatic_complexity</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="c1"># 按综合得分排序</span>
        <span class="n">scored</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">file_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;change_frequency&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span> 
                    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;complexity&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;duplication&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>
            <span class="n">scored</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scored</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>监控系统特点：</p>
<ol>
<li>多维度健康评分</li>
<li>基于历史数据的趋势预测</li>
<li>热点分析识别问题区域</li>
<li>可操作的重构建议</li>
<li>持续监控和预警机制</li>
</ol>
</details>
<p><strong>练习 2.8：实验结果自动分析</strong>
实现一个系统，能够自动分析实验结果，识别：(1) 异常实验；(2) 性能瓶颈；(3) 最优配置组合。</p>
<p><em>Hint: 使用异常检测、性能剖析和贝叶斯优化。</em></p>
<details>
<summary>参考答案</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process.kernels</span> <span class="kn">import</span> <span class="n">Matern</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">ExperimentAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_history</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">experiment_history</span>

    <span class="k">def</span> <span class="nf">detect_anomalies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检测异常实验&quot;&quot;&quot;</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 提取关键指标</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;training_time&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># 使用 IQR 方法检测异常</span>
            <span class="n">q1</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
            <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">iqr</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">iqr</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">lower_bound</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">:</span>
                    <span class="n">anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                        <span class="s1">&#39;expected_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">),</span>
                        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span>
                    <span class="p">})</span>

        <span class="c1"># 检测训练曲线异常</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;training_curve&#39;</span> <span class="ow">in</span> <span class="n">exp</span><span class="p">:</span>
                <span class="n">curve_anomalies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_curve_anomalies</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;training_curve&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">curve_anomalies</span><span class="p">:</span>
                    <span class="n">anomalies</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">curve_anomalies</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">anomalies</span>

    <span class="k">def</span> <span class="nf">_detect_curve_anomalies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curve</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检测训练曲线异常&quot;&quot;&quot;</span>
        <span class="n">anomalies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 检测 loss 爆炸</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">curve</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">losses</span><span class="p">)):</span>
            <span class="n">anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;loss_explosion&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;critical&#39;</span>
            <span class="p">})</span>

        <span class="c1"># 检测过拟合</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">train_acc</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train_acc&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]]</span>
            <span class="n">val_acc</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_acc&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">curve</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]]</span>

            <span class="k">if</span> <span class="n">train_acc</span> <span class="ow">and</span> <span class="n">val_acc</span><span class="p">:</span>
                <span class="n">gap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_acc</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val_acc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gap</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># 10% 差距</span>
                    <span class="n">anomalies</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;overfitting&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;train_val_gap&#39;</span><span class="p">:</span> <span class="n">gap</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">anomalies</span>

    <span class="k">def</span> <span class="nf">identify_bottlenecks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;识别性能瓶颈&quot;&quot;&quot;</span>
        <span class="n">bottlenecks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data_loading&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;forward_pass&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;backward_pass&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;optimizer_step&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;profiling&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exp</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">prof</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;profiling&#39;</span><span class="p">]</span>

            <span class="c1"># 分析各阶段耗时</span>
            <span class="n">total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">stage</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">prof</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">/</span> <span class="n">total_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="c1"># 如果某阶段占比异常高</span>
                <span class="n">expected_percentages</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;data_loading&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="s1">&#39;forward_pass&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                    <span class="s1">&#39;backward_pass&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
                    <span class="s1">&#39;optimizer_step&#39;</span><span class="p">:</span> <span class="mi">20</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">expected_percentages</span><span class="p">:</span>
                    <span class="n">expected</span> <span class="o">=</span> <span class="n">expected_percentages</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">percentage</span> <span class="o">&gt;</span> <span class="n">expected</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">:</span>  <span class="c1"># 超过预期 50%</span>
                        <span class="n">bottlenecks</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;percentage&#39;</span><span class="p">:</span> <span class="n">percentage</span><span class="p">,</span>
                            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
                            <span class="s1">&#39;suggestions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_optimization_suggestions</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
                        <span class="p">})</span>

        <span class="k">return</span> <span class="n">bottlenecks</span>

    <span class="k">def</span> <span class="nf">_get_optimization_suggestions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取优化建议&quot;&quot;&quot;</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data_loading&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;增加数据加载的 num_workers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;使用更高效的数据格式 (如 HDF5)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;实现数据预取和缓存&quot;</span><span class="p">,</span>
                <span class="s2">&quot;考虑使用 DALI 或其他加速库&quot;</span>
            <span class="p">],</span>
            <span class="s1">&#39;forward_pass&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;使用混合精度训练 (AMP)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;启用 cudnn.benchmark&quot;</span><span class="p">,</span>
                <span class="s2">&quot;考虑模型剪枝或量化&quot;</span><span class="p">,</span>
                <span class="s2">&quot;使用更高效的算子实现&quot;</span>
            <span class="p">],</span>
            <span class="s1">&#39;backward_pass&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;使用梯度累积减少显存占用&quot;</span><span class="p">,</span>
                <span class="s2">&quot;启用梯度检查点&quot;</span><span class="p">,</span>
                <span class="s2">&quot;考虑使用 ZeRO 优化器&quot;</span><span class="p">,</span>
                <span class="s2">&quot;检查是否有不必要的梯度计算&quot;</span>
            <span class="p">],</span>
            <span class="s1">&#39;optimizer_step&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;使用融合优化器 (如 FusedAdam)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;减少参数更新频率&quot;</span><span class="p">,</span>
                <span class="s2">&quot;考虑使用 LARS 或 LAMB&quot;</span><span class="p">,</span>
                <span class="s2">&quot;检查权重衰减设置&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">suggestions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">find_optimal_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;使用贝叶斯优化找到最优配置&quot;&quot;&quot;</span>

        <span class="c1"># 准备数据</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="n">flat_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_config</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span>
            <span class="n">param_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flat_config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flat_config</span><span class="p">)</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span>

        <span class="c1"># 转换为数值矩阵</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># 简单的数值化</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># 简化处理</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

        <span class="c1"># 高斯过程回归</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">Matern</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="n">gpr</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">gpr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># 贝叶斯优化：找下一个最佳点</span>
        <span class="k">def</span> <span class="nf">acquisition_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Expected Improvement&quot;&quot;&quot;</span>
            <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">best_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">best_y</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
            <span class="n">ei</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">best_y</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ei</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 随机搜索找最大 EI</span>
        <span class="n">best_ei</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">best_config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="c1"># 在已有配置附近采样</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.1</span>

            <span class="n">ei</span> <span class="o">=</span> <span class="n">acquisition_function</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ei</span> <span class="o">&gt;</span> <span class="n">best_ei</span><span class="p">:</span>
                <span class="n">best_ei</span> <span class="o">=</span> <span class="n">ei</span>
                <span class="n">best_config</span> <span class="o">=</span> <span class="n">candidate</span>

        <span class="c1"># 转换回配置字典</span>
        <span class="n">optimal_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">):</span>
            <span class="n">optimal_config</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_config</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># 预测性能</span>
        <span class="n">predicted_score</span><span class="p">,</span> <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">best_config</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
            <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">optimal_config</span><span class="p">,</span>
            <span class="s1">&#39;predicted_score&#39;</span><span class="p">:</span> <span class="n">predicted_score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;uncertainty&#39;</span><span class="p">:</span> <span class="n">uncertainty</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;expected_improvement&#39;</span><span class="p">:</span> <span class="n">best_ei</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_flatten_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;展平嵌套配置&quot;&quot;&quot;</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">full_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="n">key</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">flat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flatten_config</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">full_key</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flat</span><span class="p">[</span><span class="n">full_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">flat</span>
</code></pre></div>

<p>分析系统功能：</p>
<ol>
<li>异常检测：IQR 方法 + 曲线分析</li>
<li>瓶颈识别：性能剖析 + 阶段分析</li>
<li>配置优化：贝叶斯优化 + 高斯过程</li>
<li>可操作建议：针对性优化方案</li>
<li>不确定性量化：预测置信度</li>
</ol>
</details>
<hr />
<p>通过完成这些练习，你将掌握构建健壮的 LLM 后训练实验基础设施的核心技能。记住，好的基础设施是高效实验的基石，值得在项目初期投入时间建设。</p>
            </article>
            
            <nav class="page-nav"><a href="chapter1.html" class="nav-link prev">← 第一章：后训练基础理论</a><a href="chapter3.html" class="nav-link next">第三章：数据工程 →</a></nav>
        </main>
    </div>
</body>
</html>