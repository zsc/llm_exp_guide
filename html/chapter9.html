<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ä¹ç« ï¼šç”Ÿäº§éƒ¨ç½²ä¸ç›‘æ§</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">LLM åè®­ç»ƒå®éªŒè®¾è®¡æŒ‡å—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸€ç« ï¼šåè®­ç»ƒåŸºç¡€ç†è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äºŒç« ï¼šå®éªŒä»£ç åŸºç¡€è®¾æ–½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸‰ç« ï¼šæ•°æ®å·¥ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å››ç« ï¼šçº¯è¯­è¨€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äº”ç« ï¼šå¤šæ¨¡æ€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…­ç« ï¼šå¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸ƒç« ï¼šè®­ç»ƒå¾ªç¯ä¸è¿­ä»£ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…«ç« ï¼šè¯„ä¼°ä¸åŸºå‡†æµ‹è¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¹ç« ï¼šç”Ÿäº§éƒ¨ç½²ä¸ç›‘æ§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬åç« ï¼šæ¡ˆä¾‹ç ”ç©¶ä¸æœ€ä½³å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="_1">ç¬¬ä¹ç« ï¼šç”Ÿäº§éƒ¨ç½²ä¸ç›‘æ§</h1>
<p>å°†åè®­ç»ƒæ¨¡å‹ä»å®éªŒç¯å¢ƒéƒ¨ç½²åˆ°ç”Ÿäº§ç³»ç»Ÿæ˜¯ä¸€ä¸ªå¤æ‚çš„å·¥ç¨‹æŒ‘æˆ˜ã€‚æœ¬ç« ç³»ç»Ÿä»‹ç»æ¨¡å‹å‹ç¼©ã€æœåŠ¡åŒ–æ¶æ„ã€å®æ—¶ç›‘æ§ã€æ¼‚ç§»æ£€æµ‹ä»¥åŠå‘å¸ƒç­–ç•¥ç­‰å…³é”®æŠ€æœ¯ï¼Œå¸®åŠ©æ‚¨æ„å»ºç¨³å®šã€é«˜æ•ˆã€å¯ç»´æŠ¤çš„ LLM ç”Ÿäº§ç³»ç»Ÿã€‚</p>
<h2 id="91">9.1 æ¨¡å‹å‹ç¼©ä¸åŠ é€ŸæŠ€æœ¯</h2>
<h3 id="911">9.1.1 é‡åŒ–æŠ€æœ¯</h3>
<p>é‡åŒ–æ˜¯å°†æ¨¡å‹æƒé‡å’Œæ¿€æ´»å€¼ä»é«˜ç²¾åº¦ï¼ˆå¦‚ FP32ï¼‰è½¬æ¢ä¸ºä½ç²¾åº¦ï¼ˆå¦‚ INT8ã€INT4ï¼‰çš„è¿‡ç¨‹ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘æ¨¡å‹å¤§å°å’Œæ¨ç†å»¶è¿Ÿã€‚</p>
<h4 id="post-training-quantization-ptq">è®­ç»ƒåé‡åŒ–ï¼ˆPost-Training Quantization, PTQï¼‰</h4>
<p>PTQ åœ¨è®­ç»ƒå®Œæˆåå¯¹æ¨¡å‹è¿›è¡Œé‡åŒ–ï¼Œæ— éœ€é‡æ–°è®­ç»ƒï¼š</p>
<div class="codehilite"><pre><span></span><code>åŸå§‹æƒé‡ W âˆˆ [-Î±, Î±]
é‡åŒ–è¿‡ç¨‹ï¼šW_q = round(W Ã— s / Î±) 
åé‡åŒ–ï¼šW&#39; = W_q Ã— Î± / s

å…¶ä¸­ s = 2^(b-1) - 1ï¼Œb ä¸ºé‡åŒ–ä½æ•°
</code></pre></div>

<p><strong>å…³é”®æŠ€æœ¯è¦ç‚¹</strong>ï¼š</p>
<ol>
<li>
<p><strong>å¯¹ç§° vs éå¯¹ç§°é‡åŒ–</strong>
   - å¯¹ç§°ï¼šé›¶ç‚¹å›ºå®šåœ¨ 0ï¼Œå®ç°ç®€å•ä½†ç²¾åº¦ç•¥ä½
   - éå¯¹ç§°ï¼šå¼•å…¥é›¶ç‚¹åç§»ï¼Œç²¾åº¦æ›´é«˜ä½†è®¡ç®—å¤æ‚</p>
</li>
<li>
<p><strong>é€å±‚ vs é€é€šé“é‡åŒ–</strong>
   - é€å±‚ï¼šæ•´å±‚å…±äº«é‡åŒ–å‚æ•°ï¼Œå‹ç¼©ç‡é«˜
   - é€é€šé“ï¼šæ¯ä¸ªé€šé“ç‹¬ç«‹é‡åŒ–ï¼Œç²¾åº¦ä¿æŒæ›´å¥½</p>
</li>
<li>
<p><strong>åŠ¨æ€ vs é™æ€é‡åŒ–</strong>
   - é™æ€ï¼šé‡åŒ–å‚æ•°é¢„å…ˆç¡®å®šï¼Œæ¨ç†é€Ÿåº¦å¿«
   - åŠ¨æ€ï¼šè¿è¡Œæ—¶è®¡ç®—é‡åŒ–å‚æ•°ï¼Œç²¾åº¦æ›´é«˜</p>
</li>
</ol>
<h4 id="quantization-aware-training-qat">é‡åŒ–æ„ŸçŸ¥è®­ç»ƒï¼ˆQuantization-Aware Training, QATï¼‰</h4>
<p>QAT åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ¨¡æ‹Ÿé‡åŒ–æ•ˆæœï¼Œä½¿æ¨¡å‹é€‚åº”ä½ç²¾åº¦è¡¨ç¤ºï¼š</p>
<div class="codehilite"><pre><span></span><code>å‰å‘ä¼ æ’­ï¼šä½¿ç”¨é‡åŒ–æƒé‡
åå‘ä¼ æ’­ï¼šä½¿ç”¨å…¨ç²¾åº¦æ¢¯åº¦æ›´æ–°

ä¼ªé‡åŒ–æ“ä½œï¼š
W_fake_quant = dequant(quant(W))
</code></pre></div>

<p><strong>å®è·µæŠ€å·§</strong>ï¼š</p>
<ul>
<li>ğŸ’¡ ä» INT8 å¼€å§‹å°è¯•ï¼Œå¤šæ•°ä»»åŠ¡ç²¾åº¦æŸå¤± &lt; 1%</li>
<li>ğŸ’¡ å…³é”®å±‚ï¼ˆå¦‚ç¬¬ä¸€å±‚ã€æœ€åä¸€å±‚ï¼‰ä¿æŒé«˜ç²¾åº¦</li>
<li>ğŸ’¡ ä½¿ç”¨æ ¡å‡†æ•°æ®é›†ä¼˜åŒ–é‡åŒ–å‚æ•°</li>
</ul>
<h3 id="912">9.1.2 çŸ¥è¯†è’¸é¦</h3>
<p>é€šè¿‡æ•™å¸ˆ-å­¦ç”Ÿæ¡†æ¶å°†å¤§æ¨¡å‹çŸ¥è¯†è¿ç§»åˆ°å°æ¨¡å‹ï¼š</p>
<div class="codehilite"><pre><span></span><code>æŸå¤±å‡½æ•°ï¼š
L = Î± Ã— L_CE(y_student, y_true) + 
    Î² Ã— L_KL(Ïƒ(z_student/T), Ïƒ(z_teacher/T))

å…¶ä¸­ï¼š

<span class="k">-</span> L_CEï¼šäº¤å‰ç†µæŸå¤±ï¼ˆç¡¬æ ‡ç­¾ï¼‰
<span class="k">-</span> L_KLï¼šKL æ•£åº¦ï¼ˆè½¯æ ‡ç­¾ï¼‰
<span class="k">-</span> Tï¼šæ¸©åº¦å‚æ•°ï¼Œæ§åˆ¶åˆ†å¸ƒå¹³æ»‘åº¦
<span class="k">-</span> Î±, Î²ï¼šæŸå¤±æƒé‡
</code></pre></div>

<p><strong>è’¸é¦ç­–ç•¥ä¼˜åŒ–</strong>ï¼š</p>
<ol>
<li><strong>é€å±‚è’¸é¦</strong>ï¼šä¸ä»…è’¸é¦æœ€ç»ˆè¾“å‡ºï¼Œè¿˜å¯¹é½ä¸­é—´å±‚è¡¨ç¤º</li>
<li><strong>æ³¨æ„åŠ›è’¸é¦</strong>ï¼šä¼ é€’æ³¨æ„åŠ›æ¨¡å¼</li>
<li><strong>ç‰¹å¾è’¸é¦</strong>ï¼šå¯¹é½éšå±‚ç‰¹å¾åˆ†å¸ƒ</li>
</ol>
<h3 id="913">9.1.3 æ¨¡å‹å‰ªæ</h3>
<p>ç§»é™¤å†—ä½™å‚æ•°ä»¥å‡å°æ¨¡å‹å¤§å°ï¼š</p>
<h4 id="_2">ç»“æ„åŒ–å‰ªæ</h4>
<div class="codehilite"><pre><span></span><code>é‡è¦æ€§è¯„åˆ†ï¼š

- æƒé‡å¹…åº¦ï¼š|W|
- æ¢¯åº¦å¹…åº¦ï¼š|âˆ‚L/âˆ‚W|
- Taylor å±•å¼€ï¼šÎ”L â‰ˆ |W Ã— âˆ‚L/âˆ‚W|

å‰ªææµç¨‹ï¼š

1. è®­ç»ƒåŸºçº¿æ¨¡å‹
2. è®¡ç®—é‡è¦æ€§åˆ†æ•°
3. ç§»é™¤ä½åˆ†ç¥ç»å…ƒ/é€šé“/å±‚
4. å¾®è°ƒæ¢å¤æ€§èƒ½
</code></pre></div>

<h4 id="_3">éç»“æ„åŒ–å‰ªæ</h4>
<div class="codehilite"><pre><span></span><code>ç¨€ç–æ©ç ï¼šM âˆˆ {0,1}^d
ç¨€ç–æƒé‡ï¼šW_sparse = W âŠ™ M

åŠ¨æ€ç¨€ç–è®­ç»ƒï¼š

<span class="k">-</span> å‘¨æœŸæ€§æ›´æ–°æ©ç 
<span class="k">-</span> ä¿æŒå›ºå®šç¨€ç–åº¦
</code></pre></div>

<p>âš ï¸ <strong>å¸¸è§é™·é˜±</strong>ï¼š</p>
<ul>
<li>éç»“æ„åŒ–å‰ªæè™½ç„¶å‹ç¼©ç‡é«˜ï¼Œä½†ç¡¬ä»¶åŠ é€Ÿå›°éš¾</li>
<li>è¿‡åº¦å‰ªæå¯¼è‡´ä¸å¯æ¢å¤çš„æ€§èƒ½æŸå¤±</li>
<li>ä¸åŒä»»åŠ¡å¯¹å‰ªæçš„æ•æ„Ÿåº¦å·®å¼‚å·¨å¤§</li>
</ul>
<h3 id="914">9.1.4 æ¨ç†ä¼˜åŒ–æŠ€æœ¯</h3>
<h4 id="flash-attention">Flash Attention</h4>
<p>å‡å°‘æ³¨æ„åŠ›è®¡ç®—çš„å†…å­˜è®¿é—®ï¼š</p>
<div class="codehilite"><pre><span></span><code>æ ‡å‡†æ³¨æ„åŠ›ï¼šO(NÂ²) å†…å­˜
Flash Attentionï¼šO(N) å†…å­˜

é€šè¿‡åˆ†å—è®¡ç®—å’Œèåˆ kernel å®ç°ï¼š

- å‡å°‘ HBM è®¿é—®
- æé«˜ SRAM åˆ©ç”¨ç‡
</code></pre></div>

<h4 id="kv-cache">KV Cache ä¼˜åŒ–</h4>
<div class="codehilite"><pre><span></span><code><span class="nx">ç­–ç•¥</span><span class="err">ï¼š</span>

<span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">å¤šæŸ¥è¯¢æ³¨æ„åŠ›</span><span class="err">ï¼ˆ</span><span class="nx">MQA</span><span class="err">ï¼‰ï¼š</span><span class="nx">å…±äº«</span><span class="w"> </span><span class="nx">K</span><span class="err">ã€</span><span class="nx">V</span><span class="w"> </span><span class="nx">æŠ•å½±</span>
<span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›</span><span class="err">ï¼ˆ</span><span class="nx">GQA</span><span class="err">ï¼‰ï¼š</span><span class="nx">K</span><span class="err">ã€</span><span class="nx">V</span><span class="w"> </span><span class="nx">å¤´æ•°</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Q</span><span class="w"> </span><span class="nx">å¤´æ•°</span>
<span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">æ»‘åŠ¨çª—å£</span><span class="err">ï¼š</span><span class="nx">é™åˆ¶æ³¨æ„åŠ›èŒƒå›´</span>

<span class="nx">å†…å­˜è®¡ç®—</span><span class="err">ï¼š</span>
<span class="nx">Cache_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">batch</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="nx">seq_len</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="nx">n_layers</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span>
<span class="w">             </span><span class="p">(</span><span class="nx">n_kv_heads</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="nx">d_head</span><span class="p">)</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="nx">dtype_size</span>
</code></pre></div>

<h4 id="_4">æ‰¹å¤„ç†ä¼˜åŒ–</h4>
<div class="codehilite"><pre><span></span><code>åŠ¨æ€æ‰¹å¤„ç†ï¼š

<span class="k">-</span> è¿ç»­æ‰¹å¤„ç†ï¼ˆContinuous Batchingï¼‰
<span class="k">-</span> å¡«å……ä¼˜åŒ–ï¼ˆPadding Optimizationï¼‰
<span class="k">-</span> åºåˆ—å¹¶è¡Œï¼ˆSequence Parallelismï¼‰

ååé‡ä¼˜åŒ–ï¼š
Throughput = batch_size / latency
æ‰¾åˆ°æœ€ä¼˜ batch_size å¹³è¡¡å»¶è¿Ÿå’Œåå
</code></pre></div>

<h2 id="92">9.2 æœåŠ¡åŒ–æ¶æ„è®¾è®¡</h2>
<h3 id="921">9.2.1 å¾®æœåŠ¡æ¶æ„</h3>
<div class="codehilite"><pre><span></span><code>     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   Gateway   â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       â”‚       â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”€â”
â”‚Router â”‚ â”‚Auth â”‚ â”‚Rate  â”‚
â”‚       â”‚ â”‚     â”‚ â”‚Limit â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚         â”‚          â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Model  â”‚ â”‚Model â”‚ â”‚Cache  â”‚ â”‚Monitor  â”‚
â”‚Server â”‚ â”‚Pool  â”‚ â”‚Serviceâ”‚ â”‚Service  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>å…³é”®ç»„ä»¶è®¾è®¡</strong>ï¼š</p>
<ol>
<li>
<p><strong>API Gateway</strong>
   - è¯·æ±‚è·¯ç”±ä¸è´Ÿè½½å‡è¡¡
   - åè®®è½¬æ¢ï¼ˆHTTP/gRPC/WebSocketï¼‰
   - è®¤è¯æˆæƒ</p>
</li>
<li>
<p><strong>Model Server</strong>
   - æ¨¡å‹åŠ è½½ä¸ç‰ˆæœ¬ç®¡ç†
   - æ‰¹å¤„ç†é˜Ÿåˆ—
   - èµ„æºéš”ç¦»</p>
</li>
<li>
<p><strong>Cache Layer</strong>
   - ç»“æœç¼“å­˜ï¼ˆRedis/Memcachedï¼‰
   - åµŒå…¥å‘é‡ç¼“å­˜
   - KV Cache å…±äº«</p>
</li>
</ol>
<h3 id="922">9.2.2 æ¨¡å‹æœåŠ¡æ¡†æ¶</h3>
<h4 id="torchserve">TorchServe æ¶æ„</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ¨¡å‹å¤„ç†å™¨ç¤ºä¾‹</span>
<span class="k">class</span> <span class="nc">LLMHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">model_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">load_tokenizer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requests</span><span class="p">):</span>
        <span class="c1"># æ‰¹å¤„ç†é¢„å¤„ç†</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>

    <span class="k">def</span> <span class="nf">postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="c1"># è§£ç å’Œæ ¼å¼åŒ–</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
</code></pre></div>

<h4 id="triton-inference-server">Triton Inference Server</h4>
<div class="codehilite"><pre><span></span><code><span class="nx">æ¨¡å‹é…ç½®</span><span class="err">ï¼š</span>
<span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;llm_model&quot;</span>
<span class="nx">platform</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pytorch_libtorch&quot;</span>
<span class="nx">max_batch_size</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span>
<span class="nx">input</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;input_ids&quot;</span>
<span class="w">    </span><span class="nx">data_type</span><span class="p">:</span><span class="w"> </span><span class="nx">TYPE_INT64</span>
<span class="w">    </span><span class="nx">dims</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
<span class="nx">output</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;logits&quot;</span>
<span class="w">    </span><span class="nx">data_type</span><span class="p">:</span><span class="w"> </span><span class="nx">TYPE_FP32</span>
<span class="w">    </span><span class="nx">dims</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
<span class="nx">instance_group</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">count</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="nx">kind</span><span class="p">:</span><span class="w"> </span><span class="nx">KIND_GPU</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
<span class="nx">dynamic_batching</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">max_queue_delay_microseconds</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="923">9.2.3 æµå¼ç”Ÿæˆæ¶æ„</h3>
<p>å¤„ç† LLM é€ token ç”Ÿæˆçš„ç‰¹æ®Šéœ€æ±‚ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># SSE (Server-Sent Events) å®ç°</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">stream_generate</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">generate</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">generate_stream</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
            <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;token&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">token</span><span class="p">})</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span>
        <span class="n">generate</span><span class="p">(),</span>
        <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/event-stream&quot;</span>
    <span class="p">)</span>

<span class="c1"># WebSocket å®ç°</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">websocket_endpoint</span><span class="p">(</span><span class="n">websocket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">receive_text</span><span class="p">()</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">generate_stream</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send_json</span><span class="p">({</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">})</span>
    <span class="k">except</span> <span class="n">WebSocketDisconnect</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>

<p><strong>æµå¼å¤„ç†ä¼˜åŒ–</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºç®¡ç† token æµ</li>
<li>å®ç°èƒŒå‹ï¼ˆBackpressureï¼‰æœºåˆ¶</li>
<li>æ”¯æŒä¸­æ–­å’Œæ¢å¤</li>
</ul>
<h3 id="924">9.2.4 é«˜å¯ç”¨è®¾è®¡</h3>
<h4 id="_5">å¤šå‰¯æœ¬éƒ¨ç½²</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Kubernetes éƒ¨ç½²é…ç½®</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm-service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-server</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">            </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">            </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span>
<span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/health</span>
<span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span>
<span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/ready</span>
<span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</code></pre></div>

<h4 id="_6">æ•…éšœè½¬ç§»ç­–ç•¥</h4>
<div class="codehilite"><pre><span></span><code>ä¸»å¤‡æ¨¡å¼ï¼š
Primary â”€â”€â”
          â”œâ”€â”€&gt; Load Balancer â”€â”€&gt; Client
Secondary â”˜    (Health Check)

è´Ÿè½½å‡è¡¡ç®—æ³•ï¼š

- è½®è¯¢ï¼ˆRound Robinï¼‰
- æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰
- ä¸€è‡´æ€§å“ˆå¸Œï¼ˆConsistent Hashingï¼‰
- åŸºäºå»¶è¿Ÿçš„è·¯ç”±
</code></pre></div>

<h2 id="93">9.3 å®æ—¶ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ</h2>
<h3 id="931">9.3.1 æŒ‡æ ‡ä½“ç³»è®¾è®¡</h3>
<h4 id="_7">ç³»ç»ŸæŒ‡æ ‡</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Prometheus æŒ‡æ ‡å®šä¹‰</span>
<span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="n">Gauge</span>

<span class="c1"># è¯·æ±‚æŒ‡æ ‡</span>
<span class="n">request_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
    <span class="s1">&#39;llm_requests_total&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Total requests&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">request_latency</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s1">&#39;llm_request_duration_seconds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Request latency&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;operation&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># èµ„æºæŒ‡æ ‡</span>
<span class="n">gpu_utilization</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;llm_gpu_utilization_percent&#39;</span><span class="p">,</span>
    <span class="s1">&#39;GPU utilization&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;device_id&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">memory_usage</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;llm_memory_usage_bytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Memory usage&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>  <span class="c1"># gpu_memory, cpu_memory</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="_8">ä¸šåŠ¡æŒ‡æ ‡</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># è´¨é‡æŒ‡æ ‡</span>
<span class="n">output_quality_score</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s1">&#39;llm_output_quality_score&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Output quality score from feedback&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Token ç»Ÿè®¡</span>
<span class="n">token_usage</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
    <span class="s1">&#39;llm_tokens_total&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Total tokens processed&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>  <span class="c1"># input, output</span>
<span class="p">)</span>

<span class="c1"># æˆæœ¬æŒ‡æ ‡</span>
<span class="n">api_cost</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
    <span class="s1">&#39;llm_api_cost_dollars&#39;</span><span class="p">,</span>
    <span class="s1">&#39;API cost in dollars&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;customer&#39;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="932">9.3.2 æ—¥å¿—èšåˆä¸åˆ†æ</h3>
<h4 id="_9">ç»“æ„åŒ–æ—¥å¿—è®¾è®¡</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">structlog</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>

<span class="c1"># è¯·æ±‚æ—¥å¿—</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
    <span class="s2">&quot;request_received&quot;</span><span class="p">,</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
    <span class="n">model_version</span><span class="o">=</span><span class="n">model_version</span><span class="p">,</span>
    <span class="n">input_tokens</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span>
    <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># æ¨ç†æ—¥å¿—</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
    <span class="s2">&quot;inference_completed&quot;</span><span class="p">,</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">latency_ms</span><span class="o">=</span><span class="n">latency</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">output_tokens</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">output_tokens</span><span class="p">),</span>
    <span class="n">gpu_memory_mb</span><span class="o">=</span><span class="n">gpu_memory</span><span class="p">,</span>
    <span class="n">cache_hit</span><span class="o">=</span><span class="n">cache_hit</span>
<span class="p">)</span>

<span class="c1"># é”™è¯¯æ—¥å¿—</span>
<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
    <span class="s2">&quot;inference_failed&quot;</span><span class="p">,</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
    <span class="n">error_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
    <span class="n">traceback</span><span class="o">=</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="elk-stack">ELK Stack é›†æˆ</h4>
<div class="codehilite"><pre><span></span><code>æ—¥å¿—æµæ°´çº¿ï¼š
Application â”€â”€&gt; Filebeat â”€â”€&gt; Logstash â”€â”€&gt; Elasticsearch â”€â”€&gt; Kibana
                              â”‚
                              â”œâ”€&gt; è§£æå’Œå¢å¼º
                              â”œâ”€&gt; è¿‡æ»¤å’Œè·¯ç”±
                              â””â”€&gt; å‘Šè­¦è§¦å‘
</code></pre></div>

<h3 id="933">9.3.3 åˆ†å¸ƒå¼è¿½è¸ª</h3>
<p>ä½¿ç”¨ OpenTelemetry å®ç°å…¨é“¾è·¯è¿½è¸ªï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">opentelemetry</span> <span class="kn">import</span> <span class="n">trace</span>
<span class="kn">from</span> <span class="nn">opentelemetry.instrumentation.fastapi</span> <span class="kn">import</span> <span class="n">FastAPIInstrumentor</span>

<span class="n">tracer</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_tracer</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/generate&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">GenerateRequest</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;generate_request&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;tokenize&quot;</span><span class="p">):</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;inference&quot;</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;decode&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<h3 id="934">9.3.4 å‘Šè­¦ç­–ç•¥</h3>
<h4 id="_10">åˆ†çº§å‘Šè­¦</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># AlertManager é…ç½®</span>
<span class="nt">route</span><span class="p">:</span>
<span class="w">  </span><span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;alertname&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">group_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">  </span><span class="nt">group_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">  </span><span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1h</span>
<span class="w">  </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;web.hook&#39;</span>
<span class="w">  </span><span class="nt">routes</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">    </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pagerduty</span>
<span class="w">    </span><span class="nt">continue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">    </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">slack</span>

<span class="c1"># Prometheus å‘Šè­¦è§„åˆ™</span>
<span class="nt">groups</span><span class="p">:</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm_alerts</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighLatency</span>
<span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">histogram_quantile(0.99, llm_request_duration_seconds) &gt; 5</span>
<span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;P99</span><span class="nv"> </span><span class="s">å»¶è¿Ÿè¶…è¿‡</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">ç§’&quot;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GPUMemoryLeak</span>
<span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate(llm_gpu_memory_bytes[5m]) &gt; 100000000</span>
<span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GPU</span><span class="nv"> </span><span class="s">å†…å­˜æŒç»­å¢é•¿&quot;</span>
</code></pre></div>

<h4 id="_11">æ™ºèƒ½å‘Šè­¦é™å™ª</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AlertThrottler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">max_alerts</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window_seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_alerts</span> <span class="o">=</span> <span class="n">max_alerts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_times</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">deque</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">should_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_key</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_times</span><span class="p">[</span><span class="n">alert_key</span><span class="p">]</span>

        <span class="c1"># æ¸…ç†è¿‡æœŸæ—¶é—´</span>
        <span class="k">while</span> <span class="n">times</span> <span class="ow">and</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">:</span>
            <span class="n">times</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>

        <span class="c1"># æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_alerts</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="c1">## 9.4 æ¨¡å‹æ¼‚ç§»æ£€æµ‹</span>

<span class="n">æ¨¡å‹æ¼‚ç§»æ˜¯æŒ‡æ¨¡å‹åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ€§èƒ½éšæ—¶é—´ä¸‹é™çš„ç°è±¡</span><span class="err">ï¼Œ</span><span class="n">å¯èƒ½ç”±æ•°æ®åˆ†å¸ƒå˜åŒ–</span><span class="err">ã€</span><span class="n">ç”¨æˆ·è¡Œä¸ºæ¼”å˜æˆ–å¤–éƒ¨ç¯å¢ƒæ”¹å˜å¼•èµ·</span><span class="err">ã€‚</span>

<span class="c1">### 9.4.1 æ¼‚ç§»ç±»å‹ä¸æ£€æµ‹æ–¹æ³•</span>

<span class="c1">#### æ•°æ®æ¼‚ç§»ï¼ˆData Driftï¼‰</span>
<span class="n">è¾“å…¥æ•°æ®åˆ†å¸ƒçš„å˜åŒ–</span><span class="err">ï¼š</span>

<span class="err">```</span><span class="n">python</span>
<span class="c1"># KL æ•£åº¦æ£€æµ‹</span>
<span class="k">def</span> <span class="nf">kl_divergence</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è®¡ç®—ä¸¤ä¸ªåˆ†å¸ƒçš„ KL æ•£åº¦&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">epsilon</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="n">epsilon</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="n">q</span><span class="p">))</span>

<span class="c1"># Kolmogorov-Smirnov æ£€éªŒ</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ks_2samp</span>

<span class="k">def</span> <span class="nf">ks_test_drift</span><span class="p">(</span><span class="n">reference_data</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä½¿ç”¨ KS æ£€éªŒæ£€æµ‹åˆ†å¸ƒå˜åŒ–&quot;&quot;&quot;</span>
    <span class="n">statistic</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">ks_2samp</span><span class="p">(</span><span class="n">reference_data</span><span class="p">,</span> <span class="n">current_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">statistic</span>

<span class="c1"># ç‰¹å¾åˆ†å¸ƒç›‘æ§</span>
<span class="k">class</span> <span class="nc">FeatureDriftMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference_window</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_window</span> <span class="o">=</span> <span class="n">reference_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_buffers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">deque</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buffers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_window</span><span class="p">:</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">detect_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
        <span class="n">drifts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buffers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">current_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="n">current_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span><span class="p">:</span>
                <span class="n">ref_mean</span><span class="p">,</span> <span class="n">ref_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">z_score</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_mean</span> <span class="o">-</span> <span class="n">ref_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ref_std</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
                <span class="n">drifts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_score</span> <span class="o">&gt;</span> <span class="n">sensitivity</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_mean</span><span class="p">,</span> <span class="n">current_std</span><span class="p">)</span>
                <span class="n">drifts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">drifts</span>
</code></pre></div>

<h4 id="concept-drift">æ¦‚å¿µæ¼‚ç§»ï¼ˆConcept Driftï¼‰</h4>
<p>è¾“å…¥-è¾“å‡ºå…³ç³»çš„å˜åŒ–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ»‘åŠ¨çª—å£æ€§èƒ½ç›‘æ§</span>
<span class="k">class</span> <span class="nc">ConceptDriftDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_performance</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ›´æ–°æ€§èƒ½æŒ‡æ ‡&quot;&quot;&quot;</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">prediction</span> <span class="o">==</span> <span class="n">ground_truth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_window</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
            <span class="n">current_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_window</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_performance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseline_performance</span> <span class="o">=</span> <span class="n">current_accuracy</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">drift</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_accuracy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_performance</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">drift</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>

        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># ADWIN (Adaptive Windowing) ç®—æ³•</span>
<span class="k">class</span> <span class="nc">ADWIN</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.002</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æµ‹æ¦‚å¿µæ¼‚ç§»&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">+=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="c1"># æ£€æµ‹ä¸¤ä¸ªå­çª—å£çš„æ˜¾è‘—å·®å¼‚</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_change</span><span class="p">():</span>
                <span class="c1"># ä¸¢å¼ƒæ—§æ•°æ®</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shrink_window</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_detect_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä½¿ç”¨ Hoeffding ç•Œæ£€æµ‹å˜åŒ–&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">split_point</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">):</span>
            <span class="n">n0</span> <span class="o">=</span> <span class="n">split_point</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">split_point</span>

            <span class="n">sum0</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[:</span><span class="n">split_point</span><span class="p">])</span>
            <span class="n">sum1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[</span><span class="n">split_point</span><span class="p">:])</span>

            <span class="n">mean0</span> <span class="o">=</span> <span class="n">sum0</span> <span class="o">/</span> <span class="n">n0</span>
            <span class="n">mean1</span> <span class="o">=</span> <span class="n">sum1</span> <span class="o">/</span> <span class="n">n1</span>

            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n1</span><span class="p">))</span> <span class="o">*</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean0</span> <span class="o">-</span> <span class="n">mean1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<h3 id="942">9.4.2 é¢„æµ‹è´¨é‡ç›‘æ§</h3>
<h4 id="_12">ç½®ä¿¡åº¦åˆ†æ</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ConfidenceMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calibration_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration_bins</span> <span class="o">=</span> <span class="n">calibration_bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accuracies</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">update_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ›´æ–°ç½®ä¿¡åº¦ç»Ÿè®¡&quot;&quot;&quot;</span>
        <span class="n">max_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_scores</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">max_probs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accuracies</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_ece</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¡ç®—æœŸæœ›æ ¡å‡†è¯¯å·® (ECE)&quot;&quot;&quot;</span>
        <span class="n">bin_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bin_lowers</span> <span class="o">=</span> <span class="n">bin_boundaries</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">bin_uppers</span> <span class="o">=</span> <span class="n">bin_boundaries</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">ece</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">bin_lower</span><span class="p">,</span> <span class="n">bin_upper</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bin_lowers</span><span class="p">,</span> <span class="n">bin_uppers</span><span class="p">):</span>
            <span class="n">in_bin</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_scores</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bin_lower</span> <span class="o">&lt;=</span> <span class="n">conf</span> <span class="o">&lt;</span> <span class="n">bin_upper</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_bin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bin_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">in_bin</span><span class="p">])</span>
                <span class="n">bin_conf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">in_bin</span><span class="p">])</span>
                <span class="n">ece</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_bin</span><span class="p">)</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bin_acc</span> <span class="o">-</span> <span class="n">bin_conf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ece</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_scores</span><span class="p">)</span>
</code></pre></div>

<h4 id="_13">è¾“å‡ºåˆ†å¸ƒç›‘æ§</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ–‡æœ¬ç”Ÿæˆè´¨é‡æŒ‡æ ‡</span>
<span class="k">class</span> <span class="nc">TextGenerationMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generated_text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¡ç®—æ–‡æœ¬è´¨é‡æŒ‡æ ‡&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># å¤šæ ·æ€§æŒ‡æ ‡</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">generated_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;unique_tokens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

        <span class="c1"># é‡å¤åº¦</span>
        <span class="n">bigrams</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tokens</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;unique_bigrams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bigrams</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># é•¿åº¦åˆ†å¸ƒ</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;avg_sentence_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">sent</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> 
            <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">generated_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># å›°æƒ‘åº¦ä»£ç†æŒ‡æ ‡</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;entropy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_entropy</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">detect_quality_degradation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æµ‹ç”Ÿæˆè´¨é‡ä¸‹é™&quot;&quot;&quot;</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
            <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">window</span><span class="p">:</span>
                <span class="n">history</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># è®¡ç®—ç§»åŠ¨å¹³å‡å’Œæ ‡å‡†å·®</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">history</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">])</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">history</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">])</span>
                <span class="n">recent_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>

                <span class="c1"># Z-score æ£€éªŒ</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">recent_mean</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std</span><span class="p">:</span>
                    <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">,</span>
                        <span class="s1">&#39;baseline&#39;</span><span class="p">:</span> <span class="n">mean</span><span class="p">,</span>
                        <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">recent_mean</span><span class="p">,</span>
                        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">recent_mean</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">std</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">alerts</span>
</code></pre></div>

<h3 id="943">9.4.3 è‡ªåŠ¨åŒ–å“åº”ç­–ç•¥</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DriftResponseOrchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_detectors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_strategies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">register_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">detector</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ³¨å†Œæ¼‚ç§»æ£€æµ‹å™¨å’Œå“åº”ç­–ç•¥&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_detectors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_strategies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy</span>

    <span class="k">def</span> <span class="nf">monitor_and_respond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç›‘æ§å¹¶è‡ªåŠ¨å“åº”&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">detector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_detectors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_drift</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detector_name</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¤„ç†æ£€æµ‹åˆ°çš„æ¼‚ç§»&quot;&quot;&quot;</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_strategies</span><span class="p">[</span><span class="n">detector_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;alert&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Drift detected by </span><span class="si">{</span><span class="n">detector_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;retrain&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_retraining</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;fallback&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_switch_to_fallback_model</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;recalibrate&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recalibrate_model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_trigger_retraining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è§¦å‘æ¨¡å‹é‡è®­ç»ƒ&quot;&quot;&quot;</span>
        <span class="c1"># æ”¶é›†æ–°æ•°æ®</span>
        <span class="c1"># å¯åŠ¨è®­ç»ƒä»»åŠ¡</span>
        <span class="c1"># éªŒè¯æ–°æ¨¡å‹</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_recalibrate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é‡æ–°æ ¡å‡†æ¨¡å‹è¾“å‡º&quot;&quot;&quot;</span>
        <span class="c1"># ä½¿ç”¨æ¸©åº¦ç¼©æ”¾</span>
        <span class="c1"># æ›´æ–°åå¤„ç†å‚æ•°</span>
        <span class="k">pass</span>
</code></pre></div>

<h2 id="95">9.5 å›æ»šä¸ç°åº¦å‘å¸ƒç­–ç•¥</h2>
<h3 id="951">9.5.1 è“ç»¿éƒ¨ç½²</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Kubernetes è“ç»¿éƒ¨ç½²é…ç½®</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm-service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">green</span><span class="w">  </span><span class="c1"># åˆ‡æ¢åˆ° blue æˆ– green</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>

<span class="nn">---</span>
<span class="c1"># Blue éƒ¨ç½²</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm-blue</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm</span>
<span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm</span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-server</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm:v1.0</span>

<span class="nn">---</span>
<span class="c1"># Green éƒ¨ç½²</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm-green</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm</span>
<span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">green</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm</span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">green</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-server</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm:v2.0</span>
</code></pre></div>

<h3 id="952">9.5.2 é‡‘ä¸é›€å‘å¸ƒ</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CanaryDeployment</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_traffic_percent</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canary_percent</span> <span class="o">=</span> <span class="n">initial_traffic_percent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span> <span class="o">=</span> <span class="n">MetricsCollector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decision_threshold</span> <span class="o">=</span> <span class="mf">0.95</span>  <span class="c1"># æˆåŠŸç‡é˜ˆå€¼</span>

    <span class="k">def</span> <span class="nf">route_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è·¯ç”±è¯·æ±‚åˆ°é‡‘ä¸é›€æˆ–ç¨³å®šç‰ˆæœ¬&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">canary_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canary_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;canary&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;stable&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">progressive_rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ¸è¿›å¼å‘å¸ƒ&quot;&quot;&quot;</span>
        <span class="n">stages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>  <span class="c1"># æµé‡ç™¾åˆ†æ¯”é˜¶æ®µ</span>

        <span class="k">for</span> <span class="n">target_percent</span> <span class="ow">in</span> <span class="n">stages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canary_percent</span> <span class="o">=</span> <span class="n">target_percent</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># æ¯é˜¶æ®µè§‚å¯Ÿ 5 åˆ†é’Ÿ</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_health</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_check_health</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æŸ¥é‡‘ä¸é›€ç‰ˆæœ¬å¥åº·çŠ¶æ€&quot;&quot;&quot;</span>
        <span class="n">canary_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">(</span><span class="s1">&#39;canary&#39;</span><span class="p">)</span>
        <span class="n">stable_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">(</span><span class="s1">&#39;stable&#39;</span><span class="p">)</span>

        <span class="c1"># æ¯”è¾ƒå…³é”®æŒ‡æ ‡</span>
        <span class="n">canary_success_rate</span> <span class="o">=</span> <span class="n">canary_metrics</span><span class="p">[</span><span class="s1">&#39;success_rate&#39;</span><span class="p">]</span>
        <span class="n">stable_success_rate</span> <span class="o">=</span> <span class="n">stable_metrics</span><span class="p">[</span><span class="s1">&#39;success_rate&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">canary_success_rate</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statistical_test</span><span class="p">(</span>
            <span class="n">canary_metrics</span><span class="p">[</span><span class="s1">&#39;latencies&#39;</span><span class="p">],</span>
            <span class="n">stable_metrics</span><span class="p">[</span><span class="s1">&#39;latencies&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span>  <span class="c1"># æ— æ˜¾è‘—å·®å¼‚</span>

    <span class="k">def</span> <span class="nf">_rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å›æ»šåˆ°ç¨³å®šç‰ˆæœ¬&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canary_percent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Canary rollback triggered&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="953-feature-flags">9.5.3 ç‰¹å¾å¼€å…³ï¼ˆFeature Flagsï¼‰</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">FeatureFlags</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_source</span><span class="o">=</span><span class="s1">&#39;redis&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_source</span> <span class="o">=</span> <span class="n">config_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_flags</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_load_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä»é…ç½®æºåŠ è½½ç‰¹å¾å¼€å…³&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_source</span> <span class="o">==</span> <span class="s1">&#39;redis&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;new_tokenizer&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;rollout&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                <span class="s1">&#39;attention_optimization&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;rollout&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
                <span class="s1">&#39;experimental_sampler&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;rollout&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">is_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æŸ¥ç‰¹å¾æ˜¯å¦å¯ç”¨&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">flag_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="c1"># åŸºäºç”¨æˆ· ID çš„ä¸€è‡´æ€§å“ˆå¸Œ</span>
            <span class="n">hash_value</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span>
            <span class="k">return</span> <span class="n">hash_value</span> <span class="o">&lt;</span> <span class="n">flag</span><span class="p">[</span><span class="s1">&#39;rollout&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">flag</span><span class="p">[</span><span class="s1">&#39;rollout&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">with_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è£…é¥°å™¨æ¨¡å¼&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">flag_name</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># è¿”å›é»˜è®¤è¡Œä¸º</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_behavior</span><span class="p">(</span><span class="n">flag_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wrapper</span>
        <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div>

<h3 id="954">9.5.4 å›æ»šç­–ç•¥å®ç°</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RollbackManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deployment_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span> <span class="o">=</span> <span class="n">HealthChecker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_rollback_window</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 1 å°æ—¶</span>

    <span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;éƒ¨ç½²æ–°ç‰ˆæœ¬&quot;&quot;&quot;</span>
        <span class="n">deployment</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;deploying&#39;</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deployment_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deployment</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># æ‰§è¡Œéƒ¨ç½²</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_deployment</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

            <span class="c1"># å¥åº·æ£€æŸ¥</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_deployment_check</span><span class="p">(</span><span class="n">version</span><span class="p">):</span>
                <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;healthy&#39;</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unhealthy&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">automatic_rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>
            <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">automatic_rollback</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">automatic_rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªå¥åº·ç‰ˆæœ¬&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">deployment</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deployment_history</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;healthy&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rolling back to version </span><span class="si">{</span><span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_execute_deployment</span><span class="p">(</span>
                    <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">],</span>
                    <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No healthy version found for rollback&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_post_deployment_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;éƒ¨ç½²åå¥åº·æ£€æŸ¥&quot;&quot;&quot;</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span><span class="o">.</span><span class="n">check_endpoint_health</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span><span class="o">.</span><span class="n">check_model_loading</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span><span class="o">.</span><span class="n">check_inference_latency</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span><span class="o">.</span><span class="n">check_error_rate</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ‰§è¡Œå®é™…éƒ¨ç½²æ“ä½œ&quot;&quot;&quot;</span>
        <span class="c1"># æ›´æ–°æ¨¡å‹æ–‡ä»¶</span>
        <span class="c1"># é‡å¯æœåŠ¡</span>
        <span class="c1"># æ›´æ–°è·¯ç”±é…ç½®</span>
        <span class="k">pass</span>
</code></pre></div>

<h2 id="_14">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« ç³»ç»Ÿä»‹ç»äº† LLM ç”Ÿäº§éƒ¨ç½²ä¸ç›‘æ§çš„æ ¸å¿ƒæŠ€æœ¯ï¼š</p>
<h3 id="_15">ğŸ“Œ æ ¸å¿ƒæ¦‚å¿µ</h3>
<ol>
<li>
<p><strong>æ¨¡å‹ä¼˜åŒ–ä¸‰å¤§æŠ€æœ¯</strong>ï¼š
   - é‡åŒ–ï¼šPTQ vs QATï¼Œæƒè¡¡ç²¾åº¦ä¸æ•ˆç‡
   - è’¸é¦ï¼šçŸ¥è¯†ä¼ é€’ï¼Œå¤§æ¨¡å‹èƒ½åŠ›è¿ç§»åˆ°å°æ¨¡å‹
   - å‰ªæï¼šç»“æ„åŒ– vs éç»“æ„åŒ–ï¼Œç§»é™¤å†—ä½™å‚æ•°</p>
</li>
<li>
<p><strong>æœåŠ¡æ¶æ„è®¾è®¡</strong>ï¼š
   - å¾®æœåŠ¡æ¶æ„ï¼šæ¨¡å—åŒ–ã€å¯æ‰©å±•ã€é«˜å¯ç”¨
   - æµå¼ç”Ÿæˆï¼šSSE/WebSocket å®ç°é€ token è¾“å‡º
   - æ‰¹å¤„ç†ä¼˜åŒ–ï¼šåŠ¨æ€æ‰¹å¤„ç†æé«˜ååé‡</p>
</li>
<li>
<p><strong>ç›‘æ§ä½“ç³»</strong>ï¼š
   - ç³»ç»ŸæŒ‡æ ‡ï¼šå»¶è¿Ÿã€ååã€èµ„æºåˆ©ç”¨ç‡
   - ä¸šåŠ¡æŒ‡æ ‡ï¼šè´¨é‡åˆ†æ•°ã€æˆæœ¬ç»Ÿè®¡
   - åˆ†å¸ƒå¼è¿½è¸ªï¼šå…¨é“¾è·¯æ€§èƒ½åˆ†æ</p>
</li>
<li>
<p><strong>æ¼‚ç§»æ£€æµ‹</strong>ï¼š
   - æ•°æ®æ¼‚ç§»ï¼šè¾“å…¥åˆ†å¸ƒå˜åŒ–
   - æ¦‚å¿µæ¼‚ç§»ï¼šè¾“å…¥-è¾“å‡ºå…³ç³»å˜åŒ–
   - è‡ªåŠ¨å“åº”ï¼šå‘Šè­¦ã€é‡è®­ç»ƒã€å›æ»š</p>
</li>
<li>
<p><strong>å‘å¸ƒç­–ç•¥</strong>ï¼š
   - è“ç»¿éƒ¨ç½²ï¼šé›¶åœæœºåˆ‡æ¢
   - é‡‘ä¸é›€å‘å¸ƒï¼šæ¸è¿›å¼æµé‡è¿ç§»
   - ç‰¹å¾å¼€å…³ï¼šç»†ç²’åº¦åŠŸèƒ½æ§åˆ¶</p>
</li>
</ol>
<h3 id="_16">ğŸ’¡ å…³é”®å…¬å¼</h3>
<ol>
<li>
<p><strong>é‡åŒ–è¯¯å·®</strong>ï¼š
   $$\epsilon = \frac{\alpha}{2^{b-1}-1}$$
å…¶ä¸­ $\alpha$ ä¸ºæ•°å€¼èŒƒå›´ï¼Œ$b$ ä¸ºé‡åŒ–ä½æ•°</p>
</li>
<li>
<p><strong>è’¸é¦æŸå¤±</strong>ï¼š
$$L = \alpha L_{CE} + \beta \cdot T^2 \cdot L_{KL}$$</p>
</li>
<li>
<p><strong>æœŸæœ›æ ¡å‡†è¯¯å·®ï¼ˆECEï¼‰</strong>ï¼š
$$ECE = \sum_{m=1}^{M} \frac{|B_m|}{n} |acc(B_m) - conf(B_m)|$$</p>
</li>
<li>
<p><strong>KL æ•£åº¦æ¼‚ç§»æ£€æµ‹</strong>ï¼š
$$D_{KL}(P||Q) = \sum_{i} P(i) \log \frac{P(i)}{Q(i)}$$</p>
</li>
</ol>
<h3 id="_17">ğŸ”¬ å®ç”¨æŠ€å·§</h3>
<ol>
<li>
<p><strong>å‹ç¼©ç­–ç•¥é€‰æ‹©</strong>ï¼š
   - å»¶è¿Ÿæ•æ„Ÿï¼šä¼˜å…ˆé‡åŒ–ï¼ˆINT8ï¼‰
   - å†…å­˜å—é™ï¼šç»“æ„åŒ–å‰ªæ + é‡åŒ–
   - ç²¾åº¦ä¼˜å…ˆï¼šçŸ¥è¯†è’¸é¦</p>
</li>
<li>
<p><strong>ç›‘æ§å‘Šè­¦è®¾ç½®</strong>ï¼š
   - P50/P95/P99 åˆ†ä½æ•°ç›‘æ§
   - æ»‘åŠ¨çª—å£å¼‚å¸¸æ£€æµ‹
   - åˆ†çº§å‘Šè­¦é¿å…å‘Šè­¦ç–²åŠ³</p>
</li>
<li>
<p><strong>å‘å¸ƒé£é™©æ§åˆ¶</strong>ï¼š
   - é‡‘ä¸é›€èµ·å§‹æµé‡ &lt; 5%
   - æ¯é˜¶æ®µè§‚å¯Ÿæ—¶é—´ â‰¥ 5 åˆ†é’Ÿ
   - è‡ªåŠ¨å›æ»šæœºåˆ¶å¿…é¡»é…ç½®</p>
</li>
</ol>
<h2 id="gotchas">å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="_18">âš ï¸ æ¨¡å‹å‹ç¼©é™·é˜±</h3>
<ol>
<li>
<p><strong>è¿‡åº¦é‡åŒ–å¯¼è‡´ç²¾åº¦å´©æºƒ</strong>
   - é”™è¯¯ï¼šç›´æ¥åº”ç”¨ INT4 é‡åŒ–åˆ°æ‰€æœ‰å±‚
   - æ­£ç¡®ï¼šå…³é”®å±‚ä¿æŒé«˜ç²¾åº¦ï¼Œä½¿ç”¨æ··åˆç²¾åº¦ç­–ç•¥</p>
</li>
<li>
<p><strong>å¿½è§†ç¡¬ä»¶åŠ é€Ÿæ”¯æŒ</strong>
   - é”™è¯¯ï¼šä½¿ç”¨éç»“æ„åŒ–å‰ªææœŸæœ›åŠ é€Ÿ
   - æ­£ç¡®ï¼šç¡®è®¤ç›®æ ‡ç¡¬ä»¶æ”¯æŒçš„ä¼˜åŒ–æ¨¡å¼</p>
</li>
<li>
<p><strong>è’¸é¦æ¸©åº¦è®¾ç½®ä¸å½“</strong>
   - é”™è¯¯ï¼šå›ºå®šæ¸©åº¦ T=1
   - æ­£ç¡®ï¼šæ ¹æ®ä»»åŠ¡è°ƒæ•´ï¼Œé€šå¸¸ Tâˆˆ[3,10]</p>
</li>
</ol>
<h3 id="_19">âš ï¸ éƒ¨ç½²æ¶æ„é™·é˜±</h3>
<ol>
<li>
<p><strong>æ‰¹å¤„ç†é…ç½®é”™è¯¯</strong>
   - é”™è¯¯ï¼šbatch_size è¶Šå¤§è¶Šå¥½
   - æ­£ç¡®ï¼šå¹³è¡¡å»¶è¿Ÿå’Œååï¼Œæµ‹è¯•æœ€ä¼˜å€¼</p>
</li>
<li>
<p><strong>å¿½è§†å†·å¯åŠ¨é—®é¢˜</strong>
   - é”™è¯¯ï¼šä¸é¢„çƒ­æ¨¡å‹ç›´æ¥æœåŠ¡
   - æ­£ç¡®ï¼šéƒ¨ç½²åè¿›è¡Œé¢„çƒ­è¯·æ±‚</p>
</li>
<li>
<p><strong>KV Cache å†…å­˜æº¢å‡º</strong>
   - é”™è¯¯ï¼šæ— é™åˆ¶ç¼“å­˜æ‰€æœ‰åºåˆ—
   - æ­£ç¡®ï¼šè®¾ç½®æœ€å¤§åºåˆ—é•¿åº¦å’Œç¼“å­˜æ·˜æ±°ç­–ç•¥</p>
</li>
</ol>
<h3 id="_20">âš ï¸ ç›‘æ§ç›²åŒº</h3>
<ol>
<li>
<p><strong>åªç›‘æ§å¹³å‡å€¼</strong>
   - é”™è¯¯ï¼šåªçœ‹å¹³å‡å»¶è¿Ÿ
   - æ­£ç¡®ï¼šç›‘æ§ P95/P99 é•¿å°¾å»¶è¿Ÿ</p>
</li>
<li>
<p><strong>å¿½è§†ä¸šåŠ¡æŒ‡æ ‡</strong>
   - é”™è¯¯ï¼šåªå…³æ³¨ç³»ç»ŸæŒ‡æ ‡
   - æ­£ç¡®ï¼šç»“åˆä¸šåŠ¡è´¨é‡æŒ‡æ ‡ç»¼åˆè¯„ä¼°</p>
</li>
<li>
<p><strong>å‘Šè­¦é£æš´</strong>
   - é”™è¯¯ï¼šæ‰€æœ‰å¼‚å¸¸éƒ½è§¦å‘å‘Šè­¦
   - æ­£ç¡®ï¼šå‘Šè­¦èšåˆã€é™å™ªã€åˆ†çº§</p>
</li>
</ol>
<h3 id="_21">âš ï¸ å‘å¸ƒé£é™©</h3>
<ol>
<li>
<p><strong>è·³è¿‡é‡‘ä¸é›€é˜¶æ®µ</strong>
   - é”™è¯¯ï¼šç›´æ¥ 100% åˆ‡æ¢æµé‡
   - æ­£ç¡®ï¼šæ¸è¿›å¼å¢åŠ æµé‡æ¯”ä¾‹</p>
</li>
<li>
<p><strong>å›æ»šç­–ç•¥ç¼ºå¤±</strong>
   - é”™è¯¯ï¼šæ‰‹åŠ¨å›æ»šï¼Œè€—æ—¶ä¸”æ˜“é”™
   - æ­£ç¡®ï¼šè‡ªåŠ¨åŒ–å›æ»šæœºåˆ¶</p>
</li>
<li>
<p><strong>é…ç½®æ¼‚ç§»</strong>
   - é”™è¯¯ï¼šæ‰‹åŠ¨ä¿®æ”¹ç”Ÿäº§é…ç½®
   - æ­£ç¡®ï¼šç‰ˆæœ¬åŒ–é…ç½®ï¼Œé€šè¿‡ CI/CD éƒ¨ç½²</p>
</li>
</ol>
<h2 id="_22">ç»ƒä¹ é¢˜</h2>
<h3 id="_23">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  9.1ï¼šé‡åŒ–ç²¾åº¦åˆ†æ</strong>
ç»™å®šä¸€ä¸ªæƒé‡çŸ©é˜µ W âˆˆ [-2.5, 3.7]ï¼Œè®¡ç®—ä½¿ç”¨ INT8 å¯¹ç§°é‡åŒ–åçš„æœ€å¤§é‡åŒ–è¯¯å·®ã€‚</p>
<details>
<summary>Hint</summary>
<p>è€ƒè™‘å¯¹ç§°é‡åŒ–çš„èŒƒå›´ç¡®å®šæ–¹å¼å’Œé‡åŒ–æ­¥é•¿è®¡ç®—ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å¯¹ç§°é‡åŒ–éœ€è¦èŒƒå›´å¯¹ç§°äº 0ï¼š</p>
<ul>
<li>èŒƒå›´ï¼š[-3.7, 3.7]ï¼ˆå–ç»å¯¹å€¼æœ€å¤§å€¼ï¼‰</li>
<li>é‡åŒ–æ­¥é•¿ï¼šs = 3.7 / 127 â‰ˆ 0.0291</li>
<li>æœ€å¤§é‡åŒ–è¯¯å·®ï¼šs/2 â‰ˆ 0.0146</li>
</ul>
<p>å®é™…é‡åŒ–è¿‡ç¨‹ï¼š</p>
<ol>
<li>ç¼©æ”¾ï¼šW_scaled = W Ã— 127/3.7</li>
<li>å–æ•´ï¼šW_q = round(W_scaled)</li>
<li>åé‡åŒ–ï¼šW' = W_q Ã— 3.7/127</li>
</ol>
<p>æœ€å¤§è¯¯å·®å‡ºç°åœ¨é‡åŒ–è¾¹ç•Œï¼Œçº¦ä¸º 0.0146ã€‚</p>
</details>
<p><strong>ç»ƒä¹  9.2ï¼šKV Cache å†…å­˜ä¼°ç®—</strong>
è®¡ç®—ä»¥ä¸‹é…ç½®çš„ KV Cache å†…å­˜éœ€æ±‚ï¼š</p>
<ul>
<li>batch_size = 8</li>
<li>max_seq_length = 2048</li>
<li>num_layers = 24</li>
<li>num_kv_heads = 8</li>
<li>head_dim = 128</li>
<li>dtype = float16</li>
</ul>
<details>
<summary>Hint</summary>
<p>KV Cache éœ€è¦å­˜å‚¨æ¯å±‚çš„ K å’Œ V çŸ©é˜µï¼Œæ³¨æ„ float16 å  2 å­—èŠ‚ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å†…å­˜è®¡ç®—ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nx">Cache_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">batch</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="nx">seq_len</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="nx">n_layers</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="nx">n_kv_heads</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="nx">d_head</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="nx">dtype_size</span>
<span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nx">bytes</span>
<span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">Ã—</span><span class="w"> </span><span class="mi">2</span>
<span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">610</span><span class="p">,</span><span class="mi">612</span><span class="p">,</span><span class="mi">736</span><span class="w"> </span><span class="nx">bytes</span>
<span class="w">         </span><span class="err">â‰ˆ</span><span class="w"> </span><span class="m m-Double">1.5</span><span class="w"> </span><span class="nx">GB</span>
</code></pre></div>

<p>è§£é‡Šï¼š</p>
<ul>
<li>2 è¡¨ç¤º K å’Œ V ä¸¤ä¸ªçŸ©é˜µ</li>
<li>float16 å  2 å­—èŠ‚</li>
<li>æ€»è®¡çº¦ 1.5 GB æ˜¾å­˜</li>
</ul>
</details>
<p><strong>ç»ƒä¹  9.3ï¼šé‡‘ä¸é›€å‘å¸ƒæµé‡è®¡ç®—</strong>
é‡‘ä¸é›€å‘å¸ƒé‡‡ç”¨æŒ‡æ•°å¢é•¿ç­–ç•¥ï¼Œåˆå§‹æµé‡ 2%ï¼Œæ¯é˜¶æ®µç¿»å€ã€‚éœ€è¦å¤šå°‘é˜¶æ®µæ‰èƒ½è¾¾åˆ° 100% æµé‡ï¼Ÿæ¯é˜¶æ®µçš„å…·ä½“æµé‡æ¯”ä¾‹æ˜¯å¤šå°‘ï¼Ÿ</p>
<details>
<summary>Hint</summary>
<p>ä½¿ç”¨ 2^n è®¡ç®—é˜¶æ®µæ•°ï¼Œæ³¨æ„æœ€åä¸€ä¸ªé˜¶æ®µç›´æ¥åˆ° 100%ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æµé‡å¢é•¿åºåˆ—ï¼š</p>
<ul>
<li>é˜¶æ®µ 1ï¼š2%</li>
<li>é˜¶æ®µ 2ï¼š4%</li>
<li>é˜¶æ®µ 3ï¼š8%</li>
<li>é˜¶æ®µ 4ï¼š16%</li>
<li>é˜¶æ®µ 5ï¼š32%</li>
<li>é˜¶æ®µ 6ï¼š64%</li>
<li>é˜¶æ®µ 7ï¼š100%</li>
</ul>
<p>å…±éœ€è¦ 7 ä¸ªé˜¶æ®µã€‚å®é™…éƒ¨ç½²ä¸­ï¼Œé€šå¸¸ä¼šåœ¨ 50% åç›´æ¥è·³åˆ° 100%ï¼Œå³ï¼š
2% â†’ 5% â†’ 10% â†’ 25% â†’ 50% â†’ 100%ï¼ˆ6 ä¸ªé˜¶æ®µï¼‰</p>
</details>
<h3 id="_24">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  9.4ï¼šæ¼‚ç§»æ£€æµ‹ç®—æ³•è®¾è®¡</strong>
è®¾è®¡ä¸€ä¸ªè‡ªé€‚åº”çš„æ¼‚ç§»æ£€æµ‹ç®—æ³•ï¼Œè¦æ±‚ï¼š</p>
<ol>
<li>èƒ½å¤ŸåŒºåˆ†æ¸è¿›æ¼‚ç§»å’Œçªå‘æ¼‚ç§»</li>
<li>è‡ªåŠ¨è°ƒæ•´æ£€æµ‹çµæ•åº¦</li>
<li>æä¾›æ¼‚ç§»ä¸¥é‡ç¨‹åº¦è¯„åˆ†</li>
</ol>
<details>
<summary>Hint</summary>
<p>è€ƒè™‘ç»“åˆå¤šä¸ªæ—¶é—´çª—å£ã€ä½¿ç”¨ä¸åŒçš„ç»Ÿè®¡æ£€éªŒæ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•é‡åŒ–æ¼‚ç§»ç¨‹åº¦ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å¤šå°ºåº¦è‡ªé€‚åº”æ¼‚ç§»æ£€æµ‹å™¨è®¾è®¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AdaptiveDriftDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_stats</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># æ›´æ–°çª—å£</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># çªå‘æ¼‚ç§»æ£€æµ‹ï¼ˆçŸ­æœŸ vs é•¿æœŸï¼‰</span>
        <span class="n">sudden_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_sudden</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">short_window</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">long_window</span>
        <span class="p">)</span>

        <span class="c1"># æ¸è¿›æ¼‚ç§»æ£€æµ‹ï¼ˆä¸­æœŸè¶‹åŠ¿ï¼‰</span>
        <span class="n">gradual_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_gradual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">medium_window</span>
        <span class="p">)</span>

        <span class="c1"># è®¡ç®—ä¸¥é‡ç¨‹åº¦</span>
        <span class="n">severity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_severity</span><span class="p">(</span>
            <span class="n">sudden_drift</span><span class="p">,</span> 
            <span class="n">gradual_drift</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;sudden&#39;</span><span class="p">:</span> <span class="n">sudden_drift</span><span class="p">,</span>
            <span class="s1">&#39;gradual&#39;</span><span class="p">:</span> <span class="n">gradual_drift</span><span class="p">,</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">severity</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_detect_sudden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short</span><span class="p">,</span> <span class="n">long</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">short</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">long</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># KS æ£€éªŒ</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">ks_2samp</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">short</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">long</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.01</span>

    <span class="k">def</span> <span class="nf">_detect_gradual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Mann-Kendall è¶‹åŠ¿æ£€éªŒ</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mann_kendall_test</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_severity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sudden</span><span class="p">,</span> <span class="n">gradual</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sudden</span> <span class="ow">and</span> <span class="n">gradual</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;critical&#39;</span>
        <span class="k">elif</span> <span class="n">sudden</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;high&#39;</span>
        <span class="k">elif</span> <span class="n">gradual</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;medium&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;low&#39;</span>
</code></pre></div>

<p>å…³é”®è®¾è®¡ç‚¹ï¼š</p>
<ol>
<li>å¤šæ—¶é—´å°ºåº¦çª—å£æ•è·ä¸åŒç±»å‹æ¼‚ç§»</li>
<li>KS æ£€éªŒæ£€æµ‹åˆ†å¸ƒçªå˜</li>
<li>Mann-Kendall æ£€éªŒæ£€æµ‹è¶‹åŠ¿</li>
<li>ç»„åˆå¤šä¸ªä¿¡å·è¯„ä¼°ä¸¥é‡ç¨‹åº¦</li>
</ol>
</details>
<p><strong>ç»ƒä¹  9.5ï¼šè‡ªåŠ¨åŒ–å®¹é‡è§„åˆ’</strong>
è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œæ ¹æ®å†å²è´Ÿè½½æ¨¡å¼å’Œä¸šåŠ¡å¢é•¿é¢„æµ‹ï¼Œè‡ªåŠ¨è¿›è¡Œå®¹é‡è§„åˆ’å’Œèµ„æºè°ƒåº¦ã€‚è€ƒè™‘ï¼š</p>
<ol>
<li>å‘¨æœŸæ€§æ¨¡å¼ï¼ˆæ—¥/å‘¨/æœˆï¼‰</li>
<li>è¶‹åŠ¿å¢é•¿</li>
<li>çªå‘æµé‡</li>
<li>æˆæœ¬ä¼˜åŒ–</li>
</ol>
<details>
<summary>Hint</summary>
<p>ä½¿ç”¨æ—¶é—´åºåˆ—åˆ†è§£ã€é¢„æµ‹æ¨¡å‹ã€èµ„æºè°ƒåº¦ç®—æ³•çš„ç»„åˆã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è‡ªåŠ¨åŒ–å®¹é‡è§„åˆ’ç³»ç»Ÿè®¾è®¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CapacityPlanner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_model</span> <span class="o">=</span> <span class="n">CostModel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forecast_days</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="c1"># 1. æ—¶é—´åºåˆ—åˆ†è§£</span>
        <span class="n">trend</span><span class="p">,</span> <span class="n">seasonal</span><span class="p">,</span> <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompose_timeseries</span><span class="p">()</span>

        <span class="c1"># 2. é¢„æµ‹æœªæ¥è´Ÿè½½</span>
        <span class="n">future_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forecast_load</span><span class="p">(</span>
            <span class="n">trend</span><span class="p">,</span> <span class="n">seasonal</span><span class="p">,</span> <span class="n">forecast_days</span>
        <span class="p">)</span>

        <span class="c1"># 3. è®¡ç®—æ‰€éœ€èµ„æº</span>
        <span class="n">required_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_resources</span><span class="p">(</span>
            <span class="n">future_load</span><span class="p">,</span>
            <span class="n">include_buffer</span><span class="o">=</span><span class="mf">1.3</span>  <span class="c1"># 30% ç¼“å†²</span>
        <span class="p">)</span>

        <span class="c1"># 4. ä¼˜åŒ–èµ„æºé…ç½®</span>
        <span class="n">optimal_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_allocation</span><span class="p">(</span>
            <span class="n">required_resources</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cost_model</span>
        <span class="p">)</span>

        <span class="c1"># 5. ç”Ÿæˆæ‰©ç¼©å®¹è®¡åˆ’</span>
        <span class="n">scaling_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_scaling_plan</span><span class="p">(</span>
            <span class="n">optimal_config</span><span class="p">,</span>
            <span class="n">current_resources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_current_resources</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">scaling_plan</span>

    <span class="k">def</span> <span class="nf">_decompose_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># STL åˆ†è§£</span>
        <span class="kn">from</span> <span class="nn">statsmodels.tsa.seasonal</span> <span class="kn">import</span> <span class="n">STL</span>
        <span class="n">stl</span> <span class="o">=</span> <span class="n">STL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_history</span><span class="p">,</span> <span class="n">seasonal</span><span class="o">=</span><span class="mi">169</span><span class="p">)</span>  <span class="c1"># å‘¨å‘¨æœŸ</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">stl</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">trend</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">seasonal</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">resid</span>

    <span class="k">def</span> <span class="nf">_forecast_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trend</span><span class="p">,</span> <span class="n">seasonal</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="c1"># SARIMA æ¨¡å‹é¢„æµ‹</span>
        <span class="kn">from</span> <span class="nn">statsmodels.tsa.statespace.sarimax</span> <span class="kn">import</span> <span class="n">SARIMAX</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SARIMAX</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_history</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">seasonal_order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fitted</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">forecast</span> <span class="o">=</span> <span class="n">fitted</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>

        <span class="c1"># æ·»åŠ å­£èŠ‚æ€§</span>
        <span class="n">forecast_with_seasonal</span> <span class="o">=</span> <span class="n">forecast</span> <span class="o">+</span> <span class="n">seasonal</span><span class="p">[</span><span class="o">-</span><span class="n">days</span><span class="o">*</span><span class="mi">24</span><span class="p">:]</span>

        <span class="c1"># æ·»åŠ å®‰å…¨è¾¹é™…ï¼ˆP95ï¼‰</span>
        <span class="n">safety_margin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_history</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_history</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">forecast_with_seasonal</span> <span class="o">*</span> <span class="n">safety_margin</span>

    <span class="k">def</span> <span class="nf">_optimize_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">cost_model</span><span class="p">):</span>
        <span class="c1"># æ··åˆæ•´æ•°è§„åˆ’</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">milp</span>

        <span class="c1"># å®šä¹‰å†³ç­–å˜é‡ï¼šä¸åŒå®ä¾‹ç±»å‹çš„æ•°é‡</span>
        <span class="c1"># ç›®æ ‡ï¼šæœ€å°åŒ–æˆæœ¬</span>
        <span class="c1"># çº¦æŸï¼šæ»¡è¶³èµ„æºéœ€æ±‚</span>

        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">cost_model</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">instance_types</span><span class="p">]</span>
        <span class="n">A_ub</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">capacity</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">instance_types</span><span class="p">])</span>
        <span class="n">b_ub</span> <span class="o">=</span> <span class="o">-</span><span class="n">resources</span><span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">milp</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">integrality</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> 
                     <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
</code></pre></div>

<p>æ ¸å¿ƒç»„ä»¶ï¼š</p>
<ol>
<li><strong>æ—¶é—´åºåˆ—åˆ†è§£</strong>ï¼šè¯†åˆ«è¶‹åŠ¿ã€å­£èŠ‚æ€§ã€éšæœºæˆåˆ†</li>
<li><strong>è´Ÿè½½é¢„æµ‹</strong>ï¼šSARIMA æ¨¡å‹ + å®‰å…¨è¾¹é™…</li>
<li><strong>èµ„æºæ˜ å°„</strong>ï¼šè´Ÿè½½ â†’ GPU/CPU/å†…å­˜éœ€æ±‚</li>
<li><strong>æˆæœ¬ä¼˜åŒ–</strong>ï¼šè€ƒè™‘ Spot/Reserved/On-Demand å®ä¾‹ç»„åˆ</li>
<li><strong>æ¸è¿›å¼æ‰©ç¼©å®¹</strong>ï¼šé¿å…èµ„æºæŠ–åŠ¨</li>
</ol>
<p>å®æ–½è¦ç‚¹ï¼š</p>
<ul>
<li>é¢„ç•™ 20-30% ç¼“å†²åº”å¯¹çªå‘</li>
<li>ä½¿ç”¨é¢„ç•™å®ä¾‹é™ä½åŸºçº¿æˆæœ¬</li>
<li>Spot å®ä¾‹å¤„ç†å¼¹æ€§è´Ÿè½½</li>
<li>è‡ªåŠ¨å‘Šè­¦é˜ˆå€¼ï¼šå®é™… &gt; é¢„æµ‹ Ã— 1.5</li>
</ul>
</details>
<p><strong>ç»ƒä¹  9.6ï¼šé›¶åœæœºè¿ç§»æ–¹æ¡ˆ</strong>
è®¾è®¡ä¸€ä¸ªå°† LLM æœåŠ¡ä»æ•°æ®ä¸­å¿ƒ A è¿ç§»åˆ°æ•°æ®ä¸­å¿ƒ B çš„é›¶åœæœºæ–¹æ¡ˆï¼Œè€ƒè™‘ï¼š</p>
<ol>
<li>æ¨¡å‹æ–‡ä»¶åŒæ­¥ï¼ˆæ•° GBï¼‰</li>
<li>æœ‰çŠ¶æ€çš„ä¼šè¯ä¿æŒ</li>
<li>é€æ­¥æµé‡è¿ç§»</li>
<li>å¤±è´¥å›æ»š</li>
</ol>
<details>
<summary>Hint</summary>
<p>è€ƒè™‘åŒå†™ã€ä¼šè¯è¿ç§»ã€DNS åˆ‡æ¢ã€æ•°æ®ä¸€è‡´æ€§ç­‰é—®é¢˜ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>é›¶åœæœºè·¨æ•°æ®ä¸­å¿ƒè¿ç§»æ–¹æ¡ˆï¼š</p>
<p><strong>é˜¶æ®µ 1ï¼šå‡†å¤‡ï¼ˆT-7 å¤©ï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">tasks</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">éƒ¨ç½² B æ•°æ®ä¸­å¿ƒåŸºç¡€è®¾æ–½</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">é…ç½®ç½‘ç»œå’Œè´Ÿè½½å‡è¡¡å™¨</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">éƒ¨ç½² Kubernetes é›†ç¾¤</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">è®¾ç½®ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">æ¨¡å‹æ–‡ä»¶åŒæ­¥</span>
<span class="w">    </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">å¢é‡åŒæ­¥</span>
<span class="w">    </span><span class="nt">tools</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rsync --daemon</span>
<span class="w">    </span><span class="nt">bandwidth_limit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50%</span><span class="w">  </span><span class="c1"># é¿å…å½±å“ A æ•°æ®ä¸­å¿ƒ</span>
</code></pre></div>

<p><strong>é˜¶æ®µ 2ï¼šåŒå†™æ¨¡å¼ï¼ˆT-3 å¤©ï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DualWriteProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary</span> <span class="o">=</span> <span class="n">DataCenterA</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="o">=</span> <span class="n">DataCenterB</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># ä¸»æ•°æ®ä¸­å¿ƒå¤„ç†</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># å¼‚æ­¥å¤åˆ¶åˆ°å‰¯æ•°æ®ä¸­å¿ƒ</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_replicate_to_secondary</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_replicate_to_secondary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Secondary replication failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>é˜¶æ®µ 3ï¼šæµé‡è¿ç§»ï¼ˆT-0ï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TrafficMigrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">migration_percent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_affinity</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># ä¼šè¯ä¿æŒ</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session_id</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_affinity</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_affinity</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>

        <span class="c1"># æ–°ä¼šè¯æŒ‰æ¯”ä¾‹åˆ†é…</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">migration_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="s1">&#39;datacenter_b&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="s1">&#39;datacenter_a&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session_affinity</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">destination</span>
        <span class="k">return</span> <span class="n">destination</span>

    <span class="k">def</span> <span class="nf">progressive_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">percent</span> <span class="ow">in</span> <span class="n">stages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">migration_percent</span> <span class="o">=</span> <span class="n">percent</span>

            <span class="c1"># å¥åº·æ£€æŸ¥</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_health_check</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># ä¼šè¯è¿ç§»ï¼ˆé•¿è¿æ¥ï¼‰</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_migrate_sticky_sessions</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 5 åˆ†é’Ÿè§‚å¯ŸæœŸ</span>

        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p><strong>é˜¶æ®µ 4ï¼šä¼šè¯è¿ç§»</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SessionMigrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">migrate_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="c1"># 1. è·å–ä¼šè¯çŠ¶æ€</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">datacenter_a</span><span class="o">.</span><span class="n">get_session_state</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

        <span class="c1"># 2. åºåˆ—åŒ– KV Cache</span>
        <span class="n">kv_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_kv_cache</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">kv_cache</span><span class="p">)</span>

        <span class="c1"># 3. ä¼ è¾“åˆ° B æ•°æ®ä¸­å¿ƒ</span>
        <span class="n">datacenter_b</span><span class="o">.</span><span class="n">restore_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;kv_cache&#39;</span><span class="p">:</span> <span class="n">kv_cache</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="p">})</span>

        <span class="c1"># 4. éªŒè¯ä¸€è‡´æ€§</span>
        <span class="n">checksum_a</span> <span class="o">=</span> <span class="n">datacenter_a</span><span class="o">.</span><span class="n">compute_checksum</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
        <span class="n">checksum_b</span> <span class="o">=</span> <span class="n">datacenter_b</span><span class="o">.</span><span class="n">compute_checksum</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checksum_a</span> <span class="o">!=</span> <span class="n">checksum_b</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConsistencyError</span><span class="p">()</span>

        <span class="c1"># 5. æ›´æ–°è·¯ç”±</span>
        <span class="n">router</span><span class="o">.</span><span class="n">update_affinity</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="s1">&#39;datacenter_b&#39;</span><span class="p">)</span>
</code></pre></div>

<p><strong>é˜¶æ®µ 5ï¼šéªŒè¯å’Œæ¸…ç†</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># DNS åˆ‡æ¢</span>
dig<span class="w"> </span>@8.8.8.8<span class="w"> </span>api.example.com<span class="w">  </span><span class="c1"># éªŒè¯ TTL</span>
aws<span class="w"> </span>route53<span class="w"> </span>change-resource-record-sets<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--hosted-zone-id<span class="w"> </span>Z123<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--change-batch<span class="w"> </span>file://dns-cutover.json

<span class="c1"># ç›‘æ§éªŒè¯</span>

-<span class="w"> </span>é”™è¯¯ç‡<span class="w"> </span>&lt;<span class="w"> </span><span class="m">0</span>.01%
-<span class="w"> </span>P99<span class="w"> </span>å»¶è¿Ÿ<span class="w"> </span>&lt;<span class="w"> </span><span class="m">110</span>%<span class="w"> </span>åŸºçº¿
-<span class="w"> </span>ä¼šè¯è¿ç»­æ€§<span class="w"> </span><span class="m">100</span>%

<span class="c1"># æ¸…ç†æ—§èµ„æºï¼ˆT+7 å¤©ï¼‰</span>
kubectl<span class="w"> </span>--context<span class="o">=</span>datacenter-a<span class="w"> </span>delete<span class="w"> </span>deployment<span class="w"> </span>llm-service
</code></pre></div>

<p>å…³é”®æŠ€æœ¯ç‚¹ï¼š</p>
<ol>
<li><strong>å¢é‡åŒæ­¥</strong>ï¼šé¿å…ç½‘ç»œæ‹¥å¡</li>
<li><strong>ä¼šè¯äº²å’Œæ€§</strong>ï¼šä¿æŒç”¨æˆ·ä½“éªŒ</li>
<li><strong>åŒå†™éªŒè¯</strong>ï¼šç¡®ä¿ B æ•°æ®ä¸­å¿ƒå°±ç»ª</li>
<li><strong>æ¸è¿›å¼åˆ‡æ¢</strong>ï¼šå¿«é€Ÿå›æ»šèƒ½åŠ›</li>
<li><strong>çŠ¶æ€è¿ç§»</strong>ï¼šKV Cache åºåˆ—åŒ–ä¼ è¾“</li>
</ol>
<p>å¤±è´¥å›æ»šæœºåˆ¶ï¼š</p>
<ul>
<li>DNS å¿«é€Ÿåˆ‡å›ï¼ˆTTL=60sï¼‰</li>
<li>ä¼šè¯è·¯ç”±è¡¨å›æ»š</li>
<li>ä¿ç•™ A æ•°æ®ä¸­å¿ƒ 7 å¤©</li>
</ul>
</details>
<p><strong>ç»ƒä¹  9.7ï¼šæˆæœ¬ä¼˜åŒ–ç­–ç•¥</strong>
æŸ LLM æœåŠ¡æœˆåº¦ GPU æˆæœ¬ 10 ä¸‡ç¾å…ƒï¼Œè®¾è®¡ä¸€ä¸ªç»¼åˆæˆæœ¬ä¼˜åŒ–æ–¹æ¡ˆï¼Œç›®æ ‡é™ä½ 30% æˆæœ¬è€Œä¸å½±å“ SLAã€‚</p>
<details>
<summary>Hint</summary>
<p>ä»å¤šä¸ªç»´åº¦æ€è€ƒï¼šå®ä¾‹ç±»å‹ã€è°ƒåº¦ç­–ç•¥ã€ç¼“å­˜ã€æ¨¡å‹ä¼˜åŒ–ç­‰ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç»¼åˆæˆæœ¬ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ol>
<li><strong>å®ä¾‹ç±»å‹ä¼˜åŒ–ï¼ˆé¢„æœŸèŠ‚çœ 15%ï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># å½“å‰ï¼š100% On-Demand</span>
<span class="c1"># ä¼˜åŒ–åï¼šæ··åˆå®ä¾‹ç­–ç•¥</span>
<span class="n">instance_mix</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;reserved&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>    <span class="c1"># 50% é¢„ç•™å®ä¾‹ï¼ˆ3å¹´æœŸï¼ŒèŠ‚çœ 60%ï¼‰</span>
    <span class="s1">&#39;savings_plan&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="c1"># 20% Savings Planï¼ˆèŠ‚çœ 40%ï¼‰  </span>
    <span class="s1">&#39;spot&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>        <span class="c1"># 20% Spot å®ä¾‹ï¼ˆèŠ‚çœ 70%ï¼‰</span>
    <span class="s1">&#39;on_demand&#39;</span><span class="p">:</span> <span class="mf">0.1</span>    <span class="c1"># 10% æŒ‰éœ€ï¼ˆä¿æŒå¼¹æ€§ï¼‰</span>
<span class="p">}</span>

<span class="c1"># æˆæœ¬è®¡ç®—</span>
<span class="n">original_cost</span> <span class="o">=</span> <span class="mi">100000</span>  <span class="c1"># ç¾å…ƒ/æœˆ</span>
<span class="n">optimized_cost</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">100000</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span>   <span class="c1"># Reserved</span>
    <span class="mi">100000</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="mf">0.6</span> <span class="o">+</span>   <span class="c1"># Savings Plan</span>
    <span class="mi">100000</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">+</span>   <span class="c1"># Spot</span>
    <span class="mi">100000</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="mf">1.0</span>     <span class="c1"># On-Demand</span>
<span class="p">)</span> <span class="o">=</span> <span class="mi">48000</span>  <span class="c1"># èŠ‚çœ 52%ï¼Œä½†è€ƒè™‘ Spot ä¸­æ–­ï¼Œå®é™…çº¦ 15%</span>
</code></pre></div>

<ol start="2">
<li><strong>æ™ºèƒ½è°ƒåº¦å’Œè‡ªåŠ¨ä¼¸ç¼©ï¼ˆé¢„æœŸèŠ‚çœ 8%ï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CostAwareScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_priority</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span>
            <span class="c1"># ä½ä¼˜å…ˆçº§ä»»åŠ¡è°ƒåº¦åˆ° Spot å®ä¾‹</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_instances</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span>
            <span class="c1"># ä¸­ä¼˜å…ˆçº§ä½¿ç”¨é¢„ç•™å®ä¾‹</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserved_instances</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># é«˜ä¼˜å…ˆçº§ä¿è¯ SLA</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_demand_instances</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">auto_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># åŸºäºè´Ÿè½½é¢„æµ‹çš„æå‰æ‰©ç¼©å®¹</span>
        <span class="n">predicted_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">predicted_load</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="c1"># æ·±å¤œä½è°·ï¼Œå…³é—­éƒ¨åˆ†å®ä¾‹</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_down</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">predicted_load</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># é«˜å³°æœŸï¼Œæå‰æ‰©å®¹</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_up</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
</code></pre></div>

<ol start="3">
<li><strong>ç¼“å­˜ä¼˜åŒ–ï¼ˆé¢„æœŸèŠ‚çœ 5%ï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiLevelCache</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># å†…å­˜ç¼“å­˜ï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">()</span>  <span class="c1"># åˆ†å¸ƒå¼ç¼“å­˜</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l3_cache</span> <span class="o">=</span> <span class="n">S3</span><span class="p">()</span>  <span class="c1"># å†·æ•°æ®</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c1"># L1: å‘½ä¸­ç‡ 30%ï¼ŒèŠ‚çœ 100% GPU æ—¶é—´</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># L2: å‘½ä¸­ç‡ 20%ï¼ŒèŠ‚çœ 95% GPU æ—¶é—´</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="c1"># L3: åµŒå…¥å‘é‡ç¼“å­˜</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_embedding_request</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">embedding</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">embedding</span>

        <span class="c1"># Cache missï¼Œè®¡ç®—å¹¶å­˜å‚¨</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_caches</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<ol start="4">
<li><strong>æ¨¡å‹ä¼˜åŒ–ï¼ˆé¢„æœŸèŠ‚çœ 5%ï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># åŠ¨æ€æ¨¡å‹é€‰æ‹©</span>
<span class="k">class</span> <span class="nc">ModelSelector</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_complexity</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">complexity</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
            <span class="c1"># ç®€å•ä»»åŠ¡ç”¨å°æ¨¡å‹ï¼ˆ7Bï¼‰</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_model</span>  <span class="c1"># æˆæœ¬ 1x</span>
        <span class="k">elif</span> <span class="n">complexity</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span>
            <span class="c1"># ä¸­ç­‰ä»»åŠ¡ç”¨ä¸­æ¨¡å‹ï¼ˆ13Bï¼‰</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">medium_model</span>  <span class="c1"># æˆæœ¬ 2x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># å¤æ‚ä»»åŠ¡ç”¨å¤§æ¨¡å‹ï¼ˆ70Bï¼‰</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_model</span>  <span class="c1"># æˆæœ¬ 10x</span>

<span class="c1"># è¯·æ±‚çº§é‡åŒ–</span>
<span class="k">class</span> <span class="nc">DynamicQuantization</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">latency_requirement</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c1"># ms</span>
            <span class="c1"># å®½æ¾å»¶è¿Ÿè¦æ±‚ï¼Œä½¿ç”¨ INT4 é‡åŒ–</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">int4_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ä¸¥æ ¼å»¶è¿Ÿè¦æ±‚ï¼Œä½¿ç”¨ FP16</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp16_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div>

<ol start="5">
<li><strong>æ‰¹å¤„ç†ä¼˜åŒ–ï¼ˆé¢„æœŸèŠ‚çœ 2%ï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">BatchOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">optimize_batch_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># åŠ¨æ€è°ƒæ•´æ‰¹å¤§å°</span>
        <span class="n">current_latency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">get_p95_latency</span><span class="p">()</span>
        <span class="n">current_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span>

        <span class="k">if</span> <span class="n">current_latency</span> <span class="o">&lt;</span> <span class="n">SLA_LATENCY</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># æœ‰ä½™é‡ï¼Œå¢åŠ æ‰¹å¤§å°æé«˜åå</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">current_batch</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">current_latency</span> <span class="o">&gt;</span> <span class="n">SLA_LATENCY</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">:</span>
            <span class="c1"># æ¥è¿‘ SLAï¼Œå‡å°æ‰¹å¤§å°</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">current_batch</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><strong>å®æ–½è®¡åˆ’</strong>ï¼š</p>
<ol>
<li>ç¬¬ 1 ä¸ªæœˆï¼šé‡‡è´­é¢„ç•™å®ä¾‹ï¼Œéƒ¨ç½²ç¼“å­˜ç³»ç»Ÿ</li>
<li>ç¬¬ 2 ä¸ªæœˆï¼šå®æ–½æ™ºèƒ½è°ƒåº¦ï¼ŒA/B æµ‹è¯•</li>
<li>ç¬¬ 3 ä¸ªæœˆï¼šæ¨¡å‹ä¼˜åŒ–ï¼Œå…¨é¢æ¨å¹¿</li>
</ol>
<p><strong>é¢„æœŸæ•ˆæœ</strong>ï¼š</p>
<ul>
<li>æ€»æˆæœ¬é™ä½ï¼š32%</li>
<li>SLA ä¿æŒï¼š99.9%</li>
<li>ç”¨æˆ·ä½“éªŒï¼šæ— æ„ŸçŸ¥</li>
</ul>
<p><strong>é£é™©ç¼“è§£</strong>ï¼š</p>
<ul>
<li>Spot ä¸­æ–­ï¼šè‡ªåŠ¨æ•…éšœè½¬ç§»åˆ° On-Demand</li>
<li>ç¼“å­˜å¤±æ•ˆï¼šé™çº§åˆ°ç›´æ¥è®¡ç®—</li>
<li>æ¨¡å‹åˆ‡æ¢ï¼šå¹³æ»‘è¿‡æ¸¡ï¼Œç›‘æ§è´¨é‡</li>
</ul>
</details>
<p><strong>ç»ƒä¹  9.8ï¼šç«¯åˆ°ç«¯å»¶è¿Ÿä¼˜åŒ–</strong>
ä¸€ä¸ª LLM æœåŠ¡çš„ P99 å»¶è¿Ÿä¸º 5 ç§’ï¼Œåˆ†æå¹¶ä¼˜åŒ–åˆ° 2 ç§’ä»¥å†…ã€‚ç»™å‡ºè¯¦ç»†çš„åˆ†ææ–¹æ³•å’Œä¼˜åŒ–æ–¹æ¡ˆã€‚</p>
<details>
<summary>Hint</summary>
<p>ä½¿ç”¨ç«ç„°å›¾åˆ†æã€åˆ†é˜¶æ®µä¼˜åŒ–ã€å…³æ³¨é•¿å°¾å»¶è¿Ÿçš„ç‰¹æ®ŠåŸå› ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç«¯åˆ°ç«¯å»¶è¿Ÿä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šå»¶è¿Ÿåˆ†è§£åˆ†æ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LatencyProfiler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">profile_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">timeline</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 1. ç½‘ç»œæ¥æ”¶</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">receive_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;network_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

        <span class="c1"># 2. è®¤è¯æˆæƒ</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span>

        <span class="c1"># 3. é¢„å¤„ç†</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;tokenization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t2</span>

        <span class="c1"># 4. é˜Ÿåˆ—ç­‰å¾…</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">wait_for_batch</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;queue_wait&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t3</span>

        <span class="c1"># 5. æ¨¡å‹æ¨ç†</span>
        <span class="n">t4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;inference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t4</span>

        <span class="c1"># 6. åå¤„ç†</span>
        <span class="n">t5</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">postprocess</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;postprocess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t5</span>

        <span class="c1"># 7. ç½‘ç»œå‘é€</span>
        <span class="n">t6</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">send_response</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;network_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t6</span>

        <span class="k">return</span> <span class="n">timeline</span>

<span class="c1"># åˆ†æ P99 å»¶è¿Ÿç»„æˆ</span>
<span class="n">p99_breakdown</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;network_in&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>      <span class="c1"># ms</span>
    <span class="s1">&#39;auth&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>           <span class="c1"># ms</span>
    <span class="s1">&#39;tokenization&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># ms</span>
    <span class="s1">&#39;queue_wait&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>    <span class="c1"># ms (!)</span>
    <span class="s1">&#39;inference&#39;</span><span class="p">:</span> <span class="mi">4000</span><span class="p">,</span>    <span class="c1"># ms (!)</span>
    <span class="s1">&#39;postprocess&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>    <span class="c1"># ms</span>
    <span class="s1">&#39;network_out&#39;</span><span class="p">:</span> <span class="mi">250</span>    <span class="c1"># ms (!)</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ç¬¬äºŒæ­¥ï¼šé’ˆå¯¹æ€§ä¼˜åŒ–</strong></p>
<p><strong>ä¼˜åŒ– 1ï¼šæ¨ç†åŠ é€Ÿï¼ˆ4000ms â†’ 1500msï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Flash Attention å®ç°</span>
<span class="k">class</span> <span class="nc">FlashAttentionOptimized</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="c1"># åˆ†å—è®¡ç®—ï¼Œå‡å°‘å†…å­˜è®¿é—®</span>
        <span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">64</span>

        <span class="c1"># ä½¿ç”¨ Triton æ ¸å‡½æ•°</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">triton_flash_attn</span><span class="p">(</span>
            <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span>
            <span class="n">causal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">block_size</span><span class="o">=</span><span class="n">BLOCK_SIZE</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

<span class="c1"># KV Cache ä¼˜åŒ–</span>
<span class="k">class</span> <span class="nc">OptimizedKVCache</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># GPU å¸¸é©»</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># 0 æ‹·è´</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="c1"># å¼‚æ­¥ä¼ è¾“åˆ° GPU</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># ç®—å­èåˆ</span>
<span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span>
<span class="k">def</span> <span class="nf">fused_gelu_linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bias</span><span class="p">):</span>
    <span class="c1"># èåˆ GELU æ¿€æ´»å’Œçº¿æ€§å±‚</span>
    <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">gelu</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>
</code></pre></div>

<p><strong>ä¼˜åŒ– 2ï¼šé˜Ÿåˆ—ä¼˜åŒ–ï¼ˆ500ms â†’ 100msï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PriorityBatchQueue</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queues</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">deque</span><span class="p">(),</span>     <span class="c1"># SLA ä¸¥æ ¼</span>
            <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="n">deque</span><span class="p">(),</span>   <span class="c1"># æ™®é€šè¯·æ±‚</span>
            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">deque</span><span class="p">()</span>       <span class="c1"># æ‰¹é‡ä»»åŠ¡</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">continuous_batching</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">add_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_priority</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># é«˜ä¼˜å…ˆçº§ç«‹å³å¤„ç†</span>
        <span class="k">if</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_immediate_batch</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># è¿ç»­æ‰¹å¤„ç†</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_batching</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_merge_batch</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_immediate_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># é«˜ä¼˜å…ˆçº§è¯·æ±‚ä¸ç­‰å¾…</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">request</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_try_merge_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># åŠ¨æ€æ‰¹å¤„ç†ï¼Œæœ€å¤§ç­‰å¾… 100ms</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">request</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">batch</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>ä¼˜åŒ– 3ï¼šç½‘ç»œä¼˜åŒ–ï¼ˆ250ms â†’ 50msï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># HTTP/2 æœåŠ¡å™¨æ¨é€</span>
<span class="k">class</span> <span class="nc">HTTP2Streaming</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">stream_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="c1"># æœåŠ¡å™¨æ¨é€ï¼Œé€ token å‘é€</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_frame</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="c1"># é›¶æ‹·è´å‘é€</span>
<span class="k">class</span> <span class="nc">ZeroCopySender</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># ä½¿ç”¨ sendfile ç³»ç»Ÿè°ƒç”¨</span>
        <span class="n">os</span><span class="o">.</span><span class="n">sendfile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
            <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">)</span>

<span class="c1"># å‹ç¼©ä¼ è¾“</span>
<span class="k">class</span> <span class="nc">CompressionMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">compress_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>  <span class="c1"># 1KB ä»¥ä¸Šæ‰å‹ç¼©</span>
            <span class="k">return</span> <span class="n">gzip</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># å¿«é€Ÿå‹ç¼©</span>
        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<p><strong>ä¼˜åŒ– 4ï¼šé•¿å°¾å»¶è¿Ÿä¸“é¡¹ä¼˜åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TailLatencyOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc_controller</span> <span class="o">=</span> <span class="n">GCController</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_pool</span> <span class="o">=</span> <span class="n">MemoryPool</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 1. GC è°ƒä¼˜</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc_controller</span><span class="o">.</span><span class="n">set_gc_threshold</span><span class="p">(</span>
            <span class="n">threshold0</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>  <span class="c1"># å»¶è¿Ÿ GC</span>
            <span class="n">threshold1</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">threshold2</span><span class="o">=</span><span class="mi">20</span>
        <span class="p">)</span>

        <span class="c1"># 2. å†…å­˜æ± åŒ–</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_pool</span><span class="o">.</span><span class="n">preallocate</span><span class="p">(</span>
            <span class="n">tensor_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">4096</span><span class="p">],</span>
            <span class="n">count</span><span class="o">=</span><span class="mi">100</span>
        <span class="p">)</span>

        <span class="c1"># 3. CPU äº²å’Œæ€§</span>
        <span class="n">os</span><span class="o">.</span><span class="n">sched_setaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">})</span>  <span class="c1"># ç»‘å®š CPU æ ¸å¿ƒ</span>

        <span class="c1"># 4. é¢„çƒ­</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_model</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_warmup_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># JIT ç¼–è¯‘é¢„çƒ­</span>
        <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">dummy_input</span><span class="p">)</span>
</code></pre></div>

<p><strong>ä¼˜åŒ– 5ï¼šè‡ªé€‚åº”é™çº§</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AdaptiveDegradation</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">current_latency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">get_current_p99</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">current_latency</span> <span class="o">&gt;</span> <span class="mi">3000</span><span class="p">:</span>  <span class="c1"># ä¸¥é‡å»¶è¿Ÿ</span>
            <span class="c1"># é™çº§åˆ°å°æ¨¡å‹</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">current_latency</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>  <span class="c1"># ä¸­åº¦å»¶è¿Ÿ</span>
            <span class="c1"># å‡å°‘ç”Ÿæˆé•¿åº¦</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># æ­£å¸¸å¤„ç†</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div>

<p><strong>æœ€ç»ˆæ•ˆæœ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>åŸå§‹ P99: 5000ms
ä¼˜åŒ–å P99: 1850ms

åˆ†è§£ï¼š

- ç½‘ç»œæ¥æ”¶: 50ms
- è®¤è¯: 20ms
- Tokenization: 100ms
- é˜Ÿåˆ—: 100ms (ä¼˜åŒ– 400ms)
- æ¨ç†: 1500ms (ä¼˜åŒ– 2500ms)
- åå¤„ç†: 80ms
- ç½‘ç»œå‘é€: 50ms (ä¼˜åŒ– 200ms)

æ€»è®¡: 1900msï¼ˆè¾¾æ ‡ï¼‰
</code></pre></div>

<p><strong>ç›‘æ§éªŒè¯</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># A/B æµ‹è¯•éªŒè¯</span>
<span class="n">ab_test</span> <span class="o">=</span> <span class="n">ABTest</span><span class="p">(</span>
    <span class="n">control</span><span class="o">=</span><span class="s1">&#39;original&#39;</span><span class="p">,</span>
    <span class="n">treatment</span><span class="o">=</span><span class="s1">&#39;optimized&#39;</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;p50&#39;</span><span class="p">,</span> <span class="s1">&#39;p95&#39;</span><span class="p">,</span> <span class="s1">&#39;p99&#39;</span><span class="p">,</span> <span class="s1">&#39;error_rate&#39;</span><span class="p">],</span>
    <span class="n">duration_hours</span><span class="o">=</span><span class="mi">24</span>
<span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">ab_test</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">][</span><span class="s1">&#39;p99&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2000</span>
<span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">][</span><span class="s1">&#39;error_rate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.001</span>
</code></pre></div>

</details>
<hr />
<p><strong>ä¸‹ä¸€ç« </strong>ï¼š<a href="chapter10.html">ç¬¬åç« ï¼šæ¡ˆä¾‹ç ”ç©¶ä¸æœ€ä½³å®è·µ â†’</a></p>
            </article>
            
            <nav class="page-nav"><a href="chapter8.html" class="nav-link prev">â† ç¬¬å…«ç« ï¼šè¯„ä¼°ä¸åŸºå‡†æµ‹è¯•</a><a href="chapter10.html" class="nav-link next">ç¬¬åç« ï¼šæ¡ˆä¾‹ç ”ç©¶ä¸æœ€ä½³å®è·µ â†’</a></nav>
        </main>
    </div>
</body>
</html>