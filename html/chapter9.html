<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>第九章：生产部署与监控</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">LLM 后训练实验设计指南</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第一章：后训练基础理论</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第二章：实验代码基础设施</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第三章：数据工程</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第四章：纯语言任务实验设计</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第五章：多模态任务实验设计</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第六章：强化学习与人类反馈</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第七章：训练循环与迭代优化</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第八章：评估与基准测试</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第九章：生产部署与监控</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第十章：案例研究与最佳实践</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="_1">第九章：生产部署与监控</h1>
<p>将后训练模型从实验环境部署到生产系统是一个复杂的工程挑战。本章系统介绍模型压缩、服务化架构、实时监控、漂移检测以及发布策略等关键技术，帮助您构建稳定、高效、可维护的 LLM 生产系统。</p>
<h2 id="91">9.1 模型压缩与加速技术</h2>
<h3 id="911">9.1.1 量化技术</h3>
<p>量化是将模型权重和激活值从高精度（如 FP32）转换为低精度（如 INT8、INT4）的过程，可以显著减少模型大小和推理延迟。</p>
<h4 id="post-training-quantization-ptq">训练后量化（Post-Training Quantization, PTQ）</h4>
<p>PTQ 在训练完成后对模型进行量化，无需重新训练：</p>
<div class="codehilite"><pre><span></span><code>原始权重 W ∈ [-α, α]
量化过程：W_q = round(W × s / α) 
反量化：W&#39; = W_q × α / s

其中 s = 2^(b-1) - 1，b 为量化位数
</code></pre></div>

<p><strong>关键技术要点</strong>：</p>
<ol>
<li>
<p><strong>对称 vs 非对称量化</strong>
   - 对称：零点固定在 0，实现简单但精度略低
   - 非对称：引入零点偏移，精度更高但计算复杂</p>
</li>
<li>
<p><strong>逐层 vs 逐通道量化</strong>
   - 逐层：整层共享量化参数，压缩率高
   - 逐通道：每个通道独立量化，精度保持更好</p>
</li>
<li>
<p><strong>动态 vs 静态量化</strong>
   - 静态：量化参数预先确定，推理速度快
   - 动态：运行时计算量化参数，精度更高</p>
</li>
</ol>
<h4 id="quantization-aware-training-qat">量化感知训练（Quantization-Aware Training, QAT）</h4>
<p>QAT 在训练过程中模拟量化效果，使模型适应低精度表示：</p>
<div class="codehilite"><pre><span></span><code>前向传播：使用量化权重
反向传播：使用全精度梯度更新

伪量化操作：
W_fake_quant = dequant(quant(W))
</code></pre></div>

<p><strong>实践技巧</strong>：</p>
<ul>
<li>💡 从 INT8 开始尝试，多数任务精度损失 &lt; 1%</li>
<li>💡 关键层（如第一层、最后一层）保持高精度</li>
<li>💡 使用校准数据集优化量化参数</li>
</ul>
<h3 id="912">9.1.2 知识蒸馏</h3>
<p>通过教师-学生框架将大模型知识迁移到小模型：</p>
<div class="codehilite"><pre><span></span><code>损失函数：
L = α × L_CE(y_student, y_true) + 
    β × L_KL(σ(z_student/T), σ(z_teacher/T))

其中：

<span class="k">-</span> L_CE：交叉熵损失（硬标签）
<span class="k">-</span> L_KL：KL 散度（软标签）
<span class="k">-</span> T：温度参数，控制分布平滑度
<span class="k">-</span> α, β：损失权重
</code></pre></div>

<p><strong>蒸馏策略优化</strong>：</p>
<ol>
<li><strong>逐层蒸馏</strong>：不仅蒸馏最终输出，还对齐中间层表示</li>
<li><strong>注意力蒸馏</strong>：传递注意力模式</li>
<li><strong>特征蒸馏</strong>：对齐隐层特征分布</li>
</ol>
<h3 id="913">9.1.3 模型剪枝</h3>
<p>移除冗余参数以减小模型大小：</p>
<h4 id="_2">结构化剪枝</h4>
<div class="codehilite"><pre><span></span><code>重要性评分：

- 权重幅度：|W|
- 梯度幅度：|∂L/∂W|
- Taylor 展开：ΔL ≈ |W × ∂L/∂W|

剪枝流程：

1. 训练基线模型
2. 计算重要性分数
3. 移除低分神经元/通道/层
4. 微调恢复性能
</code></pre></div>

<h4 id="_3">非结构化剪枝</h4>
<div class="codehilite"><pre><span></span><code>稀疏掩码：M ∈ {0,1}^d
稀疏权重：W_sparse = W ⊙ M

动态稀疏训练：

<span class="k">-</span> 周期性更新掩码
<span class="k">-</span> 保持固定稀疏度
</code></pre></div>

<p>⚠️ <strong>常见陷阱</strong>：</p>
<ul>
<li>非结构化剪枝虽然压缩率高，但硬件加速困难</li>
<li>过度剪枝导致不可恢复的性能损失</li>
<li>不同任务对剪枝的敏感度差异巨大</li>
</ul>
<h3 id="914">9.1.4 推理优化技术</h3>
<h4 id="flash-attention">Flash Attention</h4>
<p>减少注意力计算的内存访问：</p>
<div class="codehilite"><pre><span></span><code>标准注意力：O(N²) 内存
Flash Attention：O(N) 内存

通过分块计算和融合 kernel 实现：

- 减少 HBM 访问
- 提高 SRAM 利用率
</code></pre></div>

<h4 id="kv-cache">KV Cache 优化</h4>
<div class="codehilite"><pre><span></span><code><span class="nx">策略</span><span class="err">：</span>

<span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">多查询注意力</span><span class="err">（</span><span class="nx">MQA</span><span class="err">）：</span><span class="nx">共享</span><span class="w"> </span><span class="nx">K</span><span class="err">、</span><span class="nx">V</span><span class="w"> </span><span class="nx">投影</span>
<span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">分组查询注意力</span><span class="err">（</span><span class="nx">GQA</span><span class="err">）：</span><span class="nx">K</span><span class="err">、</span><span class="nx">V</span><span class="w"> </span><span class="nx">头数</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">Q</span><span class="w"> </span><span class="nx">头数</span>
<span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">滑动窗口</span><span class="err">：</span><span class="nx">限制注意力范围</span>

<span class="nx">内存计算</span><span class="err">：</span>
<span class="nx">Cache_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">batch</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="nx">seq_len</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="nx">n_layers</span><span class="w"> </span><span class="err">×</span><span class="w"> </span>
<span class="w">             </span><span class="p">(</span><span class="nx">n_kv_heads</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="nx">d_head</span><span class="p">)</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="nx">dtype_size</span>
</code></pre></div>

<h4 id="_4">批处理优化</h4>
<div class="codehilite"><pre><span></span><code>动态批处理：

<span class="k">-</span> 连续批处理（Continuous Batching）
<span class="k">-</span> 填充优化（Padding Optimization）
<span class="k">-</span> 序列并行（Sequence Parallelism）

吞吐量优化：
Throughput = batch_size / latency
找到最优 batch_size 平衡延迟和吞吐
</code></pre></div>

<h2 id="92">9.2 服务化架构设计</h2>
<h3 id="921">9.2.1 微服务架构</h3>
<div class="codehilite"><pre><span></span><code>     ┌─────────────┐
     │   Gateway   │
     └──────┬──────┘
            │
    ┌───────┼───────┐
    │       │       │
┌───▼───┐ ┌▼────┐ ┌▼─────┐
│Router │ │Auth │ │Rate  │
│       │ │     │ │Limit │
└───┬───┘ └─────┘ └──────┘
    │
    ├──────────┬─────────┬──────────┐
    │          │         │          │
┌───▼───┐ ┌───▼──┐ ┌───▼───┐ ┌────▼────┐
│Model  │ │Model │ │Cache  │ │Monitor  │
│Server │ │Pool  │ │Service│ │Service  │
└───────┘ └──────┘ └───────┘ └─────────┘
</code></pre></div>

<p><strong>关键组件设计</strong>：</p>
<ol>
<li>
<p><strong>API Gateway</strong>
   - 请求路由与负载均衡
   - 协议转换（HTTP/gRPC/WebSocket）
   - 认证授权</p>
</li>
<li>
<p><strong>Model Server</strong>
   - 模型加载与版本管理
   - 批处理队列
   - 资源隔离</p>
</li>
<li>
<p><strong>Cache Layer</strong>
   - 结果缓存（Redis/Memcached）
   - 嵌入向量缓存
   - KV Cache 共享</p>
</li>
</ol>
<h3 id="922">9.2.2 模型服务框架</h3>
<h4 id="torchserve">TorchServe 架构</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># 模型处理器示例</span>
<span class="k">class</span> <span class="nc">LLMHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">model_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">load_tokenizer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requests</span><span class="p">):</span>
        <span class="c1"># 批处理预处理</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>

    <span class="k">def</span> <span class="nf">postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="c1"># 解码和格式化</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
</code></pre></div>

<h4 id="triton-inference-server">Triton Inference Server</h4>
<div class="codehilite"><pre><span></span><code><span class="nx">模型配置</span><span class="err">：</span>
<span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;llm_model&quot;</span>
<span class="nx">platform</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pytorch_libtorch&quot;</span>
<span class="nx">max_batch_size</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span>
<span class="nx">input</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;input_ids&quot;</span>
<span class="w">    </span><span class="nx">data_type</span><span class="p">:</span><span class="w"> </span><span class="nx">TYPE_INT64</span>
<span class="w">    </span><span class="nx">dims</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
<span class="nx">output</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;logits&quot;</span>
<span class="w">    </span><span class="nx">data_type</span><span class="p">:</span><span class="w"> </span><span class="nx">TYPE_FP32</span>
<span class="w">    </span><span class="nx">dims</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
<span class="nx">instance_group</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">count</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="nx">kind</span><span class="p">:</span><span class="w"> </span><span class="nx">KIND_GPU</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
<span class="nx">dynamic_batching</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">max_queue_delay_microseconds</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="923">9.2.3 流式生成架构</h3>
<p>处理 LLM 逐 token 生成的特殊需求：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># SSE (Server-Sent Events) 实现</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">stream_generate</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">generate</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">generate_stream</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
            <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;token&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">token</span><span class="p">})</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span>
        <span class="n">generate</span><span class="p">(),</span>
        <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/event-stream&quot;</span>
    <span class="p">)</span>

<span class="c1"># WebSocket 实现</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">websocket_endpoint</span><span class="p">(</span><span class="n">websocket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">receive_text</span><span class="p">()</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">generate_stream</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send_json</span><span class="p">({</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">})</span>
    <span class="k">except</span> <span class="n">WebSocketDisconnect</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div>

<p><strong>流式处理优化</strong>：</p>
<ul>
<li>使用环形缓冲区管理 token 流</li>
<li>实现背压（Backpressure）机制</li>
<li>支持中断和恢复</li>
</ul>
<h3 id="924">9.2.4 高可用设计</h3>
<h4 id="_5">多副本部署</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Kubernetes 部署配置</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm-service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-server</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">            </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">            </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span>
<span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/health</span>
<span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span>
<span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/ready</span>
<span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</code></pre></div>

<h4 id="_6">故障转移策略</h4>
<div class="codehilite"><pre><span></span><code>主备模式：
Primary ──┐
          ├──&gt; Load Balancer ──&gt; Client
Secondary ┘    (Health Check)

负载均衡算法：

- 轮询（Round Robin）
- 最少连接（Least Connections）
- 一致性哈希（Consistent Hashing）
- 基于延迟的路由
</code></pre></div>

<h2 id="93">9.3 实时监控与告警系统</h2>
<h3 id="931">9.3.1 指标体系设计</h3>
<h4 id="_7">系统指标</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Prometheus 指标定义</span>
<span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="n">Gauge</span>

<span class="c1"># 请求指标</span>
<span class="n">request_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
    <span class="s1">&#39;llm_requests_total&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Total requests&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">request_latency</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s1">&#39;llm_request_duration_seconds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Request latency&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;operation&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># 资源指标</span>
<span class="n">gpu_utilization</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;llm_gpu_utilization_percent&#39;</span><span class="p">,</span>
    <span class="s1">&#39;GPU utilization&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;device_id&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">memory_usage</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;llm_memory_usage_bytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Memory usage&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>  <span class="c1"># gpu_memory, cpu_memory</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="_8">业务指标</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># 质量指标</span>
<span class="n">output_quality_score</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s1">&#39;llm_output_quality_score&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Output quality score from feedback&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Token 统计</span>
<span class="n">token_usage</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
    <span class="s1">&#39;llm_tokens_total&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Total tokens processed&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>  <span class="c1"># input, output</span>
<span class="p">)</span>

<span class="c1"># 成本指标</span>
<span class="n">api_cost</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
    <span class="s1">&#39;llm_api_cost_dollars&#39;</span><span class="p">,</span>
    <span class="s1">&#39;API cost in dollars&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;customer&#39;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="932">9.3.2 日志聚合与分析</h3>
<h4 id="_9">结构化日志设计</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">structlog</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>

<span class="c1"># 请求日志</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
    <span class="s2">&quot;request_received&quot;</span><span class="p">,</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
    <span class="n">model_version</span><span class="o">=</span><span class="n">model_version</span><span class="p">,</span>
    <span class="n">input_tokens</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span>
    <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># 推理日志</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
    <span class="s2">&quot;inference_completed&quot;</span><span class="p">,</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">latency_ms</span><span class="o">=</span><span class="n">latency</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">output_tokens</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">output_tokens</span><span class="p">),</span>
    <span class="n">gpu_memory_mb</span><span class="o">=</span><span class="n">gpu_memory</span><span class="p">,</span>
    <span class="n">cache_hit</span><span class="o">=</span><span class="n">cache_hit</span>
<span class="p">)</span>

<span class="c1"># 错误日志</span>
<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
    <span class="s2">&quot;inference_failed&quot;</span><span class="p">,</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
    <span class="n">error_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
    <span class="n">traceback</span><span class="o">=</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="elk-stack">ELK Stack 集成</h4>
<div class="codehilite"><pre><span></span><code>日志流水线：
Application ──&gt; Filebeat ──&gt; Logstash ──&gt; Elasticsearch ──&gt; Kibana
                              │
                              ├─&gt; 解析和增强
                              ├─&gt; 过滤和路由
                              └─&gt; 告警触发
</code></pre></div>

<h3 id="933">9.3.3 分布式追踪</h3>
<p>使用 OpenTelemetry 实现全链路追踪：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">opentelemetry</span> <span class="kn">import</span> <span class="n">trace</span>
<span class="kn">from</span> <span class="nn">opentelemetry.instrumentation.fastapi</span> <span class="kn">import</span> <span class="n">FastAPIInstrumentor</span>

<span class="n">tracer</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_tracer</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/generate&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">GenerateRequest</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;generate_request&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;tokenize&quot;</span><span class="p">):</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;inference&quot;</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;decode&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<h3 id="934">9.3.4 告警策略</h3>
<h4 id="_10">分级告警</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># AlertManager 配置</span>
<span class="nt">route</span><span class="p">:</span>
<span class="w">  </span><span class="nt">group_by</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;alertname&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;cluster&#39;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">group_wait</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">  </span><span class="nt">group_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">  </span><span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1h</span>
<span class="w">  </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;web.hook&#39;</span>
<span class="w">  </span><span class="nt">routes</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">    </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pagerduty</span>
<span class="w">    </span><span class="nt">continue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">    </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">slack</span>

<span class="c1"># Prometheus 告警规则</span>
<span class="nt">groups</span><span class="p">:</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm_alerts</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighLatency</span>
<span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">histogram_quantile(0.99, llm_request_duration_seconds) &gt; 5</span>
<span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;P99</span><span class="nv"> </span><span class="s">延迟超过</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">秒&quot;</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GPUMemoryLeak</span>
<span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rate(llm_gpu_memory_bytes[5m]) &gt; 100000000</span>
<span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GPU</span><span class="nv"> </span><span class="s">内存持续增长&quot;</span>
</code></pre></div>

<h4 id="_11">智能告警降噪</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AlertThrottler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">max_alerts</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window_seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_alerts</span> <span class="o">=</span> <span class="n">max_alerts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_times</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">deque</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">should_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_key</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_times</span><span class="p">[</span><span class="n">alert_key</span><span class="p">]</span>

        <span class="c1"># 清理过期时间</span>
        <span class="k">while</span> <span class="n">times</span> <span class="ow">and</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">:</span>
            <span class="n">times</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>

        <span class="c1"># 检查是否超过阈值</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_alerts</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="c1">## 9.4 模型漂移检测</span>

<span class="n">模型漂移是指模型在生产环境中性能随时间下降的现象</span><span class="err">，</span><span class="n">可能由数据分布变化</span><span class="err">、</span><span class="n">用户行为演变或外部环境改变引起</span><span class="err">。</span>

<span class="c1">### 9.4.1 漂移类型与检测方法</span>

<span class="c1">#### 数据漂移（Data Drift）</span>
<span class="n">输入数据分布的变化</span><span class="err">：</span>

<span class="err">```</span><span class="n">python</span>
<span class="c1"># KL 散度检测</span>
<span class="k">def</span> <span class="nf">kl_divergence</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;计算两个分布的 KL 散度&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">epsilon</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="n">epsilon</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="n">q</span><span class="p">))</span>

<span class="c1"># Kolmogorov-Smirnov 检验</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ks_2samp</span>

<span class="k">def</span> <span class="nf">ks_test_drift</span><span class="p">(</span><span class="n">reference_data</span><span class="p">,</span> <span class="n">current_data</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;使用 KS 检验检测分布变化&quot;&quot;&quot;</span>
    <span class="n">statistic</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">ks_2samp</span><span class="p">(</span><span class="n">reference_data</span><span class="p">,</span> <span class="n">current_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">statistic</span>

<span class="c1"># 特征分布监控</span>
<span class="k">class</span> <span class="nc">FeatureDriftMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference_window</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_window</span> <span class="o">=</span> <span class="n">reference_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_buffers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">deque</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buffers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_window</span><span class="p">:</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">detect_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
        <span class="n">drifts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_buffers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">current_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="n">current_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span><span class="p">:</span>
                <span class="n">ref_mean</span><span class="p">,</span> <span class="n">ref_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">z_score</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_mean</span> <span class="o">-</span> <span class="n">ref_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ref_std</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
                <span class="n">drifts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_score</span> <span class="o">&gt;</span> <span class="n">sensitivity</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_mean</span><span class="p">,</span> <span class="n">current_std</span><span class="p">)</span>
                <span class="n">drifts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">drifts</span>
</code></pre></div>

<h4 id="concept-drift">概念漂移（Concept Drift）</h4>
<p>输入-输出关系的变化：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 滑动窗口性能监控</span>
<span class="k">class</span> <span class="nc">ConceptDriftDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_performance</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;更新性能指标&quot;&quot;&quot;</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">prediction</span> <span class="o">==</span> <span class="n">ground_truth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_window</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
            <span class="n">current_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_window</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_performance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseline_performance</span> <span class="o">=</span> <span class="n">current_accuracy</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">drift</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_accuracy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_performance</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">drift</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>

        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># ADWIN (Adaptive Windowing) 算法</span>
<span class="k">class</span> <span class="nc">ADWIN</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.002</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检测概念漂移&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">+=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="c1"># 检测两个子窗口的显著差异</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_change</span><span class="p">():</span>
                <span class="c1"># 丢弃旧数据</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shrink_window</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_detect_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;使用 Hoeffding 界检测变化&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">split_point</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">):</span>
            <span class="n">n0</span> <span class="o">=</span> <span class="n">split_point</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">split_point</span>

            <span class="n">sum0</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[:</span><span class="n">split_point</span><span class="p">])</span>
            <span class="n">sum1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">[</span><span class="n">split_point</span><span class="p">:])</span>

            <span class="n">mean0</span> <span class="o">=</span> <span class="n">sum0</span> <span class="o">/</span> <span class="n">n0</span>
            <span class="n">mean1</span> <span class="o">=</span> <span class="n">sum1</span> <span class="o">/</span> <span class="n">n1</span>

            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n1</span><span class="p">))</span> <span class="o">*</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean0</span> <span class="o">-</span> <span class="n">mean1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<h3 id="942">9.4.2 预测质量监控</h3>
<h4 id="_12">置信度分析</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ConfidenceMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calibration_bins</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration_bins</span> <span class="o">=</span> <span class="n">calibration_bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accuracies</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">update_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;更新置信度统计&quot;&quot;&quot;</span>
        <span class="n">max_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_scores</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">max_probs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accuracies</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_ece</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算期望校准误差 (ECE)&quot;&quot;&quot;</span>
        <span class="n">bin_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bin_lowers</span> <span class="o">=</span> <span class="n">bin_boundaries</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">bin_uppers</span> <span class="o">=</span> <span class="n">bin_boundaries</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">ece</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">bin_lower</span><span class="p">,</span> <span class="n">bin_upper</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bin_lowers</span><span class="p">,</span> <span class="n">bin_uppers</span><span class="p">):</span>
            <span class="n">in_bin</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_scores</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bin_lower</span> <span class="o">&lt;=</span> <span class="n">conf</span> <span class="o">&lt;</span> <span class="n">bin_upper</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_bin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bin_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">in_bin</span><span class="p">])</span>
                <span class="n">bin_conf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">in_bin</span><span class="p">])</span>
                <span class="n">ece</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_bin</span><span class="p">)</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bin_acc</span> <span class="o">-</span> <span class="n">bin_conf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ece</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_scores</span><span class="p">)</span>
</code></pre></div>

<h4 id="_13">输出分布监控</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># 文本生成质量指标</span>
<span class="k">class</span> <span class="nc">TextGenerationMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generated_text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算文本质量指标&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 多样性指标</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">generated_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;unique_tokens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

        <span class="c1"># 重复度</span>
        <span class="n">bigrams</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tokens</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;unique_bigrams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bigrams</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 长度分布</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;avg_sentence_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">sent</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> 
            <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">generated_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># 困惑度代理指标</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;entropy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_entropy</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">detect_quality_degradation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检测生成质量下降&quot;&quot;&quot;</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
            <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">window</span><span class="p">:</span>
                <span class="n">history</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># 计算移动平均和标准差</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">history</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">])</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">history</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">])</span>
                <span class="n">recent_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>

                <span class="c1"># Z-score 检验</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">recent_mean</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std</span><span class="p">:</span>
                    <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">,</span>
                        <span class="s1">&#39;baseline&#39;</span><span class="p">:</span> <span class="n">mean</span><span class="p">,</span>
                        <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">recent_mean</span><span class="p">,</span>
                        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">recent_mean</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">std</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">alerts</span>
</code></pre></div>

<h3 id="943">9.4.3 自动化响应策略</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DriftResponseOrchestrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_detectors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_strategies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">register_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">detector</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;注册漂移检测器和响应策略&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_detectors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_strategies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy</span>

    <span class="k">def</span> <span class="nf">monitor_and_respond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;监控并自动响应&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">detector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_detectors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_drift</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detector_name</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;处理检测到的漂移&quot;&quot;&quot;</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_strategies</span><span class="p">[</span><span class="n">detector_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;alert&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Drift detected by </span><span class="si">{</span><span class="n">detector_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;retrain&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_retraining</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;fallback&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_switch_to_fallback_model</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;recalibrate&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recalibrate_model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_trigger_retraining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;触发模型重训练&quot;&quot;&quot;</span>
        <span class="c1"># 收集新数据</span>
        <span class="c1"># 启动训练任务</span>
        <span class="c1"># 验证新模型</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_recalibrate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;重新校准模型输出&quot;&quot;&quot;</span>
        <span class="c1"># 使用温度缩放</span>
        <span class="c1"># 更新后处理参数</span>
        <span class="k">pass</span>
</code></pre></div>

<h2 id="95">9.5 回滚与灰度发布策略</h2>
<h3 id="951">9.5.1 蓝绿部署</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Kubernetes 蓝绿部署配置</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm-service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">green</span><span class="w">  </span><span class="c1"># 切换到 blue 或 green</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>

<span class="nn">---</span>
<span class="c1"># Blue 部署</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm-blue</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm</span>
<span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm</span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-server</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm:v1.0</span>

<span class="nn">---</span>
<span class="c1"># Green 部署</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm-green</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm</span>
<span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">green</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm</span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">green</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model-server</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llm:v2.0</span>
</code></pre></div>

<h3 id="952">9.5.2 金丝雀发布</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CanaryDeployment</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_traffic_percent</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canary_percent</span> <span class="o">=</span> <span class="n">initial_traffic_percent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span> <span class="o">=</span> <span class="n">MetricsCollector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decision_threshold</span> <span class="o">=</span> <span class="mf">0.95</span>  <span class="c1"># 成功率阈值</span>

    <span class="k">def</span> <span class="nf">route_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;路由请求到金丝雀或稳定版本&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">canary_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canary_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;canary&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stable_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;stable&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">progressive_rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;渐进式发布&quot;&quot;&quot;</span>
        <span class="n">stages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>  <span class="c1"># 流量百分比阶段</span>

        <span class="k">for</span> <span class="n">target_percent</span> <span class="ow">in</span> <span class="n">stages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canary_percent</span> <span class="o">=</span> <span class="n">target_percent</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 每阶段观察 5 分钟</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_health</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_check_health</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检查金丝雀版本健康状态&quot;&quot;&quot;</span>
        <span class="n">canary_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">(</span><span class="s1">&#39;canary&#39;</span><span class="p">)</span>
        <span class="n">stable_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">(</span><span class="s1">&#39;stable&#39;</span><span class="p">)</span>

        <span class="c1"># 比较关键指标</span>
        <span class="n">canary_success_rate</span> <span class="o">=</span> <span class="n">canary_metrics</span><span class="p">[</span><span class="s1">&#39;success_rate&#39;</span><span class="p">]</span>
        <span class="n">stable_success_rate</span> <span class="o">=</span> <span class="n">stable_metrics</span><span class="p">[</span><span class="s1">&#39;success_rate&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">canary_success_rate</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># 统计显著性检验</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statistical_test</span><span class="p">(</span>
            <span class="n">canary_metrics</span><span class="p">[</span><span class="s1">&#39;latencies&#39;</span><span class="p">],</span>
            <span class="n">stable_metrics</span><span class="p">[</span><span class="s1">&#39;latencies&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span>  <span class="c1"># 无显著差异</span>

    <span class="k">def</span> <span class="nf">_rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;回滚到稳定版本&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canary_percent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Canary rollback triggered&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="953-feature-flags">9.5.3 特征开关（Feature Flags）</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">FeatureFlags</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_source</span><span class="o">=</span><span class="s1">&#39;redis&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_source</span> <span class="o">=</span> <span class="n">config_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_flags</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_load_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;从配置源加载特征开关&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_source</span> <span class="o">==</span> <span class="s1">&#39;redis&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;new_tokenizer&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;rollout&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                <span class="s1">&#39;attention_optimization&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;rollout&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
                <span class="s1">&#39;experimental_sampler&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;rollout&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">is_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检查特征是否启用&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">flag_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="c1"># 基于用户 ID 的一致性哈希</span>
            <span class="n">hash_value</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flag_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span>
            <span class="k">return</span> <span class="n">hash_value</span> <span class="o">&lt;</span> <span class="n">flag</span><span class="p">[</span><span class="s1">&#39;rollout&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">flag</span><span class="p">[</span><span class="s1">&#39;rollout&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">with_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;装饰器模式&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">flag_name</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 返回默认行为</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_behavior</span><span class="p">(</span><span class="n">flag_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wrapper</span>
        <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div>

<h3 id="954">9.5.4 回滚策略实现</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RollbackManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deployment_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span> <span class="o">=</span> <span class="n">HealthChecker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_rollback_window</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 1 小时</span>

    <span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;部署新版本&quot;&quot;&quot;</span>
        <span class="n">deployment</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;deploying&#39;</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deployment_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deployment</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 执行部署</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_deployment</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

            <span class="c1"># 健康检查</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_deployment_check</span><span class="p">(</span><span class="n">version</span><span class="p">):</span>
                <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;healthy&#39;</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unhealthy&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">automatic_rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>
            <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">automatic_rollback</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">automatic_rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;自动回滚到上一个健康版本&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">deployment</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deployment_history</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;healthy&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rolling back to version </span><span class="si">{</span><span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_execute_deployment</span><span class="p">(</span>
                    <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">],</span>
                    <span class="n">deployment</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No healthy version found for rollback&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_post_deployment_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;部署后健康检查&quot;&quot;&quot;</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span><span class="o">.</span><span class="n">check_endpoint_health</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span><span class="o">.</span><span class="n">check_model_loading</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span><span class="o">.</span><span class="n">check_inference_latency</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_checker</span><span class="o">.</span><span class="n">check_error_rate</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;执行实际部署操作&quot;&quot;&quot;</span>
        <span class="c1"># 更新模型文件</span>
        <span class="c1"># 重启服务</span>
        <span class="c1"># 更新路由配置</span>
        <span class="k">pass</span>
</code></pre></div>

<h2 id="_14">本章小结</h2>
<p>本章系统介绍了 LLM 生产部署与监控的核心技术：</p>
<h3 id="_15">📌 核心概念</h3>
<ol>
<li>
<p><strong>模型优化三大技术</strong>：
   - 量化：PTQ vs QAT，权衡精度与效率
   - 蒸馏：知识传递，大模型能力迁移到小模型
   - 剪枝：结构化 vs 非结构化，移除冗余参数</p>
</li>
<li>
<p><strong>服务架构设计</strong>：
   - 微服务架构：模块化、可扩展、高可用
   - 流式生成：SSE/WebSocket 实现逐 token 输出
   - 批处理优化：动态批处理提高吞吐量</p>
</li>
<li>
<p><strong>监控体系</strong>：
   - 系统指标：延迟、吞吐、资源利用率
   - 业务指标：质量分数、成本统计
   - 分布式追踪：全链路性能分析</p>
</li>
<li>
<p><strong>漂移检测</strong>：
   - 数据漂移：输入分布变化
   - 概念漂移：输入-输出关系变化
   - 自动响应：告警、重训练、回滚</p>
</li>
<li>
<p><strong>发布策略</strong>：
   - 蓝绿部署：零停机切换
   - 金丝雀发布：渐进式流量迁移
   - 特征开关：细粒度功能控制</p>
</li>
</ol>
<h3 id="_16">💡 关键公式</h3>
<ol>
<li>
<p><strong>量化误差</strong>：
   $$\epsilon = \frac{\alpha}{2^{b-1}-1}$$
其中 $\alpha$ 为数值范围，$b$ 为量化位数</p>
</li>
<li>
<p><strong>蒸馏损失</strong>：
$$L = \alpha L_{CE} + \beta \cdot T^2 \cdot L_{KL}$$</p>
</li>
<li>
<p><strong>期望校准误差（ECE）</strong>：
$$ECE = \sum_{m=1}^{M} \frac{|B_m|}{n} |acc(B_m) - conf(B_m)|$$</p>
</li>
<li>
<p><strong>KL 散度漂移检测</strong>：
$$D_{KL}(P||Q) = \sum_{i} P(i) \log \frac{P(i)}{Q(i)}$$</p>
</li>
</ol>
<h3 id="_17">🔬 实用技巧</h3>
<ol>
<li>
<p><strong>压缩策略选择</strong>：
   - 延迟敏感：优先量化（INT8）
   - 内存受限：结构化剪枝 + 量化
   - 精度优先：知识蒸馏</p>
</li>
<li>
<p><strong>监控告警设置</strong>：
   - P50/P95/P99 分位数监控
   - 滑动窗口异常检测
   - 分级告警避免告警疲劳</p>
</li>
<li>
<p><strong>发布风险控制</strong>：
   - 金丝雀起始流量 &lt; 5%
   - 每阶段观察时间 ≥ 5 分钟
   - 自动回滚机制必须配置</p>
</li>
</ol>
<h2 id="gotchas">常见陷阱与错误 (Gotchas)</h2>
<h3 id="_18">⚠️ 模型压缩陷阱</h3>
<ol>
<li>
<p><strong>过度量化导致精度崩溃</strong>
   - 错误：直接应用 INT4 量化到所有层
   - 正确：关键层保持高精度，使用混合精度策略</p>
</li>
<li>
<p><strong>忽视硬件加速支持</strong>
   - 错误：使用非结构化剪枝期望加速
   - 正确：确认目标硬件支持的优化模式</p>
</li>
<li>
<p><strong>蒸馏温度设置不当</strong>
   - 错误：固定温度 T=1
   - 正确：根据任务调整，通常 T∈[3,10]</p>
</li>
</ol>
<h3 id="_19">⚠️ 部署架构陷阱</h3>
<ol>
<li>
<p><strong>批处理配置错误</strong>
   - 错误：batch_size 越大越好
   - 正确：平衡延迟和吞吐，测试最优值</p>
</li>
<li>
<p><strong>忽视冷启动问题</strong>
   - 错误：不预热模型直接服务
   - 正确：部署后进行预热请求</p>
</li>
<li>
<p><strong>KV Cache 内存溢出</strong>
   - 错误：无限制缓存所有序列
   - 正确：设置最大序列长度和缓存淘汰策略</p>
</li>
</ol>
<h3 id="_20">⚠️ 监控盲区</h3>
<ol>
<li>
<p><strong>只监控平均值</strong>
   - 错误：只看平均延迟
   - 正确：监控 P95/P99 长尾延迟</p>
</li>
<li>
<p><strong>忽视业务指标</strong>
   - 错误：只关注系统指标
   - 正确：结合业务质量指标综合评估</p>
</li>
<li>
<p><strong>告警风暴</strong>
   - 错误：所有异常都触发告警
   - 正确：告警聚合、降噪、分级</p>
</li>
</ol>
<h3 id="_21">⚠️ 发布风险</h3>
<ol>
<li>
<p><strong>跳过金丝雀阶段</strong>
   - 错误：直接 100% 切换流量
   - 正确：渐进式增加流量比例</p>
</li>
<li>
<p><strong>回滚策略缺失</strong>
   - 错误：手动回滚，耗时且易错
   - 正确：自动化回滚机制</p>
</li>
<li>
<p><strong>配置漂移</strong>
   - 错误：手动修改生产配置
   - 正确：版本化配置，通过 CI/CD 部署</p>
</li>
</ol>
<h2 id="_22">练习题</h2>
<h3 id="_23">基础题</h3>
<p><strong>练习 9.1：量化精度分析</strong>
给定一个权重矩阵 W ∈ [-2.5, 3.7]，计算使用 INT8 对称量化后的最大量化误差。</p>
<details>
<summary>Hint</summary>
<p>考虑对称量化的范围确定方式和量化步长计算。</p>
</details>
<details>
<summary>答案</summary>
<p>对称量化需要范围对称于 0：</p>
<ul>
<li>范围：[-3.7, 3.7]（取绝对值最大值）</li>
<li>量化步长：s = 3.7 / 127 ≈ 0.0291</li>
<li>最大量化误差：s/2 ≈ 0.0146</li>
</ul>
<p>实际量化过程：</p>
<ol>
<li>缩放：W_scaled = W × 127/3.7</li>
<li>取整：W_q = round(W_scaled)</li>
<li>反量化：W' = W_q × 3.7/127</li>
</ol>
<p>最大误差出现在量化边界，约为 0.0146。</p>
</details>
<p><strong>练习 9.2：KV Cache 内存估算</strong>
计算以下配置的 KV Cache 内存需求：</p>
<ul>
<li>batch_size = 8</li>
<li>max_seq_length = 2048</li>
<li>num_layers = 24</li>
<li>num_kv_heads = 8</li>
<li>head_dim = 128</li>
<li>dtype = float16</li>
</ul>
<details>
<summary>Hint</summary>
<p>KV Cache 需要存储每层的 K 和 V 矩阵，注意 float16 占 2 字节。</p>
</details>
<details>
<summary>答案</summary>
<p>内存计算：</p>
<div class="codehilite"><pre><span></span><code><span class="nx">Cache_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">batch</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="nx">seq_len</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="nx">n_layers</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="nx">n_kv_heads</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="nx">d_head</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="nx">dtype_size</span>
<span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nx">bytes</span>
<span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">2</span>
<span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">610</span><span class="p">,</span><span class="mi">612</span><span class="p">,</span><span class="mi">736</span><span class="w"> </span><span class="nx">bytes</span>
<span class="w">         </span><span class="err">≈</span><span class="w"> </span><span class="m m-Double">1.5</span><span class="w"> </span><span class="nx">GB</span>
</code></pre></div>

<p>解释：</p>
<ul>
<li>2 表示 K 和 V 两个矩阵</li>
<li>float16 占 2 字节</li>
<li>总计约 1.5 GB 显存</li>
</ul>
</details>
<p><strong>练习 9.3：金丝雀发布流量计算</strong>
金丝雀发布采用指数增长策略，初始流量 2%，每阶段翻倍。需要多少阶段才能达到 100% 流量？每阶段的具体流量比例是多少？</p>
<details>
<summary>Hint</summary>
<p>使用 2^n 计算阶段数，注意最后一个阶段直接到 100%。</p>
</details>
<details>
<summary>答案</summary>
<p>流量增长序列：</p>
<ul>
<li>阶段 1：2%</li>
<li>阶段 2：4%</li>
<li>阶段 3：8%</li>
<li>阶段 4：16%</li>
<li>阶段 5：32%</li>
<li>阶段 6：64%</li>
<li>阶段 7：100%</li>
</ul>
<p>共需要 7 个阶段。实际部署中，通常会在 50% 后直接跳到 100%，即：
2% → 5% → 10% → 25% → 50% → 100%（6 个阶段）</p>
</details>
<h3 id="_24">挑战题</h3>
<p><strong>练习 9.4：漂移检测算法设计</strong>
设计一个自适应的漂移检测算法，要求：</p>
<ol>
<li>能够区分渐进漂移和突发漂移</li>
<li>自动调整检测灵敏度</li>
<li>提供漂移严重程度评分</li>
</ol>
<details>
<summary>Hint</summary>
<p>考虑结合多个时间窗口、使用不同的统计检验方法，以及如何量化漂移程度。</p>
</details>
<details>
<summary>答案</summary>
<p>多尺度自适应漂移检测器设计：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AdaptiveDriftDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_stats</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># 更新窗口</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># 突发漂移检测（短期 vs 长期）</span>
        <span class="n">sudden_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_sudden</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">short_window</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">long_window</span>
        <span class="p">)</span>

        <span class="c1"># 渐进漂移检测（中期趋势）</span>
        <span class="n">gradual_drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_gradual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">medium_window</span>
        <span class="p">)</span>

        <span class="c1"># 计算严重程度</span>
        <span class="n">severity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_severity</span><span class="p">(</span>
            <span class="n">sudden_drift</span><span class="p">,</span> 
            <span class="n">gradual_drift</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;sudden&#39;</span><span class="p">:</span> <span class="n">sudden_drift</span><span class="p">,</span>
            <span class="s1">&#39;gradual&#39;</span><span class="p">:</span> <span class="n">gradual_drift</span><span class="p">,</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">severity</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_detect_sudden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short</span><span class="p">,</span> <span class="n">long</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">short</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">long</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># KS 检验</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">ks_2samp</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">short</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">long</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.01</span>

    <span class="k">def</span> <span class="nf">_detect_gradual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Mann-Kendall 趋势检验</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mann_kendall_test</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_severity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sudden</span><span class="p">,</span> <span class="n">gradual</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sudden</span> <span class="ow">and</span> <span class="n">gradual</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;critical&#39;</span>
        <span class="k">elif</span> <span class="n">sudden</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;high&#39;</span>
        <span class="k">elif</span> <span class="n">gradual</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;medium&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;low&#39;</span>
</code></pre></div>

<p>关键设计点：</p>
<ol>
<li>多时间尺度窗口捕获不同类型漂移</li>
<li>KS 检验检测分布突变</li>
<li>Mann-Kendall 检验检测趋势</li>
<li>组合多个信号评估严重程度</li>
</ol>
</details>
<p><strong>练习 9.5：自动化容量规划</strong>
设计一个系统，根据历史负载模式和业务增长预测，自动进行容量规划和资源调度。考虑：</p>
<ol>
<li>周期性模式（日/周/月）</li>
<li>趋势增长</li>
<li>突发流量</li>
<li>成本优化</li>
</ol>
<details>
<summary>Hint</summary>
<p>使用时间序列分解、预测模型、资源调度算法的组合。</p>
</details>
<details>
<summary>答案</summary>
<p>自动化容量规划系统设计：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CapacityPlanner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_model</span> <span class="o">=</span> <span class="n">CostModel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forecast_days</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="c1"># 1. 时间序列分解</span>
        <span class="n">trend</span><span class="p">,</span> <span class="n">seasonal</span><span class="p">,</span> <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompose_timeseries</span><span class="p">()</span>

        <span class="c1"># 2. 预测未来负载</span>
        <span class="n">future_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forecast_load</span><span class="p">(</span>
            <span class="n">trend</span><span class="p">,</span> <span class="n">seasonal</span><span class="p">,</span> <span class="n">forecast_days</span>
        <span class="p">)</span>

        <span class="c1"># 3. 计算所需资源</span>
        <span class="n">required_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_resources</span><span class="p">(</span>
            <span class="n">future_load</span><span class="p">,</span>
            <span class="n">include_buffer</span><span class="o">=</span><span class="mf">1.3</span>  <span class="c1"># 30% 缓冲</span>
        <span class="p">)</span>

        <span class="c1"># 4. 优化资源配置</span>
        <span class="n">optimal_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_allocation</span><span class="p">(</span>
            <span class="n">required_resources</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cost_model</span>
        <span class="p">)</span>

        <span class="c1"># 5. 生成扩缩容计划</span>
        <span class="n">scaling_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_scaling_plan</span><span class="p">(</span>
            <span class="n">optimal_config</span><span class="p">,</span>
            <span class="n">current_resources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_current_resources</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">scaling_plan</span>

    <span class="k">def</span> <span class="nf">_decompose_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># STL 分解</span>
        <span class="kn">from</span> <span class="nn">statsmodels.tsa.seasonal</span> <span class="kn">import</span> <span class="n">STL</span>
        <span class="n">stl</span> <span class="o">=</span> <span class="n">STL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_history</span><span class="p">,</span> <span class="n">seasonal</span><span class="o">=</span><span class="mi">169</span><span class="p">)</span>  <span class="c1"># 周周期</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">stl</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">trend</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">seasonal</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">resid</span>

    <span class="k">def</span> <span class="nf">_forecast_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trend</span><span class="p">,</span> <span class="n">seasonal</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="c1"># SARIMA 模型预测</span>
        <span class="kn">from</span> <span class="nn">statsmodels.tsa.statespace.sarimax</span> <span class="kn">import</span> <span class="n">SARIMAX</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SARIMAX</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_history</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">seasonal_order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fitted</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">forecast</span> <span class="o">=</span> <span class="n">fitted</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>

        <span class="c1"># 添加季节性</span>
        <span class="n">forecast_with_seasonal</span> <span class="o">=</span> <span class="n">forecast</span> <span class="o">+</span> <span class="n">seasonal</span><span class="p">[</span><span class="o">-</span><span class="n">days</span><span class="o">*</span><span class="mi">24</span><span class="p">:]</span>

        <span class="c1"># 添加安全边际（P95）</span>
        <span class="n">safety_margin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_history</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_history</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">forecast_with_seasonal</span> <span class="o">*</span> <span class="n">safety_margin</span>

    <span class="k">def</span> <span class="nf">_optimize_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">cost_model</span><span class="p">):</span>
        <span class="c1"># 混合整数规划</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">milp</span>

        <span class="c1"># 定义决策变量：不同实例类型的数量</span>
        <span class="c1"># 目标：最小化成本</span>
        <span class="c1"># 约束：满足资源需求</span>

        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">cost_model</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">instance_types</span><span class="p">]</span>
        <span class="n">A_ub</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">capacity</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">instance_types</span><span class="p">])</span>
        <span class="n">b_ub</span> <span class="o">=</span> <span class="o">-</span><span class="n">resources</span><span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">milp</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">integrality</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> 
                     <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
</code></pre></div>

<p>核心组件：</p>
<ol>
<li><strong>时间序列分解</strong>：识别趋势、季节性、随机成分</li>
<li><strong>负载预测</strong>：SARIMA 模型 + 安全边际</li>
<li><strong>资源映射</strong>：负载 → GPU/CPU/内存需求</li>
<li><strong>成本优化</strong>：考虑 Spot/Reserved/On-Demand 实例组合</li>
<li><strong>渐进式扩缩容</strong>：避免资源抖动</li>
</ol>
<p>实施要点：</p>
<ul>
<li>预留 20-30% 缓冲应对突发</li>
<li>使用预留实例降低基线成本</li>
<li>Spot 实例处理弹性负载</li>
<li>自动告警阈值：实际 &gt; 预测 × 1.5</li>
</ul>
</details>
<p><strong>练习 9.6：零停机迁移方案</strong>
设计一个将 LLM 服务从数据中心 A 迁移到数据中心 B 的零停机方案，考虑：</p>
<ol>
<li>模型文件同步（数 GB）</li>
<li>有状态的会话保持</li>
<li>逐步流量迁移</li>
<li>失败回滚</li>
</ol>
<details>
<summary>Hint</summary>
<p>考虑双写、会话迁移、DNS 切换、数据一致性等问题。</p>
</details>
<details>
<summary>答案</summary>
<p>零停机跨数据中心迁移方案：</p>
<p><strong>阶段 1：准备（T-7 天）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">tasks</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">部署 B 数据中心基础设施</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">配置网络和负载均衡器</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">部署 Kubernetes 集群</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">设置监控和日志系统</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">模型文件同步</span>
<span class="w">    </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">增量同步</span>
<span class="w">    </span><span class="nt">tools</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rsync --daemon</span>
<span class="w">    </span><span class="nt">bandwidth_limit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50%</span><span class="w">  </span><span class="c1"># 避免影响 A 数据中心</span>
</code></pre></div>

<p><strong>阶段 2：双写模式（T-3 天）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DualWriteProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary</span> <span class="o">=</span> <span class="n">DataCenterA</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="o">=</span> <span class="n">DataCenterB</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># 主数据中心处理</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># 异步复制到副数据中心</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_replicate_to_secondary</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_replicate_to_secondary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Secondary replication failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>阶段 3：流量迁移（T-0）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TrafficMigrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">migration_percent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_affinity</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># 会话保持</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session_id</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_affinity</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_affinity</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>

        <span class="c1"># 新会话按比例分配</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">migration_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="s1">&#39;datacenter_b&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="s1">&#39;datacenter_a&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session_affinity</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">destination</span>
        <span class="k">return</span> <span class="n">destination</span>

    <span class="k">def</span> <span class="nf">progressive_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">percent</span> <span class="ow">in</span> <span class="n">stages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">migration_percent</span> <span class="o">=</span> <span class="n">percent</span>

            <span class="c1"># 健康检查</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_health_check</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># 会话迁移（长连接）</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_migrate_sticky_sessions</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 5 分钟观察期</span>

        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p><strong>阶段 4：会话迁移</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SessionMigrator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">migrate_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="c1"># 1. 获取会话状态</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">datacenter_a</span><span class="o">.</span><span class="n">get_session_state</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

        <span class="c1"># 2. 序列化 KV Cache</span>
        <span class="n">kv_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_kv_cache</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">kv_cache</span><span class="p">)</span>

        <span class="c1"># 3. 传输到 B 数据中心</span>
        <span class="n">datacenter_b</span><span class="o">.</span><span class="n">restore_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;kv_cache&#39;</span><span class="p">:</span> <span class="n">kv_cache</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="p">})</span>

        <span class="c1"># 4. 验证一致性</span>
        <span class="n">checksum_a</span> <span class="o">=</span> <span class="n">datacenter_a</span><span class="o">.</span><span class="n">compute_checksum</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
        <span class="n">checksum_b</span> <span class="o">=</span> <span class="n">datacenter_b</span><span class="o">.</span><span class="n">compute_checksum</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checksum_a</span> <span class="o">!=</span> <span class="n">checksum_b</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConsistencyError</span><span class="p">()</span>

        <span class="c1"># 5. 更新路由</span>
        <span class="n">router</span><span class="o">.</span><span class="n">update_affinity</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="s1">&#39;datacenter_b&#39;</span><span class="p">)</span>
</code></pre></div>

<p><strong>阶段 5：验证和清理</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># DNS 切换</span>
dig<span class="w"> </span>@8.8.8.8<span class="w"> </span>api.example.com<span class="w">  </span><span class="c1"># 验证 TTL</span>
aws<span class="w"> </span>route53<span class="w"> </span>change-resource-record-sets<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--hosted-zone-id<span class="w"> </span>Z123<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--change-batch<span class="w"> </span>file://dns-cutover.json

<span class="c1"># 监控验证</span>

-<span class="w"> </span>错误率<span class="w"> </span>&lt;<span class="w"> </span><span class="m">0</span>.01%
-<span class="w"> </span>P99<span class="w"> </span>延迟<span class="w"> </span>&lt;<span class="w"> </span><span class="m">110</span>%<span class="w"> </span>基线
-<span class="w"> </span>会话连续性<span class="w"> </span><span class="m">100</span>%

<span class="c1"># 清理旧资源（T+7 天）</span>
kubectl<span class="w"> </span>--context<span class="o">=</span>datacenter-a<span class="w"> </span>delete<span class="w"> </span>deployment<span class="w"> </span>llm-service
</code></pre></div>

<p>关键技术点：</p>
<ol>
<li><strong>增量同步</strong>：避免网络拥塞</li>
<li><strong>会话亲和性</strong>：保持用户体验</li>
<li><strong>双写验证</strong>：确保 B 数据中心就绪</li>
<li><strong>渐进式切换</strong>：快速回滚能力</li>
<li><strong>状态迁移</strong>：KV Cache 序列化传输</li>
</ol>
<p>失败回滚机制：</p>
<ul>
<li>DNS 快速切回（TTL=60s）</li>
<li>会话路由表回滚</li>
<li>保留 A 数据中心 7 天</li>
</ul>
</details>
<p><strong>练习 9.7：成本优化策略</strong>
某 LLM 服务月度 GPU 成本 10 万美元，设计一个综合成本优化方案，目标降低 30% 成本而不影响 SLA。</p>
<details>
<summary>Hint</summary>
<p>从多个维度思考：实例类型、调度策略、缓存、模型优化等。</p>
</details>
<details>
<summary>答案</summary>
<p>综合成本优化方案：</p>
<ol>
<li><strong>实例类型优化（预期节省 15%）</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># 当前：100% On-Demand</span>
<span class="c1"># 优化后：混合实例策略</span>
<span class="n">instance_mix</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;reserved&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>    <span class="c1"># 50% 预留实例（3年期，节省 60%）</span>
    <span class="s1">&#39;savings_plan&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="c1"># 20% Savings Plan（节省 40%）  </span>
    <span class="s1">&#39;spot&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>        <span class="c1"># 20% Spot 实例（节省 70%）</span>
    <span class="s1">&#39;on_demand&#39;</span><span class="p">:</span> <span class="mf">0.1</span>    <span class="c1"># 10% 按需（保持弹性）</span>
<span class="p">}</span>

<span class="c1"># 成本计算</span>
<span class="n">original_cost</span> <span class="o">=</span> <span class="mi">100000</span>  <span class="c1"># 美元/月</span>
<span class="n">optimized_cost</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">100000</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span>   <span class="c1"># Reserved</span>
    <span class="mi">100000</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="mf">0.6</span> <span class="o">+</span>   <span class="c1"># Savings Plan</span>
    <span class="mi">100000</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">+</span>   <span class="c1"># Spot</span>
    <span class="mi">100000</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="mf">1.0</span>     <span class="c1"># On-Demand</span>
<span class="p">)</span> <span class="o">=</span> <span class="mi">48000</span>  <span class="c1"># 节省 52%，但考虑 Spot 中断，实际约 15%</span>
</code></pre></div>

<ol start="2">
<li><strong>智能调度和自动伸缩（预期节省 8%）</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CostAwareScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_priority</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span>
            <span class="c1"># 低优先级任务调度到 Spot 实例</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_instances</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span>
            <span class="c1"># 中优先级使用预留实例</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserved_instances</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 高优先级保证 SLA</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_demand_instances</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">auto_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 基于负载预测的提前扩缩容</span>
        <span class="n">predicted_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">predicted_load</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="c1"># 深夜低谷，关闭部分实例</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_down</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">predicted_load</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># 高峰期，提前扩容</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_up</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
</code></pre></div>

<ol start="3">
<li><strong>缓存优化（预期节省 5%）</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiLevelCache</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 内存缓存（热点数据）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">()</span>  <span class="c1"># 分布式缓存</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l3_cache</span> <span class="o">=</span> <span class="n">S3</span><span class="p">()</span>  <span class="c1"># 冷数据</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c1"># L1: 命中率 30%，节省 100% GPU 时间</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># L2: 命中率 20%，节省 95% GPU 时间</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="c1"># L3: 嵌入向量缓存</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_embedding_request</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">embedding</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">embedding</span>

        <span class="c1"># Cache miss，计算并存储</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_caches</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<ol start="4">
<li><strong>模型优化（预期节省 5%）</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># 动态模型选择</span>
<span class="k">class</span> <span class="nc">ModelSelector</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_complexity</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">complexity</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
            <span class="c1"># 简单任务用小模型（7B）</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_model</span>  <span class="c1"># 成本 1x</span>
        <span class="k">elif</span> <span class="n">complexity</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span>
            <span class="c1"># 中等任务用中模型（13B）</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">medium_model</span>  <span class="c1"># 成本 2x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 复杂任务用大模型（70B）</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_model</span>  <span class="c1"># 成本 10x</span>

<span class="c1"># 请求级量化</span>
<span class="k">class</span> <span class="nc">DynamicQuantization</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">latency_requirement</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c1"># ms</span>
            <span class="c1"># 宽松延迟要求，使用 INT4 量化</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">int4_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 严格延迟要求，使用 FP16</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp16_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div>

<ol start="5">
<li><strong>批处理优化（预期节省 2%）</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">BatchOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">optimize_batch_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 动态调整批大小</span>
        <span class="n">current_latency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">get_p95_latency</span><span class="p">()</span>
        <span class="n">current_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span>

        <span class="k">if</span> <span class="n">current_latency</span> <span class="o">&lt;</span> <span class="n">SLA_LATENCY</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># 有余量，增加批大小提高吞吐</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">current_batch</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">current_latency</span> <span class="o">&gt;</span> <span class="n">SLA_LATENCY</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">:</span>
            <span class="c1"># 接近 SLA，减小批大小</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">current_batch</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><strong>实施计划</strong>：</p>
<ol>
<li>第 1 个月：采购预留实例，部署缓存系统</li>
<li>第 2 个月：实施智能调度，A/B 测试</li>
<li>第 3 个月：模型优化，全面推广</li>
</ol>
<p><strong>预期效果</strong>：</p>
<ul>
<li>总成本降低：32%</li>
<li>SLA 保持：99.9%</li>
<li>用户体验：无感知</li>
</ul>
<p><strong>风险缓解</strong>：</p>
<ul>
<li>Spot 中断：自动故障转移到 On-Demand</li>
<li>缓存失效：降级到直接计算</li>
<li>模型切换：平滑过渡，监控质量</li>
</ul>
</details>
<p><strong>练习 9.8：端到端延迟优化</strong>
一个 LLM 服务的 P99 延迟为 5 秒，分析并优化到 2 秒以内。给出详细的分析方法和优化方案。</p>
<details>
<summary>Hint</summary>
<p>使用火焰图分析、分阶段优化、关注长尾延迟的特殊原因。</p>
</details>
<details>
<summary>答案</summary>
<p>端到端延迟优化方案：</p>
<p><strong>第一步：延迟分解分析</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LatencyProfiler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">profile_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">timeline</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 1. 网络接收</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">receive_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;network_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

        <span class="c1"># 2. 认证授权</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span>

        <span class="c1"># 3. 预处理</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;tokenization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t2</span>

        <span class="c1"># 4. 队列等待</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">wait_for_batch</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;queue_wait&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t3</span>

        <span class="c1"># 5. 模型推理</span>
        <span class="n">t4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;inference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t4</span>

        <span class="c1"># 6. 后处理</span>
        <span class="n">t5</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">postprocess</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;postprocess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t5</span>

        <span class="c1"># 7. 网络发送</span>
        <span class="n">t6</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">send_response</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">timeline</span><span class="p">[</span><span class="s1">&#39;network_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t6</span>

        <span class="k">return</span> <span class="n">timeline</span>

<span class="c1"># 分析 P99 延迟组成</span>
<span class="n">p99_breakdown</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;network_in&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>      <span class="c1"># ms</span>
    <span class="s1">&#39;auth&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>           <span class="c1"># ms</span>
    <span class="s1">&#39;tokenization&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># ms</span>
    <span class="s1">&#39;queue_wait&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>    <span class="c1"># ms (!)</span>
    <span class="s1">&#39;inference&#39;</span><span class="p">:</span> <span class="mi">4000</span><span class="p">,</span>    <span class="c1"># ms (!)</span>
    <span class="s1">&#39;postprocess&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>    <span class="c1"># ms</span>
    <span class="s1">&#39;network_out&#39;</span><span class="p">:</span> <span class="mi">250</span>    <span class="c1"># ms (!)</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>第二步：针对性优化</strong></p>
<p><strong>优化 1：推理加速（4000ms → 1500ms）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Flash Attention 实现</span>
<span class="k">class</span> <span class="nc">FlashAttentionOptimized</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="c1"># 分块计算，减少内存访问</span>
        <span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">64</span>

        <span class="c1"># 使用 Triton 核函数</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">triton_flash_attn</span><span class="p">(</span>
            <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span>
            <span class="n">causal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">block_size</span><span class="o">=</span><span class="n">BLOCK_SIZE</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

<span class="c1"># KV Cache 优化</span>
<span class="k">class</span> <span class="nc">OptimizedKVCache</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># GPU 常驻</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># 0 拷贝</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="c1"># 异步传输到 GPU</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># 算子融合</span>
<span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span>
<span class="k">def</span> <span class="nf">fused_gelu_linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bias</span><span class="p">):</span>
    <span class="c1"># 融合 GELU 激活和线性层</span>
    <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">gelu</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">weight</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>
</code></pre></div>

<p><strong>优化 2：队列优化（500ms → 100ms）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PriorityBatchQueue</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queues</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">deque</span><span class="p">(),</span>     <span class="c1"># SLA 严格</span>
            <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="n">deque</span><span class="p">(),</span>   <span class="c1"># 普通请求</span>
            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">deque</span><span class="p">()</span>       <span class="c1"># 批量任务</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">continuous_batching</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">add_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_priority</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># 高优先级立即处理</span>
        <span class="k">if</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_immediate_batch</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># 连续批处理</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_batching</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_merge_batch</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_immediate_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># 高优先级请求不等待</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">request</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_try_merge_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># 动态批处理，最大等待 100ms</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">request</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">batch</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>优化 3：网络优化（250ms → 50ms）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># HTTP/2 服务器推送</span>
<span class="k">class</span> <span class="nc">HTTP2Streaming</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">stream_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="c1"># 服务器推送，逐 token 发送</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_frame</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="c1"># 零拷贝发送</span>
<span class="k">class</span> <span class="nc">ZeroCopySender</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># 使用 sendfile 系统调用</span>
        <span class="n">os</span><span class="o">.</span><span class="n">sendfile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
            <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">)</span>

<span class="c1"># 压缩传输</span>
<span class="k">class</span> <span class="nc">CompressionMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">compress_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>  <span class="c1"># 1KB 以上才压缩</span>
            <span class="k">return</span> <span class="n">gzip</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 快速压缩</span>
        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<p><strong>优化 4：长尾延迟专项优化</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TailLatencyOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc_controller</span> <span class="o">=</span> <span class="n">GCController</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_pool</span> <span class="o">=</span> <span class="n">MemoryPool</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 1. GC 调优</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc_controller</span><span class="o">.</span><span class="n">set_gc_threshold</span><span class="p">(</span>
            <span class="n">threshold0</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>  <span class="c1"># 延迟 GC</span>
            <span class="n">threshold1</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">threshold2</span><span class="o">=</span><span class="mi">20</span>
        <span class="p">)</span>

        <span class="c1"># 2. 内存池化</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_pool</span><span class="o">.</span><span class="n">preallocate</span><span class="p">(</span>
            <span class="n">tensor_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">4096</span><span class="p">],</span>
            <span class="n">count</span><span class="o">=</span><span class="mi">100</span>
        <span class="p">)</span>

        <span class="c1"># 3. CPU 亲和性</span>
        <span class="n">os</span><span class="o">.</span><span class="n">sched_setaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">})</span>  <span class="c1"># 绑定 CPU 核心</span>

        <span class="c1"># 4. 预热</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_model</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_warmup_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># JIT 编译预热</span>
        <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">dummy_input</span><span class="p">)</span>
</code></pre></div>

<p><strong>优化 5：自适应降级</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AdaptiveDegradation</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">current_latency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">get_current_p99</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">current_latency</span> <span class="o">&gt;</span> <span class="mi">3000</span><span class="p">:</span>  <span class="c1"># 严重延迟</span>
            <span class="c1"># 降级到小模型</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">current_latency</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>  <span class="c1"># 中度延迟</span>
            <span class="c1"># 减少生成长度</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 正常处理</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div>

<p><strong>最终效果</strong>：</p>
<div class="codehilite"><pre><span></span><code>原始 P99: 5000ms
优化后 P99: 1850ms

分解：

- 网络接收: 50ms
- 认证: 20ms
- Tokenization: 100ms
- 队列: 100ms (优化 400ms)
- 推理: 1500ms (优化 2500ms)
- 后处理: 80ms
- 网络发送: 50ms (优化 200ms)

总计: 1900ms（达标）
</code></pre></div>

<p><strong>监控验证</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># A/B 测试验证</span>
<span class="n">ab_test</span> <span class="o">=</span> <span class="n">ABTest</span><span class="p">(</span>
    <span class="n">control</span><span class="o">=</span><span class="s1">&#39;original&#39;</span><span class="p">,</span>
    <span class="n">treatment</span><span class="o">=</span><span class="s1">&#39;optimized&#39;</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;p50&#39;</span><span class="p">,</span> <span class="s1">&#39;p95&#39;</span><span class="p">,</span> <span class="s1">&#39;p99&#39;</span><span class="p">,</span> <span class="s1">&#39;error_rate&#39;</span><span class="p">],</span>
    <span class="n">duration_hours</span><span class="o">=</span><span class="mi">24</span>
<span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">ab_test</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">][</span><span class="s1">&#39;p99&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2000</span>
<span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">][</span><span class="s1">&#39;error_rate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.001</span>
</code></pre></div>

</details>
<hr />
<p><strong>下一章</strong>：<a href="chapter10.html">第十章：案例研究与最佳实践 →</a></p>
            </article>
            
            <nav class="page-nav"><a href="chapter8.html" class="nav-link prev">← 第八章：评估与基准测试</a><a href="chapter10.html" class="nav-link next">第十章：案例研究与最佳实践 →</a></nav>
        </main>
    </div>
</body>
</html>