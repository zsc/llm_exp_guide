<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬äº”ç« ï¼šå¤šæ¨¡æ€ä»»åŠ¡å®éªŒè®¾è®¡</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">LLM åè®­ç»ƒå®éªŒè®¾è®¡æŒ‡å—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸€ç« ï¼šåè®­ç»ƒåŸºç¡€ç†è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äºŒç« ï¼šå®éªŒä»£ç åŸºç¡€è®¾æ–½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸‰ç« ï¼šæ•°æ®å·¥ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å››ç« ï¼šçº¯è¯­è¨€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äº”ç« ï¼šå¤šæ¨¡æ€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…­ç« ï¼šå¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸ƒç« ï¼šè®­ç»ƒå¾ªç¯ä¸è¿­ä»£ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…«ç« ï¼šè¯„ä¼°ä¸åŸºå‡†æµ‹è¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¹ç« ï¼šç”Ÿäº§éƒ¨ç½²ä¸ç›‘æ§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬åç« ï¼šæ¡ˆä¾‹ç ”ç©¶ä¸æœ€ä½³å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="_1">ç¬¬äº”ç« ï¼šå¤šæ¨¡æ€ä»»åŠ¡å®éªŒè®¾è®¡</h1>
<p>æœ¬ç« æ·±å…¥æ¢è®¨å¤šæ¨¡æ€å¤§è¯­è¨€æ¨¡å‹çš„åè®­ç»ƒå®éªŒè®¾è®¡ï¼Œæ¶µç›–è§†è§‰ã€éŸ³é¢‘ã€è§†é¢‘ç­‰æ¨¡æ€ä¸è¯­è¨€çš„èåˆæ–¹æ³•ã€‚æˆ‘ä»¬å°†ç³»ç»Ÿå­¦ä¹ å¦‚ä½•è®¾è®¡è·¨æ¨¡æ€å¯¹é½å®éªŒã€å¤„ç†æ¨¡æ€é—´çš„å¼‚è´¨æ€§æŒ‘æˆ˜ï¼Œä»¥åŠæ„å»ºç»Ÿä¸€çš„å¤šæ¨¡æ€è¡¨ç¤ºç©ºé—´ã€‚é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œæ‚¨å°†æŒæ¡æ„å»ºç”Ÿäº§çº§å¤šæ¨¡æ€æ¨¡å‹çš„å®Œæ•´å®éªŒæµç¨‹ã€‚</p>
<h2 id="51-">5.1 è§†è§‰-è¯­è¨€å¯¹é½åŸºç¡€</h2>
<p>è§†è§‰-è¯­è¨€å¯¹é½æ˜¯å¤šæ¨¡æ€æ¨¡å‹çš„æ ¸å¿ƒæŒ‘æˆ˜ã€‚ä¸åŒäºæ–‡æœ¬çš„ç¦»æ•£è¡¨ç¤ºï¼Œè§†è§‰ä¿¡å·æ˜¯è¿ç»­çš„é«˜ç»´æ•°æ®ï¼Œå¦‚ä½•åœ¨ä¿æŒè¯­ä¹‰ä¸€è‡´æ€§çš„åŒæ—¶å®ç°é«˜æ•ˆå¯¹é½ï¼Œæ˜¯å®éªŒè®¾è®¡çš„å…³é”®è€ƒé‡ã€‚</p>
<h3 id="511">5.1.1 å¯¹é½èŒƒå¼æ¼”è¿›</h3>
<p>å¤šæ¨¡æ€å¯¹é½ç»å†äº†ä»ç®€å•ç‰¹å¾æ‹¼æ¥åˆ°æ·±åº¦è¯­ä¹‰èåˆçš„æ¼”è¿›è¿‡ç¨‹ï¼š</p>
<p><strong>æ—©æœŸæ–¹æ³•ï¼ˆ2015-2018ï¼‰</strong>ï¼š</p>
<ul>
<li>ç‰¹å¾çº§è”ï¼šç®€å•å°† CNN ç‰¹å¾ä¸è¯åµŒå…¥æ‹¼æ¥</li>
<li>åŒå¡”æ¶æ„ï¼šç‹¬ç«‹ç¼–ç åè®¡ç®—ç›¸ä¼¼åº¦</li>
<li>é—®é¢˜ï¼šæ¨¡æ€é—´éš™ï¼ˆmodality gapï¼‰ä¸¥é‡ï¼Œè¯­ä¹‰å¯¹é½æ•ˆæœå·®</li>
</ul>
<p><strong>ä¸­æœŸå‘å±•ï¼ˆ2018-2021ï¼‰</strong>ï¼š</p>
<ul>
<li>æ³¨æ„åŠ›æœºåˆ¶å¼•å…¥ï¼šViLBERTã€LXMERT ç­‰ä½¿ç”¨ co-attention</li>
<li>é¢„è®­ç»ƒä»»åŠ¡è®¾è®¡ï¼šMasked Language Modeling + Masked Region Modeling</li>
<li>çªç ´ï¼šCLIP çš„å¯¹æ¯”å­¦ä¹ èŒƒå¼ï¼Œå®ç°é›¶æ ·æœ¬è¿ç§»</li>
</ul>
<p><strong>å½“å‰å‰æ²¿ï¼ˆ2021-2025ï¼‰</strong>ï¼š</p>
<ul>
<li>ç»Ÿä¸€æ¶æ„ï¼šFlamingoã€BLIP-2 çš„ Q-Former è®¾è®¡</li>
<li>å¤§è§„æ¨¡é¢„è®­ç»ƒï¼šLAION-5B ç­‰åäº¿çº§æ•°æ®é›†</li>
<li>æ•ˆç‡ä¼˜åŒ–ï¼šFLIP çš„ç¨€ç–é‡‡æ ·ï¼ŒèŠ‚çœ 2/3 è®¡ç®—</li>
</ul>
<div class="codehilite"><pre><span></span><code>æ¼”è¿›è·¯å¾„ï¼š
Feature Concat â†’ Dual Encoder â†’ Cross Attention â†’ Unified Architecture
     â†“              â†“                â†“                    â†“
  ä½æ•ˆå¯¹é½      æ¨¡æ€éš”ç¦»         è®¡ç®—å¯†é›†           ç»Ÿä¸€è¡¨ç¤ºç©ºé—´
</code></pre></div>

<h3 id="512-clip">5.1.2 CLIP åŠå…¶å˜ä½“</h3>
<p>CLIPï¼ˆContrastive Language-Image Pre-trainingï¼‰å¥ å®šäº†ç°ä»£è§†è§‰-è¯­è¨€å¯¹é½çš„åŸºç¡€ï¼š</p>
<p><strong>æ ¸å¿ƒè®¾è®¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>Image Encoder: ResNet/ViT â†’ I_emb âˆˆ R^d
Text Encoder: Transformer â†’ T_emb âˆˆ R^d
å¯¹é½ç›®æ ‡: maximize cos(I_emb, T_emb) for matched pairs
</code></pre></div>

<p><strong>å…³é”®åˆ›æ–°</strong>ï¼š</p>
<ol>
<li><strong>å¯¹ç§°æŸå¤±</strong>ï¼šå›¾åƒâ†’æ–‡æœ¬ å’Œ æ–‡æœ¬â†’å›¾åƒ åŒå‘å¯¹æ¯”</li>
<li><strong>æ¸©åº¦å‚æ•°</strong>ï¼šÏ„ = 0.07ï¼Œæ§åˆ¶åˆ†å¸ƒé”åº¦</li>
<li><strong>å¤§æ‰¹é‡è®­ç»ƒ</strong>ï¼š32K batch sizeï¼Œå……åˆ†åˆ©ç”¨è´Ÿæ ·æœ¬</li>
</ol>
<p><strong>CLIP å˜ä½“å¯¹æ¯”</strong>ï¼š</p>
<p>| æ¨¡å‹ | åˆ›æ–°ç‚¹ | æ€§èƒ½æå‡ | è®¡ç®—æˆæœ¬ |</p>
<table>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>åˆ›æ–°ç‚¹</th>
<th>æ€§èƒ½æå‡</th>
<th>è®¡ç®—æˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>CLIP</td>
<td>åŸºç¡€å¯¹æ¯”å­¦ä¹ </td>
<td>Baseline</td>
<td>1.0x</td>
</tr>
<tr>
<td>ALIGN</td>
<td>å™ªå£°æ•°æ®è®­ç»ƒ</td>
<td>+2% Zero-shot</td>
<td>1.2x</td>
</tr>
<tr>
<td>FLIP</td>
<td>éšæœº Mask 50% patches</td>
<td>-1% ç²¾åº¦ï¼Œ-2.5x è®­ç»ƒæ—¶é—´</td>
<td>0.4x</td>
</tr>
<tr>
<td>OpenCLIP</td>
<td>æ‰©å±•åˆ° ViT-G/14</td>
<td>+5% ImageNet</td>
<td>3.0x</td>
</tr>
<tr>
<td>EVA-CLIP</td>
<td>æ”¹è¿›åˆå§‹åŒ–ä¸ä¼˜åŒ–å™¨</td>
<td>+3% å‡å€¼ç²¾åº¦</td>
<td>1.1x</td>
</tr>
</tbody>
</table>
<p><strong>å®éªŒè®¾è®¡è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>æ•°æ®è´¨é‡ vs æ•°é‡æƒè¡¡ï¼šALIGN è¯æ˜ 1B å™ªå£°æ•°æ®å¯è¡Œ</li>
<li>ç¼–ç å™¨å®¹é‡åˆ†é…ï¼šè§†è§‰ç¼–ç å™¨é€šå¸¸éœ€è¦æ›´å¤§å®¹é‡</li>
<li>è®­ç»ƒç¨³å®šæ€§ï¼šæ¢¯åº¦ç´¯ç§¯ + mixed precision å…³é”®</li>
</ul>
<h3 id="513">5.1.3 å¯¹æ¯”å­¦ä¹ æŸå¤±è®¾è®¡</h3>
<p>å¯¹æ¯”å­¦ä¹ æŸå¤±æ˜¯å¤šæ¨¡æ€å¯¹é½çš„æ ¸å¿ƒï¼Œå…¶è®¾è®¡ç›´æ¥å½±å“æ¨¡å‹æ€§èƒ½ï¼š</p>
<p><strong>InfoNCE æŸå¤±</strong>ï¼š
$$\mathcal{L}_{\text{InfoNCE}} = -\log \frac{\exp(s_{ii}/\tau)}{\sum_{j=1}^{N} \exp(s_{ij}/\tau)}$$
å…¶ä¸­ $s_{ij} = \text{cos}(f_I(x_i), f_T(t_j))$ ä¸ºç›¸ä¼¼åº¦å¾—åˆ†ã€‚</p>
<p><strong>æ”¹è¿›æ–¹å‘</strong>ï¼š</p>
<ol>
<li><strong>éš¾è´Ÿæ ·æœ¬æŒ–æ˜</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä¼ªä»£ç </span>
<span class="n">hard_negatives</span> <span class="o">=</span> <span class="n">top_k</span><span class="p">(</span><span class="n">similarity_scores</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">exclude_positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">pos_score</span><span class="o">/</span><span class="n">Ï„</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">pos_score</span><span class="o">/</span><span class="n">Ï„</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">neg</span><span class="o">/</span><span class="n">Ï„</span><span class="p">)</span> <span class="k">for</span> <span class="n">neg</span> <span class="ow">in</span> <span class="n">hard_negatives</span><span class="p">)))</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>å¤šç²’åº¦å¯¹æ¯”</strong>ï¼š
- Globalï¼šæ•´å›¾-æ•´å¥å¯¹æ¯”
- Regionalï¼šåŒºåŸŸ-çŸ­è¯­å¯¹æ¯”<br />
- Patchï¼šå›¾å—-è¯æ±‡å¯¹æ¯”</p>
</li>
<li>
<p><strong>è½¯æ ‡ç­¾å¯¹æ¯”</strong>ï¼š
è€ƒè™‘æ ‡æ³¨ä¸ç¡®å®šæ€§ï¼Œä½¿ç”¨è½¯æ ‡ç­¾ï¼š
$$\mathcal{L}_{\text{soft}} = -\sum_{j} y_j \log p_j$$
å…¶ä¸­ $y_j$ ä¸ºè½¯æ ‡ç­¾åˆ†å¸ƒã€‚</p>
</li>
</ol>
<p><strong>å®éªŒæŠ€å·§</strong>ï¼š</p>
<ul>
<li>æ¸©åº¦å‚æ•°è°ƒä¼˜ï¼šÏ„ âˆˆ [0.01, 0.1]ï¼Œè¿‡å°å¯¼è‡´æ¢¯åº¦çˆ†ç‚¸</li>
<li>æ‰¹é‡å¤§å°æ•ˆåº”ï¼šæ‰¹é‡ç¿»å€ï¼Œæ€§èƒ½æå‡çº¦ 1-2%</li>
<li>è´Ÿæ ·æœ¬é˜Ÿåˆ—ï¼šç»´æŠ¤åŠ¨æ€è´Ÿæ ·æœ¬ bankï¼Œæå‡å¤šæ ·æ€§</li>
</ul>
<h3 id="514">5.1.4 è´Ÿæ ·æœ¬é‡‡æ ·ç­–ç•¥</h3>
<p>è´Ÿæ ·æœ¬è´¨é‡ç›´æ¥å†³å®šå¯¹æ¯”å­¦ä¹ æ•ˆæœï¼š</p>
<p><strong>é‡‡æ ·ç­–ç•¥å¯¹æ¯”</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>éšæœºé‡‡æ ·ï¼š
â”œâ”€â”€ ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œæ— å
â””â”€â”€ ç¼ºç‚¹ï¼šåŒ…å«å¤§é‡ç®€å•è´Ÿæ ·æœ¬ï¼Œå­¦ä¹ æ•ˆç‡ä½

éš¾ä¾‹æŒ–æ˜ï¼š
â”œâ”€â”€ ä¼˜ç‚¹ï¼šåŠ é€Ÿæ”¶æ•›ï¼Œæå‡åŒºåˆ†èƒ½åŠ›
â””â”€â”€ ç¼ºç‚¹ï¼šå¯èƒ½è¿‡æ‹Ÿåˆï¼Œéœ€è¦ curriculum

æ··åˆç­–ç•¥ï¼š
â”œâ”€â”€ 80% éšæœº + 20% éš¾ä¾‹
â””â”€â”€ å¹³è¡¡æ¢ç´¢ä¸åˆ©ç”¨
</code></pre></div>

<p><strong>é«˜çº§é‡‡æ ·æŠ€æœ¯</strong>ï¼š</p>
<ol>
<li><strong>è·¨æ‰¹æ¬¡è´Ÿæ ·æœ¬</strong>ï¼ˆMoCo é£æ ¼ï¼‰ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">NegativeBank</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)))</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>è¯­ä¹‰å±‚æ¬¡é‡‡æ ·</strong>ï¼š
- Level 1ï¼šå®Œå…¨æ— å…³ï¼ˆçŒ«å›¾ç‰‡ vs æ±½è½¦æè¿°ï¼‰
- Level 2ï¼šé¢†åŸŸç›¸å…³ï¼ˆç‹—å›¾ç‰‡ vs çŒ«æè¿°ï¼‰<br />
- Level 3ï¼šç»†ç²’åº¦åŒºåˆ†ï¼ˆå“ˆå£«å¥‡ vs é˜¿æ‹‰æ–¯åŠ æè¿°ï¼‰</p>
</li>
<li>
<p><strong>åŠ¨æ€éš¾åº¦è°ƒæ•´</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>è®­ç»ƒåˆæœŸï¼š70% easy + 30% hard
è®­ç»ƒä¸­æœŸï¼š50% easy + 50% hard  
è®­ç»ƒåæœŸï¼š30% easy + 70% hard
</code></pre></div>

<p><strong>å®éªŒå»ºè®®</strong>ï¼š</p>
<ul>
<li>ç›‘æ§è´Ÿæ ·æœ¬ç›¸ä¼¼åº¦åˆ†å¸ƒï¼Œé¿å… collapse</li>
<li>ä½¿ç”¨ gradient accumulation æ¨¡æ‹Ÿå¤§æ‰¹é‡</li>
<li>å®šæœŸè¯„ä¼° retrieval metricsï¼Œä¸åªçœ‹ loss</li>
</ul>
<h2 id="52">5.2 å›¾åƒç†è§£ä¸ç”Ÿæˆçš„ç»Ÿä¸€å»ºæ¨¡</h2>
<p>ç»Ÿä¸€å»ºæ¨¡æ˜¯å¤šæ¨¡æ€é¢†åŸŸçš„åœ£æ¯â€”â€”ç”¨å•ä¸€æ¨¡å‹åŒæ—¶å¤„ç†ç†è§£å’Œç”Ÿæˆä»»åŠ¡ã€‚è¿™ä¸ä»…ç®€åŒ–äº†ç³»ç»Ÿæ¶æ„ï¼Œè¿˜èƒ½å®ç°ä»»åŠ¡é—´çš„çŸ¥è¯†è¿ç§»ã€‚</p>
<h3 id="521-">5.2.1 ç¼–ç å™¨-è§£ç å™¨æ¶æ„è®¾è®¡</h3>
<p>ç°ä»£ç»Ÿä¸€æ¶æ„éœ€è¦å¹³è¡¡ç†è§£çš„ç²¾ç¡®æ€§å’Œç”Ÿæˆçš„å¤šæ ·æ€§ï¼š</p>
<p><strong>æ¶æ„æ¼”è¿›</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">ä¼ ç»Ÿåˆ†ç¦»å¼ï¼š</span>
<span class="n">Vision</span><span class="w"> </span><span class="n">Encoder</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Understanding</span><span class="w"> </span><span class="n">Tasks</span>
<span class="n">Text</span><span class="w"> </span><span class="n">Decoder</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Generation</span><span class="w"> </span><span class="n">Tasks</span>
<span class="err">é—®é¢˜ï¼šä»»åŠ¡å­¤ç«‹ï¼Œæ— æ³•å…±äº«è¡¨ç¤º</span>

<span class="err">æ—©æœŸç»Ÿä¸€ï¼ˆ</span><span class="n">DALL</span><span class="o">-</span><span class="n">E</span><span class="err">ï¼‰ï¼š</span>
<span class="n">Text</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Image</span><span class="w"> </span><span class="n">Tokens</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Autoregressive</span><span class="w"> </span><span class="n">Transformer</span>
<span class="err">é—®é¢˜ï¼šå›¾åƒç¦»æ•£åŒ–æŸå¤±ä¸¥é‡</span>

<span class="err">å½“å‰ä¸»æµï¼ˆ</span><span class="n">Flamingo</span><span class="o">/</span><span class="n">BLIP</span><span class="o">-</span><span class="mh">2</span><span class="err">ï¼‰ï¼š</span>
<span class="n">Frozen</span><span class="w"> </span><span class="n">Vision</span><span class="w"> </span><span class="n">Encoder</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Perceiver</span><span class="w"> </span><span class="n">Resampler</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">LLM</span><span class="w"> </span><span class="n">Decoder</span>
<span class="err">ä¼˜åŠ¿ï¼šä¿ç•™é¢„è®­ç»ƒæƒé‡ï¼Œé«˜æ•ˆé€‚é…</span>
</code></pre></div>

<p><strong>å…³é”®è®¾è®¡é€‰æ‹©</strong>ï¼š</p>
<ol>
<li>
<p><strong>Vision Encoder é€‰æ‹©</strong>ï¼š
   - CLIP ViT-L/14ï¼šå¹³è¡¡æ€§èƒ½ä¸æ•ˆç‡
   - EVA-02 ViT-Eï¼šæè‡´æ€§èƒ½ï¼Œ5B å‚æ•°
   - ConvNeXt V2ï¼šæ›´å¥½çš„å±€éƒ¨ç‰¹å¾</p>
</li>
<li>
<p><strong>è¿æ¥å±‚è®¾è®¡</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PerceiverResampler</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">num_latents</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latents</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_latents</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_attend</span> <span class="o">=</span> <span class="n">CrossAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_attend</span> <span class="o">=</span> <span class="n">SelfAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visual_features</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latents</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_attend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">visual_features</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attend</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">x</span>  <span class="c1"># [64, 1024] å›ºå®šé•¿åº¦è¾“å‡º</span>
</code></pre></div>

<ol start="3">
<li><strong>Decoder é€‚é…</strong>ï¼š
   - Prefix Tuningï¼šè§†è§‰ç‰¹å¾ä½œä¸º prefix
   - Adapter Layersï¼šåœ¨ FFN åæ’å…¥é€‚é…å±‚
   - LoRAï¼šä½ç§©é€‚é…ï¼Œå‚æ•°æ•ˆç‡æœ€é«˜</li>
</ol>
<p><strong>å®éªŒæŠ€å·§</strong>ï¼š</p>
<ul>
<li>å†»ç»“ç­–ç•¥ï¼šå…ˆå†»ç»“ encoderï¼ŒåæœŸè”åˆå¾®è°ƒ</li>
<li>å­¦ä¹ ç‡è°ƒåº¦ï¼šencoder 1e-5, connector 1e-4, decoder 2e-5</li>
<li>æ•°æ®é…æ¯”ï¼šç†è§£:ç”Ÿæˆ = 3:1 åˆæœŸï¼Œé€æ­¥å¹³è¡¡</li>
</ul>
<h3 id="522-vs">5.2.2 è‡ªå›å½’ vs æ‰©æ•£æ¨¡å‹é›†æˆ</h3>
<p>ä¸¤å¤§ç”ŸæˆèŒƒå¼çš„ä¼˜åŠ£ä¸é›†æˆç­–ç•¥ï¼š</p>
<p><strong>èŒƒå¼å¯¹æ¯”</strong>ï¼š</p>
<p>| ç‰¹æ€§ | è‡ªå›å½’ï¼ˆARï¼‰ | æ‰©æ•£æ¨¡å‹ï¼ˆDMï¼‰ | æ··åˆæ–¹æ¡ˆ |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è‡ªå›å½’ï¼ˆARï¼‰</th>
<th>æ‰©æ•£æ¨¡å‹ï¼ˆDMï¼‰</th>
<th>æ··åˆæ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç”Ÿæˆè´¨é‡</td>
<td>ä¸­ç­‰</td>
<td>é«˜</td>
<td>é«˜</td>
</tr>
<tr>
<td>æ¨ç†é€Ÿåº¦</td>
<td>å¿«ï¼ˆå•æ¬¡ï¼‰</td>
<td>æ…¢ï¼ˆå¤šæ­¥ï¼‰</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td>å¯æ§æ€§</td>
<td>å¼ºï¼ˆtokençº§ï¼‰</td>
<td>å¼±ï¼ˆå…¨å±€ï¼‰</td>
<td>å¼º</td>
</tr>
<tr>
<td>è®­ç»ƒç¨³å®šæ€§</td>
<td>é«˜</td>
<td>ä¸­ç­‰</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td>å†…å­˜éœ€æ±‚</td>
<td>ä½</td>
<td>é«˜</td>
<td>é«˜</td>
</tr>
</tbody>
</table>
<p><strong>é›†æˆæ¶æ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>è¾“å…¥æ–‡æœ¬ â†’ LLM â†’ å†³ç­–ï¼š{ç†è§£ä»»åŠ¡ â†’ AR è¾“å‡º}
                     {ç”Ÿæˆä»»åŠ¡ â†’ è§¦å‘ DM}

Diffusion åˆ†æ”¯ï¼š
LLM embeddings â†’ Cross-Attention â†’ U-Net â†’ å›¾åƒ
                     â†‘
                 Text Condition
</code></pre></div>

<p><strong>CM3Leon å¼ç»Ÿä¸€</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">UnifiedModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s2">&quot;understand&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;understand&quot;</span><span class="p">:</span>
            <span class="c1"># å›¾åƒ â†’ æ–‡æœ¬</span>
            <span class="n">img_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ar_generate</span><span class="p">(</span><span class="n">concat</span><span class="p">([</span><span class="n">img_tokens</span><span class="p">,</span> <span class="n">text</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;generate&quot;</span><span class="p">:</span>
            <span class="c1"># æ–‡æœ¬ â†’ å›¾åƒ</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_diffusion</span><span class="p">:</span>
                <span class="n">text_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffusion_decode</span><span class="p">(</span><span class="n">text_emb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ar_generate_image</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>

<p><strong>è®­ç»ƒç­–ç•¥</strong>ï¼š</p>
<ol>
<li>é˜¶æ®µä¸€ï¼šåˆ†åˆ«é¢„è®­ç»ƒ AR å’Œ DM åˆ†æ”¯</li>
<li>é˜¶æ®µäºŒï¼šå†»ç»“ DMï¼Œè®­ç»ƒ ARâ†’DM æ¥å£</li>
<li>é˜¶æ®µä¸‰ï¼šè”åˆå¾®è°ƒï¼Œå¹³è¡¡ä¸¤ç§æŸå¤±</li>
</ol>
<h3 id="523-token">5.2.3 å›¾åƒ Token åŒ–ç­–ç•¥</h3>
<p>Token åŒ–è´¨é‡å†³å®šäº†æ¨¡å‹ç†è§£å’Œç”Ÿæˆçš„ä¸Šé™ï¼š</p>
<p><strong>ä¸»æµæ–¹æ³•</strong>ï¼š</p>
<ol>
<li><strong>VQ-VAE ç³»åˆ—</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code>åŸå§‹ VQ-VAE: 32Ã—32 â†’ 8Ã—8 tokens (å‹ç¼©ç‡ 16)
VQ-VAE-2: å±‚çº§ç»“æ„ï¼Œtop: 32Ã—32, bottom: 64Ã—64
é—®é¢˜ï¼šç æœ¬åå¡Œï¼Œé‡å»ºè´¨é‡å—é™
</code></pre></div>

<ol start="2">
<li><strong>VQGAN</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># å…³é”®æ”¹è¿›ï¼šæ„ŸçŸ¥æŸå¤± + å¯¹æŠ—è®­ç»ƒ</span>
<span class="n">L_total</span> <span class="o">=</span> <span class="n">L_recon</span> <span class="o">+</span> <span class="n">Î»_p</span><span class="o">*</span><span class="n">L_perceptual</span> <span class="o">+</span> <span class="n">Î»_g</span><span class="o">*</span><span class="n">L_gan</span> <span class="o">+</span> <span class="n">Î»_c</span><span class="o">*</span><span class="n">L_codebook</span>

<span class="c1"># ç æœ¬å¤§å°å½±å“ï¼š</span>
<span class="o">|</span><span class="n">Codebook</span><span class="o">|</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">:</span> <span class="n">é‡å»º</span> <span class="n">PSNR</span> <span class="o">~</span><span class="mi">23</span><span class="n">dB</span>
<span class="o">|</span><span class="n">Codebook</span><span class="o">|</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">:</span> <span class="n">é‡å»º</span> <span class="n">PSNR</span> <span class="o">~</span><span class="mi">26</span><span class="n">dB</span>
<span class="o">|</span><span class="n">Codebook</span><span class="o">|</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">:</span> <span class="n">é‡å»º</span> <span class="n">PSNR</span> <span class="o">~</span><span class="mi">27</span><span class="n">dB</span> <span class="p">(</span><span class="n">æ”¶ç›Šé€’å‡</span><span class="p">)</span>
</code></pre></div>

<ol start="3">
<li><strong>è¿ç»­ Tokenï¼ˆSEED, LaVITï¼‰</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ContinuousTokenizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="c1"># ä¸é‡åŒ–ï¼Œç›´æ¥è¾“å‡ºè¿ç»­ç‰¹å¾</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># [B, 256, 16, 16]</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># [B, 256, D]</span>
        <span class="k">return</span> <span class="n">tokens</span>  <span class="c1"># è¿ç»­å€¼ï¼Œæ— ç æœ¬</span>
</code></pre></div>

<p><strong>åˆ†è¾¨ç‡å¤„ç†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>å›ºå®šåˆ†è¾¨ç‡ï¼š
â”œâ”€â”€ ç®€å•ä½†æŸå¤±ä¿¡æ¯
â””â”€â”€ 448Ã—448 æ˜¯å¸¸è§é€‰æ‹©

åŠ¨æ€åˆ†è¾¨ç‡ï¼ˆQwen-VLï¼‰ï¼š
â”œâ”€â”€ ä¿æŒå®½é«˜æ¯”
â”œâ”€â”€ Padding åˆ°æœ€è¿‘çš„ 14 çš„å€æ•°
â””â”€â”€ ä½ç½®ç¼–ç éœ€è¦ 2D æ’å€¼

NaViT é£æ ¼æ‰“åŒ…ï¼š
â”œâ”€â”€ ä¸åŒåˆ†è¾¨ç‡å›¾åƒæ‰“åŒ…æˆåºåˆ—
â”œâ”€â”€ æ·»åŠ åˆ†è¾¨ç‡ token æ ‡è®°è¾¹ç•Œ
â””â”€â”€ è®¡ç®—æ•ˆç‡æœ€é«˜
</code></pre></div>

<p><strong>å®éªŒè¦ç‚¹</strong>ï¼š</p>
<ul>
<li>Token æ•°é‡æƒè¡¡ï¼š256 tokens å¤Ÿç”¨ï¼Œ1024 tokens ç»†èŠ‚æ›´å¥½</li>
<li>é‡å»ºè´¨é‡ç›‘æ§ï¼šFID &lt; 5 å¯æ¥å—ï¼Œ&lt; 2 ä¼˜ç§€</li>
<li>è¯­ä¹‰ä¿æŒï¼šç”¨ CLIP score éªŒè¯è¯­ä¹‰ä¸€è‡´æ€§</li>
</ul>
<h3 id="524">5.2.4 åˆ†è¾¨ç‡è‡ªé€‚åº”è®­ç»ƒ</h3>
<p>å¤„ç†çœŸå®ä¸–ç•Œå¤šæ ·åŒ–åˆ†è¾¨ç‡çš„å…³é”®æŠ€æœ¯ï¼š</p>
<p><strong>æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>æŒ‘æˆ˜ï¼š

1. è®­ç»ƒæ•°æ®åˆ†è¾¨ç‡ä¸ä¸€ï¼ˆ224Ã—224 åˆ° 4Kï¼‰
2. æ¨ç†éœ€æ±‚å¤šæ ·ï¼ˆç¼©ç•¥å›¾ vs ç»†èŠ‚å›¾ï¼‰
3. è®¡ç®—èµ„æºé™åˆ¶

è§£å†³æ–¹æ¡ˆçŸ©é˜µï¼š
              ä½åˆ†è¾¨ç‡      ä¸­åˆ†è¾¨ç‡      é«˜åˆ†è¾¨ç‡
è®­ç»ƒé˜¶æ®µ1ï¼š    100%          -            -
è®­ç»ƒé˜¶æ®µ2ï¼š     60%         30%          10%
è®­ç»ƒé˜¶æ®µ3ï¼š     30%         40%          30%
</code></pre></div>

<p><strong>Pix2Struct æ–¹æ³•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">variable_resolution_encode</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">max_patches</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>

    <span class="c1"># è‡ªé€‚åº”å†³å®š patch æ•°é‡</span>
    <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">h</span>
    <span class="k">if</span> <span class="n">aspect_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">max_patches</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">))</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_patches</span> <span class="o">/</span> <span class="n">cols</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">max_patches</span> <span class="o">/</span> <span class="n">aspect_ratio</span><span class="p">))</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_patches</span> <span class="o">/</span> <span class="n">rows</span><span class="p">)</span>

    <span class="c1"># åŠ¨æ€ patch embedding</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="n">extract_patches</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">patches</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>  <span class="c1"># è¿”å›å¸ƒå±€ä¿¡æ¯</span>
</code></pre></div>

<p><strong>ä½ç½®ç¼–ç é€‚é…</strong>ï¼š</p>
<ol>
<li><strong>2D æ­£å¼¦ç¼–ç æ’å€¼</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">interpolate_pos_encoding</span><span class="p">(</span><span class="n">pos_embed</span><span class="p">,</span> <span class="n">new_size</span><span class="p">):</span>
    <span class="c1"># pos_embed: [1, N, D], N = 14Ã—14 = 196</span>
    <span class="n">old_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pos_embed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">pos_embed</span> <span class="o">=</span> <span class="n">pos_embed</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">old_size</span><span class="p">,</span> <span class="n">old_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pos_embed</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">pos_embed</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> 
                              <span class="n">size</span><span class="o">=</span><span class="n">new_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bicubic&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pos_embed</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<ol start="2">
<li><strong>RoPE 2D æ‰©å±•</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">rope_2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="c1"># ä¸º h å’Œ w ç»´åº¦åˆ†åˆ«è®¡ç®— RoPE</span>
    <span class="n">pos_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">pos_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># åº”ç”¨æ—‹è½¬ä½ç½®ç¼–ç </span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">apply_rope</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos_h</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">apply_rope</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos_w</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div>

<p><strong>å¤šå°ºåº¦è®­ç»ƒç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Curriculum</span><span class="w"> </span><span class="nv">Learning</span>ï¼š
<span class="nv">Week</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span>:<span class="w"> </span><span class="mi">224</span>Ã—<span class="mi">224</span><span class="w"> </span><span class="nv">only</span>
<span class="nv">Week</span><span class="w"> </span><span class="mi">3</span><span class="o">-</span><span class="mi">4</span>:<span class="w"> </span><span class="mi">224</span>Ã—<span class="mi">224</span><span class="w"> </span><span class="ss">(</span><span class="mi">70</span><span class="o">%</span><span class="ss">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">448</span>Ã—<span class="mi">448</span><span class="w"> </span><span class="ss">(</span><span class="mi">30</span><span class="o">%</span><span class="ss">)</span>
<span class="nv">Week</span><span class="w"> </span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span>:<span class="w"> </span><span class="mi">224</span>Ã—<span class="mi">224</span><span class="w"> </span><span class="ss">(</span><span class="mi">40</span><span class="o">%</span><span class="ss">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">448</span>Ã—<span class="mi">448</span><span class="w"> </span><span class="ss">(</span><span class="mi">40</span><span class="o">%</span><span class="ss">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">896</span>Ã—<span class="mi">896</span><span class="w"> </span><span class="ss">(</span><span class="mi">20</span><span class="o">%</span><span class="ss">)</span>
<span class="nv">Week</span><span class="w"> </span><span class="mi">7</span><span class="o">+</span>:<span class="w">  </span>åŠ¨æ€é‡‡æ ·ï¼Œæ ¹æ®<span class="w"> </span><span class="nv">loss</span><span class="w"> </span>è°ƒæ•´

æ•°æ®å¢å¼ºï¼š

<span class="o">-</span><span class="w"> </span><span class="k">Random</span><span class="w"> </span><span class="nv">Crop</span>:<span class="w"> </span>ä¿æŒç›®æ ‡å¯è§å‰æä¸‹
<span class="o">-</span><span class="w"> </span><span class="nv">Multi</span><span class="o">-</span><span class="nv">scale</span><span class="w"> </span><span class="nv">Training</span>:<span class="w"> </span><span class="mi">0</span>.<span class="mi">8</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>.<span class="mi">2</span><span class="nv">x</span><span class="w"> </span>ç¼©æ”¾
<span class="o">-</span><span class="w"> </span><span class="nv">Mixup</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">Feature</span><span class="w"> </span><span class="nv">Level</span>:<span class="w"> </span>ä¸åŒåˆ†è¾¨ç‡ç‰¹å¾æ··åˆ
</code></pre></div>

<p><strong>æ•ˆç‡ä¼˜åŒ–</strong>ï¼š</p>
<ul>
<li>Flash Attentionï¼šé•¿åºåˆ—å¿…å¤‡</li>
<li>Gradient Checkpointingï¼šç”¨æ—¶é—´æ¢æ˜¾å­˜</li>
<li>Mixed Resolution Batchï¼šç›¸è¿‘åˆ†è¾¨ç‡åˆ†ç»„</li>
</ul>
<h2 id="53">5.3 éŸ³é¢‘æ¨¡æ€é›†æˆ</h2>
<p>éŸ³é¢‘æ¨¡æ€å¸¦æ¥ç‹¬ç‰¹æŒ‘æˆ˜ï¼šæ—¶åºä¾èµ–æ€§å¼ºã€é‡‡æ ·ç‡é«˜ã€ä¿¡å·ç±»å‹å¤šæ ·ï¼ˆè¯­éŸ³ã€éŸ³ä¹ã€ç¯å¢ƒéŸ³ï¼‰ã€‚æœ‰æ•ˆçš„éŸ³é¢‘é›†æˆéœ€è¦å¹³è¡¡æ—¶é¢‘åŸŸç‰¹å¾æå–ä¸è®¡ç®—æ•ˆç‡ã€‚</p>
<h3 id="531">5.3.1 è¯­éŸ³è¯†åˆ«ä¸ç†è§£</h3>
<p>è¯­éŸ³æ˜¯æœ€é‡è¦çš„éŸ³é¢‘æ¨¡æ€ï¼Œå…¶ä¸æ–‡æœ¬çš„å¤©ç„¶å¯¹åº”å…³ç³»ä½¿å…¶æˆä¸ºå¤šæ¨¡æ€èåˆçš„ç†æƒ³èµ·ç‚¹ï¼š</p>
<p><strong>æŠ€æœ¯è·¯çº¿æ¼”è¿›</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>ä¼ ç»Ÿçº§è”ï¼šASR â†’ æ–‡æœ¬ â†’ LLM
â”œâ”€â”€ ä¼˜ç‚¹ï¼šæ¨¡å—åŒ–ï¼Œå„éƒ¨åˆ†å¯ç‹¬ç«‹ä¼˜åŒ–
â””â”€â”€ ç¼ºç‚¹ï¼šé”™è¯¯ä¼ æ’­ï¼Œä¸¢å¤±éŸµå¾‹ä¿¡æ¯

ç«¯åˆ°ç«¯é›†æˆï¼šAudio â†’ Encoder â†’ LLM
â”œâ”€â”€ ä¼˜ç‚¹ï¼šä¿ç•™å®Œæ•´éŸ³é¢‘ä¿¡æ¯
â””â”€â”€ ç¼ºç‚¹ï¼šéœ€è¦å¤§é‡é…å¯¹æ•°æ®
</code></pre></div>

<p><strong>Whisper é›†æˆæ–¹æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">WhisperLLMAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">whisper_model</span><span class="o">=</span><span class="s2">&quot;large-v3&quot;</span><span class="p">,</span> <span class="n">llm_model</span><span class="o">=</span><span class="s2">&quot;llama-7b&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whisper</span> <span class="o">=</span> <span class="n">load_whisper</span><span class="p">(</span><span class="n">whisper_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">load_llm</span><span class="p">(</span><span class="n">llm_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>  <span class="c1"># Whisper â†’ LLM dim</span>

    <span class="k">def</span> <span class="nf">encode_audio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio_waveform</span><span class="p">):</span>
        <span class="c1"># æå– Whisper encoder è¾“å‡º</span>
        <span class="n">mel</span> <span class="o">=</span> <span class="n">log_mel_spectrogram</span><span class="p">(</span><span class="n">audio_waveform</span><span class="p">)</span>
        <span class="n">audio_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">whisper</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">mel</span><span class="p">)</span>  <span class="c1"># [T, 1280]</span>

        <span class="c1"># æŠ•å½±åˆ° LLM ç©ºé—´</span>
        <span class="n">audio_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">(</span><span class="n">audio_features</span><span class="p">)</span>  <span class="c1"># [T, 4096]</span>

        <span class="c1"># é™é‡‡æ ·ï¼ˆWhisper 50Hz â†’ LLM ~10Hzï¼‰</span>
        <span class="n">audio_tokens</span> <span class="o">=</span> <span class="n">audio_tokens</span><span class="p">[::</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># ç®€å•é™é‡‡æ ·</span>
        <span class="k">return</span> <span class="n">audio_tokens</span>
</code></pre></div>

<p><strong>å¤šè¯­è¨€å¤„ç†ç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>è¯­è¨€æ„ŸçŸ¥ç¼–ç </strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">lang_embeddings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;en&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">768</span><span class="p">),</span>
    <span class="s2">&quot;zh&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">768</span><span class="p">),</span>
    <span class="s2">&quot;es&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">768</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">encode_with_lang</span><span class="p">(</span><span class="n">audio</span><span class="p">,</span> <span class="n">detected_lang</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>
    <span class="n">lang_emb</span> <span class="o">=</span> <span class="n">lang_embeddings</span><span class="p">[</span><span class="n">detected_lang</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">features</span> <span class="o">+</span> <span class="n">lang_emb</span>  <span class="c1"># è¯­è¨€åç½®</span>
</code></pre></div>

<ol start="2">
<li><strong>ä»£ç åˆ‡æ¢å¤„ç†</strong>ï¼ˆCode-switchingï¼‰ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">è¾“å…¥</span><span class="err">ï¼š</span><span class="s">&quot;ä»Šå¤©å¤©æ°” really niceï¼Œæˆ‘ä»¬å» shopping å§&quot;</span>

<span class="n">åˆ†æ®µç­–ç•¥</span><span class="err">ï¼š</span>
<span class="p">[</span><span class="n">ä»Šå¤©å¤©æ°”</span><span class="p">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">zh_encoder</span>
<span class="p">[</span><span class="n">really</span><span class="w"> </span><span class="n">nice</span><span class="p">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">en_encoder</span><span class="w">  </span>
<span class="p">[</span><span class="n">æˆ‘ä»¬å»</span><span class="p">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">zh_encoder</span>
<span class="p">[</span><span class="n">shopping</span><span class="p">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">en_encoder</span>
<span class="p">[</span><span class="n">å§</span><span class="p">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">zh_encoder</span>

<span class="n">èåˆ</span><span class="err">ï¼š</span><span class="n">Attention</span><span class="w"> </span><span class="n">æœºåˆ¶è‡ªåŠ¨å­¦ä¹ è¾¹ç•Œ</span>
</code></pre></div>

<p><strong>éŸµå¾‹ä¿¡æ¯ä¿ç•™</strong>ï¼š</p>
<ul>
<li>éŸ³é«˜ï¼ˆPitchï¼‰ï¼šæå– F0 è½¨è¿¹ï¼Œä½œä¸ºé¢å¤– channel</li>
<li>èƒ½é‡ï¼ˆEnergyï¼‰ï¼šRMS energy æ›²çº¿</li>
<li>è¯­é€Ÿï¼ˆDurationï¼‰ï¼šéŸ³ç´ æ—¶é•¿ä¿¡æ¯</li>
<li>æƒ…æ„Ÿï¼ˆEmotionï¼‰ï¼šé¢„è®­ç»ƒæƒ…æ„Ÿåˆ†ç±»å™¨ç‰¹å¾</li>
</ul>
<h3 id="532">5.3.2 éŸ³ä¹ä¸ç¯å¢ƒéŸ³ç†è§£</h3>
<p>éè¯­éŸ³éŸ³é¢‘ç†è§£éœ€è¦ä¸åŒçš„ç‰¹å¾æå–å’Œå»ºæ¨¡ç­–ç•¥ï¼š</p>
<p><strong>éŸ³ä¹ç†è§£å±‚æ¬¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>ä½çº§ç‰¹å¾ï¼š
â”œâ”€â”€ èŠ‚å¥ï¼ˆTempo, Beatï¼‰
â”œâ”€â”€ éŸ³é«˜ï¼ˆPitch, Keyï¼‰
â””â”€â”€ éŸ³è‰²ï¼ˆTimbreï¼‰

ä¸­çº§ç»“æ„ï¼š
â”œâ”€â”€ å’Œå¼¦è¿›è¡Œ
â”œâ”€â”€ æ—‹å¾‹çº¿æ¡
â””â”€â”€ èŠ‚å¥æ¨¡å¼

é«˜çº§è¯­ä¹‰ï¼š
â”œâ”€â”€ é£æ ¼æµæ´¾
â”œâ”€â”€ æƒ…æ„Ÿè¡¨è¾¾
â””â”€â”€ ç»“æ„åˆ†æï¼ˆVerse, Chorus, Bridgeï¼‰
</code></pre></div>

<p><strong>MusicLM å¼å»ºæ¨¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MusicEncoder</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w2v_music</span> <span class="o">=</span> <span class="n">load_pretrained</span><span class="p">(</span><span class="s2">&quot;wav2vec2-music&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mulan</span> <span class="o">=</span> <span class="n">load_pretrained</span><span class="p">(</span><span class="s2">&quot;mulan&quot;</span><span class="p">)</span>  <span class="c1"># éŸ³ä¹-æ–‡æœ¬å¯¹é½</span>

    <span class="k">def</span> <span class="nf">encode_hierarchical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio</span><span class="p">):</span>
        <span class="c1"># å£°å­¦ tokens (w2v-BERT)</span>
        <span class="n">acoustic_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2v_music</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>  <span class="c1"># 50Hz</span>

        <span class="c1"># è¯­ä¹‰ tokens (MuLaN)</span>
        <span class="n">semantic_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mulan</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>  <span class="c1"># 1Hz</span>

        <span class="c1"># å±‚æ¬¡åŒ–è¡¨ç¤º</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;fine&quot;</span><span class="p">:</span> <span class="n">acoustic_tokens</span><span class="p">,</span>    <span class="c1"># ç»†ç²’åº¦</span>
            <span class="s2">&quot;coarse&quot;</span><span class="p">:</span> <span class="n">semantic_tokens</span><span class="p">,</span>   <span class="c1"># ç²—ç²’åº¦</span>
        <span class="p">}</span>
</code></pre></div>

<p><strong>ç¯å¢ƒéŸ³äº‹ä»¶æ£€æµ‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AudioEventDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">527</span><span class="p">):</span>  <span class="c1"># AudioSet classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">ConvBlock</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">ConvBlock</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">ConvBlock</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">):</span>
        <span class="c1"># å¤šå°ºåº¦ç‰¹å¾æå–</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">)</span>

        <span class="c1"># å¸§çº§é¢„æµ‹</span>
        <span class="n">frame_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>  <span class="c1"># [T, 527]</span>

        <span class="c1"># èšåˆä¸ºç‰‡æ®µçº§</span>
        <span class="n">segment_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">segment_logits</span>
</code></pre></div>

<p><strong>éŸ³é¢‘å­—å¹•ç”Ÿæˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>è¾“å…¥ï¼š[ç‹—å«å£°] + [æ±½è½¦ç»è¿‡] + [é›¨å£°]
è¾“å‡ºï¼š&quot;é›¨å¤©è¡—é“ä¸Šï¼Œä¸€åªç‹—å¯¹ç€ç»è¿‡çš„æ±½è½¦å å«&quot;

å…³é”®ï¼šæ—¶åºå…³ç³»å»ºæ¨¡ + äº‹ä»¶å…±ç°å­¦ä¹ 
</code></pre></div>

<h3 id="533">5.3.3 éŸ³é¢‘ç¼–ç å™¨é€‰æ‹©</h3>
<p>ä¸åŒéŸ³é¢‘ç¼–ç å™¨çš„ç‰¹ç‚¹ä¸é€‚ç”¨åœºæ™¯ï¼š</p>
<p><strong>ä¸»æµç¼–ç å™¨å¯¹æ¯”</strong>ï¼š</p>
<p>| ç¼–ç å™¨ | é¢„è®­ç»ƒæ•°æ® | ç‰¹ç‚¹ | æœ€ä½³åœºæ™¯ |</p>
<table>
<thead>
<tr>
<th>ç¼–ç å™¨</th>
<th>é¢„è®­ç»ƒæ•°æ®</th>
<th>ç‰¹ç‚¹</th>
<th>æœ€ä½³åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>Wav2Vec2</td>
<td>960h LibriSpeech</td>
<td>è‡ªç›‘ç£ï¼ŒCPC loss</td>
<td>è‹±æ–‡è¯­éŸ³</td>
</tr>
<tr>
<td>HuBERT</td>
<td>60k h Libri-Light</td>
<td>Masked prediction</td>
<td>å¤šè¯­è¨€è¯­éŸ³</td>
</tr>
<tr>
<td>WavLM</td>
<td>94k h æ··åˆ</td>
<td>å»å™ª + æ©ç </td>
<td>å™ªå£°é²æ£’</td>
</tr>
<tr>
<td>Whisper</td>
<td>680k h æ ‡æ³¨</td>
<td>æœ‰ç›‘ç£ï¼Œå¤šä»»åŠ¡</td>
<td>é€šç”¨è¯­éŸ³</td>
</tr>
<tr>
<td>BEATs</td>
<td>AudioSet + ç§æœ‰</td>
<td>éŸ³é¢‘ MAE</td>
<td>é€šç”¨éŸ³é¢‘</td>
</tr>
<tr>
<td>CLAP</td>
<td>LAION-Audio-630K</td>
<td>å¯¹æ¯”å­¦ä¹ </td>
<td>éŸ³é¢‘-æ–‡æœ¬å¯¹é½</td>
</tr>
</tbody>
</table>
<p><strong>é€‰æ‹©å†³ç­–æ ‘</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>éœ€è¦è¯­éŸ³è¯†åˆ«ï¼Ÿ
â”œâ”€æ˜¯â†’ éœ€è¦å¤šè¯­è¨€ï¼Ÿ
â”‚     â”œâ”€æ˜¯â†’ Whisper
â”‚     â””â”€å¦â†’ Wav2Vec2
â””â”€å¦â†’ éœ€è¦æ–‡æœ¬æè¿°ï¼Ÿ
      â”œâ”€æ˜¯â†’ CLAP
      â””â”€å¦â†’ BEATs
</code></pre></div>

<p><strong>ç‰¹å¾æå–å±‚çº§</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">extract_hierarchical_features</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">audio</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Whisper ç¤ºä¾‹</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">WhisperModel</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;conv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>  <span class="c1"># æ—©æœŸå£°å­¦ç‰¹å¾</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">encoder</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">blocks</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">24</span><span class="p">]:</span>  <span class="c1"># é€‰æ‹©æ€§ä¿å­˜</span>
                <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;layer_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">return</span> <span class="n">features</span>  <span class="c1"># å¤šå±‚çº§ç‰¹å¾</span>
</code></pre></div>

<h3 id="534">5.3.4 æ—¶é¢‘åŸŸç‰¹å¾èåˆ</h3>
<p>æœ‰æ•ˆèåˆæ—¶åŸŸå’Œé¢‘åŸŸä¿¡æ¯æ˜¯éŸ³é¢‘ç†è§£çš„å…³é”®ï¼š</p>
<p><strong>ç‰¹å¾æå–ç®¡çº¿</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AudioFeatureExtractor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">16000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mel_bins</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_length</span> <span class="o">=</span> <span class="mi">160</span>  <span class="c1"># 10ms</span>

    <span class="k">def</span> <span class="nf">extract_all_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waveform</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># æ—¶åŸŸç‰¹å¾</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;zcr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_crossing_rate</span><span class="p">(</span><span class="n">waveform</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">short_time_energy</span><span class="p">(</span><span class="n">waveform</span><span class="p">)</span>

        <span class="c1"># é¢‘åŸŸç‰¹å¾  </span>
        <span class="n">stft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">n_fft</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">hop_length</span><span class="o">=</span><span class="mi">160</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;spectral_centroid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectral_centroid</span><span class="p">(</span><span class="n">stft</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;spectral_rolloff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectral_rolloff</span><span class="p">(</span><span class="n">stft</span><span class="p">)</span>

        <span class="c1"># æ—¶é¢‘ç‰¹å¾</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;mel_spec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mel_spectrogram</span><span class="p">(</span><span class="n">waveform</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;mfcc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfcc</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">n_mfcc</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">features</span>
</code></pre></div>

<p><strong>å¤šå°ºåº¦æ—¶é—´å»ºæ¨¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>çŸ­æ—¶çª—å£ï¼ˆ10-30msï¼‰ï¼š
â””â”€â”€ æ•è·éŸ³ç´ ã€éŸ³é«˜å˜åŒ–

ä¸­æ—¶çª—å£ï¼ˆ100-500msï¼‰ï¼š  
â””â”€â”€ æ•è·éŸ³èŠ‚ã€èŠ‚æ‹

é•¿æ—¶çª—å£ï¼ˆ1-5sï¼‰ï¼š
â””â”€â”€ æ•è·å¥å­ã€ä¹å¥

è¶…é•¿çª—å£ï¼ˆ&gt;10sï¼‰ï¼š
â””â”€â”€ æ•è·æ®µè½ã€éŸ³ä¹ç»“æ„
</code></pre></div>

<p><strong>æ³¨æ„åŠ›èåˆæœºåˆ¶</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TimeFreqAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># x: [Batch, Time, Freq, Dim]</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># æ—¶é—´ç»´åº¦æ³¨æ„åŠ›</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># [B, T, D]</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_attn</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">x_t</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># é¢‘ç‡ç»´åº¦æ³¨æ„åŠ›  </span>
        <span class="n">x_f</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, F, D]</span>
        <span class="n">x_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_attn</span><span class="p">(</span><span class="n">x_f</span><span class="p">,</span> <span class="n">x_f</span><span class="p">,</span> <span class="n">x_f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># å¹¿æ’­å¹¶èåˆ</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">x_t</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x_f</span> <span class="o">=</span> <span class="n">x_f</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">x_fused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x_t</span><span class="p">,</span> <span class="n">x_f</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x_fused</span>
</code></pre></div>

<p><strong>å®éªŒä¼˜åŒ–æŠ€å·§</strong>ï¼š</p>
<ul>
<li>SpecAugmentï¼šæ—¶é¢‘åŸŸæ•°æ®å¢å¼º</li>
<li>æ··åˆç²¾åº¦ï¼šèŠ‚çœæ˜¾å­˜ï¼ŒåŠ é€Ÿè®­ç»ƒ</li>
<li>æ¸è¿›å¼åˆ†è¾¨ç‡ï¼šä»ä½åˆ†è¾¨ç‡å¼€å§‹è®­ç»ƒ</li>
</ul>
<h2 id="54">5.4 è§†é¢‘ç†è§£çš„æ—¶åºå»ºæ¨¡</h2>
<p>è§†é¢‘ä½œä¸ºæœ€å¤æ‚çš„å¤šæ¨¡æ€æ•°æ®ï¼Œä¸ä»…åŒ…å«è§†è§‰å’ŒéŸ³é¢‘ä¿¡æ¯ï¼Œè¿˜å…·æœ‰å¼ºçƒˆçš„æ—¶åºä¾èµ–æ€§ã€‚æœ‰æ•ˆçš„æ—¶åºå»ºæ¨¡æ˜¯è§†é¢‘ç†è§£çš„æ ¸å¿ƒï¼Œå†³å®šäº†æ¨¡å‹èƒ½å¦æ•è·åŠ¨ä½œã€äº‹ä»¶å’Œå™äº‹ç»“æ„ã€‚</p>
<h3 id="541">5.4.1 å¸§é‡‡æ ·ç­–ç•¥</h3>
<p>è§†é¢‘çš„é«˜ç»´ç‰¹æ€§ï¼ˆå…¸å‹ 30fpsï¼‰ä½¿å¾—å¤„ç†æ‰€æœ‰å¸§åœ¨è®¡ç®—ä¸Šä¸å¯è¡Œã€‚æ™ºèƒ½çš„å¸§é‡‡æ ·ç­–ç•¥éœ€è¦åœ¨ä¿¡æ¯ä¿ç•™å’Œè®¡ç®—æ•ˆç‡é—´å–å¾—å¹³è¡¡ã€‚</p>
<p><strong>é‡‡æ ·æ–¹æ³•å¯¹æ¯”</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>å‡åŒ€é‡‡æ ·ï¼ˆUniform Samplingï¼‰ï¼š
â”œâ”€â”€ å®ç°ï¼šæ¯éš” k å¸§é‡‡æ ·ä¸€æ¬¡
â”œâ”€â”€ ä¼˜ç‚¹ï¼šç®€å•ï¼Œä¿æŒæ—¶åºå‡åŒ€æ€§
â”œâ”€â”€ ç¼ºç‚¹ï¼šå¯èƒ½é”™è¿‡å…³é”®å¸§
â””â”€â”€ é€‚ç”¨ï¼šåŠ¨ä½œå‡åŒ€åˆ†å¸ƒçš„è§†é¢‘

å¯†é›†é‡‡æ ·ï¼ˆDense Samplingï¼‰ï¼š
â”œâ”€â”€ å®ç°ï¼šåœ¨çŸ­æ—¶é—´çª—å£å†…å¯†é›†é‡‡æ ·
â”œâ”€â”€ ä¼˜ç‚¹ï¼šæ•è·ç»†ç²’åº¦åŠ¨ä½œ
â”œâ”€â”€ ç¼ºç‚¹ï¼šé•¿ç¨‹ä¾èµ–å»ºæ¨¡å›°éš¾
â””â”€â”€ é€‚ç”¨ï¼šåŠ¨ä½œè¯†åˆ«ä»»åŠ¡

ç¨€ç–é‡‡æ ·ï¼ˆSparse Samplingï¼‰ï¼š
â”œâ”€â”€ å®ç°ï¼šå¤§é—´éš”é‡‡æ ·ï¼Œè¦†ç›–æ•´ä¸ªè§†é¢‘
â”œâ”€â”€ ä¼˜ç‚¹ï¼šæ•è·å…¨å±€ç»“æ„
â”œâ”€â”€ ç¼ºç‚¹ï¼šä¸¢å¤±å±€éƒ¨ç»†èŠ‚
â””â”€â”€ é€‚ç”¨ï¼šè§†é¢‘åˆ†ç±»ã€æ‘˜è¦

è‡ªé€‚åº”é‡‡æ ·ï¼ˆAdaptive Samplingï¼‰ï¼š
â”œâ”€â”€ å®ç°ï¼šåŸºäºå†…å®¹å˜åŒ–åŠ¨æ€è°ƒæ•´
â”œâ”€â”€ ä¼˜ç‚¹ï¼šä¿¡æ¯ä¿ç•™æœ€ä¼˜
â”œâ”€â”€ ç¼ºç‚¹ï¼šè®¡ç®—å¼€é”€å¤§
â””â”€â”€ é€‚ç”¨ï¼šäº‹ä»¶æ£€æµ‹ã€é«˜å…‰æå–
</code></pre></div>

<p><strong>TSNï¼ˆTemporal Segment Networksï¼‰é‡‡æ ·</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">tsn_sampling</span><span class="p">(</span><span class="n">video_frames</span><span class="p">,</span> <span class="n">num_segments</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TSN çš„åˆ†æ®µé‡‡æ ·ç­–ç•¥&quot;&quot;&quot;</span>
    <span class="n">total_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">video_frames</span><span class="p">)</span>
    <span class="n">segment_len</span> <span class="o">=</span> <span class="n">total_frames</span> <span class="o">//</span> <span class="n">num_segments</span>

    <span class="n">sampled_frames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_segments</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">segment_len</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">segment_len</span><span class="p">,</span> <span class="n">total_frames</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
            <span class="c1"># æ¯æ®µä¸­é—´å¸§</span>
            <span class="n">frame_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">end</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="c1"># æ¯æ®µéšæœºé‡‡æ ·</span>
            <span class="n">frame_idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;dense&#39;</span><span class="p">:</span>
            <span class="c1"># æ¯æ®µé‡‡æ ·å¤šå¸§</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">sampled_frames</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">video_frames</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="n">sampled_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">video_frames</span><span class="p">[</span><span class="n">frame_idx</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">sampled_frames</span>
</code></pre></div>

<p><strong>æ—¶åºjitteringå¢å¼º</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TemporalJitter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_jitter</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_jitter</span> <span class="o">=</span> <span class="n">max_jitter</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_indices</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®­ç»ƒæ—¶æ·»åŠ æ—¶åºæ‰°åŠ¨ï¼Œæå‡æ³›åŒ–&quot;&quot;&quot;</span>
        <span class="n">jittered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">frame_indices</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_jitter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_jitter</span><span class="p">)</span>
            <span class="n">new_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">frame_indices</span><span class="p">))</span>
            <span class="n">jittered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jittered</span>
</code></pre></div>

<p><strong>å…³é”®å¸§æ£€æµ‹é‡‡æ ·</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">keyframe_sampling</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åŸºäºå†…å®¹å˜åŒ–çš„å…³é”®å¸§é‡‡æ ·&quot;&quot;&quot;</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">video</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">video</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="c1"># è®¡ç®—å¸§é—´å·®å¼‚</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">compute_frame_difference</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">frame</span>

    <span class="k">return</span> <span class="n">frames</span>

<span class="k">def</span> <span class="nf">compute_frame_difference</span><span class="p">(</span><span class="n">frame1</span><span class="p">,</span> <span class="n">frame2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä½¿ç”¨ç›´æ–¹å›¾å·®å¼‚ + å…‰æµå¹…åº¦&quot;&quot;&quot;</span>
    <span class="c1"># é¢œè‰²ç›´æ–¹å›¾å·®å¼‚</span>
    <span class="n">hist1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcHist</span><span class="p">([</span><span class="n">frame1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">])</span>
    <span class="n">hist2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcHist</span><span class="p">([</span><span class="n">frame2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">256</span><span class="p">])</span>
    <span class="n">hist_diff</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">compareHist</span><span class="p">(</span><span class="n">hist1</span><span class="p">,</span> <span class="n">hist2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">HISTCMP_CHISQR</span><span class="p">)</span>

    <span class="c1"># å…‰æµå¹…åº¦ï¼ˆå¯é€‰ï¼‰</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcOpticalFlowFarneback</span><span class="p">(</span><span class="n">gray1</span><span class="p">,</span> <span class="n">gray2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">flow</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">hist_diff</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">magnitude</span>
</code></pre></div>

<p><strong>å®éªŒå»ºè®®</strong>ï¼š</p>
<ul>
<li>çŸ­è§†é¢‘ï¼ˆ&lt;10sï¼‰ï¼š8-16 å¸§è¶³å¤Ÿ</li>
<li>é•¿è§†é¢‘ï¼ˆ&gt;60sï¼‰ï¼š32-64 å¸§ï¼Œåˆ†å±‚é‡‡æ ·</li>
<li>åŠ¨ä½œè¯†åˆ«ï¼šå¯†é›†é‡‡æ · + TSMï¼ˆTemporal Shift Moduleï¼‰</li>
<li>è§†é¢‘é—®ç­”ï¼šç¨€ç–é‡‡æ · + å…³é”®å¸§æ£€æµ‹</li>
</ul>
<h3 id="542">5.4.2 æ—¶åºæ³¨æ„åŠ›æœºåˆ¶</h3>
<p>æ—¶åºæ³¨æ„åŠ›æ˜¯è§†é¢‘ç†è§£çš„æ ¸å¿ƒï¼Œéœ€è¦æœ‰æ•ˆå»ºæ¨¡å¸§é—´å…³ç³»whileæ§åˆ¶è®¡ç®—å¤æ‚åº¦ã€‚</p>
<p><strong>æ—¶ç©ºæ³¨æ„åŠ›åˆ†è§£</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SpaceTimeAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ—¶ç©ºæ³¨æ„åŠ›åˆ†è§£ï¼Œé™ä½å¤æ‚åº¦ O(TÂ²SÂ²) â†’ O(TÂ²+SÂ²)&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># x: [B, T, S, D] - Batch, Time, Space, Dim</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># ç©ºé—´æ³¨æ„åŠ›ï¼ˆç‹¬ç«‹å¤„ç†æ¯å¸§ï¼‰</span>
        <span class="n">x_spatial</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="n">x_spatial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_attn</span><span class="p">(</span><span class="n">x_spatial</span><span class="p">,</span> <span class="n">x_spatial</span><span class="p">,</span> <span class="n">x_spatial</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_spatial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x_spatial</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">D</span><span class="p">))</span>
        <span class="n">x_spatial</span> <span class="o">=</span> <span class="n">x_spatial</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

        <span class="c1"># æ—¶é—´æ³¨æ„åŠ›ï¼ˆè·¨å¸§å»ºæ¨¡ï¼‰</span>
        <span class="n">x_temporal</span> <span class="o">=</span> <span class="n">x_spatial</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">S</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="n">x_temporal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_attn</span><span class="p">(</span><span class="n">x_temporal</span><span class="p">,</span> <span class="n">x_temporal</span><span class="p">,</span> <span class="n">x_temporal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_temporal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">x_temporal</span> <span class="o">+</span> <span class="n">x_temporal</span><span class="p">)</span>
        <span class="n">x_temporal</span> <span class="o">=</span> <span class="n">x_temporal</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x_temporal</span>
</code></pre></div>

<p><strong>TimeSformeræ¶æ„å˜ä½“</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>Divided Attentionï¼ˆåˆ†ç¦»æ³¨æ„åŠ›ï¼‰ï¼š
Space Attn â†’ Time Attn
å¤æ‚åº¦ï¼šO(TSÂ²) + O(TÂ²S)

Joint Attentionï¼ˆè”åˆæ³¨æ„åŠ›ï¼‰ï¼š
SpaceTime Attn together
å¤æ‚åº¦ï¼šO((TS)Â²) - è®¡ç®—å¯†é›†

Axial Attentionï¼ˆè½´å‘æ³¨æ„åŠ›ï¼‰ï¼š
Height â†’ Width â†’ Time
å¤æ‚åº¦ï¼šO(THÂ²W) + O(THWÂ²) + O(TÂ²HW)
</code></pre></div>

<p><strong>å±€éƒ¨æ—¶åºæ³¨æ„åŠ›</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LocalTemporalAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å±€éƒ¨çª—å£æ—¶åºæ³¨æ„åŠ›ï¼Œé™ä½é•¿è§†é¢‘å¤æ‚åº¦&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># x: [B, T, D]</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># æ»‘åŠ¨çª—å£æ³¨æ„åŠ›</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">window</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>  <span class="c1"># [B, W, D]</span>
            <span class="n">center_idx</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">start</span>

            <span class="c1"># è®¡ç®—çª—å£å†…æ³¨æ„åŠ›</span>
            <span class="n">attn_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span>
                <span class="n">window</span><span class="p">[:,</span> <span class="n">center_idx</span><span class="p">:</span><span class="n">center_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># Query</span>
                <span class="n">window</span><span class="p">,</span>  <span class="c1"># Key</span>
                <span class="n">window</span>   <span class="c1"># Value</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">output</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">attn_out</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<p><strong>æ—¶åºä½ç½®ç¼–ç ç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">temporal_position_encoding</span><span class="p">(</span><span class="n">num_frames</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">max_period</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä¸ºè§†é¢‘å¸§ç”Ÿæˆæ—¶åºä½ç½®ç¼–ç &quot;&quot;&quot;</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_frames</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">div_term</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">max_period</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim</span><span class="p">))</span>

    <span class="n">pe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_frames</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
    <span class="n">pe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
    <span class="n">pe</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>

    <span class="c1"># æ·»åŠ å¸§ç‡è‡ªé€‚åº”</span>
    <span class="k">if</span> <span class="n">frame_rate</span> <span class="o">!=</span> <span class="mi">30</span><span class="p">:</span>  <span class="c1"># å‡è®¾30fpsä¸ºåŸºå‡†</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mf">30.0</span> <span class="o">/</span> <span class="n">frame_rate</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">*</span> <span class="n">scale</span>

    <span class="k">return</span> <span class="n">pe</span>
</code></pre></div>

<h3 id="543">5.4.3 é•¿è§†é¢‘å¤„ç†ä¼˜åŒ–</h3>
<p>é•¿è§†é¢‘ï¼ˆ&gt;5åˆ†é’Ÿï¼‰å¸¦æ¥ä¸¥é‡çš„å†…å­˜å’Œè®¡ç®—æŒ‘æˆ˜ï¼Œéœ€è¦ç‰¹æ®Šçš„ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<p><strong>å±‚æ¬¡åŒ–å¤„ç†æ¶æ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HierarchicalVideoModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å±‚æ¬¡åŒ–é•¿è§†é¢‘å¤„ç†&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clip_len</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_len</span> <span class="o">=</span> <span class="n">clip_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>

        <span class="c1"># å±€éƒ¨ç¼–ç å™¨ï¼ˆå¤„ç†çŸ­ç‰‡æ®µï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_encoder</span> <span class="o">=</span> <span class="n">VideoEncoder</span><span class="p">(</span><span class="n">num_frames</span><span class="o">=</span><span class="n">clip_len</span><span class="p">)</span>

        <span class="c1"># å…¨å±€èšåˆå™¨ï¼ˆèåˆç‰‡æ®µç‰¹å¾ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_aggregator</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="mi">4</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video</span><span class="p">):</span>
        <span class="c1"># video: [B, T_total, H, W, C]</span>
        <span class="n">clips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_clips</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>  <span class="c1"># [B, N_clips, clip_len, H, W, C]</span>

        <span class="c1"># ç¼–ç æ¯ä¸ªç‰‡æ®µ</span>
        <span class="n">clip_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clips</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_encoder</span><span class="p">(</span><span class="n">clips</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>  <span class="c1"># [B, D]</span>
            <span class="n">clip_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>

        <span class="n">clip_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">clip_features</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, N_clips, D]</span>

        <span class="c1"># å…¨å±€èšåˆ</span>
        <span class="n">global_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_aggregator</span><span class="p">(</span><span class="n">clip_features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">global_features</span>
</code></pre></div>

<p><strong>å†…å­˜ä¼˜åŒ–æŠ€æœ¯</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MemoryEfficientVideoProcessor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">chunk_size</span>

    <span class="k">def</span> <span class="nf">process_video_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_path</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æµå¼å¤„ç†ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨å¸§&quot;&quot;&quot;</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">chunk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">chunk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">:</span>
                <span class="c1"># å¤„ç†å½“å‰chunk</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="n">chunk_tensor</span> <span class="o">=</span> <span class="n">preprocess_frames</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">chunk_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">chunk_tensor</span><span class="p">)</span>
                    <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_features</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

                <span class="c1"># æ¸…ç©ºchunkï¼Œä¿ç•™éƒ¨åˆ†é‡å </span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>  <span class="c1"># ä¿ç•™8å¸§é‡å </span>

        <span class="c1"># å¤„ç†å‰©ä½™å¸§</span>
        <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">chunk_tensor</span> <span class="o">=</span> <span class="n">preprocess_frames</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">chunk_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">chunk_tensor</span><span class="p">)</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_features</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<p><strong>Tokenå‹ç¼©ç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TokenMerging</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tokenåˆå¹¶ï¼Œå‡å°‘åºåˆ—é•¿åº¦&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># tokens: [B, N, D]</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">num_keep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">scores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># åŸºäºç›¸ä¼¼åº¦çš„åˆå¹¶</span>
            <span class="n">similarity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">similarity</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># å¹³å‡ç›¸ä¼¼åº¦</span>

        <span class="c1"># ä¿ç•™é‡è¦tokens</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">num_keep</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">kept_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">indices</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">D</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">kept_tokens</span>
</code></pre></div>

<h3 id="544">5.4.4 åŠ¨ä½œè¯†åˆ«ä¸äº‹ä»¶å®šä½</h3>
<p>åŠ¨ä½œè¯†åˆ«å’Œæ—¶åºå®šä½æ˜¯è§†é¢‘ç†è§£çš„æ ¸å¿ƒä»»åŠ¡ï¼Œéœ€è¦ç²¾ç¡®æ•è·åŠ¨ä½œè¾¹ç•Œå’Œè¯­ä¹‰ã€‚</p>
<p><strong>åŒæµç½‘ç»œï¼ˆTwo-Streamï¼‰æ¶æ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TwoStreamNetwork</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RGBæµ + å…‰æµæµçš„ç»å…¸æ¶æ„&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">400</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># RGBæµï¼šå¤–è§‚ä¿¡æ¯</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb_stream</span> <span class="o">=</span> <span class="n">ResNet3D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># å…‰æµæµï¼šè¿åŠ¨ä¿¡æ¯</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow_stream</span> <span class="o">=</span> <span class="n">ResNet3D</span><span class="p">(</span><span class="n">input_channels</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (u, v)</span>

        <span class="c1"># èåˆå±‚</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rgb_frames</span><span class="p">,</span> <span class="n">flow_frames</span><span class="p">):</span>
        <span class="n">rgb_feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb_stream</span><span class="p">(</span><span class="n">rgb_frames</span><span class="p">)</span>
        <span class="n">flow_feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow_stream</span><span class="p">(</span><span class="n">flow_frames</span><span class="p">)</span>

        <span class="c1"># æ™šæœŸèåˆ</span>
        <span class="n">fused</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">rgb_feat</span><span class="p">,</span> <span class="n">flow_feat</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span><span class="p">(</span><span class="n">fused</span><span class="p">)</span>
</code></pre></div>

<p><strong>æ—¶åºåŠ¨ä½œå®šä½ï¼ˆTALï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TemporalActionLocalization</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ—¶åºåŠ¨ä½œå®šä½ï¼Œè¾“å‡ºåŠ¨ä½œç±»åˆ«å’Œæ—¶é—´è¾¹ç•Œ&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span> <span class="o">=</span> <span class="n">I3D</span><span class="p">()</span>  <span class="c1"># 3D CNN backbone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># èµ·æ­¢æ—¶é—´å›å½’</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video</span><span class="p">):</span>
        <span class="c1"># æå–æ—¶åºç‰¹å¾</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>  <span class="c1"># [B, C, T]</span>

        <span class="c1"># é€å¸§åˆ†ç±»</span>
        <span class="n">class_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>  <span class="c1"># [B, num_classes, T]</span>

        <span class="c1"># è¾¹ç•Œå›å½’</span>
        <span class="n">boundaries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>  <span class="c1"># [B, 2, T]</span>
        <span class="n">start_offsets</span> <span class="o">=</span> <span class="n">boundaries</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">end_offsets</span> <span class="o">=</span> <span class="n">boundaries</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;class_scores&#39;</span><span class="p">:</span> <span class="n">class_scores</span><span class="p">,</span>
            <span class="s1">&#39;start_offsets&#39;</span><span class="p">:</span> <span class="n">start_offsets</span><span class="p">,</span>
            <span class="s1">&#39;end_offsets&#39;</span><span class="p">:</span> <span class="n">end_offsets</span>
        <span class="p">}</span>
</code></pre></div>

<p><strong>åŠ¨ä½œè´¨é‡è¯„ä¼°ï¼ˆAQAï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ActionQualityAssessment</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è¯„ä¼°åŠ¨ä½œæ‰§è¡Œè´¨é‡ï¼Œå¦‚ä½“æ“ã€è·³æ°´è¯„åˆ†&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">VideoEncoder</span><span class="p">()</span>

        <span class="c1"># å¤šä»»åŠ¡å¤´</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">768</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># åˆ†æ•°å›å½’</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">768</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>  <span class="c1"># æ’åºå­¦ä¹ </span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>

        <span class="c1"># ç›´æ¥åˆ†æ•°é¢„æµ‹</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_head</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="c1"># ç›¸å¯¹æ’åºå­¦ä¹ </span>
        <span class="k">if</span> <span class="n">pairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feat_a</span><span class="p">,</span> <span class="n">feat_b</span> <span class="o">=</span> <span class="n">pairs</span>
            <span class="n">rank_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_head</span><span class="p">(</span><span class="n">feat_a</span><span class="p">)</span>
            <span class="n">rank_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_head</span><span class="p">(</span><span class="n">feat_b</span><span class="p">)</span>
            <span class="n">margin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rank_a</span> <span class="o">-</span> <span class="n">rank_b</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">scores</span><span class="p">,</span> <span class="n">margin</span>

        <span class="k">return</span> <span class="n">scores</span>
</code></pre></div>

<p><strong>å®éªŒä¼˜åŒ–è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>é¢„è®­ç»ƒåˆå§‹åŒ–ï¼šKinetics-400/600 é¢„è®­ç»ƒæƒé‡</li>
<li>å¤šå°ºåº¦æµ‹è¯•ï¼š1x, 1.25x, 1.5x å°ºåº¦èåˆ</li>
<li>æ—¶åºå¢å¼ºï¼šé€Ÿåº¦æ‰°åŠ¨ [0.5x, 2x]</li>
<li>ç±»åˆ«å¹³è¡¡ï¼šFocal Loss å¤„ç†é•¿å°¾åˆ†å¸ƒ</li>
</ul>
<h2 id="55">5.5 è·¨æ¨¡æ€æ³¨æ„åŠ›æœºåˆ¶è®¾è®¡</h2>
<p>è·¨æ¨¡æ€æ³¨æ„åŠ›æ˜¯å¤šæ¨¡æ€æ¨¡å‹çš„æ ¸å¿ƒç»„ä»¶ï¼Œå†³å®šäº†ä¸åŒæ¨¡æ€ä¿¡æ¯å¦‚ä½•æœ‰æ•ˆäº¤äº’å’Œèåˆã€‚è®¾è®¡é«˜æ•ˆçš„è·¨æ¨¡æ€æ³¨æ„åŠ›æœºåˆ¶éœ€è¦å¹³è¡¡è¡¨è¾¾èƒ½åŠ›ã€è®¡ç®—æ•ˆç‡å’Œè®­ç»ƒç¨³å®šæ€§ã€‚</p>
<h3 id="551-vs">5.5.1 æ—©æœŸèåˆ vs æ™šæœŸèåˆ</h3>
<p>èåˆæ—¶æœºçš„é€‰æ‹©æ·±åˆ»å½±å“æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›å’Œè®¡ç®—æ•ˆç‡ï¼š</p>
<p><strong>èåˆç­–ç•¥å¯¹æ¯”</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">æ—©æœŸèåˆ</span><span class="err">ï¼ˆ</span><span class="n">Early</span><span class="w"> </span><span class="k">Fusion</span><span class="err">ï¼‰ï¼š</span>
<span class="n">è¾“å…¥å±‚</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="o">[</span><span class="n">Concat/Add</span><span class="o">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">ç»Ÿä¸€å¤„ç†</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">ä¼˜ç‚¹</span><span class="err">ï¼š</span><span class="n">å……åˆ†äº¤äº’</span><span class="err">ï¼Œ</span><span class="n">å‚æ•°å…±äº«</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">ç¼ºç‚¹</span><span class="err">ï¼š</span><span class="n">æ¨¡æ€å·®å¼‚å¤§</span><span class="err">ï¼Œ</span><span class="n">ä¼˜åŒ–å›°éš¾</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">é€‚ç”¨</span><span class="err">ï¼š</span><span class="n">æ¨¡æ€ç›¸ä¼¼åº¦é«˜çš„ä»»åŠ¡</span>

<span class="n">æ™šæœŸèåˆ</span><span class="err">ï¼ˆ</span><span class="n">Late</span><span class="w"> </span><span class="k">Fusion</span><span class="err">ï¼‰ï¼š</span>
<span class="n">ç‹¬ç«‹ç¼–ç </span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">é«˜å±‚ç‰¹å¾</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="o">[</span><span class="n">Fusion</span><span class="o">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">è¾“å‡º</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">ä¼˜ç‚¹</span><span class="err">ï¼š</span><span class="n">æ¨¡å—åŒ–</span><span class="err">ï¼Œ</span><span class="n">æ˜“äºä¼˜åŒ–</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">ç¼ºç‚¹</span><span class="err">ï¼š</span><span class="n">äº¤äº’ä¸å……åˆ†</span><span class="err">ï¼Œ</span><span class="n">å‚æ•°å†—ä½™</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">é€‚ç”¨</span><span class="err">ï¼š</span><span class="n">æ¨¡æ€ç‹¬ç«‹æ€§å¼ºçš„ä»»åŠ¡</span>

<span class="n">æ¸è¿›èåˆ</span><span class="err">ï¼ˆ</span><span class="n">Progressive</span><span class="w"> </span><span class="k">Fusion</span><span class="err">ï¼‰ï¼š</span>
<span class="n">å¤šå±‚çº§èåˆ</span><span class="err">ï¼Œ</span><span class="n">é€æ­¥åŠ æ·±äº¤äº’</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">ä¼˜ç‚¹</span><span class="err">ï¼š</span><span class="n">å¹³è¡¡æ—©æœŸå’Œæ™šæœŸä¼˜åŠ¿</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">ç¼ºç‚¹</span><span class="err">ï¼š</span><span class="n">æ¶æ„å¤æ‚</span><span class="err">ï¼Œ</span><span class="n">è°ƒå‚å›°éš¾</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">é€‚ç”¨</span><span class="err">ï¼š</span><span class="n">å¤æ‚å¤šæ¨¡æ€ç†è§£ä»»åŠ¡</span>
</code></pre></div>

<p><strong>æ—©æœŸèåˆå®ç°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">EarlyFusion</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ—©æœŸèåˆï¼šç›´æ¥æ‹¼æ¥è¾“å…¥&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vision_dim</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">text_dim</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># æŠ•å½±åˆ°ç›¸åŒç»´åº¦</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vision_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">vision_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">text_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>

        <span class="c1"># èåˆåçš„å¤„ç†</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span><span class="n">hidden_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="mi">6</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vision_features</span><span class="p">,</span> <span class="n">text_features</span><span class="p">):</span>
        <span class="c1"># æŠ•å½±</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vision_proj</span><span class="p">(</span><span class="n">vision_features</span><span class="p">)</span>  <span class="c1"># [B, Nv, D]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_proj</span><span class="p">(</span><span class="n">text_features</span><span class="p">)</span>      <span class="c1"># [B, Nt, D]</span>

        <span class="c1"># æ‹¼æ¥</span>
        <span class="n">fused</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, Nv+Nt, D]</span>

        <span class="c1"># ç»Ÿä¸€å¤„ç†</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_layers</span><span class="p">(</span><span class="n">fused</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<p><strong>æ™šæœŸèåˆå®ç°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LateFusion</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ™šæœŸèåˆï¼šç‹¬ç«‹å¤„ç†åèåˆ&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># ç‹¬ç«‹ç¼–ç å™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vision_encoder</span> <span class="o">=</span> <span class="n">VisionTransformer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span> <span class="o">=</span> <span class="n">TextTransformer</span><span class="p">()</span>

        <span class="c1"># èåˆç­–ç•¥</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">768</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">texts</span><span class="p">):</span>
        <span class="c1"># ç‹¬ç«‹ç¼–ç </span>
        <span class="n">v_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vision_encoder</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, D]</span>
        <span class="n">t_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># [B, D]</span>

        <span class="c1"># é«˜å±‚èåˆ</span>
        <span class="n">fused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">v_out</span><span class="p">,</span> <span class="n">t_out</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fused</span>
</code></pre></div>

<p><strong>æ¸è¿›èåˆæ¶æ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ProgressiveFusion</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ¸è¿›å¼å¤šå±‚èåˆ&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">num_layers</span>

        <span class="c1"># æ¯3å±‚è¿›è¡Œä¸€æ¬¡èåˆ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_points</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vision_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">TransformerLayer</span><span class="p">(</span><span class="mi">768</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">TransformerLayer</span><span class="p">(</span><span class="mi">768</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># è·¨æ¨¡æ€èåˆå±‚</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">CrossModalAttention</span><span class="p">(</span><span class="mi">768</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fusion_points</span><span class="p">))</span>
        <span class="p">])</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v_input</span><span class="p">,</span> <span class="n">t_input</span><span class="p">):</span>
        <span class="n">fusion_idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span><span class="p">):</span>
            <span class="c1"># ç‹¬ç«‹å¤„ç†</span>
            <span class="n">v_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vision_layers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">v_input</span><span class="p">)</span>
            <span class="n">t_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_layers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">t_input</span><span class="p">)</span>

            <span class="c1"># åœ¨èåˆç‚¹è¿›è¡Œè·¨æ¨¡æ€äº¤äº’</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_points</span><span class="p">:</span>
                <span class="n">v_input</span><span class="p">,</span> <span class="n">t_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_attention</span><span class="p">[</span><span class="n">fusion_idx</span><span class="p">](</span><span class="n">v_input</span><span class="p">,</span> <span class="n">t_input</span><span class="p">)</span>
                <span class="n">fusion_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">v_input</span><span class="p">,</span> <span class="n">t_input</span>
</code></pre></div>

<h3 id="552">5.5.2 äº¤å‰æ³¨æ„åŠ›ä¼˜åŒ–</h3>
<p>äº¤å‰æ³¨æ„åŠ›æ˜¯å®ç°æ¨¡æ€é—´ä¿¡æ¯äº¤æ¢çš„æ ¸å¿ƒæœºåˆ¶ï¼š</p>
<p><strong>æ ‡å‡†äº¤å‰æ³¨æ„åŠ›</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CrossModalAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åŒå‘äº¤å‰æ³¨æ„åŠ›&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v2t_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t2v_attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_t</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vision</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="c1"># Vision attending to Text</span>
        <span class="n">v2t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v2t_attn</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">vision</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">text</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_v</span><span class="p">(</span><span class="n">vision</span> <span class="o">+</span> <span class="n">v2t</span><span class="p">)</span>

        <span class="c1"># Text attending to Vision</span>
        <span class="n">t2v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2v_attn</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">vision</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">vision</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_t</span><span class="p">(</span><span class="n">text</span> <span class="o">+</span> <span class="n">t2v</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vision</span><span class="p">,</span> <span class="n">text</span>
</code></pre></div>

<p><strong>ç¨€ç–äº¤å‰æ³¨æ„åŠ›</strong>ï¼ˆé™ä½å¤æ‚åº¦ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SparseBlockAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å—ç¨€ç–æ¨¡å¼çš„äº¤å‰æ³¨æ„åŠ›&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">block_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">block_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key_value</span><span class="p">):</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">key_value</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># å°†åºåˆ—åˆ†å—</span>
        <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">N</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span>
        <span class="n">query_blocks</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
            <span class="c1"># æ¯ä¸ªqueryå—åªattendåˆ°å¯¹åº”çš„keyå—</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

            <span class="n">q_block</span> <span class="o">=</span> <span class="n">query_blocks</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># [B, block_size, D]</span>
            <span class="n">kv_block</span> <span class="o">=</span> <span class="n">key_value</span><span class="p">[:,</span> <span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>  <span class="c1"># [B, block_size, D]</span>

            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">q_block</span><span class="p">,</span> <span class="n">kv_block</span><span class="p">,</span> <span class="n">kv_block</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><strong>é—¨æ§äº¤å‰æ³¨æ„åŠ›</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">GatedCrossAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä½¿ç”¨é—¨æ§æœºåˆ¶çš„äº¤å‰æ³¨æ„åŠ›&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="c1"># é—¨æ§ç½‘ç»œ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key_value</span><span class="p">):</span>
        <span class="c1"># è®¡ç®—æ³¨æ„åŠ›</span>
        <span class="n">attn_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key_value</span><span class="p">,</span> <span class="n">key_value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># è®¡ç®—é—¨æ§æƒé‡</span>
        <span class="n">gate_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">query</span><span class="p">,</span> <span class="n">attn_out</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_net</span><span class="p">(</span><span class="n">gate_input</span><span class="p">)</span>

        <span class="c1"># é—¨æ§è¾“å‡º</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">gate</span> <span class="o">*</span> <span class="n">attn_out</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gate</span><span class="p">)</span> <span class="o">*</span> <span class="n">query</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<p><strong>å±‚æ¬¡åŒ–æ³¨æ„åŠ›æ± åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">HierarchicalAttentionPooling</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¤šç²’åº¦æ³¨æ„åŠ›æ± åŒ–&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">num_levels</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_levels</span> <span class="o">=</span> <span class="n">num_levels</span>

        <span class="c1"># ä¸åŒç²’åº¦çš„æ± åŒ–å¤´</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_heads</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">//</span> <span class="n">num_levels</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_levels</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># ç²’åº¦ç‰¹å®šçš„æ³¨æ„åŠ›</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span> <span class="o">//</span> <span class="n">num_levels</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_levels</span><span class="p">)</span>
        <span class="p">])</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="c1"># features: [B, N, D]</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">pooled_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_levels</span><span class="p">):</span>
            <span class="c1"># ä¸åŒæ­¥é•¿çš„æ± åŒ–</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">i</span>
            <span class="n">pooled</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:,</span> <span class="p">::</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># é™é‡‡æ ·</span>

            <span class="c1"># æŠ•å½±åˆ°å­ç©ºé—´</span>
            <span class="n">pooled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_heads</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">pooled</span><span class="p">)</span>

            <span class="c1"># å±‚çº§å†…æ³¨æ„åŠ›</span>
            <span class="n">attended</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_attention</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">pooled</span><span class="p">,</span> <span class="n">pooled</span><span class="p">,</span> <span class="n">pooled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pooled_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attended</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># [B, D/num_levels]</span>

        <span class="c1"># æ‹¼æ¥å¤šç²’åº¦ç‰¹å¾</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">pooled_features</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, D]</span>
</code></pre></div>

<h3 id="553-mome">5.5.3 æ¨¡æ€ä¸“å®¶æ··åˆï¼ˆMoMEï¼‰</h3>
<p>æ¨¡æ€ä¸“å®¶æ··åˆé€šè¿‡ä¸ºä¸åŒæ¨¡æ€åˆ†é…ä¸“é—¨çš„å¤„ç†è·¯å¾„ï¼Œæå‡æ¨¡å‹çš„ä¸“ä¸šåŒ–èƒ½åŠ›ï¼š</p>
<p><strong>MoME æ¶æ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ModalityMixtureOfExperts</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ¨¡æ€æ„ŸçŸ¥çš„ä¸“å®¶æ··åˆ&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">num_experts</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num_modalities</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_experts</span> <span class="o">=</span> <span class="n">num_experts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_modalities</span> <span class="o">=</span> <span class="n">num_modalities</span>

        <span class="c1"># ä¸“å®¶ç½‘ç»œ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experts</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">FeedForward</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_experts</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># æ¨¡æ€ç‰¹å®šçš„è·¯ç”±ç½‘ç»œ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">({</span>
            <span class="s1">&#39;vision&#39;</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">num_experts</span><span class="p">),</span>
            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">num_experts</span><span class="p">),</span>
            <span class="s1">&#39;audio&#39;</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">num_experts</span><span class="p">)</span>
        <span class="p">})</span>

        <span class="c1"># Top-k é€‰æ‹©</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">modality</span><span class="o">=</span><span class="s1">&#39;vision&#39;</span><span class="p">):</span>
        <span class="c1"># è®¡ç®—è·¯ç”±æƒé‡</span>
        <span class="n">router</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routers</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span>
        <span class="n">routing_weights</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">router</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B, num_experts]</span>

        <span class="c1"># é€‰æ‹© top-k ä¸“å®¶</span>
        <span class="n">top_k_weights</span><span class="p">,</span> <span class="n">top_k_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">routing_weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_k</span><span class="p">)</span>
        <span class="n">top_k_weights</span> <span class="o">=</span> <span class="n">top_k_weights</span> <span class="o">/</span> <span class="n">top_k_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># åº”ç”¨ä¸“å®¶</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_k</span><span class="p">):</span>
            <span class="n">expert_idx</span> <span class="o">=</span> <span class="n">top_k_indices</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">top_k_weights</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># æ‰¹é‡å¤„ç†æ¯ä¸ªä¸“å®¶</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
                <span class="n">expert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experts</span><span class="p">[</span><span class="n">expert_idx</span><span class="p">[</span><span class="n">b</span><span class="p">]]</span>
                <span class="n">output</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">*</span> <span class="n">expert</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<p><strong>åŠ¨æ€ä¸“å®¶åˆ†é…</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DynamicExpertAllocation</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åŸºäºè¾“å…¥å†…å®¹åŠ¨æ€åˆ†é…ä¸“å®¶&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">num_experts</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_experts</span> <span class="o">=</span> <span class="n">num_experts</span>

        <span class="c1"># ä¸“å®¶æ± </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experts</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">TransformerBlock</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_experts</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># è´Ÿè½½å‡è¡¡æŸå¤±æƒé‡</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_balance_weight</span> <span class="o">=</span> <span class="mf">0.01</span>

        <span class="c1"># è·¯ç”±ç½‘ç»œ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num_experts</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># è®¡ç®—æ¯ä¸ªtokençš„è·¯ç”±</span>
        <span class="n">router_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># [B, N, num_experts]</span>
        <span class="n">router_probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">router_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Gumbel-Softmax é‡‡æ ·ï¼ˆè®­ç»ƒæ—¶ï¼‰</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">router_probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">gumbel_softmax</span><span class="p">(</span><span class="n">router_logits</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">hard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># è´Ÿè½½å‡è¡¡æŸå¤±</span>
        <span class="n">expert_usage</span> <span class="o">=</span> <span class="n">router_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">load_balance_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_balance_weight</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">expert_usage</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_experts</span> <span class="o">-</span> <span class="n">expert_usage</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># åº”ç”¨ä¸“å®¶</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">expert</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experts</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">router_probs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># [B, N, 1]</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">expert</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">load_balance_loss</span>
</code></pre></div>

<p><strong>æ¨¡æ€ç‰¹å®šä¸“å®¶è®¾è®¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ModalitySpecificExperts</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä¸ºæ¯ä¸ªæ¨¡æ€è®¾è®¡ä¸“é—¨çš„ä¸“å®¶&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># è§†è§‰ä¸“å®¶ï¼šæ“…é•¿ç©ºé—´å…³ç³»</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vision_expert</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">Conv2dAdapter</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span>  <span class="c1"># 2D å·ç§¯é€‚é…</span>
            <span class="n">SpatialAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span>
            <span class="n">FeedForward</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># æ–‡æœ¬ä¸“å®¶ï¼šæ“…é•¿åºåˆ—å»ºæ¨¡</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_expert</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">PositionalEncoding</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span>
            <span class="n">CausalAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span>  <span class="c1"># å› æœæ³¨æ„åŠ›</span>
            <span class="n">FeedForward</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># éŸ³é¢‘ä¸“å®¶ï¼šæ“…é•¿æ—¶é¢‘åˆ†æ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_expert</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">SpectralGating</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span>  <span class="c1"># é¢‘åŸŸé—¨æ§</span>
            <span class="n">TemporalConvNet</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span>
            <span class="n">FeedForward</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># é€šç”¨ä¸“å®¶ï¼šå¤„ç†è·¨æ¨¡æ€ä¿¡æ¯</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_expert</span> <span class="o">=</span> <span class="n">TransformerBlock</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">modality_mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        modality_mask: [B, N] æŒ‡ç¤ºæ¯ä¸ªtokençš„æ¨¡æ€</span>
<span class="sd">        0: vision, 1: text, 2: audio, 3: mixed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># åº”ç”¨æ¨¡æ€ç‰¹å®šä¸“å®¶</span>
        <span class="k">for</span> <span class="n">modality</span><span class="p">,</span> <span class="n">expert</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vision_expert</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text_expert</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">audio_expert</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_expert</span>
        <span class="p">]):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">modality_mask</span> <span class="o">==</span> <span class="n">modality</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">expert</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<h3 id="554">5.5.4 è®¡ç®—æ•ˆç‡ä¼˜åŒ–</h3>
<p>è·¨æ¨¡æ€æ³¨æ„åŠ›çš„è®¡ç®—å¼€é”€å·¨å¤§ï¼Œä¼˜åŒ–ç­–ç•¥è‡³å…³é‡è¦ï¼š</p>
<p><strong>Flash Attention é›†æˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">FlashCrossAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä½¿ç”¨ Flash Attention çš„è·¨æ¨¡æ€æ³¨æ„åŠ›&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">=</span> <span class="n">num_heads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">//</span> <span class="n">num_heads</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kv_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key_value</span><span class="p">):</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">key_value</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># æŠ•å½±</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_proj</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">)</span>
        <span class="n">kv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv_proj</span><span class="p">(</span><span class="n">key_value</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">)</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">kv</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Flash Attention (éœ€è¦ç‰¹å®šç¡¬ä»¶æ”¯æŒ)</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="kn">from</span> <span class="nn">flash_attn</span> <span class="kn">import</span> <span class="n">flash_attn_func</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">flash_attn_func</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback to standard attention</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">)</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">attn</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_proj</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</code></pre></div>

<p><strong>ä½ç§©åˆ†è§£ä¼˜åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LowRankCrossAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä½ç§©åˆ†è§£çš„äº¤å‰æ³¨æ„åŠ›&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>

        <span class="c1"># ä½ç§©æŠ•å½±</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_down</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_up</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kv_down</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">rank</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kv_up</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">rank</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># æ ‡å‡†æ³¨æ„åŠ›ï¼ˆä½ç»´ï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key_value</span><span class="p">):</span>
        <span class="c1"># é™ç»´</span>
        <span class="n">q_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_down</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># [B, N, rank]</span>
        <span class="n">kv_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv_down</span><span class="p">(</span><span class="n">key_value</span><span class="p">)</span>  <span class="c1"># [B, M, rank*2]</span>
        <span class="n">k_low</span><span class="p">,</span> <span class="n">v_low</span> <span class="o">=</span> <span class="n">kv_low</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># ä½ç»´æ³¨æ„åŠ›</span>
        <span class="n">attn_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">q_low</span><span class="p">,</span> <span class="n">k_low</span><span class="p">,</span> <span class="n">v_low</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># å‡ç»´</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_up</span><span class="p">(</span><span class="n">attn_out</span><span class="p">)</span>

        <span class="c1"># æ®‹å·®è¿æ¥</span>
        <span class="k">return</span> <span class="n">output</span> <span class="o">+</span> <span class="n">query</span>
</code></pre></div>

<p><strong>è®¡ç®—å¤ç”¨ç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ComputeReuseAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¤ç”¨è®¡ç®—ç»“æœçš„æ³¨æ„åŠ›&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key_value</span><span class="p">,</span> <span class="n">cache_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="c1"># å¤ç”¨ç¼“å­˜çš„key/valueæŠ•å½±</span>
            <span class="n">k_cached</span><span class="p">,</span> <span class="n">v_cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="n">k_cached</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">v_cached</span><span class="p">,</span>
                <span class="n">need_weights</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># æ­£å¸¸è®¡ç®—</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key_value</span><span class="p">,</span> <span class="n">key_value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># ç¼“å­˜ä¸­é—´ç»“æœ</span>
            <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="o">.</span><span class="n">in_proj_weight</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span> <span class="o">@</span> <span class="n">key_value</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="o">.</span><span class="n">in_proj_weight</span><span class="p">[</span><span class="n">dim</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">dim</span><span class="p">]</span> <span class="o">@</span> <span class="n">key_value</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">v</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div>

<p><strong>é‡åŒ–æ„ŸçŸ¥è®­ç»ƒ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">QuantizedCrossAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ”¯æŒé‡åŒ–çš„äº¤å‰æ³¨æ„åŠ›&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">768</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qconfig</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">get_default_qconfig</span><span class="p">(</span><span class="s1">&#39;fbgemm&#39;</span><span class="p">)</span>

        <span class="c1"># é‡åŒ–æ„ŸçŸ¥å±‚</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">QuantStub</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dequant</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">DeQuantStub</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key_value</span><span class="p">):</span>
        <span class="c1"># é‡åŒ–è¾“å…¥</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">key_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="p">(</span><span class="n">key_value</span><span class="p">)</span>

        <span class="c1"># æ‰§è¡Œæ³¨æ„åŠ›ï¼ˆé‡åŒ–ï¼‰</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key_value</span><span class="p">,</span> <span class="n">key_value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># åé‡åŒ–è¾“å‡º</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dequant</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">prepare_quantization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å‡†å¤‡é‡åŒ–&quot;&quot;&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">prepare_qat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">convert_quantization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è½¬æ¢ä¸ºé‡åŒ–æ¨¡å‹&quot;&quot;&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<h2 id="_2">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« ç³»ç»Ÿä»‹ç»äº†å¤šæ¨¡æ€ä»»åŠ¡çš„å®éªŒè®¾è®¡æ–¹æ³•ï¼Œæ¶µç›–äº†ä»åŸºç¡€çš„è§†è§‰-è¯­è¨€å¯¹é½åˆ°å¤æ‚çš„è·¨æ¨¡æ€æ³¨æ„åŠ›æœºåˆ¶è®¾è®¡ã€‚æ ¸å¿ƒè¦ç‚¹åŒ…æ‹¬ï¼š</p>
<p><strong>ğŸ“Œ å…³é”®æ¦‚å¿µå›é¡¾</strong>ï¼š</p>
<ol>
<li><strong>è§†è§‰-è¯­è¨€å¯¹é½</strong>ï¼šCLIP çš„å¯¹æ¯”å­¦ä¹ èŒƒå¼å¥ å®šåŸºç¡€ï¼Œå…³é”®åœ¨äºå¤§æ‰¹é‡è®­ç»ƒå’Œæ¸©åº¦å‚æ•°è°ƒä¼˜</li>
<li><strong>ç»Ÿä¸€å»ºæ¨¡æ¶æ„</strong>ï¼šPerceiver Resampler ç­‰è¿æ¥å±‚è®¾è®¡å®ç°äº†é«˜æ•ˆçš„æ¨¡æ€æ¡¥æ¥</li>
<li><strong>éŸ³é¢‘é›†æˆç­–ç•¥</strong>ï¼šæ—¶é¢‘åŸŸç‰¹å¾èåˆä¸å±‚æ¬¡åŒ–ç¼–ç å¤„ç†å¤šæ ·åŒ–éŸ³é¢‘ä¿¡å·</li>
<li><strong>è§†é¢‘æ—¶åºå»ºæ¨¡</strong>ï¼šå¸§é‡‡æ ·ç­–ç•¥ä¸æ—¶ç©ºæ³¨æ„åŠ›åˆ†è§£å¹³è¡¡æ•ˆç‡ä¸æ•ˆæœ</li>
<li><strong>è·¨æ¨¡æ€æ³¨æ„åŠ›</strong>ï¼šæ—©æœŸvsæ™šæœŸèåˆã€MoMEä¸“å®¶æ··åˆã€è®¡ç®—æ•ˆç‡ä¼˜åŒ–</li>
</ol>
<p><strong>ğŸ’¡ å®ç”¨å…¬å¼æ€»ç»“</strong>ï¼š</p>
<ul>
<li>InfoNCE æŸå¤±ï¼š$\mathcal{L} = -\log \frac{\exp(s_{ii}/\tau)}{\sum_j \exp(s_{ij}/\tau)}$</li>
<li>æ—¶ç©ºå¤æ‚åº¦ä¼˜åŒ–ï¼š$O(T^2S^2) \rightarrow O(T^2 + S^2)$</li>
<li>è´Ÿè½½å‡è¡¡çº¦æŸï¼š$\mathcal{L}_{balance} = \text{Var}(usage) + ||\frac{1}{K} - usage||_1$</li>
</ul>
<p><strong>ğŸ”¬ è¿›é˜¶æ¢ç´¢æ–¹å‘</strong>ï¼š</p>
<ul>
<li>3D è§†è§‰ç†è§£çš„å¤šè§†è§’èåˆ</li>
<li>å®æ—¶å¤šæ¨¡æ€æµå¤„ç†ä¼˜åŒ–</li>
<li>ç¥ç»æ¶æ„æœç´¢ï¼ˆNASï¼‰ç”¨äºè·¨æ¨¡æ€è®¾è®¡</li>
<li>æ¨¡æ€ç¼ºå¤±æƒ…å†µä¸‹çš„é²æ£’æ¨ç†</li>
</ul>
<h2 id="_3">ç»ƒä¹ é¢˜</h2>
<h3 id="_4">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  5.1</strong>ï¼šå®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ CLIP æ¨¡å‹ï¼ŒåŒ…æ‹¬å›¾åƒç¼–ç å™¨ã€æ–‡æœ¬ç¼–ç å™¨å’Œå¯¹æ¯”æŸå¤±ã€‚</p>
<ul>
<li><em>Hint</em>ï¼šä½¿ç”¨é¢„è®­ç»ƒçš„ ResNet50 å’Œ BERT-baseï¼Œå…³æ³¨æŠ•å½±å±‚è®¾è®¡</li>
</ul>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å…³é”®å®ç°è¦ç‚¹ï¼š</p>
<ol>
<li>å›¾åƒç¼–ç å™¨è¾“å‡ºéœ€è¦å…¨å±€æ± åŒ–å¾—åˆ° [B, D] ç‰¹å¾</li>
<li>æ–‡æœ¬ç¼–ç å™¨ä½¿ç”¨ [CLS] token æˆ–å¹³å‡æ± åŒ–</li>
<li>æŠ•å½±åˆ°ç›¸åŒç»´åº¦ç©ºé—´ï¼ˆå¦‚ 512ï¼‰</li>
<li>å¯¹æ¯”æŸå¤±éœ€è¦è®¡ç®— batch å†…æ‰€æœ‰é…å¯¹çš„ç›¸ä¼¼åº¦</li>
<li>æ¸©åº¦å‚æ•°åˆå§‹åŒ–ä¸º 0.07ï¼Œå¯å­¦ä¹ </li>
</ol>
</details>
<p><strong>ç»ƒä¹  5.2</strong>ï¼šè®¾è®¡ä¸€ä¸ªå¸§é‡‡æ ·ç­–ç•¥ï¼Œä» 10 åˆ†é’Ÿçš„è§†é¢‘ä¸­é‡‡æ · 32 å¸§ç”¨äºåŠ¨ä½œè¯†åˆ«ã€‚</p>
<ul>
<li><em>Hint</em>ï¼šè€ƒè™‘ TSN çš„åˆ†æ®µé‡‡æ ·æ€æƒ³</li>
</ul>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>å»ºè®®ç­–ç•¥ï¼š</p>
<ol>
<li>å°†è§†é¢‘åˆ†ä¸º 32 ä¸ªç­‰é•¿ç‰‡æ®µ</li>
<li>æ¯ä¸ªç‰‡æ®µéšæœºé‡‡æ · 1 å¸§ï¼ˆè®­ç»ƒæ—¶ï¼‰æˆ–ä¸­é—´å¸§ï¼ˆæµ‹è¯•æ—¶ï¼‰</li>
<li>å¯¹äºåŠ¨ä½œå¯†é›†åŒºåŸŸï¼Œå¯ä½¿ç”¨å…‰æµå¹…åº¦åŠ æƒé‡‡æ ·</li>
<li>ä¿æŒæœ€å° 0.5 ç§’é—´éš”é¿å…å†—ä½™</li>
</ol>
</details>
<p><strong>ç»ƒä¹  5.3</strong>ï¼šè®¡ç®— ViT-L/14 å¤„ç† 224Ã—224 å›¾åƒæ—¶äº§ç”Ÿçš„ token æ•°é‡ã€‚</p>
<ul>
<li><em>Hint</em>ï¼špatch size = 14</li>
</ul>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>è®¡ç®—è¿‡ç¨‹ï¼š</p>
<ul>
<li>å›¾åƒå°ºå¯¸ï¼š224 Ã— 224</li>
<li>Patch å°ºå¯¸ï¼š14 Ã— 14</li>
<li>æ¯ä¸ªç»´åº¦çš„ patch æ•°ï¼š224 / 14 = 16</li>
<li>æ€» patch æ•°ï¼š16 Ã— 16 = 256</li>
<li>åŠ ä¸Š [CLS] tokenï¼š256 + 1 = 257 tokens</li>
</ul>
</details>
<p><strong>ç»ƒä¹  5.4</strong>ï¼šæ¯”è¾ƒæ—©æœŸèåˆå’Œæ™šæœŸèåˆåœ¨å‚æ•°é‡å’Œè®¡ç®—é‡ä¸Šçš„å·®å¼‚ã€‚</p>
<ul>
<li><em>Hint</em>ï¼šå‡è®¾è§†è§‰å’Œæ–‡æœ¬åºåˆ—é•¿åº¦åˆ†åˆ«ä¸º Nv å’Œ Nt</li>
</ul>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>åˆ†æï¼š</p>
<ul>
<li>æ—©æœŸèåˆï¼š</li>
<li>åºåˆ—é•¿åº¦ï¼šNv + Nt</li>
<li>è‡ªæ³¨æ„åŠ›å¤æ‚åº¦ï¼šO((Nv + Nt)Â²)</li>
<li>
<p>å‚æ•°å…±äº«ï¼Œæ€»å‚æ•°é‡è¾ƒå°‘</p>
</li>
<li>
<p>æ™šæœŸèåˆï¼š</p>
</li>
<li>ç‹¬ç«‹å¤„ç†å¤æ‚åº¦ï¼šO(NvÂ²) + O(NtÂ²)</li>
<li>å‚æ•°é‡çº¦ä¸ºæ—©æœŸèåˆçš„ 2 å€</li>
<li>å½“ Nv â‰ˆ Nt æ—¶ï¼Œè®¡ç®—é‡çº¦ä¸ºæ—©æœŸèåˆçš„ 50%</li>
</ul>
</details>
<h3 id="_5">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  5.5</strong>ï¼šè®¾è®¡ä¸€ä¸ªè‡ªé€‚åº”çš„æ¨¡æ€ä¸“å®¶åˆ†é…ç­–ç•¥ï¼Œæ ¹æ®è¾“å…¥åŠ¨æ€å†³å®šä½¿ç”¨å“ªäº›ä¸“å®¶ã€‚</p>
<ul>
<li><em>Hint</em>ï¼šè€ƒè™‘ç¨€ç–æ¿€æ´»å’Œè´Ÿè½½å‡è¡¡</li>
</ul>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>è®¾è®¡è¦ç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨å¯å­¦ä¹ çš„è·¯ç”±ç½‘ç»œï¼Œè¾“å‡ºæ¯ä¸ªä¸“å®¶çš„åˆ†æ•°</li>
<li>Top-k é€‰æ‹©ï¼ˆk=2ï¼‰ï¼Œä¿æŒç¨€ç–æ€§</li>
<li>æ·»åŠ è´Ÿè½½å‡è¡¡æŸå¤±ï¼šé¼“åŠ±å‡åŒ€ä½¿ç”¨æ‰€æœ‰ä¸“å®¶</li>
<li>å¼•å…¥å®¹é‡é™åˆ¶ï¼šæ¯ä¸ªä¸“å®¶å¤„ç†çš„ token æ•°ä¸Šé™</li>
<li>ä½¿ç”¨ Gumbel-Softmax å®ç°å¯å¾®åˆ†çš„ç¦»æ•£é€‰æ‹©</li>
<li>è¾…åŠ©æŸå¤±ï¼šæœ€å°åŒ–æœªä½¿ç”¨ä¸“å®¶çš„æ¯”ä¾‹</li>
</ol>
</details>
<p><strong>ç»ƒä¹  5.6</strong>ï¼šå¦‚ä½•å¤„ç†è§†é¢‘ä¸­çš„éŸ³ç”»ä¸åŒæ­¥é—®é¢˜ï¼Ÿè®¾è®¡ä¸€ä¸ªå¯¹é½æœºåˆ¶ã€‚</p>
<ul>
<li><em>Hint</em>ï¼šè€ƒè™‘å­¦ä¹ æ—¶é—´åç§»</li>
</ul>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>å¯å­¦ä¹ çš„æ—¶é—´åç§»é¢„æµ‹å™¨ï¼Œè¾“å‡ºéŸ³é¢‘ç›¸å¯¹è§†é¢‘çš„åç§»é‡</li>
<li>ä½¿ç”¨äº’ç›¸å…³è®¡ç®—éŸ³è§†é¢‘ç‰¹å¾çš„æœ€ä½³å¯¹é½ç‚¹</li>
<li>å¾ªç¯ä¸€è‡´æ€§çº¦æŸï¼šè§†é¢‘â†’éŸ³é¢‘â†’è§†é¢‘åº”è¯¥å›åˆ°åŸç‚¹</li>
<li>å¯¹æ¯”å­¦ä¹ ï¼šåŒæ­¥çš„éŸ³è§†é¢‘å¯¹ä½œä¸ºæ­£æ ·æœ¬</li>
<li>æ»‘åŠ¨çª—å£æ³¨æ„åŠ›ï¼Œå…è®¸ Â±2 ç§’çš„åç§»æœç´¢</li>
<li>æ•°æ®å¢å¼ºï¼šè®­ç»ƒæ—¶äººä¸ºå¼•å…¥æ—¶é—´åç§»</li>
</ol>
</details>
<p><strong>ç»ƒä¹  5.7</strong>ï¼šè®¾è®¡ä¸€ä¸ª token å‹ç¼©ç­–ç•¥ï¼Œå°† 1024 ä¸ªè§†è§‰ tokens å‹ç¼©åˆ° 64 ä¸ªã€‚</p>
<ul>
<li><em>Hint</em>ï¼šè€ƒè™‘è¯­ä¹‰èšç±»å’Œé‡è¦æ€§è¯„åˆ†</li>
</ul>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>æ–¹æ¡ˆè®¾è®¡ï¼š</p>
<ol>
<li>å­¦ä¹  64 ä¸ªå¯å­¦ä¹ çš„èšç±»ä¸­å¿ƒ</li>
<li>è®¡ç®—æ¯ä¸ª token åˆ°èšç±»ä¸­å¿ƒçš„ç›¸ä¼¼åº¦</li>
<li>Soft assignmentï¼šæ¯ä¸ª token è½¯åˆ†é…åˆ°å¤šä¸ªä¸­å¿ƒ</li>
<li>åŠ æƒèšåˆï¼šæ ¹æ®åˆ†é…æƒé‡èšåˆ tokens</li>
<li>ä¿ç•™éƒ¨åˆ†åŸå§‹é‡è¦ tokensï¼ˆå¦‚ [CLS]ï¼‰</li>
<li>æ¸è¿›å‹ç¼©ï¼š1024â†’256â†’64ï¼Œé¿å…ä¿¡æ¯æŸå¤±è¿‡å¿«</li>
<li>è¾…åŠ©é‡å»ºæŸå¤±ï¼šå‹ç¼©ååº”èƒ½é‡å»ºåŸå§‹ç‰¹å¾</li>
</ol>
</details>
<p><strong>ç»ƒä¹  5.8</strong>ï¼šå¦‚ä½•åœ¨ä¿æŒæ€§èƒ½çš„å‰æä¸‹ï¼Œå°†è·¨æ¨¡æ€æ³¨æ„åŠ›çš„å†…å­˜å ç”¨é™ä½ 75%ï¼Ÿ</p>
<ul>
<li><em>Hint</em>ï¼šç»“åˆå¤šç§ä¼˜åŒ–æŠ€æœ¯</li>
</ul>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>ç»¼åˆä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ol>
<li><strong>Flash Attention</strong>ï¼šèåˆè®¡ç®—ï¼Œå‡å°‘ä¸­é—´ç»“æœå­˜å‚¨ï¼ˆ-50%ï¼‰</li>
<li><strong>ä½ç§©åˆ†è§£</strong>ï¼šå°† 768 ç»´é™åˆ° 128 ç»´è®¡ç®—ï¼ˆ-70%ï¼‰</li>
<li><strong>å—ç¨€ç–æ¨¡å¼</strong>ï¼šåªè®¡ç®—å±€éƒ¨å’Œå…¨å±€æ³¨æ„åŠ›ï¼ˆ-60%ï¼‰</li>
<li><strong>æ¢¯åº¦æ£€æŸ¥ç‚¹</strong>ï¼šç”¨è®¡ç®—æ¢å†…å­˜ï¼ˆ-40%ï¼‰</li>
<li><strong>æ··åˆç²¾åº¦</strong>ï¼šFP16 è®¡ç®—ï¼ŒFP32 ç´¯åŠ ï¼ˆ-50%ï¼‰</li>
<li><strong>KV ç¼“å­˜å¤ç”¨</strong>ï¼šè·¨å±‚å…±äº« key-valueï¼ˆ-30%ï¼‰</li>
</ol>
<p>ç»„åˆä½¿ç”¨å¯è¾¾åˆ° 75% ä»¥ä¸Šçš„å†…å­˜èŠ‚çœï¼Œæ€§èƒ½æŸå¤± &lt;2%ã€‚</p>
</details>
<h2 id="_6">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<p>âš ï¸ <strong>å¸¸è§é”™è¯¯ä¸è°ƒè¯•æŠ€å·§</strong>ï¼š</p>
<ol>
<li>
<p><strong>æ¨¡æ€ä¸å¹³è¡¡é—®é¢˜</strong>
   - é”™è¯¯ï¼šä¸€ä¸ªæ¨¡æ€ä¸»å¯¼ï¼Œå…¶ä»–æ¨¡æ€è¢«å¿½ç•¥
   - è§£å†³ï¼šåˆ†åˆ«è®¡ç®—æ¯ä¸ªæ¨¡æ€çš„æ¢¯åº¦èŒƒæ•°ï¼ŒåŠ¨æ€è°ƒæ•´å­¦ä¹ ç‡</p>
</li>
<li>
<p><strong>è§†è§‰ Token æ•°é‡çˆ†ç‚¸</strong>
   - é”™è¯¯ï¼šé«˜åˆ†è¾¨ç‡å›¾åƒäº§ç”Ÿè¿‡å¤š tokens
   - è§£å†³ï¼šä½¿ç”¨ Perceiver é™ç»´æˆ–åˆ†å±‚å¤„ç†</p>
</li>
<li>
<p><strong>éŸ³è§†é¢‘ä¸åŒæ­¥</strong>
   - é”™è¯¯ï¼šå‡è®¾éŸ³è§†é¢‘å®Œå…¨å¯¹é½
   - è§£å†³ï¼šå…è®¸å¯å­¦ä¹ çš„æ—¶é—´åç§»ï¼Œä½¿ç”¨ DTW å¯¹é½</p>
</li>
<li>
<p><strong>è´Ÿæ ·æœ¬é‡‡æ ·åå·®</strong>
   - é”™è¯¯ï¼šè´Ÿæ ·æœ¬è¿‡äºç®€å•æˆ–è¿‡äºå›°éš¾
   - è§£å†³ï¼šç»´æŠ¤éš¾åº¦åˆ†å¸ƒï¼Œcurriculum é‡‡æ ·</p>
</li>
<li>
<p><strong>è·¨æ¨¡æ€æ¢¯åº¦ä¸ç¨³å®š</strong>
   - é”™è¯¯ï¼šä¸åŒæ¨¡æ€æ¢¯åº¦å°ºåº¦å·®å¼‚å¤§
   - è§£å†³ï¼šåˆ†æ¨¡æ€çš„ gradient clipping å’Œå½’ä¸€åŒ–</p>
</li>
<li>
<p><strong>æ¨ç†é€Ÿåº¦ç“¶é¢ˆ</strong>
   - é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨è®­ç»ƒæ¶æ„éƒ¨ç½²
   - è§£å†³ï¼šçŸ¥è¯†è’¸é¦åˆ°è½»é‡çº§å­¦ç”Ÿæ¨¡å‹</p>
</li>
<li>
<p><strong>æ•°æ®æ³„éœ²é£é™©</strong>
   - é”™è¯¯ï¼šæµ‹è¯•é›†çš„éŸ³è§†é¢‘å¯¹å‡ºç°åœ¨è®­ç»ƒé›†
   - è§£å†³ï¼šåŸºäºè§†é¢‘ ID è€Œéå¸§çº§åˆ«åˆ’åˆ†æ•°æ®é›†</p>
</li>
<li>
<p><strong>è®¡ç®—å›¾å†…å­˜æ³„éœ²</strong>
   - é”™è¯¯ï¼šä¿å­˜äº†è¿‡å¤šçš„ä¸­é—´æ¿€æ´»å€¼
   - è§£å†³ï¼šåŠæ—¶ detach()ï¼Œä½¿ç”¨ gradient checkpointing</p>
</li>
</ol>
            </article>
            
            <nav class="page-nav"><a href="chapter4.html" class="nav-link prev">â† ç¬¬å››ç« ï¼šçº¯è¯­è¨€ä»»åŠ¡å®éªŒè®¾è®¡</a><a href="chapter6.html" class="nav-link next">ç¬¬å…­ç« ï¼šå¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆ â†’</a></nav>
        </main>
    </div>
</body>
</html>