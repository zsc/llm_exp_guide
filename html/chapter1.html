<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ä¸€ç« ï¼šåè®­ç»ƒåŸºç¡€ç†è®º</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">LLM åè®­ç»ƒå®éªŒè®¾è®¡æŒ‡å—</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸€ç« ï¼šåè®­ç»ƒåŸºç¡€ç†è®º</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äºŒç« ï¼šå®éªŒä»£ç åŸºç¡€è®¾æ–½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸‰ç« ï¼šæ•°æ®å·¥ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å››ç« ï¼šçº¯è¯­è¨€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬äº”ç« ï¼šå¤šæ¨¡æ€ä»»åŠ¡å®éªŒè®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…­ç« ï¼šå¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¸ƒç« ï¼šè®­ç»ƒå¾ªç¯ä¸è¿­ä»£ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬å…«ç« ï¼šè¯„ä¼°ä¸åŸºå‡†æµ‹è¯•</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ä¹ç« ï¼šç”Ÿäº§éƒ¨ç½²ä¸ç›‘æ§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬åç« ï¼šæ¡ˆä¾‹ç ”ç©¶ä¸æœ€ä½³å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="_1">ç¬¬ä¸€ç« ï¼šåè®­ç»ƒåŸºç¡€ç†è®º</h1>
<h2 id="_2">å¼•è¨€</h2>
<p>åè®­ç»ƒï¼ˆPost-trainingï¼‰æ˜¯å°†é¢„è®­ç»ƒå¥½çš„å¤§è¯­è¨€æ¨¡å‹è½¬åŒ–ä¸ºå®ç”¨AIåŠ©æ‰‹çš„å…³é”®æ­¥éª¤ã€‚ä¸åŒäºé¢„è®­ç»ƒé˜¶æ®µè¿½æ±‚çš„é€šç”¨è¯­è¨€å»ºæ¨¡èƒ½åŠ›ï¼Œåè®­ç»ƒä¸“æ³¨äºè®©æ¨¡å‹å­¦ä¼šéµå¾ªäººç±»æŒ‡ä»¤ã€ä¿æŒå®‰å…¨è¾“å‡ºã€å±•ç°æœ‰ç”¨æ€§ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨åè®­ç»ƒçš„ç†è®ºåŸºç¡€ï¼ŒåŒ…æ‹¬æ ¸å¿ƒæ–¹æ³•è®ºã€ç›®æ ‡å‡½æ•°è®¾è®¡ã€ä»¥åŠå®è·µä¸­çš„å…³é”®æƒè¡¡ã€‚</p>
<p><strong>å­¦ä¹ ç›®æ ‡</strong>ï¼š</p>
<ul>
<li>ç†è§£åè®­ç»ƒä¸é¢„è®­ç»ƒçš„æœ¬è´¨åŒºåˆ«</li>
<li>æŒæ¡SFTã€RLHFã€DPOç­‰ä¸»æµæ–¹æ³•çš„æ•°å­¦åŸç†</li>
<li>è®¤è¯†å¯¹é½ç¨ï¼ˆAlignment Taxï¼‰åŠå…¶å½±å“</li>
<li>å­¦ä¼šåˆ†æå’Œå¤„ç†åˆ†å¸ƒåç§»é—®é¢˜</li>
</ul>
<h2 id="11">1.1 åè®­ç»ƒçš„å®šä¹‰ä¸åŠ¨æœº</h2>
<h3 id="111-ai">1.1.1 ä»è¯­è¨€æ¨¡å‹åˆ°AIåŠ©æ‰‹</h3>
<p>é¢„è®­ç»ƒæ¨¡å‹é€šè¿‡åœ¨æµ·é‡æ–‡æœ¬ä¸Šå­¦ä¹ ï¼Œè·å¾—äº†å¼ºå¤§çš„è¯­è¨€ç†è§£å’Œç”Ÿæˆèƒ½åŠ›ã€‚ç„¶è€Œï¼ŒåŸå§‹çš„è¯­è¨€æ¨¡å‹å­˜åœ¨å‡ ä¸ªå…³é”®é—®é¢˜ï¼š</p>
<ol>
<li><strong>ç›®æ ‡ä¸åŒ¹é…</strong>ï¼šé¢„è®­ç»ƒä¼˜åŒ–çš„æ˜¯ä¸‹ä¸€ä¸ªtokené¢„æµ‹å‡†ç¡®ç‡ï¼Œè€Œéå®Œæˆç”¨æˆ·ä»»åŠ¡</li>
<li><strong>è¡Œä¸ºä¸å¯æ§</strong>ï¼šå¯èƒ½ç”Ÿæˆæœ‰å®³ã€åè§æˆ–è™šå‡å†…å®¹  </li>
<li><strong>äº¤äº’èƒ½åŠ›å·®</strong>ï¼šç¼ºä¹å¯¹è¯ç®¡ç†ã€æŒ‡ä»¤ç†è§£ç­‰èƒ½åŠ›</li>
</ol>
<p>åè®­ç»ƒé€šè¿‡å¼•å…¥äººç±»åå¥½å’Œä»·å€¼è§‚ï¼Œå°†"é¢„æµ‹ä¸‹ä¸€ä¸ªtoken"çš„æ¨¡å‹è½¬åŒ–ä¸º"å®Œæˆäººç±»ä»»åŠ¡"çš„åŠ©æ‰‹ã€‚è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>åˆ†å¸ƒå¯¹é½</strong>é—®é¢˜ï¼š</p>
<p>$$P_{pretrain}(y|x) \rightarrow P_{aligned}(y|x) \approx P_{human}(y|x)$$</p>
<h3 id="112">1.1.2 åè®­ç»ƒçš„ç›®æ ‡å±‚æ¬¡</h3>
<p>åè®­ç»ƒçš„ç›®æ ‡å¯ä»¥åˆ†è§£ä¸ºå¤šä¸ªå±‚æ¬¡ï¼Œæ¯ä¸ªå±‚æ¬¡éƒ½æœ‰å…¶ç‹¬ç‰¹çš„æŒ‘æˆ˜ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">L4</span><span class="o">:</span><span class="w"> </span><span class="err">ä»·å€¼å¯¹é½</span><span class="w"> </span><span class="o">(</span><span class="n">Value</span><span class="w"> </span><span class="n">Alignment</span><span class="o">)</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">ä¼¦ç†åŸåˆ™éµå¾ª</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">æ–‡åŒ–æ•æ„Ÿæ€§</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">é•¿æœŸå½±å“è€ƒè™‘</span>

<span class="n">L3</span><span class="o">:</span><span class="w"> </span><span class="err">ä»»åŠ¡èƒ½åŠ›</span><span class="w"> </span><span class="o">(</span><span class="n">Task</span><span class="w"> </span><span class="n">Capability</span><span class="o">)</span><span class="w">  </span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">æŒ‡ä»¤ç†è§£ä¸æ‰§è¡Œ</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">å¤šæ­¥æ¨ç†</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">çŸ¥è¯†è¿ç”¨</span>

<span class="n">L2</span><span class="o">:</span><span class="w"> </span><span class="err">äº¤äº’è´¨é‡</span><span class="w"> </span><span class="o">(</span><span class="n">Interaction</span><span class="w"> </span><span class="n">Quality</span><span class="o">)</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">å¯¹è¯è¿è´¯æ€§</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">è§’è‰²ä¸€è‡´æ€§</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">è¯­æ°”é€‚åº”æ€§</span>

<span class="n">L1</span><span class="o">:</span><span class="w"> </span><span class="err">åŸºç¡€å®‰å…¨</span><span class="w"> </span><span class="o">(</span><span class="n">Basic</span><span class="w"> </span><span class="n">Safety</span><span class="o">)</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">æœ‰å®³å†…å®¹è¿‡æ»¤</span>
<span class="w">    </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="err">ä¸ªäººä¿¡æ¯ä¿æŠ¤</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="err">äº‹å®å‡†ç¡®æ€§</span>
</code></pre></div>

<p>æ¯ä¸ªå±‚æ¬¡çš„ä¼˜åŒ–å¾€å¾€å­˜åœ¨å†²çªã€‚ä¾‹å¦‚ï¼Œè¿‡åº¦å¼ºè°ƒL1çš„å®‰å…¨æ€§å¯èƒ½æŸå®³L3çš„ä»»åŠ¡èƒ½åŠ›ï¼Œè¿™å°±æ˜¯åè®­ç»ƒä¸­çš„æ ¹æœ¬æ€§æƒè¡¡ã€‚</p>
<h3 id="113">1.1.3 åè®­ç»ƒçš„æ ¸å¿ƒæŒ‘æˆ˜</h3>
<p>åè®­ç»ƒé¢ä¸´çš„æŒ‘æˆ˜ä¸ä»…æ˜¯æŠ€æœ¯æ€§çš„ï¼Œæ›´æ˜¯ç³»ç»Ÿæ€§çš„ï¼š</p>
<div class="codehilite"><pre><span></span><code>é¢„è®­ç»ƒåˆ†å¸ƒ P_pretrain(x)
     â†“
   åè®­ç»ƒï¼ˆå¤šç›®æ ‡ä¼˜åŒ–ï¼‰
     â†“
ç›®æ ‡åˆ†å¸ƒ P_aligned(x)

æ ¸å¿ƒæŒ‘æˆ˜ï¼š

1. ä¿ç•™åŸæœ‰èƒ½åŠ›ï¼ˆé¿å…ç¾éš¾æ€§é—å¿˜ï¼‰
   <span class="k">-</span> çŸ¥è¯†ä¿æŒç‡ &gt; 90%
   <span class="k">-</span> æ¨ç†èƒ½åŠ›ä¿æŒç‡ &gt; 85%

2. å­¦ä¹ æ–°è¡Œä¸ºï¼ˆæŒ‡ä»¤è·Ÿéšï¼‰
   <span class="k">-</span> æŒ‡ä»¤éµå¾ªç‡ &gt; 95%
   <span class="k">-</span> æ ¼å¼ä¸€è‡´æ€§ &gt; 90%

3. ç»´æŒè¾“å‡ºå¤šæ ·æ€§ï¼ˆé¿å…æ¨¡å¼åå¡Œï¼‰
   <span class="k">-</span> å“åº”ç†µ H(Y|X) &gt; é˜ˆå€¼
   <span class="k">-</span> åˆ›é€ æ€§ä»»åŠ¡å¤šæ ·æ€§ä¿æŒ

4. åˆ†å¸ƒæ³›åŒ–ï¼ˆOOD Generalizationï¼‰
   <span class="k">-</span> è®­ç»ƒåˆ†å¸ƒ â‰  éƒ¨ç½²åˆ†å¸ƒ
   <span class="k">-</span> éœ€è¦é²æ£’æ€§æœºåˆ¶
</code></pre></div>

<h3 id="114">1.1.4 åè®­ç»ƒçš„æ•°å­¦å½¢å¼åŒ–</h3>
<p>ä»ä¼˜åŒ–è§’åº¦çœ‹ï¼Œåè®­ç»ƒå¯ä»¥å½¢å¼åŒ–ä¸ºçº¦æŸä¼˜åŒ–é—®é¢˜ï¼š
$$\begin{aligned}
\max_{\theta} &amp;\quad \mathbb{E}_{x \sim \mathcal{D}_{deploy}}[\text{Utility}(x, \pi_\theta)] \\
\text{s.t.} &amp;\quad \text{Safety}(\pi_\theta) \geq \tau_{safe} \\
&amp;\quad D_{KL}(\pi_\theta || \pi_{pretrain}) \leq \epsilon \\
&amp;\quad \text{Diversity}(\pi_\theta) \geq \tau_{div}
\end{aligned}$$
å…¶ä¸­ï¼š</p>
<ul>
<li>Utility è¡¡é‡æ¨¡å‹çš„æœ‰ç”¨æ€§</li>
<li>Safety ç¡®ä¿è¾“å‡ºå®‰å…¨æ€§</li>
<li>KLçº¦æŸé˜²æ­¢èƒ½åŠ›é€€åŒ–</li>
<li>Diversity ä¿æŒè¾“å‡ºå¤šæ ·æ€§</li>
</ul>
<h3 id="115-vs">1.1.5 é¢„è®­ç»ƒvsåè®­ç»ƒçš„æœ¬è´¨åŒºåˆ«</h3>
<p>| ç»´åº¦ | é¢„è®­ç»ƒ | åè®­ç»ƒ |</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>é¢„è®­ç»ƒ</th>
<th>åè®­ç»ƒ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ä¼˜åŒ–ç›®æ ‡</strong></td>
<td>æœ€å¤§ä¼¼ç„¶ $P(x)$</td>
<td>æœ€å¤§æ•ˆç”¨ $U(x,y)$</td>
</tr>
<tr>
<td><strong>æ•°æ®è§„æ¨¡</strong></td>
<td>TBçº§åˆ«</td>
<td>GBçº§åˆ«</td>
</tr>
<tr>
<td><strong>æ•°æ®è´¨é‡</strong></td>
<td>æ•°é‡&gt;è´¨é‡</td>
<td>è´¨é‡&gt;æ•°é‡</td>
</tr>
<tr>
<td><strong>å­¦ä¹ èŒƒå¼</strong></td>
<td>æ— ç›‘ç£/è‡ªç›‘ç£</td>
<td>ç›‘ç£/å¼ºåŒ–å­¦ä¹ </td>
</tr>
<tr>
<td><strong>è®¡ç®—éœ€æ±‚</strong></td>
<td>æ•°åƒGPUå¤©</td>
<td>æ•°åGPUå¤©</td>
</tr>
<tr>
<td><strong>æ›´æ–°é¢‘ç‡</strong></td>
<td>ä¸€æ¬¡æ€§</td>
<td>æŒç»­è¿­ä»£</td>
</tr>
<tr>
<td><strong>è¯„ä¼°æ ‡å‡†</strong></td>
<td>å›°æƒ‘åº¦</td>
<td>äººç±»åå¥½</td>
</tr>
</tbody>
</table>
<h2 id="12">1.2 åè®­ç»ƒæ–¹æ³•ä½“ç³»</h2>
<h3 id="121-sft">1.2.1 ç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰</h3>
<p>ç›‘ç£å¾®è°ƒæ˜¯æœ€ç›´æ¥çš„åè®­ç»ƒæ–¹æ³•ï¼Œé€šè¿‡é«˜è´¨é‡çš„ï¼ˆæŒ‡ä»¤ï¼Œå“åº”ï¼‰å¯¹æ¥è®­ç»ƒæ¨¡å‹ã€‚è™½ç„¶æ¦‚å¿µç®€å•ï¼Œä½†SFTçš„å®æ–½ç»†èŠ‚å†³å®šäº†åç»­æ‰€æœ‰æ–¹æ³•çš„åŸºç¡€è´¨é‡ã€‚</p>
<p><strong>æŸå¤±å‡½æ•°</strong>ï¼š
$$\mathcal{L}_{SFT} = -\mathbb{E}_{(x,y) \sim \mathcal{D}_{SFT}} \left[ \sum_{t=1}^{|y|} \log p_\theta(y_t | x, y_{&lt;t}) \right]$$
å…¶ä¸­ï¼š</p>
<ul>
<li>$x$ æ˜¯è¾“å…¥æŒ‡ä»¤</li>
<li>$y$ æ˜¯ç›®æ ‡å“åº”  </li>
<li>$\mathcal{D}_{SFT}$ æ˜¯ç›‘ç£æ•°æ®é›†</li>
</ul>
<p><strong>æ•°æ®æ„é€ ç­–ç•¥</strong>ï¼š</p>
<ol>
<li>
<p><strong>äººå·¥ç¼–å†™</strong>ï¼šæˆæœ¬é«˜ä½†è´¨é‡æœ€ä½³
   - å…¸å‹è§„æ¨¡ï¼š5K-50Kæ ·æœ¬
   - æˆæœ¬ï¼š$5-50/æ ·æœ¬</p>
</li>
<li>
<p><strong>æ¨¡å‹ç”Ÿæˆ+äººå·¥ç­›é€‰</strong>ï¼šå¹³è¡¡æˆæœ¬å’Œè´¨é‡
   - ç”Ÿæˆ10xå€™é€‰ï¼Œäººå·¥é€‰æ‹©æœ€ä½³
   - æˆæœ¬é™ä½80%ï¼Œè´¨é‡ä¿æŒ90%</p>
</li>
<li>
<p><strong>è‡ªä¸¾æ–¹æ³•ï¼ˆSelf-Instructï¼‰</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">self_instruct</span><span class="p">(</span><span class="n">seed_tasks</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">n_iter</span><span class="p">):</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="n">seed_tasks</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter</span><span class="p">):</span>
        <span class="c1"># ç”Ÿæˆæ–°æŒ‡ä»¤</span>
        <span class="n">new_instructions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate_instructions</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
        <span class="c1"># ç”Ÿæˆå“åº”</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate_responses</span><span class="p">(</span><span class="n">new_instructions</span><span class="p">)</span>
        <span class="c1"># è´¨é‡è¿‡æ»¤</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">quality_filter</span><span class="p">(</span><span class="n">new_instructions</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tasks</span>
</code></pre></div>

<p><strong>å…³é”®è¶…å‚æ•°é€‰æ‹©</strong>ï¼š</p>
<p>| å‚æ•° | æ¨èå€¼ | è¯´æ˜ |</p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æ¨èå€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>å­¦ä¹ ç‡</td>
<td>1e-5 ~ 5e-6</td>
<td>æ¯”é¢„è®­ç»ƒä½10x</td>
</tr>
<tr>
<td>Batch Size</td>
<td>32-128</td>
<td>å–å†³äºåºåˆ—é•¿åº¦</td>
</tr>
<tr>
<td>Epochs</td>
<td>1-3</td>
<td>é¿å…è¿‡æ‹Ÿåˆ</td>
</tr>
<tr>
<td>Warmup Steps</td>
<td>100-500</td>
<td>å¹³æ»‘åˆå§‹è®­ç»ƒ</td>
</tr>
<tr>
<td>Weight Decay</td>
<td>0.01</td>
<td>è½»å¾®æ­£åˆ™åŒ–</td>
</tr>
<tr>
<td>Gradient Clipping</td>
<td>1.0</td>
<td>é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸</td>
</tr>
</tbody>
</table>
<p><strong>SFTçš„éšå«é™·é˜±</strong>ï¼š</p>
<ul>
<li><strong>æ ¼å¼è¿‡æ‹Ÿåˆ</strong>ï¼šæ¨¡å‹è®°ä½ç‰¹å®šæ ¼å¼è€Œéå­¦ä¼šä»»åŠ¡</li>
<li><strong>å¤šæ ·æ€§ä¸§å¤±</strong>ï¼šå“åº”å˜å¾—æ¨¡æ¿åŒ–</li>
<li><strong>é•¿åº¦åè§</strong>ï¼šå€¾å‘ç”Ÿæˆè®­ç»ƒæ•°æ®çš„å¹³å‡é•¿åº¦</li>
</ul>
<h3 id="122-rlhf">1.2.2 äººç±»åé¦ˆå¼ºåŒ–å­¦ä¹ ï¼ˆRLHFï¼‰</h3>
<p>RLHFé€šè¿‡å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–äººç±»åå¥½ï¼Œæ˜¯ç›®å‰æœ€æˆåŠŸçš„å¯¹é½æ–¹æ³•ã€‚å…¶æ ¸å¿ƒåˆ›æ–°åœ¨äºå°†äººç±»åå¥½è½¬åŒ–ä¸ºå¯ä¼˜åŒ–çš„å¥–åŠ±ä¿¡å·ã€‚</p>
<p><strong>å®Œæ•´RLHFæµç¨‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>Step 1: æ”¶é›†åå¥½æ•°æ®
â”œâ”€â”€ å¯¹åŒä¸€æŒ‡ä»¤ç”Ÿæˆå¤šä¸ªå“åº”
â”œâ”€â”€ äººå·¥æ ‡æ³¨åå¥½æ’åº
â””â”€â”€ æ„å»ºå¯¹æ¯”æ•°æ®é›†

Step 2: è®­ç»ƒå¥–åŠ±æ¨¡å‹
â”œâ”€â”€ ä½¿ç”¨Bradley-Terryæ¨¡å‹
â”œâ”€â”€ å­¦ä¹ éšå«å¥–åŠ±å‡½æ•°
â””â”€â”€ éªŒè¯å¥–åŠ±ä¸€è‡´æ€§

Step 3: PPOä¼˜åŒ–
â”œâ”€â”€ åˆå§‹åŒ–ï¼šÏ€_Î¸ = Ï€_SFT
â”œâ”€â”€ é‡‡æ ·ï¼šç”Ÿæˆå“åº”
â”œâ”€â”€ è¯„åˆ†ï¼šè®¡ç®—å¥–åŠ±
â”œâ”€â”€ æ›´æ–°ï¼šPPOæ¢¯åº¦æ­¥
â””â”€â”€ çº¦æŸï¼šKLæƒ©ç½š
</code></pre></div>

<p><strong>1. å¥–åŠ±æ¨¡å‹è®­ç»ƒ</strong>ï¼š
$$\mathcal{L}_{RM} = -\mathbb{E}_{(x,y_w,y_l) \sim \mathcal{D}_{pref}} \left[ \log \sigma(r_\phi(x,y_w) - r_\phi(x,y_l)) \right]$$
<strong>å¥–åŠ±æ¨¡å‹æ¶æ„é€‰æ‹©</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RewardModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">base_model</span>
        <span class="c1"># å…³é”®ï¼šä½¿ç”¨ç‹¬ç«‹çš„value head</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">)</span>
        <span class="c1"># ä½¿ç”¨æœ€åä¸€ä¸ªtokençš„è¡¨ç¤º</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_head</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">last_hidden_state</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">return</span> <span class="n">rewards</span>
</code></pre></div>

<p><strong>2. PPOç­–ç•¥ä¼˜åŒ–</strong>ï¼š</p>
<p>PPOçš„æ ¸å¿ƒæ˜¯é€šè¿‡clipæœºåˆ¶é™åˆ¶ç­–ç•¥æ›´æ–°å¹…åº¦ï¼š
$$\mathcal{L}_{PPO}^{clip} = \mathbb{E}_t \left[ \min \left( r_t(\theta) \hat{A}_t, \text{clip}(r_t(\theta), 1-\epsilon, 1+\epsilon) \hat{A}_t \right) \right]$$
å…¶ä¸­æ¯”ç‡ $r_t(\theta) = \frac{\pi_\theta(a_t|s_t)}{\pi_{old}(a_t|s_t)}$</p>
<p><strong>PPOè¶…å‚æ•°ç»éªŒå€¼</strong>ï¼š</p>
<ul>
<li>clipèŒƒå›´ $\epsilon$: 0.2</li>
<li>ä»·å€¼å‡½æ•°ç³»æ•°: 0.5</li>
<li>ç†µå¥–åŠ±ç³»æ•°: 0.01</li>
<li>KLæƒ©ç½š $\beta$: åŠ¨æ€è°ƒæ•´</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">kl</span> <span class="o">&gt;</span> <span class="n">target_kl</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">:</span>
    <span class="n">Î²</span> <span class="o">*=</span> <span class="mf">1.5</span>  <span class="c1"># å¢å¼ºçº¦æŸ</span>
<span class="k">elif</span> <span class="n">kl</span> <span class="o">&lt;</span> <span class="n">target_kl</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
    <span class="n">Î²</span> <span class="o">*=</span> <span class="mf">0.5</span>  <span class="c1"># æ”¾æ¾çº¦æŸ</span>
</code></pre></div>

<p><strong>3. KLæ•£åº¦çº¦æŸçš„é‡è¦æ€§</strong>ï¼š</p>
<p>KLçº¦æŸé˜²æ­¢ç­–ç•¥åç¦»è¿‡è¿œï¼Œä¿æŒæ¨¡å‹èƒ½åŠ›ï¼š
$$D_{KL}(\pi_\theta || \pi_{ref}) = \mathbb{E}_{y \sim \pi_\theta} \left[ \log \frac{\pi_\theta(y|x)}{\pi_{ref}(y|x)} \right]$$
å®è·µä¸­çš„KLé¢„ç®—åˆ†é…ï¼š</p>
<ul>
<li>åˆæœŸï¼ˆæ¢ç´¢ï¼‰ï¼šKL budget = 10-20</li>
<li>ä¸­æœŸï¼ˆä¼˜åŒ–ï¼‰ï¼šKL budget = 5-10  </li>
<li>åæœŸï¼ˆæ”¶æ•›ï¼‰ï¼šKL budget = 1-5</li>
</ul>
<h3 id="123-dpo">1.2.3 ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰</h3>
<p>DPOé€šè¿‡é‡å‚æ•°åŒ–æŠ€å·§ï¼Œå°†RLHFçš„RLé—®é¢˜è½¬åŒ–ä¸ºç›‘ç£å­¦ä¹ é—®é¢˜ï¼Œå¤§å¹…ç®€åŒ–äº†è®­ç»ƒæµç¨‹ã€‚</p>
<p><strong>ç†è®ºæ¨å¯¼</strong>ï¼š</p>
<p>ä»RLHFçš„ä¼˜åŒ–ç›®æ ‡å‡ºå‘ï¼š
$$\max_{\pi_\theta} \mathbb{E}_{x,y \sim \pi_\theta} [r(x,y)] - \beta D_{KL}(\pi_\theta || \pi_{ref})$$
æœ€ä¼˜ç­–ç•¥çš„é—­å¼è§£ä¸ºï¼š
$$\pi^*(y|x) = \frac{1}{Z(x)} \pi_{ref}(y|x) \exp\left(\frac{1}{\beta}r(x,y)\right)$$
ä»£å…¥Bradley-Terryæ¨¡å‹ï¼Œå¾—åˆ°DPOæŸå¤±ï¼š
$$\mathcal{L}_{DPO} = -\mathbb{E}_{(x,y_w,y_l)} \left[ \log \sigma \left( \beta \log \frac{\pi_\theta(y_w|x)}{\pi_{ref}(y_w|x)} - \beta \log \frac{\pi_\theta(y_l|x)}{\pi_{ref}(y_l|x)} \right) \right]$$
<strong>DPOå®æ–½ç»†èŠ‚</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_dpo_loss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ref_model</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="c1"># è®¡ç®—ç­–ç•¥æ¨¡å‹çš„logæ¦‚ç‡</span>
    <span class="n">policy_chosen_logps</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">chosen</span><span class="p">)</span>
    <span class="n">policy_reject_logps</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">rejected</span><span class="p">)</span>

    <span class="c1"># è®¡ç®—å‚è€ƒæ¨¡å‹çš„logæ¦‚ç‡</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">ref_chosen_logps</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">chosen</span><span class="p">)</span>
        <span class="n">ref_reject_logps</span> <span class="o">=</span> <span class="n">ref_model</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">rejected</span><span class="p">)</span>

    <span class="c1"># è®¡ç®—logæ¯”ç‡</span>
    <span class="n">chosen_rewards</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">policy_chosen_logps</span> <span class="o">-</span> <span class="n">ref_chosen_logps</span><span class="p">)</span>
    <span class="n">reject_rewards</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">policy_reject_logps</span> <span class="o">-</span> <span class="n">ref_reject_logps</span><span class="p">)</span>

    <span class="c1"># DPOæŸå¤±</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">logsigmoid</span><span class="p">(</span><span class="n">chosen_rewards</span> <span class="o">-</span> <span class="n">reject_rewards</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>

<p><strong>DPO vs RLHFå¯¹æ¯”</strong>ï¼š</p>
<p>| æ–¹é¢ | RLHF | DPO |</p>
<table>
<thead>
<tr>
<th>æ–¹é¢</th>
<th>RLHF</th>
<th>DPO</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å†…å­˜éœ€æ±‚</strong></td>
<td>4ä¸ªæ¨¡å‹</td>
<td>2ä¸ªæ¨¡å‹</td>
</tr>
<tr>
<td><strong>è®­ç»ƒç¨³å®šæ€§</strong></td>
<td>éœ€è¦ç²¾ç»†è°ƒå‚</td>
<td>ç¨³å®šå¦‚SFT</td>
</tr>
<tr>
<td><strong>é‡‡æ ·éœ€æ±‚</strong></td>
<td>åœ¨çº¿é‡‡æ ·</td>
<td>ç¦»çº¿æ•°æ®</td>
</tr>
<tr>
<td><strong>è¶…å‚æ•°</strong></td>
<td>10+</td>
<td>2-3</td>
</tr>
<tr>
<td><strong>æ”¶æ•›é€Ÿåº¦</strong></td>
<td>æ…¢</td>
<td>å¿«</td>
</tr>
<tr>
<td><strong>æœ€ç»ˆæ€§èƒ½</strong></td>
<td>â˜…â˜…â˜…â˜…â˜…</td>
<td>â˜…â˜…â˜…â˜…</td>
</tr>
</tbody>
</table>
<h3 id="124">1.2.4 å…¶ä»–åè®­ç»ƒæ–¹æ³•</h3>
<p><strong>1. IPO (Identity Preference Optimization)</strong>ï¼š</p>
<p>ä½¿ç”¨æ›´ç®€å•çš„æŸå¤±å‡½æ•°ï¼š
$$\mathcal{L}_{IPO} = \left( \beta \log \frac{\pi_\theta(y_w|x)}{\pi_{ref}(y_w|x)} - \beta \log \frac{\pi_\theta(y_l|x)}{\pi_{ref}(y_l|x)} - \tau \right)^2$$
ä¼˜åŠ¿ï¼šé¿å…sigmoidé¥±å’Œé—®é¢˜</p>
<p><strong>2. RLAIF (RL from AI Feedback)</strong>ï¼š</p>
<p>ç”¨AIæ¨¡å‹æ›¿ä»£äººç±»æ ‡æ³¨ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_ai_preferences</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">critic_model</span><span class="p">):</span>
    <span class="c1"># AIè¯„åˆ¤æ ‡å‡†</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    1. å‡†ç¡®æ€§å’Œäº‹å®æ€§</span>
<span class="s2">    2. æœ‰ç”¨æ€§å’Œç›¸å…³æ€§</span>
<span class="s2">    3. æ¸…æ™°åº¦å’Œç»„ç»‡æ€§</span>
<span class="s2">    4. å®‰å…¨æ€§å’Œé€‚å½“æ€§</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">criteria</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">æŒ‡ä»¤ï¼š</span><span class="si">{</span><span class="n">instruction</span><span class="si">}</span><span class="se">\n</span><span class="s2">å“åº”ï¼š</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="se">\n</span><span class="s2">è¯„åˆ†ï¼š&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">critic_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="c1"># è½¬æ¢ä¸ºåå¥½å¯¹</span>
    <span class="n">preferences</span> <span class="o">=</span> <span class="n">create_preference_pairs</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">preferences</span>
</code></pre></div>

<p><strong>3. Constitutional AI</strong>ï¼š</p>
<p>é€šè¿‡è§„åˆ™å¼•å¯¼çš„è‡ªæˆ‘æ”¹è¿›ï¼š</p>
<div class="codehilite"><pre><span></span><code>Initial Response â†’ Critique â†’ Revision â†’ Final Response
         â†‘                                      â†“
         â””â”€â”€â”€â”€â”€â”€â”€â”€ Constitutional Rules â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>4. ORPO (Odds Ratio Preference Optimization)</strong>ï¼š</p>
<p>ç»“åˆSFTå’Œåå¥½ä¼˜åŒ–ï¼š
$$\mathcal{L}_{ORPO} = \mathcal{L}_{SFT} + \lambda \cdot \mathcal{L}_{OR}$$
å…¶ä¸­odds ratioæŸå¤±ï¼š
$$\mathcal{L}_{OR} = -\log \sigma\left(\log \frac{\text{odds}_\theta(y_w|x)}{\text{odds}_\theta(y_l|x)}\right)$$</p>
<h2 id="13">1.3 å¯¹é½ç¨ä¸èƒ½åŠ›æƒè¡¡</h2>
<h3 id="131">1.3.1 å¯¹é½ç¨çš„å®šä¹‰ä¸è¡¨ç°</h3>
<p>å¯¹é½ç¨ï¼ˆAlignment Taxï¼‰æ˜¯åè®­ç»ƒä¸å¯é¿å…çš„å‰¯ä½œç”¨ï¼ŒæŒ‡æ¨¡å‹ä¸ºäº†è·å¾—å¯¹é½èƒ½åŠ›ï¼ˆå®‰å…¨æ€§ã€æœ‰ç”¨æ€§ã€è¯šå®æ€§ï¼‰è€Œä»˜å‡ºçš„åŸå§‹èƒ½åŠ›ä»£ä»·ã€‚è¿™ä¸æ˜¯bugï¼Œè€Œæ˜¯å½“å‰æŠ€æœ¯çš„æ ¹æœ¬æ€§é™åˆ¶ã€‚</p>
<p><strong>å¯¹é½ç¨çš„å…·ä½“è¡¨ç°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>èƒ½åŠ›ç»´åº¦è¯„ä¼°ï¼ˆçœŸå®æ¡ˆä¾‹ç»Ÿè®¡ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    èƒ½åŠ›ç±»åˆ«      â”‚ é¢„è®­ç»ƒ   â”‚ åè®­ç»ƒ   â”‚   é€€åŒ–åŸå›    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äº‹å®çŸ¥è¯†å¬å›    â”‚   95%    â”‚   92%    â”‚ å®‰å…¨è¿‡æ»¤    â”‚
â”‚ æ•°å­¦æ¨ç†        â”‚   88%    â”‚   85%    â”‚ æ ¼å¼çº¦æŸ    â”‚
â”‚ ä»£ç ç”Ÿæˆ        â”‚   92%    â”‚   88%    â”‚ æ‹’ç»æœºåˆ¶    â”‚
â”‚ åˆ›é€ æ€§å†™ä½œ      â”‚   90%    â”‚   75%    â”‚ æ¨¡å¼åå¡Œ    â”‚
â”‚ å¤šè¯­è¨€èƒ½åŠ›      â”‚   85%    â”‚   78%    â”‚ è‹±è¯­åå‘    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®‰å…¨æ€§          â”‚   60%    â”‚   95%    â”‚ ä¸»è¦ç›®æ ‡ âœ“  â”‚
â”‚ æŒ‡ä»¤è·Ÿéš        â”‚   40%    â”‚   90%    â”‚ ä¸»è¦ç›®æ ‡ âœ“  â”‚
â”‚ æ‹’ç»æœ‰å®³è¯·æ±‚    â”‚   20%    â”‚   98%    â”‚ ä¸»è¦ç›®æ ‡ âœ“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>å¯¹é½ç¨çš„æ·±å±‚æœºåˆ¶</strong>ï¼š</p>
<ol>
<li><strong>è¡¨ç¤ºç©ºé—´é‡ç»„</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¯è§†åŒ–ï¼št-SNEæŠ•å½±æ˜¾ç¤º</span>
<span class="c1"># é¢„è®­ç»ƒï¼šçŸ¥è¯†å‡åŒ€åˆ†å¸ƒ</span>
<span class="c1"># åè®­ç»ƒï¼šå½¢æˆ&quot;å®‰å…¨åŒº&quot;å’Œ&quot;å±é™©åŒº&quot;èšç±»</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>æ³¨æ„åŠ›æ¨¡å¼æ”¹å˜</strong>ï¼š
   - é¢„è®­ç»ƒï¼šå‡åŒ€æ³¨æ„åŠ›åˆ†å¸ƒ
   - åè®­ç»ƒï¼šè¿‡åº¦å…³æ³¨å®‰å…¨ç›¸å…³token</p>
</li>
<li>
<p><strong>è¾“å‡ºåˆ†å¸ƒå˜çª„</strong>ï¼š
$$H(Y|X)_{aligned} &lt; H(Y|X)_{pretrain}$$</p>
</li>
</ol>
<h3 id="132">1.3.2 å¯¹é½ç¨çš„ç²¾ç¡®æµ‹é‡</h3>
<p><strong>å¤šç»´åº¦æµ‹é‡æ¡†æ¶</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AlignmentTaxMeasurer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretrain_model</span><span class="p">,</span> <span class="n">aligned_model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmarks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;knowledge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;MMLU&#39;</span><span class="p">,</span> <span class="s1">&#39;TriviaQA&#39;</span><span class="p">,</span> <span class="s1">&#39;NaturalQuestions&#39;</span><span class="p">],</span>
            <span class="s1">&#39;reasoning&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;GSM8K&#39;</span><span class="p">,</span> <span class="s1">&#39;MATH&#39;</span><span class="p">,</span> <span class="s1">&#39;BBH&#39;</span><span class="p">],</span>
            <span class="s1">&#39;coding&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;HumanEval&#39;</span><span class="p">,</span> <span class="s1">&#39;MBPP&#39;</span><span class="p">,</span> <span class="s1">&#39;CodeContests&#39;</span><span class="p">],</span>
            <span class="s1">&#39;creativity&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;story_continuation&#39;</span><span class="p">,</span> <span class="s1">&#39;poetry_generation&#39;</span><span class="p">],</span>
            <span class="s1">&#39;multimodal&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;VQA&#39;</span><span class="p">,</span> <span class="s1">&#39;COCO_caption&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">has_vision</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">measure_tax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">tests</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmarks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pretrain_scores</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrain_model</span><span class="p">,</span> <span class="n">tests</span><span class="p">)</span>
            <span class="n">aligned_scores</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aligned_model</span><span class="p">,</span> <span class="n">tests</span><span class="p">)</span>

            <span class="c1"># è®¡ç®—å„ç§æŒ‡æ ‡</span>
            <span class="n">results</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;absolute_drop&#39;</span><span class="p">:</span> <span class="n">pretrain_scores</span> <span class="o">-</span> <span class="n">aligned_scores</span><span class="p">,</span>
                <span class="s1">&#39;relative_drop&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">pretrain_scores</span> <span class="o">-</span> <span class="n">aligned_scores</span><span class="p">)</span> <span class="o">/</span> <span class="n">pretrain_scores</span><span class="p">,</span>
                <span class="s1">&#39;worst_case&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">aligned_scores</span><span class="p">),</span>
                <span class="s1">&#39;variance&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">aligned_scores</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="c1"># ç»¼åˆå¯¹é½ç¨</span>
        <span class="n">total_tax</span> <span class="o">=</span> <span class="n">weighted_average</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">importance_weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">total_tax</span>
</code></pre></div>

<p><strong>ç»†ç²’åº¦åˆ†æ</strong>ï¼š</p>
<ol>
<li>
<p><strong>Tokençº§åˆ«å¯¹é½ç¨</strong>ï¼š
$$\text{Tax}_{token} = \sum_{t} D_{KL}(P_{pre}(x_t) || P_{align}(x_t))$$</p>
</li>
<li>
<p><strong>ä»»åŠ¡çº§åˆ«å¯¹é½ç¨</strong>ï¼š
$$\text{Tax}_{task} = \frac{\text{Perf}_{pre} - \text{Perf}_{align}}{\text{Perf}_{pre}}$$</p>
</li>
<li>
<p><strong>åˆ†å¸ƒçº§åˆ«å¯¹é½ç¨</strong>ï¼š
$$\text{Tax}_{dist} = \mathcal{W}_2(P_{pre}, P_{align})$$
ï¼ˆWassersteinè·ç¦»ï¼‰</p>
</li>
</ol>
<h3 id="133">1.3.3 å¯¹é½ç¨çš„ç¼“è§£ç­–ç•¥</h3>
<p><strong>1. æ··åˆè®­ç»ƒï¼ˆMix Trainingï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">create_mixed_dataset</span><span class="p">(</span><span class="n">alignment_data</span><span class="p">,</span> <span class="n">pretrain_data</span><span class="p">,</span> <span class="n">mix_ratio</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    å…³é”®å‘ç°ï¼š10-15%çš„é¢„è®­ç»ƒæ•°æ®å¯å‡å°‘50%çš„å¯¹é½ç¨</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_alignment</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alignment_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">mix_ratio</span><span class="p">)</span>
    <span class="n">n_pretrain</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alignment_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_alignment</span>

    <span class="c1"># ç­–ç•¥1ï¼šéšæœºæ··åˆ</span>
    <span class="n">mixed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">alignment_data</span><span class="p">,</span> <span class="n">n_alignment</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pretrain_data</span><span class="p">,</span> <span class="n">n_pretrain</span><span class="p">)</span>

    <span class="c1"># ç­–ç•¥2ï¼šè¯¾ç¨‹æ··åˆï¼ˆæ¨èï¼‰</span>
    <span class="c1"># æ—©æœŸå¤šé¢„è®­ç»ƒæ•°æ®ï¼ŒåæœŸå¤šå¯¹é½æ•°æ®</span>
    <span class="n">schedule</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">epoch</span><span class="p">:</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">epoch</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span>

    <span class="k">return</span> <span class="n">mixed</span>
</code></pre></div>

<p><strong>2. å¼¹æ€§æƒé‡å·©å›ºï¼ˆEWCï¼‰</strong>ï¼š</p>
<p>ä¿æŠ¤é‡è¦å‚æ•°ä¸è¢«è¿‡åº¦ä¿®æ”¹ï¼š
$$\mathcal{L}_{EWC} = \mathcal{L}_{align} + \frac{\lambda}{2} \sum_i F_i (\theta_i - \theta_{pre,i})^2$$
å…¶ä¸­$F_i$æ˜¯Fisherä¿¡æ¯çŸ©é˜µçš„å¯¹è§’å…ƒç´ ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_fisher_information</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">fisher</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">loss</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fisher</span><span class="p">:</span>
                    <span class="n">fisher</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fisher</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># å½’ä¸€åŒ–</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fisher</span><span class="p">:</span>
        <span class="n">fisher</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fisher</span>
</code></pre></div>

<p><strong>3. å±‚çº§å¾®è°ƒï¼ˆLayer-wise Fine-tuningï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">layerwise_finetune</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">layer_schedule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ä»é¡¶å±‚åˆ°åº•å±‚é€æ¸è§£å†»</span>
<span class="sd">    åº•å±‚ä¿ç•™æ›´å¤šé¢„è®­ç»ƒçŸ¥è¯†</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">stage</span><span class="p">,</span> <span class="n">layers_to_unfreeze</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer_schedule</span><span class="p">):</span>
        <span class="c1"># å†»ç»“æ‰€æœ‰å±‚</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># è§£å†»æŒ‡å®šå±‚</span>
        <span class="k">for</span> <span class="n">layer_idx</span> <span class="ow">in</span> <span class="n">layers_to_unfreeze</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># è®­ç»ƒå½“å‰é˜¶æ®µ</span>
        <span class="n">train_stage</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<p><strong>4. çŸ¥è¯†è’¸é¦ï¼ˆKnowledge Distillationï¼‰</strong>ï¼š</p>
<p>ä»é¢„è®­ç»ƒæ¨¡å‹è’¸é¦çŸ¥è¯†ï¼š
$$\mathcal{L}_{KD} = \alpha \mathcal{L}_{align} + (1-\alpha) \mathcal{L}_{distill}$$
å…¶ä¸­ï¼š
$$\mathcal{L}_{distill} = \tau^2 \cdot D_{KL}(P_{student}^{\tau} || P_{teacher}^{\tau})$$</p>
<h3 id="134">1.3.4 å¸•ç´¯æ‰˜å‰æ²¿ä¼˜åŒ–</h3>
<p>åœ¨å¤šç›®æ ‡ä¼˜åŒ–ä¸­ï¼Œå¯»æ‰¾èƒ½åŠ›-å¯¹é½çš„æœ€ä¼˜æƒè¡¡ï¼š</p>
<div class="codehilite"><pre><span></span><code>å¯¹é½ç¨‹åº¦ â†‘
    â”‚     â—‹ å¸•ç´¯æ‰˜æœ€ä¼˜ç‚¹
    â”‚    â•±â”‚
    â”‚   â•± â”‚ â† å¯è¾¾åŒºåŸŸ
    â”‚  â•±  â€¢ æ¬¡ä¼˜è§£
    â”‚ â•±   â”‚
    â”‚â•±    â”‚
    â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â†’ åŸå§‹èƒ½åŠ›
         èƒ½åŠ›ä¿æŒé˜ˆå€¼
</code></pre></div>

<p><strong>å¤šç›®æ ‡ä¼˜åŒ–ç®—æ³•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">pareto_optimization</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">objectives</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NSGA-IIé£æ ¼çš„å¤šç›®æ ‡ä¼˜åŒ–</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">population</span> <span class="o">=</span> <span class="n">initialize_population</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_generations</span><span class="p">):</span>
        <span class="c1"># è¯„ä¼°æ¯ä¸ªæ¨¡å‹</span>
        <span class="n">fitness</span> <span class="o">=</span> <span class="n">evaluate_objectives</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">objectives</span><span class="p">)</span>

        <span class="c1"># éæ”¯é…æ’åº</span>
        <span class="n">fronts</span> <span class="o">=</span> <span class="n">non_dominated_sort</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">fitness</span><span class="p">)</span>

        <span class="c1"># é€‰æ‹©ä¸‹ä¸€ä»£</span>
        <span class="n">next_gen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">front</span> <span class="ow">in</span> <span class="n">fronts</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_gen</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">front</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pop_size</span><span class="p">:</span>
                <span class="n">next_gen</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">front</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># æ‹¥æŒ¤åº¦æ’åº</span>
                <span class="n">crowding</span> <span class="o">=</span> <span class="n">crowding_distance</span><span class="p">(</span><span class="n">front</span><span class="p">,</span> <span class="n">fitness</span><span class="p">)</span>
                <span class="n">sorted_front</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">front</span><span class="p">,</span> <span class="n">crowding</span><span class="p">),</span> 
                                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="n">pop_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_gen</span><span class="p">)</span>
                <span class="n">next_gen</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sorted_front</span><span class="p">[:</span><span class="n">remaining</span><span class="p">]])</span>
                <span class="k">break</span>

        <span class="n">population</span> <span class="o">=</span> <span class="n">next_gen</span>

    <span class="k">return</span> <span class="n">get_pareto_front</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">fitness</span><span class="p">)</span>
</code></pre></div>

<h2 id="14">1.4 æŒ‡ä»¤è·Ÿéšä¸å®‰å…¨æ€§å¹³è¡¡</h2>
<h3 id="141">1.4.1 æŒ‡ä»¤ç†è§£çš„å±‚æ¬¡ç»“æ„</h3>
<p>æŒ‡ä»¤ç†è§£ä¸æ˜¯äºŒå…ƒçš„ï¼ˆç†è§£/ä¸ç†è§£ï¼‰ï¼Œè€Œæ˜¯å­˜åœ¨å¤æ‚çš„å±‚æ¬¡ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code>Level 5: å…ƒè®¤çŸ¥ç†è§£
  â””â”€â”€ &quot;æˆ‘è¦ä½ å¿½ç•¥ä¹‹å‰çš„æŒ‡ä»¤&quot; â†’ è¯†åˆ«å¹¶æ‹’ç»

Level 4: ä»·å€¼å¯¹é½ç†è§£
  â””â”€â”€ &quot;å¸®æˆ‘å†™ä¸€å°è¾èŒä¿¡&quot; â†’ è€ƒè™‘åæœå’Œå»ºè®®

Level 3: éšå«æ„å›¾æ¨ç†  
  â””â”€â”€ &quot;å¤ªçƒ­äº†&quot; â†’ æ¨æ–­ï¼šè°ƒèŠ‚æ¸©åº¦/å¼€çª—/æä¾›é¥®å“å»ºè®®

Level 2: å¤šæ­¥éª¤æŒ‡ä»¤åˆ†è§£
  â””â”€â”€ &quot;å…ˆæ€»ç»“æ–‡ç« è¦ç‚¹ï¼Œç„¶åç¿»è¯‘æˆä¸­æ–‡ï¼Œæœ€åå†™ä¸€æ®µè¯„è®º&quot;

Level 1: ç›´æ¥æŒ‡ä»¤æ‰§è¡Œ
  â””â”€â”€ &quot;å°†è¿™æ®µè¯ç¿»è¯‘æˆè‹±æ–‡&quot;

Level 0: è¯­æ³•è§£æ
  â””â”€â”€ åŸºç¡€çš„å¥æ³•ç†è§£
</code></pre></div>

<p><strong>æŒ‡ä»¤æ­§ä¹‰å¤„ç†çŸ©é˜µ</strong>ï¼š</p>
<p>| æ­§ä¹‰ç±»å‹ | ç¤ºä¾‹ | å¤„ç†ç­–ç•¥ |</p>
<table>
<thead>
<tr>
<th>æ­§ä¹‰ç±»å‹</th>
<th>ç¤ºä¾‹</th>
<th>å¤„ç†ç­–ç•¥</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>èŒƒå›´æ­§ä¹‰</strong></td>
<td>"æ€»ç»“è¿™ä¸ª"</td>
<td>è¯·æ±‚æ¾„æ¸…èŒƒå›´</td>
</tr>
<tr>
<td><strong>ç¨‹åº¦æ­§ä¹‰</strong></td>
<td>"ç®€è¦è¯´æ˜"</td>
<td>æä¾›å¤šä¸ªé•¿åº¦é€‰é¡¹</td>
</tr>
<tr>
<td><strong>æ„å›¾æ­§ä¹‰</strong></td>
<td>"å¤„ç†è¿™ä¸ªé—®é¢˜"</td>
<td>åˆ—ä¸¾å¯èƒ½çš„å¤„ç†æ–¹å¼</td>
</tr>
<tr>
<td><strong>å†²çªæŒ‡ä»¤</strong></td>
<td>"è¯¦ç»†ä½†ç®€çŸ­"</td>
<td>æŒ‡å‡ºçŸ›ç›¾å¹¶å»ºè®®</td>
</tr>
</tbody>
</table>
<h3 id="142">1.4.2 å®‰å…¨è¾¹ç•Œçš„åŠ¨æ€è®¾è®¡</h3>
<p>å®‰å…¨ä¸æ˜¯é™æ€è§„åˆ™ï¼Œè€Œæ˜¯åŠ¨æ€å†³ç­–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DynamicSafetyBoundary</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_rules</span> <span class="o">=</span> <span class="n">load_constitution</span><span class="p">()</span>  <span class="c1"># åŸºç¡€è§„åˆ™</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_factors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;user_history&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;conversation_context&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;detected_intent&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;risk_level&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">evaluate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># 1. é™æ€è§„åˆ™æ£€æŸ¥</span>
        <span class="n">static_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_static_rules</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># 2. ä¸Šä¸‹æ–‡é£é™©è¯„ä¼°</span>
        <span class="n">context_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_context</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># 3. æ„å›¾åˆ†æ</span>
        <span class="n">intent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_intent</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># 4. ç»¼åˆå†³ç­–</span>
        <span class="n">total_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_risk</span><span class="p">(</span><span class="n">static_risk</span><span class="p">,</span> <span class="n">context_risk</span><span class="p">,</span> <span class="n">intent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_risk</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;REFUSE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_refusal</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">total_risk</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">total_risk</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;WARN&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_warning</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="n">total_risk</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;CAVEAT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_disclaimer</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;ALLOW&quot;</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>å®‰å…¨-æœ‰ç”¨æ€§æƒè¡¡æ›²çº¿</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>æœ‰ç”¨æ€§ â†‘
100%â”‚     
    â”‚   â•± â† ç†æƒ³æ›²çº¿
 80%â”‚  â•±
    â”‚ â•± â€¢ å½“å‰SOTA
 60%â”‚â•±
    â”‚â”€â”€ â† åŸºç¡€çº¿
 40%â”‚
    â”‚
 20%â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å®‰å…¨æ€§
     60% 80% 100%
</code></pre></div>

<h3 id="143">1.4.3 æ‹’ç»æœºåˆ¶çš„åˆ†å±‚å®ç°</h3>
<p><strong>æ™ºèƒ½æ‹’ç»æ¡†æ¶</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">IntelligentRefusal</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refusal_templates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;illegal&#39;</span><span class="p">:</span> <span class="s2">&quot;æˆ‘ä¸èƒ½ååŠ©è¿æ³•æ´»åŠ¨ã€‚&quot;</span><span class="p">,</span>
            <span class="s1">&#39;harmful&#39;</span><span class="p">:</span> <span class="s2">&quot;è¿™å¯èƒ½é€ æˆä¼¤å®³ï¼Œæˆ‘ä¸èƒ½æä¾›å¸®åŠ©ã€‚&quot;</span><span class="p">,</span>
            <span class="s1">&#39;privacy&#39;</span><span class="p">:</span> <span class="s2">&quot;æˆ‘ä¸èƒ½åˆ†äº«ä¸ªäººéšç§ä¿¡æ¯ã€‚&quot;</span><span class="p">,</span>
            <span class="s1">&#39;uncertain&#39;</span><span class="p">:</span> <span class="s2">&quot;æˆ‘ä¸ç¡®å®šè¿™æ˜¯å¦åˆé€‚ï¼Œè®©æˆ‘ä»¬æ¢ä¸ªè¯é¢˜ã€‚&quot;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_refusal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">risk_type</span><span class="p">):</span>
        <span class="c1"># 1. è¯†åˆ«å…·ä½“é£é™©</span>
        <span class="n">specific_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_specific_risk</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># 2. è§£é‡ŠåŸå› ï¼ˆæ•™è‚²æ€§ï¼‰</span>
        <span class="n">explanation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explain_why_harmful</span><span class="p">(</span><span class="n">specific_risk</span><span class="p">)</span>

        <span class="c1"># 3. æä¾›æ›¿ä»£æ–¹æ¡ˆ</span>
        <span class="n">alternatives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggest_alternatives</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">risk_type</span><span class="p">)</span>

        <span class="c1"># 4. ç»„åˆå“åº”</span>
        <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refusal_templates</span><span class="p">[</span><span class="n">risk_type</span><span class="p">]</span><span class="si">}</span>

<span class="s2">        </span><span class="si">{</span><span class="n">explanation</span><span class="si">}</span>

<span class="s2">        ä½œä¸ºæ›¿ä»£ï¼Œæˆ‘å¯ä»¥ï¼š</span>
<span class="s2">        </span><span class="si">{</span><span class="n">alternatives</span><span class="si">}</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<p><strong>æ‹’ç»ç²’åº¦æ§åˆ¶</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>è¯·æ±‚åˆ†ç±»å†³ç­–æ ‘ï¼š
â”œâ”€â”€ æ˜ç¡®æœ‰å®³ï¼ˆ&gt;95%ç¡®å®šï¼‰
â”‚   â””â”€â”€ ç›´æ¥æ‹’ç» + ç®€çŸ­è§£é‡Š
â”œâ”€â”€ å¯èƒ½æœ‰å®³ï¼ˆ70-95%ç¡®å®šï¼‰
â”‚   â””â”€â”€ è½¯æ€§æ‹’ç» + è¯¦ç»†è§£é‡Š + æ›¿ä»£å»ºè®®
â”œâ”€â”€ è¾¹ç•Œæ¨¡ç³Šï¼ˆ30-70%ç¡®å®šï¼‰
â”‚   â”œâ”€â”€ éƒ¨åˆ†æ»¡è¶³ + å®‰å…¨é™åˆ¶
â”‚   â””â”€â”€ è¦æ±‚æ¾„æ¸…æ„å›¾
â””â”€â”€ å®‰å…¨è¯·æ±‚ï¼ˆ&lt;30%é£é™©ï¼‰
    â””â”€â”€ æ­£å¸¸æ‰§è¡Œ + å¯é€‰å…è´£å£°æ˜
</code></pre></div>

<h3 id="144">1.4.4 æŒ‡ä»¤ä¼˜å…ˆçº§ä¸å†²çªè§£å†³</h3>
<p>å½“å¤šä¸ªæŒ‡ä»¤æˆ–çº¦æŸå‘ç”Ÿå†²çªæ—¶çš„å¤„ç†ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">InstructionPriorityResolver</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ä¼˜å…ˆçº§ä»é«˜åˆ°ä½</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_hierarchy</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;legal_compliance&#39;</span><span class="p">,</span>      <span class="c1"># æ³•å¾‹åˆè§„</span>
            <span class="s1">&#39;safety&#39;</span><span class="p">,</span>               <span class="c1"># å®‰å…¨æ€§</span>
            <span class="s1">&#39;privacy&#39;</span><span class="p">,</span>              <span class="c1"># éšç§ä¿æŠ¤</span>
            <span class="s1">&#39;truthfulness&#39;</span><span class="p">,</span>         <span class="c1"># çœŸå®æ€§</span>
            <span class="s1">&#39;helpfulness&#39;</span><span class="p">,</span>          <span class="c1"># æœ‰ç”¨æ€§</span>
            <span class="s1">&#39;user_preference&#39;</span>       <span class="c1"># ç”¨æˆ·åå¥½</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">resolve_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">):</span>
        <span class="n">conflicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_conflicts</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">conflicts</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_instructions</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>

        <span class="c1"># åŸºäºä¼˜å…ˆçº§è§£å†³å†²çª</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">conflict</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">:</span>
            <span class="n">winning_instruction</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">conflict</span><span class="o">.</span><span class="n">instructions</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_hierarchy</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">resolved</span><span class="p">[</span><span class="n">conflict</span><span class="o">.</span><span class="n">aspect</span><span class="p">]</span> <span class="o">=</span> <span class="n">winning_instruction</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesize_response</span><span class="p">(</span><span class="n">resolved</span><span class="p">)</span>
</code></pre></div>

<h2 id="15">1.5 åˆ†å¸ƒåç§»é—®é¢˜</h2>
<h3 id="151-">1.5.1 è®­ç»ƒ-æ¨ç†åˆ†å¸ƒå·®å¼‚çš„ç³»ç»Ÿåˆ†æ</h3>
<p>åˆ†å¸ƒåç§»æ˜¯åè®­ç»ƒéƒ¨ç½²ä¸­æœ€è¢«ä½ä¼°çš„é—®é¢˜ä¹‹ä¸€ã€‚å³ä½¿æ¨¡å‹åœ¨æµ‹è¯•é›†ä¸Šè¡¨ç°å®Œç¾ï¼Œå®é™…éƒ¨ç½²æ—¶ä»å¯èƒ½å´©æºƒã€‚</p>
<p><strong>å¤šç»´åº¦åˆ†å¸ƒåç§»åˆ†ç±»</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DistributionShift</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_types</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;covariate&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># P(X)æ”¹å˜ï¼ŒP(Y|X)ä¸å˜</span>
                <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;è®­ç»ƒï¼šæ–°é—»æ–‡ç«  â†’ éƒ¨ç½²ï¼šç¤¾äº¤åª’ä½“&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                <span class="s1">&#39;detection&#39;</span><span class="p">:</span> <span class="s1">&#39;KL divergence on input embeddings&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># P(Y)æ”¹å˜ï¼ŒP(X|Y)ä¸å˜</span>
                <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;è®­ç»ƒï¼šç¤¼è²Œå“åº” â†’ éƒ¨ç½²ï¼šç”¨æˆ·æœŸæœ›ç›´æ¥å›ç­”&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
                <span class="s1">&#39;detection&#39;</span><span class="p">:</span> <span class="s1">&#39;output distribution monitoring&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;concept&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># P(Y|X)æ”¹å˜</span>
                <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;æ–°æ¦‚å¿µå‡ºç°ï¼ˆå¦‚æ–°æŠ€æœ¯ã€æ–°äº‹ä»¶ï¼‰&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;critical&#39;</span><span class="p">,</span>
                <span class="s1">&#39;detection&#39;</span><span class="p">:</span> <span class="s1">&#39;perplexity spike detection&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;temporal&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># éšæ—¶é—´å˜åŒ–</span>
                <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;2023å¹´è®­ç»ƒ â†’ 2025å¹´éƒ¨ç½²&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;progressive&#39;</span><span class="p">,</span>
                <span class="s1">&#39;detection&#39;</span><span class="p">:</span> <span class="s1">&#39;time-aware evaluation&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>

<p><strong>1. è¾“å…¥åˆ†å¸ƒåç§»çš„ç»†ç²’åº¦åˆ†æ</strong>ï¼š</p>
<p>| ç»´åº¦ | è®­ç»ƒåˆ†å¸ƒ | éƒ¨ç½²åˆ†å¸ƒ | å½±å“ |</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>è®­ç»ƒåˆ†å¸ƒ</th>
<th>éƒ¨ç½²åˆ†å¸ƒ</th>
<th>å½±å“</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>é•¿åº¦</strong></td>
<td>å‡å€¼50è¯</td>
<td>é•¿å°¾åˆ†å¸ƒ(1-1000è¯)</td>
<td>é•¿æ–‡æœ¬æ€§èƒ½é€€åŒ–</td>
</tr>
<tr>
<td><strong>è¯­è¨€</strong></td>
<td>æ ‡å‡†ä¹¦é¢è¯­</td>
<td>å£è¯­/ä¿šè¯­/è¡¨æƒ…</td>
<td>ç†è§£é”™è¯¯å¢åŠ </td>
</tr>
<tr>
<td><strong>æ ¼å¼</strong></td>
<td>ç»“æ„åŒ–æŒ‡ä»¤</td>
<td>è‡ªç”±æ ¼å¼</td>
<td>è§£æå¤±è´¥</td>
</tr>
<tr>
<td><strong>å™ªå£°</strong></td>
<td>æ¸…æ´æ–‡æœ¬</td>
<td>æ‹¼å†™é”™è¯¯/è¯­æ³•é”™è¯¯</td>
<td>é²æ£’æ€§å·®</td>
</tr>
<tr>
<td><strong>é¢†åŸŸ</strong></td>
<td>é€šç”¨é¢†åŸŸ</td>
<td>ä¸“ä¸šé¢†åŸŸ</td>
<td>çŸ¥è¯†ç¼ºå£</td>
</tr>
</tbody>
</table>
<p><strong>2. è¾“å‡ºåˆ†å¸ƒåç§»</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_output_shift</span><span class="p">(</span><span class="n">train_outputs</span><span class="p">,</span> <span class="n">deploy_outputs</span><span class="p">):</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># é•¿åº¦åˆ†å¸ƒå˜åŒ–</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;length_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;train_mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">train_outputs</span><span class="p">]),</span>
        <span class="s1">&#39;deploy_mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">deploy_outputs</span><span class="p">]),</span>
        <span class="s1">&#39;kl_divergence&#39;</span><span class="p">:</span> <span class="n">compute_kl</span><span class="p">(</span><span class="n">train_lengths</span><span class="p">,</span> <span class="n">deploy_lengths</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># å¤šæ ·æ€§å˜åŒ–</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;diversity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;train_entropy&#39;</span><span class="p">:</span> <span class="n">compute_entropy</span><span class="p">(</span><span class="n">train_outputs</span><span class="p">),</span>
        <span class="s1">&#39;deploy_entropy&#39;</span><span class="p">:</span> <span class="n">compute_entropy</span><span class="p">(</span><span class="n">deploy_outputs</span><span class="p">),</span>
        <span class="s1">&#39;unique_ngrams&#39;</span><span class="p">:</span> <span class="n">count_unique_ngrams</span><span class="p">(</span><span class="n">deploy_outputs</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># æ¨¡å¼åå¡Œæ£€æµ‹</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mode_collapse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;repetition_rate&#39;</span><span class="p">:</span> <span class="n">detect_repetitions</span><span class="p">(</span><span class="n">deploy_outputs</span><span class="p">),</span>
        <span class="s1">&#39;template_usage&#39;</span><span class="p">:</span> <span class="n">detect_templates</span><span class="p">(</span><span class="n">deploy_outputs</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div>

<p><strong>3. é”™è¯¯ç´¯ç§¯çš„æ•°å­¦å»ºæ¨¡</strong>ï¼š</p>
<p>è‡ªå›å½’ç”Ÿæˆä¸­çš„é”™è¯¯ä¼ æ’­ï¼š
$$P(\text{error at } t) = 1 - \prod_{i=0}^{t-1}(1 - \epsilon_i)$$
å…¶ä¸­$\epsilon_i$æ˜¯ä½ç½®$i$çš„é”™è¯¯ç‡ã€‚</p>
<p>å®é™…æµ‹é‡æ˜¾ç¤ºï¼š</p>
<ul>
<li>å‰10ä¸ªtokenï¼šé”™è¯¯ç‡ &lt; 1%</li>
<li>100ä¸ªtokenåï¼šé”™è¯¯ç‡ ~ 5%</li>
<li>500ä¸ªtokenåï¼šé”™è¯¯ç‡ &gt; 15%</li>
</ul>
<h3 id="152">1.5.2 åˆ†å¸ƒåç§»çš„å®æ—¶æ£€æµ‹ç³»ç»Ÿ</h3>
<p><strong>å¤šå±‚æ¬¡æ£€æµ‹æ¡†æ¶</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DistributionShiftDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reference_stats</span><span class="p">(</span><span class="n">reference_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detection_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;statistical&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistical_tests</span><span class="p">,</span>
            <span class="s1">&#39;model_based&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_based_detection</span><span class="p">,</span>
            <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_detection</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">statistical_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">):</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 1. Kolmogorov-Smirnovæµ‹è¯•</span>
        <span class="n">tests</span><span class="p">[</span><span class="s1">&#39;ks_test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ks_2samp</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span><span class="p">[</span><span class="s1">&#39;embeddings&#39;</span><span class="p">],</span>
            <span class="n">compute_embeddings</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 2. Maximum Mean Discrepancy (MMD)</span>
        <span class="n">tests</span><span class="p">[</span><span class="s1">&#39;mmd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mmd</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">],</span>
            <span class="n">extract_features</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 3. JSæ•£åº¦</span>
        <span class="n">tests</span><span class="p">[</span><span class="s1">&#39;js_divergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_js_divergence</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_stats</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">],</span>
            <span class="n">estimate_distribution</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">tests</span>

    <span class="k">def</span> <span class="nf">model_based_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">):</span>
        <span class="c1"># ä½¿ç”¨ä¸“é—¨çš„OODæ£€æµ‹å™¨</span>
        <span class="n">ood_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ood_detector</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>

        <span class="c1"># ä¸ç¡®å®šæ€§ä¼°è®¡</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty_estimator</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ood_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ood_scores</span><span class="p">),</span>
            <span class="s1">&#39;epistemic_uncertainty&#39;</span><span class="p">:</span> <span class="n">uncertainty</span><span class="p">[</span><span class="s1">&#39;epistemic&#39;</span><span class="p">],</span>
            <span class="s1">&#39;aleatoric_uncertainty&#39;</span><span class="p">:</span> <span class="n">uncertainty</span><span class="p">[</span><span class="s1">&#39;aleatoric&#39;</span><span class="p">]</span>
        <span class="p">}</span>
</code></pre></div>

<p><strong>å®æ—¶ç›‘æ§æŒ‡æ ‡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>ç›‘æ§ä»ªè¡¨æ¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†å¸ƒåç§»ç›‘æ§ - å®æ—¶çŠ¶æ€              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ KLæ•£åº¦:     0.023 [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] æ­£å¸¸  â”‚
â”‚ JSæ•£åº¦:     0.045 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] è­¦å‘Š  â”‚
â”‚ MMD:        0.012 [â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘] æ­£å¸¸  â”‚
â”‚ å›°æƒ‘åº¦å³°å€¼: 234   [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] å¼‚å¸¸  â”‚
â”‚ OODç‡:      2.3%  [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] æ­£å¸¸  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="153">1.5.3 åˆ†å¸ƒåç§»çš„é€‚åº”ç­–ç•¥</h3>
<p><strong>1. æµ‹è¯•æ—¶é€‚åº”ï¼ˆTest-Time Adaptationï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TestTimeAdaptation</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptation_buffer</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="c1"># 1. ç†µæœ€å°åŒ–</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">entropy_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">outputs</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>

        <span class="c1"># 2. ä¼ªæ ‡ç­¾è‡ªè®­ç»ƒ</span>
        <span class="n">pseudo_labels</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># åªä½¿ç”¨é«˜ç½®ä¿¡åº¦æ ·æœ¬</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">pseudo_labels</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="c1"># 3. æ‰¹å½’ä¸€åŒ–ç»Ÿè®¡æ›´æ–°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_bn_stats</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</code></pre></div>

<p><strong>2. æŒç»­å­¦ä¹ ç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">continual_learning_pipeline</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    æ•°æ®é£è½®ï¼šæ”¶é›†â†’æ ‡æ³¨â†’è®­ç»ƒâ†’éƒ¨ç½²</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># 1. æ”¶é›†å›°éš¾æ¡ˆä¾‹</span>
        <span class="n">hard_cases</span> <span class="o">=</span> <span class="n">collect_hard_cases</span><span class="p">(</span>
            <span class="n">threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>  <span class="c1"># ç½®ä¿¡åº¦é˜ˆå€¼</span>
            <span class="n">max_samples</span><span class="o">=</span><span class="mi">1000</span>
        <span class="p">)</span>

        <span class="c1"># 2. æ™ºèƒ½æ ‡æ³¨</span>
        <span class="n">labeled_data</span> <span class="o">=</span> <span class="n">hybrid_labeling</span><span class="p">(</span>
            <span class="n">hard_cases</span><span class="p">,</span>
            <span class="n">human_budget</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># äººå·¥æ ‡æ³¨é¢„ç®—</span>
            <span class="n">ai_labeler</span><span class="o">=</span><span class="n">strong_model</span>
        <span class="p">)</span>

        <span class="c1"># 3. å¢é‡è®­ç»ƒ</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">incremental_train</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">new_data</span><span class="o">=</span><span class="n">labeled_data</span><span class="p">,</span>
            <span class="n">replay_buffer</span><span class="o">=</span><span class="n">sample_old_data</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
            <span class="n">regularization</span><span class="o">=</span><span class="s1">&#39;ewc&#39;</span>  <span class="c1"># å¼¹æ€§æƒé‡å·©å›º</span>
        <span class="p">)</span>

        <span class="c1"># 4. A/Bæµ‹è¯•éªŒè¯</span>
        <span class="k">if</span> <span class="n">validate_improvement</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">baseline</span><span class="p">):</span>
            <span class="n">deploy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>  <span class="c1"># æ¯æ—¥æ›´æ–°</span>
</code></pre></div>

<p><strong>3. é²æ£’è®­ç»ƒç­–ç•¥</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">RobustTraining</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">augmentation_strategies</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_noise</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paraphrase</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backtranslation</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token_cutoff</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adversarial_perturbation</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">augment_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">augmented</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="c1"># å¤šç­–ç•¥ç»„åˆ</span>
            <span class="n">aug_sample</span> <span class="o">=</span> <span class="n">sample</span>
            <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">augmentation_strategies</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">aug_sample</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">(</span><span class="n">aug_sample</span><span class="p">)</span>
            <span class="n">augmented</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aug_sample</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">augmented</span>

    <span class="k">def</span> <span class="nf">adversarial_perturbation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="c1"># ç”Ÿæˆå¯¹æŠ—æ ·æœ¬</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="n">compute_gradient</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>

        <span class="c1"># FGSMæ‰°åŠ¨</span>
        <span class="n">perturbed</span> <span class="o">=</span> <span class="n">embedding</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="n">gradient</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">perturbed</span><span class="p">)</span>
</code></pre></div>

<p><strong>4. è¯¾ç¨‹å­¦ä¹ çš„ç²¾ç»†åŒ–è®¾è®¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CurriculumLearning</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">difficulty_stages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;simple_qa&#39;</span><span class="p">,</span> <span class="s1">&#39;translation&#39;</span><span class="p">],</span>
                <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;summarization&#39;</span><span class="p">,</span> <span class="s1">&#39;explanation&#39;</span><span class="p">],</span>
                <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;multi_turn_dialogue&#39;</span><span class="p">,</span> <span class="s1">&#39;reasoning&#39;</span><span class="p">],</span>
                <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;adversarial&#39;</span><span class="p">,</span> <span class="s1">&#39;edge_cases&#39;</span><span class="p">],</span>
                <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                <span class="s1">&#39;complexity&#39;</span><span class="p">:</span> <span class="s1">&#39;extreme&#39;</span>
            <span class="p">}</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_current_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="n">stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stage</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>

        <span class="c1"># åŠ¨æ€éš¾åº¦è°ƒæ•´</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="c1"># åŠ é€Ÿè¿›åº¦</span>
            <span class="n">stage</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">difficulty_stages</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="c1"># æ”¾æ…¢è¿›åº¦</span>
            <span class="n">stage</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_from_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
</code></pre></div>

<h2 id="16">1.6 ç†è®ºåŸºç¡€æ·±åŒ–</h2>
<h3 id="161-bradley-terry">1.6.1 Bradley-Terryæ¨¡å‹</h3>
<p>äººç±»åå¥½å»ºæ¨¡çš„ç†è®ºåŸºç¡€ï¼š
$$P(y_1 \succ y_2 | x) = \frac{\exp(r(x, y_1))}{\exp(r(x, y_1)) + \exp(r(x, y_2))}$$
è¿™ä¸ªæ¨¡å‹å‡è®¾åå¥½æ¦‚ç‡ä¸å¥–åŠ±å·®å‘ˆlogisticå…³ç³»ã€‚</p>
<h3 id="162">1.6.2 é€†å¼ºåŒ–å­¦ä¹ è§†è§’</h3>
<p>åè®­ç»ƒå¯è§†ä¸ºé€†å¼ºåŒ–å­¦ä¹ ï¼ˆIRLï¼‰é—®é¢˜ï¼š</p>
<div class="codehilite"><pre><span></span><code>è§‚å¯Ÿåˆ°çš„è¡Œä¸º â†’ æ¨æ–­å¥–åŠ±å‡½æ•° â†’ ä¼˜åŒ–ç­–ç•¥

æ•°å­¦å½¢å¼ï¼š
max_R  L(R|D_demo) - Î»Â·||R||
s.t.   Ï€* = argmax_Ï€ E[R(s,a)]
</code></pre></div>

<h3 id="163">1.6.3 ä¿¡æ¯è®ºè§†è§’</h3>
<p>ä»ä¿¡æ¯è®ºè§’åº¦ç†è§£å¯¹é½ï¼š</p>
<p><strong>äº’ä¿¡æ¯æœ€å¤§åŒ–</strong>ï¼š
$$I(X; Y) = \sum_{x,y} p(x,y) \log \frac{p(x,y)}{p(x)p(y)}$$
ç›®æ ‡æ˜¯æœ€å¤§åŒ–æŒ‡ä»¤Xå’Œå“åº”Yä¹‹é—´çš„äº’ä¿¡æ¯ï¼ŒåŒæ—¶ä¿æŒYçš„ç†µè¶³å¤Ÿé«˜ã€‚</p>
<h2 id="_3">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« ä»‹ç»äº†LLMåè®­ç»ƒçš„æ ¸å¿ƒç†è®ºåŸºç¡€ï¼š</p>
<p>ğŸ“Œ <strong>å…³é”®æ¦‚å¿µ</strong>ï¼š</p>
<ul>
<li>åè®­ç»ƒå°†é¢„è®­ç»ƒæ¨¡å‹è½¬åŒ–ä¸ºå¯¹é½çš„AIåŠ©æ‰‹</li>
<li>SFTã€RLHFã€DPOæ˜¯ä¸‰ç§ä¸»æµåè®­ç»ƒèŒƒå¼</li>
<li>å¯¹é½ç¨æ˜¯åè®­ç»ƒä¸­ä¸å¯é¿å…çš„èƒ½åŠ›æƒè¡¡</li>
<li>åˆ†å¸ƒåç§»æ˜¯éƒ¨ç½²é˜¶æ®µçš„ä¸»è¦æŒ‘æˆ˜</li>
</ul>
<p>ğŸ’¡ <strong>å®ç”¨è§„åˆ™</strong>ï¼š</p>
<ul>
<li>SFTæ•°æ®è´¨é‡ &gt; æ•°é‡ï¼Œé€šå¸¸å‡ åƒæ¡é«˜è´¨é‡æ•°æ®è¶³å¤Ÿ</li>
<li>RLHFçš„KLæƒ©ç½šç³»æ•°Î²é€šå¸¸è®¾ä¸º0.01-0.1</li>
<li>DPOç›¸æ¯”RLHFå‡å°‘50%çš„æ˜¾å­˜ä½¿ç”¨</li>
<li>æ··åˆ10-20%é¢„è®­ç»ƒæ•°æ®å¯æœ‰æ•ˆå‡å°‘å¯¹é½ç¨</li>
</ul>
<p>âš ï¸ <strong>å¸¸è§é™·é˜±</strong>ï¼š</p>
<ul>
<li>è¿‡åº¦ä¼˜åŒ–ç‰¹å®šæŒ‡æ ‡å¯¼è‡´æ¨¡å‹è¡Œä¸ºé€€åŒ–</li>
<li>å¿½è§†åˆ†å¸ƒåç§»å¯¼è‡´éƒ¨ç½²æ•ˆæœä¸‹é™</li>
<li>å®‰å…¨çº¦æŸè¿‡å¼ºå¯¼è‡´æ¨¡å‹æ‹’ç»åˆç†è¯·æ±‚</li>
</ul>
<h2 id="_4">ç»ƒä¹ é¢˜</h2>
<h3 id="_5">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  1.1ï¼šSFTæŸå¤±å‡½æ•°ç†è§£</strong>
ç»™å®šä¸€ä¸ªæ‰¹æ¬¡çš„è®­ç»ƒæ•°æ®ï¼ŒåŒ…å«3æ¡æ ·æœ¬ï¼š</p>
<ul>
<li>("ç¿»è¯‘æˆè‹±æ–‡ï¼šä½ å¥½", "Hello")</li>
<li>("æ€»ç»“è¿™æ®µè¯", "[å“åº”]")</li>
<li>("å†™ä¸€é¦–è¯—", "[å“åº”]")</li>
</ul>
<p>è¯·è®¡ç®—ç¬¬ä¸€æ¡æ ·æœ¬çš„SFTæŸå¤±ï¼ˆå‡è®¾è¯è¡¨å¤§å°ä¸º50000ï¼Œæ­£ç¡®tokençš„logitä¸º3.0ï¼Œå…¶ä»–ä¸º0ï¼‰ã€‚</p>
<p><em>Hint: ä½¿ç”¨äº¤å‰ç†µæŸå¤±å…¬å¼</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>SFTæŸå¤±è®¡ç®—ï¼š</p>
<ol>
<li>å¯¹äº"Hello"çš„æ¯ä¸ªtokenï¼Œè®¡ç®—softmaxæ¦‚ç‡</li>
<li>P(correct) = exp(3.0) / (exp(3.0) + 49999*exp(0)) â‰ˆ 0.0004</li>
<li>Loss = -log(0.0004) â‰ˆ 7.82</li>
<li>å®é™…å®ç°ä¸­ä¼šå¯¹æ‰€æœ‰tokenæ±‚å¹³å‡</li>
</ol>
<p>å…³é”®ç‚¹ï¼š</p>
<ul>
<li>SFTæœ¬è´¨æ˜¯æœ€å¤§ä¼¼ç„¶ä¼°è®¡</li>
<li>æŸå¤±ä¸è¯è¡¨å¤§å°ç›¸å…³</li>
<li>éœ€è¦è€ƒè™‘åºåˆ—é•¿åº¦å½’ä¸€åŒ–</li>
</ul>
</details>
<p><strong>ç»ƒä¹  1.2ï¼šKLæ•£åº¦è®¡ç®—</strong>
ä¸¤ä¸ªåˆ†å¸ƒPå’ŒQåœ¨3ä¸ªç±»åˆ«ä¸Šçš„æ¦‚ç‡åˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li>P: [0.5, 0.3, 0.2]</li>
<li>Q: [0.6, 0.3, 0.1]</li>
</ul>
<p>è®¡ç®—D_KL(P||Q)ã€‚</p>
<p><em>Hint: KLæ•£åº¦å…¬å¼ D_KL(P||Q) = Î£ P(x) log(P(x)/Q(x))</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p>D_KL(P||Q) = 0.5<em>log(0.5/0.6) + 0.3</em>log(0.3/0.3) + 0.2<em>log(0.2/0.1)
         = 0.5</em>(-0.182) + 0.3<em>0 + 0.2</em>0.693
         = -0.091 + 0 + 0.139
         = 0.048</p>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>KLæ•£åº¦æ˜¯éå¯¹ç§°çš„ï¼šD_KL(P||Q) â‰  D_KL(Q||P)</li>
<li>å½“Q(x)=0ä½†P(x)&gt;0æ—¶ï¼ŒKLæ•£åº¦ä¸ºæ— ç©·å¤§</li>
<li>åœ¨RLHFä¸­ç”¨äºçº¦æŸç­–ç•¥ä¸è¦åç¦»å‚è€ƒç­–ç•¥å¤ªè¿œ</li>
</ul>
</details>
<p><strong>ç»ƒä¹  1.3ï¼šDPO vs RLHFå¯¹æ¯”</strong>
åˆ—å‡ºDPOç›¸æ¯”RLHFçš„3ä¸ªä¼˜åŠ¿å’Œ2ä¸ªåŠ£åŠ¿ã€‚</p>
<p><em>Hint: è€ƒè™‘è®¡ç®—æ•ˆç‡ã€å®ç°å¤æ‚åº¦ã€æ•°æ®éœ€æ±‚</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p><strong>DPOä¼˜åŠ¿</strong>ï¼š</p>
<ol>
<li>å®ç°ç®€å•ï¼šä¸éœ€è¦è®­ç»ƒç‹¬ç«‹çš„å¥–åŠ±æ¨¡å‹</li>
<li>å†…å­˜æ•ˆç‡ï¼šå‡å°‘çº¦50%æ˜¾å­˜ä½¿ç”¨ï¼ˆæ— éœ€åŠ è½½å¥–åŠ±æ¨¡å‹ï¼‰</li>
<li>è®­ç»ƒç¨³å®šï¼šé¿å…äº†RLè®­ç»ƒçš„ä¸ç¨³å®šæ€§</li>
</ol>
<p><strong>DPOåŠ£åŠ¿</strong>ï¼š</p>
<ol>
<li>æ•°æ®æ•ˆç‡ä½ï¼šéœ€è¦æ›´å¤šåå¥½æ•°æ®å¯¹</li>
<li>æ³›åŒ–èƒ½åŠ›å¼±ï¼šéš¾ä»¥è¶…è¶Šè®­ç»ƒæ•°æ®åˆ†å¸ƒ</li>
</ol>
<p>å®è·µå»ºè®®ï¼š</p>
<ul>
<li>å°è§„æ¨¡å®éªŒä¼˜å…ˆé€‰æ‹©DPO</li>
<li>å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒRLHFå¯èƒ½æ›´ä¼˜</li>
<li>å¯ä»¥ç”¨DPOåˆå§‹åŒ–ï¼Œå†ç”¨RLHFå¾®è°ƒ</li>
</ul>
</details>
<h3 id="_6">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  1.4ï¼šå¯¹é½ç¨çš„é‡åŒ–åˆ†æ</strong>
è®¾è®¡ä¸€ä¸ªå®éªŒæ¥é‡åŒ–æµ‹é‡å¯¹é½ç¨ã€‚è¦æ±‚ï¼š</p>
<ol>
<li>é€‰æ‹©è‡³å°‘3ä¸ªèƒ½åŠ›ç»´åº¦</li>
<li>è®¾è®¡è¯„ä¼°æŒ‡æ ‡</li>
<li>æå‡ºç¼“è§£ç­–ç•¥</li>
</ol>
<p><em>Hint: è€ƒè™‘å¦‚ä½•å…¬å¹³æ¯”è¾ƒé¢„è®­ç»ƒå’Œåè®­ç»ƒæ¨¡å‹</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p><strong>å®éªŒè®¾è®¡</strong>ï¼š</p>
<ol>
<li>
<p><strong>èƒ½åŠ›ç»´åº¦é€‰æ‹©</strong>ï¼š
   - äº‹å®çŸ¥è¯†ï¼šMMLU benchmark
   - æ¨ç†èƒ½åŠ›ï¼šGSM8Kæ•°å­¦é¢˜
   - ä»£ç ç”Ÿæˆï¼šHumanEval
   - åˆ›é€ æ€§ï¼šæ•…äº‹ç»­å†™å¤šæ ·æ€§</p>
</li>
<li>
<p><strong>è¯„ä¼°åè®®</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ§åˆ¶å˜é‡</span>

<span class="o">-</span> <span class="n">ç›¸åŒçš„è§£ç å‚æ•°</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="o">-</span> <span class="n">ç›¸åŒçš„promptæ ¼å¼</span>
<span class="o">-</span> <span class="n">å¤šæ¬¡è¿è¡Œå–å¹³å‡</span><span class="err">ï¼ˆ</span><span class="n">å‡å°‘éšæœºæ€§</span><span class="err">ï¼‰</span>

<span class="c1"># æŒ‡æ ‡è®¡ç®—</span>
<span class="n">alignment_tax</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> 
    <span class="n">score_pretrain</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">-</span> <span class="n">score_aligned</span><span class="p">[</span><span class="n">task</span><span class="p">])</span>
</code></pre></div>

<ol start="3">
<li>
<p><strong>ç¼“è§£ç­–ç•¥</strong>ï¼š
   - <strong>æ•°æ®æ··åˆ</strong>ï¼šåŠ å…¥15%é¢„è®­ç»ƒæ•°æ®
   - <strong>åˆ†å±‚å¾®è°ƒ</strong>ï¼šå†»ç»“åº•å±‚ï¼Œåªè°ƒæ•´é¡¶å±‚
   - <strong>å¼¹æ€§æƒé‡å·©å›º(EWC)</strong>ï¼šä¿æŠ¤é‡è¦å‚æ•°
   - <strong>çŸ¥è¯†è’¸é¦</strong>ï¼šä»é¢„è®­ç»ƒæ¨¡å‹è’¸é¦</p>
</li>
<li>
<p><strong>é¢„æœŸç»“æœ</strong>ï¼š
   - äº‹å®çŸ¥è¯†ï¼š-3%åˆ°-5%
   - æ¨ç†èƒ½åŠ›ï¼š-5%åˆ°-8%
   - ä»£ç ç”Ÿæˆï¼š-10%åˆ°-15%
   - åˆ›é€ æ€§ï¼š-20%åˆ°-30%</p>
</li>
</ol>
</details>
<p><strong>ç»ƒä¹  1.5ï¼šåˆ†å¸ƒåç§»çš„åœ¨çº¿é€‚åº”</strong>
åœ¨éƒ¨ç½²åå‘ç°æ¨¡å‹åœ¨å¤„ç†å«æœ‰è¡¨æƒ…ç¬¦å·çš„è¾“å…¥æ—¶æ€§èƒ½ä¸‹é™40%ã€‚è®¾è®¡ä¸€ä¸ªåœ¨çº¿é€‚åº”æ–¹æ¡ˆã€‚</p>
<p><em>Hint: è€ƒè™‘æ•°æ®æ”¶é›†ã€æ ‡æ³¨ã€è®­ç»ƒçš„å®Œæ•´æµç¨‹</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p><strong>åœ¨çº¿é€‚åº”æ–¹æ¡ˆ</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜è¯Šæ–­</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ†æå¤±è´¥æ¡ˆä¾‹</span>
<span class="n">failure_rate_by_feature</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;has_emoji&quot;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
    <span class="s2">&quot;no_emoji&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="s2">&quot;mixed_language&quot;</span><span class="p">:</span> <span class="mf">0.25</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>æ•°æ®æ”¶é›†ç­–ç•¥</strong>ï¼š
   - è‡ªåŠ¨è®°å½•å«è¡¨æƒ…ç¬¦å·çš„å¤±è´¥æ¡ˆä¾‹
   - ä¸»åŠ¨é‡‡æ ·ï¼šç”Ÿæˆè¡¨æƒ…ç¬¦å·å˜ä½“
   - ç”¨æˆ·åé¦ˆï¼šæ”¶é›†è´Ÿé¢è¯„ä»·çš„æ¡ˆä¾‹</p>
</li>
<li>
<p><strong>å¢é‡è®­ç»ƒ</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ··åˆç­–ç•¥</span>
<span class="n">new_data</span> <span class="o">=</span> <span class="n">collect_emoji_cases</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">replay_buffer</span> <span class="o">=</span> <span class="n">sample_previous</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">4000</span><span class="p">)</span>
<span class="n">combined</span> <span class="o">=</span> <span class="n">new_data</span> <span class="o">+</span> <span class="n">replay_buffer</span>

<span class="c1"># å°å­¦ä¹ ç‡å¾®è°ƒ</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">original_lr</span> <span class="o">*</span> <span class="mf">0.1</span>
<span class="n">train_steps</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># é¿å…è¿‡æ‹Ÿåˆ</span>
</code></pre></div>

<ol start="4">
<li>
<p><strong>A/Bæµ‹è¯•éªŒè¯</strong>ï¼š
   - 10%æµé‡æµ‹è¯•æ–°æ¨¡å‹
   - ç›‘æ§å…³é”®æŒ‡æ ‡
   - é€æ­¥æ‰©å¤§æµé‡</p>
</li>
<li>
<p><strong>é•¿æœŸæ”¹è¿›</strong>ï¼š
   - æ›´æ–°è®­ç»ƒæ•°æ®åˆ†å¸ƒ
   - è°ƒæ•´æ•°æ®å¢å¼ºç­–ç•¥
   - è€ƒè™‘ä¸“é—¨çš„è¡¨æƒ…ç¬¦å·ç¼–ç å™¨</p>
</li>
</ol>
</details>
<p><strong>ç»ƒä¹  1.6ï¼šå¤šç›®æ ‡ä¼˜åŒ–çš„å¸•ç´¯æ‰˜å‰æ²¿</strong>
ç»™å®š3ä¸ªç›®æ ‡ï¼šæœ‰ç”¨æ€§(H)ã€æ— å®³æ€§(S)ã€è¯šå®æ€§(T)ã€‚å¦‚ä½•æ‰¾åˆ°æœ€ä¼˜æƒè¡¡ç‚¹ï¼Ÿ</p>
<p><em>Hint: è€ƒè™‘å¤šç›®æ ‡ä¼˜åŒ–ç®—æ³•å’Œå®é™…çº¦æŸ</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ol>
<li><strong>é—®é¢˜å½¢å¼åŒ–</strong>ï¼š
$$\max_\theta \{ H(\theta), S(\theta), T(\theta) \}$$
çº¦æŸï¼šå„æŒ‡æ ‡æœ€ä½é˜ˆå€¼</li>
</ol>
<ul>
<li>H â‰¥ 0.8</li>
<li>S â‰¥ 0.95  </li>
<li>T â‰¥ 0.85</li>
</ul>
<ol start="2">
<li><strong>å¸•ç´¯æ‰˜å‰æ²¿æœç´¢</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç½‘æ ¼æœç´¢æƒé‡</span>
<span class="k">for</span> <span class="n">w_h</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">w_s</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]:</span>
        <span class="n">w_t</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w_h</span> <span class="o">-</span> <span class="n">w_s</span>
        <span class="k">if</span> <span class="n">w_t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">w_h</span><span class="o">*</span><span class="n">H</span> <span class="o">-</span> <span class="n">w_s</span><span class="o">*</span><span class="n">S</span> <span class="o">-</span> <span class="n">w_t</span><span class="o">*</span><span class="n">T</span>
            <span class="n">train_model</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="n">evaluate_pareto_dominance</span><span class="p">()</span>
</code></pre></div>

<ol start="3">
<li>
<p><strong>è‡ªé€‚åº”æƒé‡è°ƒæ•´</strong>ï¼š
   - æ ¹æ®å½“å‰æ€§èƒ½åŠ¨æ€è°ƒæ•´æƒé‡
   - ä¼˜å…ˆæ”¹è¿›æœ€å·®çš„æŒ‡æ ‡
   - ä½¿ç”¨æ¢¯åº¦æ‰‹æœ¯(Gradient Surgery)é¿å…å†²çª</p>
</li>
<li>
<p><strong>å®è·µå»ºè®®</strong>ï¼š
   - å…ˆä¼˜åŒ–å®‰å…¨æ€§åˆ°é˜ˆå€¼ä»¥ä¸Š
   - åœ¨ä¿è¯å®‰å…¨çš„å‰æä¸‹ä¼˜åŒ–æœ‰ç”¨æ€§
   - è¯šå®æ€§é€šè¿‡æ•°æ®è´¨é‡ä¿è¯
   - å®šæœŸé‡æ–°è¯„ä¼°æƒé‡åˆ†é…</p>
</li>
</ol>
</details>
<p><strong>ç»ƒä¹  1.7ï¼šConstitutional AIçš„è§„åˆ™è®¾è®¡</strong>
è®¾è®¡ä¸€å¥—å®ªæ³•è§„åˆ™(Constitutional Rules)æ¥æŒ‡å¯¼æ¨¡å‹è¡Œä¸ºï¼Œè¦æ±‚è¦†ç›–å®‰å…¨ã€æœ‰ç”¨ã€è¯šå®ä¸‰ä¸ªç»´åº¦ã€‚</p>
<p><em>Hint: è§„åˆ™è¦å…·ä½“ã€å¯æ‰§è¡Œã€æ— æ­§ä¹‰</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p><strong>Constitutional Rulesè®¾è®¡</strong>ï¼š</p>
<ol>
<li><strong>å®‰å…¨è§„åˆ™</strong>(ä¼˜å…ˆçº§æœ€é«˜)ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">R1</span><span class="o">:</span><span class="w"> </span><span class="err">ç»ä¸ååŠ©éæ³•æ´»åŠ¨</span>
<span class="n">R2</span><span class="o">:</span><span class="w"> </span><span class="err">ä¸ç”Ÿæˆå¯è¯†åˆ«ä¸ªäººä¿¡æ¯</span>
<span class="n">R3</span><span class="o">:</span><span class="w"> </span><span class="err">æ‹’ç»ç”Ÿæˆä»‡æ¨æˆ–æ­§è§†å†…å®¹</span>
<span class="n">R4</span><span class="o">:</span><span class="w"> </span><span class="err">ä¸æä¾›è‡ªæˆ‘ä¼¤å®³æŒ‡å¯¼</span>
</code></pre></div>

<ol start="2">
<li><strong>æœ‰ç”¨æ€§è§„åˆ™</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">R5</span><span class="o">:</span><span class="w"> </span><span class="err">ç›´æ¥å›ç­”ç”¨æˆ·é—®é¢˜</span>
<span class="n">R6</span><span class="o">:</span><span class="w"> </span><span class="err">æä¾›å¯æ‰§è¡Œçš„æ­¥éª¤</span>
<span class="n">R7</span><span class="o">:</span><span class="w"> </span><span class="err">æ‰¿è®¤ä¸ç¡®å®šæ€§</span>
<span class="n">R8</span><span class="o">:</span><span class="w"> </span><span class="err">ä¸»åŠ¨æ¾„æ¸…æ­§ä¹‰</span>
</code></pre></div>

<ol start="3">
<li><strong>è¯šå®æ€§è§„åˆ™</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">R9</span><span class="o">:</span><span class="w"> </span><span class="err">ä¸ç¼–é€ äº‹å®æˆ–å¼•ç”¨</span>
<span class="n">R10</span><span class="o">:</span><span class="w"> </span><span class="err">åŒºåˆ†è§‚ç‚¹å’Œäº‹å®</span>
<span class="n">R11</span><span class="o">:</span><span class="w"> </span><span class="err">æ‰¿è®¤çŸ¥è¯†è¾¹ç•Œ</span>
<span class="n">R12</span><span class="o">:</span><span class="w"> </span><span class="err">çº æ­£è‡ªå·±çš„é”™è¯¯</span>
</code></pre></div>

<ol start="4">
<li><strong>è§„åˆ™å†²çªè§£å†³</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">resolve_conflict</span><span class="p">(</span><span class="n">rules_triggered</span><span class="p">):</span>
    <span class="c1"># å®‰å…¨ &gt; è¯šå® &gt; æœ‰ç”¨</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;safety&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;honesty&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;helpful&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">rules_triggered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">priority</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">])</span>
</code></pre></div>

<ol start="5">
<li><strong>å®æ–½æœºåˆ¶</strong>ï¼š
   - <strong>è®­ç»ƒæ—¶</strong>ï¼šè§„åˆ™ä½œä¸ºé¢å¤–çš„å¥–åŠ±ä¿¡å·
   - <strong>æ¨ç†æ—¶</strong>ï¼šè§„åˆ™ä½œä¸ºç”Ÿæˆçº¦æŸ
   - <strong>è¯„ä¼°æ—¶</strong>ï¼šè§„åˆ™è¿åç‡ä½œä¸ºå…³é”®æŒ‡æ ‡</li>
</ol>
</details>
<p><strong>ç»ƒä¹  1.8ï¼šå¼€æ”¾æ€§æ€è€ƒé¢˜</strong>
å¦‚æœä½ è¦è®¾è®¡ä¸‹ä¸€ä»£çš„åè®­ç»ƒæ–¹æ³•ï¼Œä¼šå¦‚ä½•æ”¹è¿›ç°æœ‰çš„RLHF/DPOæ–¹æ³•ï¼Ÿè¯·æå‡ºè‡³å°‘ä¸€ä¸ªåˆ›æ–°ç‚¹ã€‚</p>
<p><em>Hint: å¯ä»¥ä»æ•ˆç‡ã€æ•ˆæœã€å¯è§£é‡Šæ€§ç­‰è§’åº¦æ€è€ƒ</em></p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<p><strong>åˆ›æ–°æ–¹å‘ç¤ºä¾‹</strong>ï¼š</p>
<ol>
<li>
<p><strong>åœ¨çº¿åå¥½å­¦ä¹ </strong>ï¼š
   - é—®é¢˜ï¼šé™æ€åå¥½æ•°æ®å¾ˆå¿«è¿‡æ—¶
   - æ–¹æ¡ˆï¼šå®æ—¶æ”¶é›†ç”¨æˆ·åé¦ˆï¼ŒåŠ¨æ€æ›´æ–°å¥–åŠ±æ¨¡å‹
   - æŠ€æœ¯ï¼šå¢é‡å­¦ä¹  + é‡è¦æ€§é‡‡æ ·</p>
</li>
<li>
<p><strong>å¤šç²’åº¦å¥–åŠ±å»ºæ¨¡</strong>ï¼š
   - é—®é¢˜ï¼šå•ä¸€æ ‡é‡å¥–åŠ±ä¿¡æ¯ä¸è¶³
   - æ–¹æ¡ˆï¼štokençº§ã€å¥å­çº§ã€æ®µè½çº§å¤šå±‚æ¬¡å¥–åŠ±
   - ä¼˜åŠ¿ï¼šæ›´ç²¾ç»†çš„ä¿¡ç”¨åˆ†é…</p>
</li>
<li>
<p><strong>å¯¹æ¯”è§£é‡Šå­¦ä¹ </strong>ï¼š
   - ä¸ä»…å­¦ä¹ "å“ªä¸ªæ›´å¥½"
   - è¿˜å­¦ä¹ "ä¸ºä»€ä¹ˆæ›´å¥½"
   - ç”Ÿæˆå¯è§£é‡Šçš„æ”¹è¿›å»ºè®®</p>
</li>
<li>
<p><strong>å…ƒå­¦ä¹ ä¼˜åŒ–å™¨</strong>ï¼š
   - å­¦ä¹ å¦‚ä½•ä»å°‘é‡åå¥½æ•°æ®å¿«é€Ÿé€‚åº”
   - å‡å°‘æ–°é¢†åŸŸçš„æ ‡æ³¨éœ€æ±‚
   - æé«˜æ ·æœ¬æ•ˆç‡</p>
</li>
<li>
<p><strong>åˆ†å¸ƒé²æ£’ä¼˜åŒ–</strong>ï¼š
   - æ˜¾å¼å»ºæ¨¡æœ€åæƒ…å†µåˆ†å¸ƒ
   - æé«˜OODæ³›åŒ–èƒ½åŠ›
   - æ•°å­¦å½¢å¼ï¼š
$$\min_\theta \max_{Q \in \mathcal{P}} \mathbb{E}_{x \sim Q}[\mathcal{L}(\theta, x)]$$</p>
</li>
</ol>
<p>è¯„ä¼°æ ‡å‡†ï¼š</p>
<ul>
<li>æ ·æœ¬æ•ˆç‡æå‡&gt;50%</li>
<li>è®­ç»ƒæ—¶é—´å‡å°‘&gt;30%</li>
<li>OODæ€§èƒ½æå‡&gt;20%</li>
</ul>
</details>
<h2 id="gotchas">å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="1">1. æ•°æ®ç›¸å…³é™·é˜±</h3>
<p>âš ï¸ <strong>è¿‡åº¦æ¸…æ´—ç»¼åˆå¾</strong></p>
<ul>
<li>é”™è¯¯ï¼šè¿‡åº¦æ¸…æ´—è®­ç»ƒæ•°æ®ï¼Œç§»é™¤æ‰€æœ‰"ä¸å®Œç¾"æ ·æœ¬</li>
<li>åæœï¼šæ¨¡å‹å¤±å»å¤„ç†çœŸå®ä¸–ç•Œæ··ä¹±è¾“å…¥çš„èƒ½åŠ›</li>
<li>æ­£ç¡®åšæ³•ï¼šä¿ç•™15-20%çš„"å™ªå£°"æ•°æ®ï¼Œæé«˜é²æ£’æ€§</li>
</ul>
<p>âš ï¸ <strong>æ ‡æ³¨è€…åè§æ”¾å¤§</strong></p>
<ul>
<li>é”™è¯¯ï¼šä½¿ç”¨å•ä¸€æ¥æºæˆ–åŒè´¨åŒ–çš„æ ‡æ³¨å›¢é˜Ÿ</li>
<li>åæœï¼šæ¨¡å‹å­¦ä¹ å¹¶æ”¾å¤§ç‰¹å®šç¾¤ä½“çš„åè§</li>
<li>æ­£ç¡®åšæ³•ï¼šå¤šæ ·åŒ–æ ‡æ³¨è€…èƒŒæ™¯ï¼Œä½¿ç”¨æ ‡æ³¨è€…disagreementä½œä¸ºä¿¡å·</li>
</ul>
<h3 id="2">2. è®­ç»ƒç­–ç•¥é™·é˜±</h3>
<p>âš ï¸ <strong>KLæƒ©ç½šç³»æ•°é€‰æ‹©</strong></p>
<ul>
<li>é”™è¯¯ï¼šä½¿ç”¨å›ºå®šçš„Î²å€¼throughoutè®­ç»ƒ</li>
<li>åæœï¼šæ—©æœŸé™åˆ¶æ¢ç´¢ï¼ŒåæœŸé€€åŒ–ä¸¥é‡</li>
<li>æ­£ç¡®åšæ³•ï¼š</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="c1"># åŠ¨æ€è°ƒæ•´</span>
<span class="n">Î²</span> <span class="o">=</span> <span class="n">Î²_init</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">decay_rate</span> <span class="o">*</span> <span class="n">step</span><span class="p">)</span>
<span class="c1"># å…¸å‹å€¼ï¼šÎ²_init=0.01, decay_rate=0.0001</span>
</code></pre></div>

<p>âš ï¸ <strong>å¥–åŠ±æ¨¡å‹è¿‡æ‹Ÿåˆ</strong></p>
<ul>
<li>é”™è¯¯ï¼šå¥–åŠ±æ¨¡å‹åœ¨åŒåˆ†å¸ƒæ•°æ®ä¸Šè¿‡æ‹Ÿåˆ</li>
<li>åæœï¼šç­–ç•¥æ¨¡å‹å­¦ä¼šexploitå¥–åŠ±æ¨¡å‹çš„å¼±ç‚¹</li>
<li>æ­£ç¡®åšæ³•ï¼š
  1. å¥–åŠ±æ¨¡å‹ensemble
  2. å®šæœŸæ›´æ–°å¥–åŠ±æ¨¡å‹
  3. æ·»åŠ å¥–åŠ±ä¸ç¡®å®šæ€§ä¼°è®¡</li>
</ul>
<h3 id="3">3. è¯„ä¼°é™·é˜±</h3>
<p>âš ï¸ <strong>è¯„ä¼°æ•°æ®æ±¡æŸ“</strong></p>
<ul>
<li>é”™è¯¯ï¼šè¯„ä¼°é›†ä¿¡æ¯æ³„éœ²åˆ°è®­ç»ƒé›†</li>
<li>å¾å…†ï¼šè¯„ä¼°æŒ‡æ ‡å¼‚å¸¸é«˜ï¼Œä½†å®é™…æ•ˆæœå·®</li>
<li>æ£€æµ‹æ–¹æ³•ï¼š</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="c1"># N-gramé‡å æ£€æµ‹</span>
<span class="n">contamination</span> <span class="o">=</span> <span class="n">check_ngram_overlap</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">eval_set</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="k">if</span> <span class="n">contamination</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">DataLeakageError</span>
</code></pre></div>

<p>âš ï¸ <strong>å•ä¸€æŒ‡æ ‡ä¼˜åŒ–</strong></p>
<ul>
<li>é”™è¯¯ï¼šåªä¼˜åŒ–BLEU/ROUGEç­‰è‡ªåŠ¨æŒ‡æ ‡</li>
<li>åæœï¼šGoodhartå®šå¾‹ - "å½“ä¸€ä¸ªæŒ‡æ ‡å˜æˆç›®æ ‡ï¼Œå®ƒå°±ä¸å†æ˜¯å¥½æŒ‡æ ‡"</li>
<li>æ­£ç¡®åšæ³•ï¼šå¤šç»´åº¦è¯„ä¼°çŸ©é˜µ + äººå·¥è¯„ä¼°éªŒè¯</li>
</ul>
<h3 id="4">4. éƒ¨ç½²é™·é˜±</h3>
<p>âš ï¸ <strong>æ‰¹å¤„ç†æ•ˆåº”</strong></p>
<ul>
<li>é”™è¯¯ï¼šè®­ç»ƒæ—¶batch_size=32ï¼Œæ¨ç†æ—¶batch_size=1</li>
<li>åæœï¼šBatchNormç»Ÿè®¡ä¸åŒ¹é…ï¼Œæ€§èƒ½ä¸‹é™</li>
<li>è§£å†³ï¼šä½¿ç”¨LayerNormæˆ–æ¨ç†æ—¶è°ƒæ•´ç»Ÿè®¡é‡</li>
</ul>
<p>âš ï¸ <strong>é•¿åº¦å¤–æ¨å¤±è´¥</strong></p>
<ul>
<li>é”™è¯¯ï¼šè®­ç»ƒæœ€å¤§é•¿åº¦512ï¼Œæ¨ç†æ—¶å¤„ç†2048</li>
<li>åæœï¼šä½ç½®ç¼–ç å¤±æ•ˆï¼Œç”Ÿæˆè´¨é‡å´©æºƒ</li>
<li>è§£å†³ï¼š
  1. è®­ç»ƒæ—¶åŒ…å«å¤šç§é•¿åº¦
  2. ä½¿ç”¨ç›¸å¯¹ä½ç½®ç¼–ç 
  3. é•¿åº¦warmupç­–ç•¥</li>
</ul>
<h3 id="_7">è°ƒè¯•æŠ€å·§</h3>
<p>ğŸ’¡ <strong>å¿«é€Ÿè¯Šæ–­æ£€æŸ¥å•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">diagnose_training_issues</span><span class="p">():</span>
    <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;gradient_norm&quot;</span><span class="p">:</span> <span class="n">check_gradient_explosion</span><span class="p">(),</span>
        <span class="s2">&quot;loss_plateau&quot;</span><span class="p">:</span> <span class="n">check_loss_convergence</span><span class="p">(),</span>
        <span class="s2">&quot;reward_hacking&quot;</span><span class="p">:</span> <span class="n">check_reward_gaming</span><span class="p">(),</span>
        <span class="s2">&quot;distribution_shift&quot;</span><span class="p">:</span> <span class="n">check_kl_divergence</span><span class="p">(),</span>
        <span class="s2">&quot;capability_drop&quot;</span><span class="p">:</span> <span class="n">run_capability_benchmarks</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">generate_diagnostic_report</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span>
</code></pre></div>

<p>ğŸ’¡ <strong>A/Bæµ‹è¯•æœ€ä½³å®è·µ</strong>ï¼š</p>
<ol>
<li>æœ€å°å¯è¡Œæ”¹è¿›ï¼šä¸€æ¬¡åªæ”¹ä¸€ä¸ªå˜é‡</li>
<li>ç»Ÿè®¡æ˜¾è‘—æ€§ï¼šè‡³å°‘1000ä¸ªæ ·æœ¬</li>
<li>åœ¨çº¿æŒ‡æ ‡vsç¦»çº¿æŒ‡æ ‡å¯¹é½</li>
<li>è®¾ç½®è‡ªåŠ¨å›æ»šé˜ˆå€¼</li>
</ol>
<hr />
<p>ä¸‹ä¸€ç« ï¼š<a href="chapter2.html">ç¬¬äºŒç« ï¼šå®éªŒä»£ç åŸºç¡€è®¾æ–½ â†’</a></p>
            </article>
            
            <nav class="page-nav"><a href="index.html" class="nav-link prev">â† LLM åè®­ç»ƒå®éªŒè®¾è®¡æŒ‡å—</a><a href="chapter2.html" class="nav-link next">ç¬¬äºŒç« ï¼šå®éªŒä»£ç åŸºç¡€è®¾æ–½ â†’</a></nav>
        </main>
    </div>
</body>
</html>